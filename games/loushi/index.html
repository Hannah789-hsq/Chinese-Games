<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陋室铭 - 君子之居</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'wechat-green': '#07C160',
                        'wechat-bg': '#EDEDED',
                        'wechat-dark-bg': '#111111',
                        'bubble-self': '#95EC69',
                        'bubble-self-dark': '#2B7D39',
                        'bubble-other': '#FFFFFF',
                        'bubble-other-dark': '#2C2C2C',
                    },
                    fontFamily: {
                        'song': ['SimSun', 'serif'],
                    }
                }
            }
        };
    </script>
    <style>
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        /* 移除打字动画效果
        .typing-animation {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 1.5s steps(40, end);
        } */
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .message-bubble {
            position: relative;
            max-width: 85%;
            word-wrap: break-word;
            white-space: normal;
            text-align: left;
            line-height: 1.4;
            font-size: 15px;
            text-indent: 0 !important;
            padding: 12px 16px !important;
            margin-left: 0 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        .message-bubble * {
            text-indent: 0 !important;
            margin-left: 0 !important;
        }
        
        /* 优化列表项的排版 */
        .message-bubble ol, 
        .message-bubble ul {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .message-bubble li {
            margin-bottom: 0.25rem;
        }
        
        .message-bubble.self:after {
            content: '';
            position: absolute;
            right: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: #95EC69;
            border-right: 0;
            margin-top: -10px;
            margin-right: 0px;
        }
        
        .dark .message-bubble.self:after {
            border-left-color: #2B7D39;
        }
        
        .message-bubble.other:after {
            content: '';
            position: absolute;
            left: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: #FFF;
            border-left: 0;
            margin-top: -10px;
            margin-left: 0px;
        }
        
        .dark .message-bubble.other:after {
            border-right-color: #2C2C2C;
        }
        
        /* Ancient scroll style for the 陋室铭 text */
        .ancient-scroll {
            background-color: #f5e8c8;
            border: 1px solid #d3b17d;
            border-radius: 5px;
            color: #5c3317;
        }
        
        .dark .ancient-scroll {
            background-color: #3c3020;
            border-color: #5e4c3e;
            color: #d3b17d;
        }

        /* Wechat moments style */
        .wechat-moments {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 100%;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .dark .wechat-moments {
            background-color: #262626;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .moment-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dark .moment-header {
            border-bottom: 1px solid #333;
        }
        
        .moment-content {
            padding: 16px;
        }
        
        .moment-footer {
            display: flex;
            padding: 10px 16px;
            color: #576b95;
            font-size: 0.9em;
            border-top: 1px solid #f0f0f0;
        }
        
        .dark .moment-footer {
            border-top: 1px solid #333;
            color: #8ab4f8;
        }
        
        .moment-likes {
            margin-right: 12px;
        }
    </style>
</head>
<body class="bg-wechat-bg dark:bg-wechat-dark-bg min-h-screen font-sans text-gray-800 dark:text-gray-200 transition-colors duration-300">


    <!-- Progress indicator -->
    <div class="fixed top-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-800 z-40">
        <div id="progressBar" class="h-full bg-wechat-green transition-all duration-300" style="width: 0%"></div>
    </div>

    <!-- Status bar -->
    <div class="fixed top-0 left-0 right-0 h-6 bg-white dark:bg-black text-black dark:text-white text-sm font-medium flex items-center justify-between px-4 z-50">
        <div class="flex items-center">
            <span>20:15</span>
        </div>
        <div class="flex items-center space-x-1">
            <div class="flex space-x-1">
                <div class="w-1 h-1 bg-black dark:bg-white rounded-full"></div>
                <div class="w-1 h-1 bg-black dark:bg-white rounded-full"></div>
                <div class="w-1 h-1 bg-black dark:bg-white rounded-full"></div>
                <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
            </div>
            <span class="text-xs">5G</span>
            <div class="w-6 h-3 border border-black dark:border-white rounded-sm relative">
                <div class="w-4 h-2 bg-green-500 rounded-sm absolute top-0.5 left-0.5"></div>
                <div class="w-1 h-1 bg-black dark:bg-white rounded-sm absolute top-1 -right-1"></div>
            </div>
        </div>
    </div>

    <!-- Chat header -->
    <header class="sticky top-6 z-40 bg-gray-100 dark:bg-gray-800 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center">
            <button class="mr-4 text-blue-500">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
            </button>
            <div class="text-center">
                <h1 class="text-lg font-medium text-black dark:text-white">陋室雅集 (18)</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">17人在线</p>
            </div>
        </div>
        <button class="text-black dark:text-white">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
            </svg>
        </button>
    </header>

    <!-- Game Guide Overlay -->
    <div id="gameGuide" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 py-8">
            <!-- Header with game title -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">陋室铭 - 君子之居</h1>
                <p class="text-gray-600 dark:text-gray-400">体验唐代诗人刘禹锡创作《陋室铭》的历程</p>
            </div>
            
            <!-- Game introduction -->
            <div class="mb-8 bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">📜</span> 历史背景</h2>
                <p class="mb-3">公元824年，唐朝文宗时期。你将扮演刘禹锡，曾任监察御史的你因政治原因触怒权贵，被贬至安徽和州任刺史。</p>
                <p class="mb-3">初到和州，县令见你是被贬官员，暗中欲刁难于你，多次搬迁你的住所，想借此打击你的锐气...</p>
                <p>然而，真正的君子能够在逆境中保持高洁品格。你将在这段经历中创作出传世名篇《陋室铭》，阐述"外在环境不足以限制内心世界"的哲理。</p>
            </div>
            
            <!-- Game objectives -->
            <div class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">🎯</span> 游戏目标</h2>
                <div class="pl-5 border-l-4 border-indigo-500 dark:border-indigo-400">
                    <p class="mb-2">• 体验刘禹锡创作《陋室铭》的历史背景</p>
                    <p class="mb-2">• 探索"君子居之，何陋之有"这一哲学思想</p>
                    <p class="mb-2">• 通过选择影响最终《陋室铭》的风格</p>
                    <p>• 获得符合你性格的四种结局之一</p>
                </div>
            </div>
            
            <!-- Gameplay mechanics -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 flex items-center"><span class="mr-2">💬</span> 对话选择</h3>
                    <p>在游戏中，你将面临多种对话选择，每个选择都会影响游戏走向和你的性格倾向。选择具有陶渊明风格的回答会增加"隐逸"倾向，选择杜甫风格的会增加"家国"倾向，选择儒家风格的会增加"修身"倾向。</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 flex items-center"><span class="mr-2">@</span> @历史名人</h3>
                    <p>游戏的核心特色！你可以在不同场景@历史名人与他们交流。每个环境中可@的人物不同，且次数有限。与不同历史人物的交流会影响你的性格倾向，并可能解锁新的历史人物。</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 flex items-center"><span class="mr-2">🔓</span> 人物解锁</h3>
                    <p>初始可@的历史人物有限。通过与特定人物对话，你可以解锁更多历史名人。例如，与陶渊明对话可能解锁王维，与孔子对话可能解锁颜回，等等。探索不同组合，解锁更多对话！</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 flex items-center"><span class="mr-2">🏆</span> 四种结局</h3>
                    <p>根据你的选择和@的历史人物，游戏有四种不同结局：隐逸闲适结局（陶渊明风格）、家国情怀结局（杜甫风格）、儒雅修身结局（儒家风格）和诗意人生结局（平衡风格）。</p>
                </div>
            </div>
            
            <!-- Interface guide -->
            <div class="mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">🖥️</span> 界面指南</h2>
                <div class="grid grid-cols-1 gap-3">
                    <div class="flex items-start">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full p-2 mr-3">💬</div>
                        <div>
                            <p class="font-medium">对话界面</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">模拟微信聊天界面，显示你与历史人物、县令的对话。</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full p-2 mr-3">👆</div>
                        <div>
                            <p class="font-medium">选项按钮</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">底部会弹出对话选项，点击选择你的回应。</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full p-2 mr-3">@</div>
                        <div>
                            <p class="font-medium">@历史名人</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">选择"@历史名人..."选项可打开人物列表，选择要交流的历史人物。</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Start button -->
            <div class="text-center">
                <button id="startGameBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-colors duration-300 shadow-lg transform hover:scale-105">
                    开始游戏
                </button>
                <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">点击开始，体验《陋室铭》的创作历程</p>
            </div>
        </div>
    </div>

    <!-- Chat container -->
    <div id="chatContainer" class="pb-32 pt-32 px-3 bg-gray-50 dark:bg-gray-900">
        <!-- Messages will be added here dynamically -->
    </div>

    <!-- Options container - Fixed at bottom with extra margin -->
    <div id="optionsContainer" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-3 pb-16 transition-all duration-300 transform translate-y-full">
        <div id="optionsList" class="flex flex-col space-y-2">
            <!-- Options will be added here dynamically -->
        </div>
    </div>

    <!-- Debug info -->
    <div id="debugInfo" class="fixed bottom-20 right-2 bg-black bg-opacity-70 text-white p-2 rounded text-xs" style="display: none;">
        当前阶段: <span id="debugStage">0</span>
    </div>

    <!-- "Typing" indicator -->
    <div id="typingIndicator" class="fixed bottom-20 left-3 bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-full px-3 py-1 text-sm opacity-0 transition-opacity duration-300">
        有人正在输入...
    </div>

    <!-- Wechat-style Input area -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 px-3 py-2">
        <div class="flex items-center">
            <!-- Voice button -->
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-400">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                </svg>
            </button>
            
            <!-- Text input -->
            <div class="flex-1 bg-gray-100 dark:bg-gray-800 rounded-full mx-2 relative">
                <input id="userInput" type="text" placeholder="点击此处继续..."
                    class="w-full rounded-full px-4 py-2 bg-transparent focus:outline-none text-base text-gray-400 dark:text-gray-500"
                    disabled readonly>
            </div>
            
            <!-- Emoji button -->
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-400">
                😊
            </button>
            
            <!-- Plus button -->
            <button class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-400">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // 调试模式（开启后可以显示当前游戏阶段和详细错误信息）
        const DEBUG_MODE = true; // 临时开启调试模式来定位错误

        // Game state
        const gameState = {
            currentStage: 0,
            selectedOptions: [],
            stylePoints: {
                tao: 0,    // 陶渊明风格分数
                du: 0,     // 杜甫风格分数
                ru: 0,     // 儒家风格分数（孔子、杨雄）
                balanced: 0 // 平衡风格分数
            },
            unlockedCharacters: [
                "tao",     // 陶渊明（初始解锁）
                "du",      // 杜甫（初始解锁）
                "confucius", // 孔子（初始解锁）
                "libai"    // 李白（初始解锁）
            ],
            mentionedCharacters: [], // 已@过的角色，用于追踪交互
            availableMentions: {     // 每个环境可用的@次数
                "1": 10,  // 江边环境
                "2": 10,  // 柳边环境
                "3": 10   // 斗室环境
            },
            
            // 环境-人物映射表：定义每个人物在哪个环境中可以出现
            environmentCharacters: {
                "1": [ // 江边环境
                    "tao", "du", "libai", "confucius", "baijuyi"
                ],
                "2": [ // 柳边环境
                    "wangwei", "zhugeliang", "liqingzhao"
                ],
                "3": [ // 斗室环境
                    "sushi", "yangxiong", "yanhuei", "zengzi"
                ]
            },

            lastSpeaker: null,
            isShowingMessages: false, // 是否正在显示消息
            characterEmojis: {
                "narrator": "📱",
                "liuyuxi": "📝",
                "countyMagistrate": "😠",
                "zhugeliang": "🧙‍♂️",
                "yangxiong": "🧐",
                "confucius": "👴",
                "liuzongyuan": "📚",
                "tao": "🌱",
                "du": "🌧️",
                "libai": "🍷",
                "yanhuei": "📚",
                "wangwei": "🎨",
                "sushi": "🌊",
                "liqingzhao": "🌸",
                "zengzi": "📜",
                "baijuyi": "🎭",
                "system": "ℹ️"
            },
            characterNames: {
                "narrator": "系统通知",
                "liuyuxi": "刘禹锡",
                "countyMagistrate": "县令",
                "zhugeliang": "诸葛亮",
                "yangxiong": "杨雄",
                "confucius": "孔子",
                "liuzongyuan": "柳宗元",
                "tao": "陶渊明",
                "du": "杜甫",
                "libai": "李白",
                "yanhuei": "颜回",
                "wangwei": "王维",
                "sushi": "苏轼",
                "liqingzhao": "李清照",
                "zengzi": "曾子",
                "baijuyi": "白居易",
                "system": "系统"
            },
            // 角色信息，包括风格、简介等
            characterInfo: {
                "tao": { 
                    style: "隐逸派", 
                    desc: "东晋诗人，归隐田园，著有《桃花源记》",
                    unlocks: ["wangwei"] // 与陶渊明对话后解锁王维
                },
                "du": { 
                    style: "家国派", 
                    desc: "唐代诗人，'诗圣'，忧国忧民",
                    unlocks: ["libai"] // 与杜甫对话可能解锁李白
                },
                "confucius": { 
                    style: "儒家派", 
                    desc: "儒家创始人，主张'仁'、'礼'",
                    unlocks: ["yanhuei", "zengzi"] // 与孔子对话后解锁颜回和曾子
                },
                "libai": { 
                    style: "综合派", 
                    desc: "唐代诗人，'诗仙'，豪放不羁",
                    unlocks: ["sushi"] // 与李白对话后解锁苏轼
                },
                "yanhuei": { 
                    style: "儒家派", 
                    desc: "孔子最得意门生，安贫乐道",
                    unlocks: []
                },
                "wangwei": { 
                    style: "隐逸派", 
                    desc: "唐代诗人，山水田园诗人，禅宗大师",
                    unlocks: []
                },
                "zhugeliang": { 
                    style: "家国派", 
                    desc: "三国蜀汉丞相，忠心报国",
                    unlocks: []
                },
                "yangxiong": { 
                    style: "儒家派", 
                    desc: "西汉文学家，著有《法言》",
                    unlocks: []
                },
                "sushi": { 
                    style: "综合派", 
                    desc: "宋代文豪，豪放派代表",
                    unlocks: ["liqingzhao"] // 与苏轼对话后解锁李清照
                },
                "liqingzhao": { 
                    style: "综合派", 
                    desc: "宋代女词人，婉约派代表",
                    unlocks: []
                },
                "zengzi": { 
                    style: "儒家派", 
                    desc: "孔子弟子，著有《大学》",
                    unlocks: []
                },
                "baijuyi": { 
                    style: "家国派", 
                    desc: "唐代诗人，贬江州司马，与刘禹锡同遭贬谪",
                    unlocks: [] 
                }
            }
        };

        // 取消黑暗模式
        // 确保始终处于浅色模式
        document.documentElement.classList.remove('dark');

        // Get DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const optionsContainer = document.getElementById('optionsContainer');
        const optionsList = document.getElementById('optionsList');
        const userInput = document.getElementById('userInput');
        const progressBar = document.getElementById('progressBar');
        const typingIndicator = document.getElementById('typingIndicator');
        const debugInfo = document.getElementById('debugInfo');
        const debugStage = document.getElementById('debugStage');

        // 如果开启调试模式，显示调试信息
        if (DEBUG_MODE) {
            debugInfo.style.display = "block";
        }

        // 游戏推进系统配置
        const gameProgression = {
            // 感悟系统（方案一）
            insights: {
                philosophical: 0,  // 哲学感悟
                emotional: 0,      // 情感共鸣  
                practical: 0,      // 实践智慧
                artistic: 0        // 艺术灵感
            },
            
            // 三幕状态（方案三）
            acts: {
                "1": { // 江边 - 愤怒转向思考
                    minInsights: 6,
                    theme: "初识古人智慧",
                    magistrateThought: "怎么还不沮丧？这人在想什么？"
                },
                "2": { // 柳边 - 思考转向领悟  
                    minInsights: 12,
                    theme: "深悟人生真理",
                    magistrateThought: "竟然还能谈笑风生？得用最后一招！"
                },
                "3": { // 斗室 - 领悟转向创作
                    minInsights: 18,
                    theme: "彻悟陋室真谛",
                    magistrateThought: "这...这个人到底怎么回事？"
                }
            }
        };

        // 心态成长系统
        const mentalStates = {
            "confused_angry": {
                name: "初贬无措期",
                description: "对县令刁难的愤怒，对贬谪遭遇的不解，对未来的迷茫不安",
                enlightenmentMultiplier: 1 // 基础启发获取倍率
            },
            "adapting_reflecting": {
                name: "适应思考期", 
                description: "开始适应新环境，与古人对话获得启发，逐渐理解贬谪的意义",
                enlightenmentMultiplier: 1.5
            },
            "enlightened_transcendent": {
                name: "领悟升华期",
                description: "完全接受现状，感激这段经历，心境澄明通透",
                enlightenmentMultiplier: 2
            }
        };

        // 启发值系统
        const enlightenmentSystem = {
            philosophical: 0,  // 哲学启发
            artistic: 0,       // 艺术启发  
            emotional: 0,      // 情感共鸣
            practical: 0       // 实践智慧
        };

        // 当前心态状态
        let currentMentalState = "confused_angry";
        let totalEnlightenment = 0;

        // 分段式对话系统（完整的出场展示版本）
        const segmentedDialogues = {
            // 陶渊明完整出场展示（江边环境）
            "tao_segment1": {
                environment: "1",
                segment: 1,
                character: "tao",
                messages: [
                    { type: "narrator", text: "🌊🌿🍷" },
                    { type: "tao", text: "刘兄，我陶渊明特来看望。见你被县令如此刁难，让我想起自己当年的遭遇..." },
                    { type: "tao", text: "我也曾在彭泽做县令，只做了八十多天就辞官而去。那时有督邮来检查，下属说要束带接见，我说'我岂能为五斗米向乡里小儿折腰！'" },
                    { type: "tao", text: "辞官归田后，日日耕种锄草，身体反倒硬朗了许多。每日在东篱下种菊，傍晚举首望见南山轮廓，心旷神怡。有闲暇便写些文字，或携壶浊酒独酌，与田园为伴，倒也惬意。" },
                    { type: "tao", text: "记得归田后的第一年冬天，家中断粮，我骑牛入城，沿街乞食，也不觉得羞耻。邻居们起初都笑我傻，三四年后见我怡然自得，也都羡慕起来。" },
                    { type: "tao", text: "如今我种的菊花，十里八乡无人不知。'采菊东篱下，悠然见南山'，这南山不在远方，在心中。刘兄今日处境，正如我当年，莫要被外物所困。" }
                ],
                options: [
                    { 
                        text: "请教先生如何在困境中保持内心平静", 
                        style: "tao",
                        nextSegment: "tao_segment2a",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "想了解先生田园生活的更多细节", 
                        style: "tao",
                        nextSegment: "tao_segment2b",
                        enlightenment: { philosophical: 1 }
                    },
                    { 
                        text: "先生当年辞官后有没有后悔过？", 
                        style: "balanced",
                        nextSegment: "tao_segment2c",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "tao_segment2a": {
                character: "tao", 
                messages: [
                    { type: "tao", text: "善！君见东篱菊否？可植于阶前。宦海浮沉，总不如一杯清酒来得痛快。" }
                ],
                options: [
                    { 
                        text: "愿随先生种菊南山下", 
                        style: "tao",
                        nextSegment: "tao_segment3a",
                        enlightenment: { philosophical: 3, emotional: 2 }
                    },
                    { 
                        text: "先生之境界，我虽向往，但仍有未了心愿", 
                        style: "balanced",
                        nextSegment: "tao_segment3b",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ],
                triggerGroups: ["libai_insert_garden"] // 可能触发李白插话
            },
            "tao_segment2b": {
                character: "tao",
                messages: [
                    { type: "tao", text: "官署如樊笼，不见彭泽旧事乎？菊圃方滋，自有东篱趣；杏坛未冷，更需后学魂。各随其性，何必强求？" }
                ],
                options: [
                    { 
                        text: "先生所言极是，各有天命", 
                        style: "tao",
                        nextSegment: "tao_segment3c",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "纵然如此，我心仍不能忘怀国事", 
                        style: "du",
                        nextSegment: "tao_segment3d",
                        enlightenment: { practical: 2, emotional: 1 }
                    }
                ]
            },
            "tao_segment3a": {
                character: "tao",
                messages: [
                    { type: "tao", text: "此心安处是吾乡。刘兄若能在此江边有所悟得，他日必能超然物外。" }
                ],
                options: [
                    { 
                        text: "感谢先生指点，我已有所悟", 
                        style: "tao",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },

            // 杜甫完整出场展示（江边环境）
            "du_segment1": {
                environment: "1",
                segment: 1,
                character: "du",
                messages: [
                    { type: "narrator", text: "🌊🌧️📝" },
                    { type: "du", text: "刘兄，子美见礼。闻君被贬，特来相访。见你身在江边，我不禁想起自己的经历。" },
                    { type: "du", text: "我生逢乱世，亲历安史之乱。'国破山河在，城春草木深'，眼见百姓流离失所，朝野腐败，心中郁结难消啊。" },
                    { type: "du", text: "我曾流落夔州，住过破旧茅屋，'床头屋漏无干处，雨脚如麻未断绝'，挑灯夜战，只为记录这乱世中的点滴。最艰难时，我带着病妻幼子逃难，'朝行水草边，暮宿山木下'，亲眼目睹民间疾苦。" },
                    { type: "du", text: "但我始终相信，'会当凌绝顶，一览众山小'。身处逆境，更应保持初心。虽说一介书生，难挽天下大势，但'位卑未敢忘忧国'，也是我辈读书人的气节啊！" },
                    { type: "du", text: "彼县令之流，徒知奉承权贵，殊不知'朱门酒肉臭，路有冻死骨'的悲剧何时方休？刘兄，我们虽身微言轻，然一支笔，胜千军万马。" }
                ],
                options: [
                    { 
                        text: "子美所言极是！虽遭贬谪，我仍心系朝堂，只是力不从心，难以施展抱负。", 
                        style: "du",
                        nextSegment: "du_segment2a",
                        enlightenment: { practical: 3, emotional: 1 }
                    },
                    { 
                        text: "子美历经磨难仍心系苍生，我深感敬佩。在这乱世中，个人的力量真的有用吗？", 
                        style: "du",
                        nextSegment: "du_segment2b",
                        enlightenment: { practical: 2 }
                    },
                    { 
                        text: "子美忧国忧民，令人敬佩。只是我渐觉随遇而安的好处，何必过度忧思？", 
                        style: "tao",
                        nextSegment: "du_segment2c",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "du_segment2a": {
                character: "du",
                messages: [
                    { type: "du", text: "这江边环境虽不如京城繁华，但见你安之若素，不免让我想起'安得广厦千万间，大庇天下寒士俱欢颜'的心愿。" }
                ],
                options: [
                    { 
                        text: "子美心系苍生，我深为感动", 
                        style: "du",
                        nextSegment: "du_segment3a",
                        enlightenment: { practical: 2, emotional: 1 }
                    },
                    { 
                        text: "如今我倒渐觉随遇而安的好处", 
                        style: "tao",
                        nextSegment: "du_segment3b",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "du_segment2b": {
                character: "du",
                messages: [
                    { type: "du", text: "我生逢乱世，亲历安史之乱。'国破山河在，城春草木深'，眼见百姓流离失所，朝野腐败，心中郁结难消啊。" }
                ],
                options: [
                    { 
                        text: "子美所言极是！虽遭贬谪，我仍心系朝堂", 
                        style: "du",
                        nextSegment: "du_segment3a",
                        enlightenment: { practical: 3, emotional: 1 }
                    },
                    { 
                        text: "天下事难以一人之力改变，何不学会释然？", 
                        style: "tao",
                        nextSegment: "du_segment3c",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "du_segment3a": {
                character: "du",
                messages: [
                    { type: "du", text: "刘兄有此心怀，他日必成大器。天下兴亡，匹夫有责，我等虽力微言轻，然笔墨千秋，或可感天地，泣鬼神！" }
                ],
                options: [
                    { 
                        text: "愿与子美同行此路，以笔墨鸣不平！", 
                        style: "du",
                        enlightenment: { practical: 3 }
                    }
                ]
            },
            "du_segment3b": {
                character: "du", 
                messages: [
                    { type: "du", text: "各有所志。当年吾与太白结交，他也常劝我'一樽还酹江月'，不必太过忧思。然吾见民生多艰，何能置身事外？" }
                ],
                options: [
                    { 
                        text: "子美与太白友谊深厚，令人羡慕", 
                        style: "balanced",
                        enlightenment: { emotional: 2 }
                    }
                ]
            },
            "du_segment3c": {
                character: "du",
                messages: [
                    { type: "du", text: "刘兄志趣，倒与太白相近。或许你们看得更透彻，只是我见惯战乱颠沛，实在无法置身事外。" }
                ],
                options: [
                    { 
                        text: "各有所安，子美忧民之心可敬", 
                        style: "balanced",
                        enlightenment: { emotional: 1, practical: 1 }
                    }
                ]
            },

            // 李白完整出场展示（江边环境）
            "libai_segment1": {
                environment: "1",
                segment: 1,
                character: "libai",
                messages: [
                    { type: "narrator", text: "🌊🍷🌙" },
                    { type: "libai", text: "哈哈哈！刘兄，遇见故人，不胜欢喜！我正从峨眉赏月归来，一壶好酒尚未饮尽，便闻你被贬之事，特来看望！" },
                    { type: "libai", text: "那县令嘛——嗝~（打个酒嗝）——不过是碌碌小人罢了！我当年在唐玄宗面前都敢口出狂言，何况小小县令？'安能摧眉折腰事权贵，使我不得开心颜'！" },
                    { type: "libai", text: "你可知道，我年轻时曾隐居庐山，一间草屋，虽小却胜似皇宫！《望庐山瀑布》就是那时所作，'飞流直下三千尺，疑是银河落九天'，你看这气势，哪是小屋子能限制得了的？" },
                    { type: "libai", text: "我啊，生平漂泊，曾在剑阁题诗'蜀道之难难于上青天'，在夷陵醉酒'朝辞白帝彩云间'，在金陵登高'钟山只隔数重山'，哪一处不是我李白的诗境？" },
                    { type: "libai", text: "刘兄，人活世上，不过百年光阴。'天生我材必有用，千金散尽还复来'！你这小小一贬，何足挂齿？来，这壶剑南春，我敬你一杯！" }
                ],
                options: [
                    { 
                        text: "太白兄豪迈非常！确如你所言，'天生我材必有用，千金散尽还复来'，何惧贬谪？", 
                        style: "balanced",
                        nextSegment: "libai_segment2a",
                        enlightenment: { artistic: 2, philosophical: 1 }
                    },
                    { 
                        text: "太白兄虽能'仰天大笑出门去'，我却常思'安得广厦千万间，大庇天下寒士俱欢颜'啊！", 
                        style: "du",
                        nextSegment: "libai_segment2b",
                        enlightenment: { practical: 2, artistic: 1 }
                    },
                    { 
                        text: "请太白兄传授豪迈洒脱之道", 
                        style: "balanced",
                        nextSegment: "libai_segment2c",
                        enlightenment: { artistic: 1 }
                    }
                ]
            },
            "libai_segment2a": {
                character: "libai",
                messages: [
                    { type: "libai", text: "哈哈！痛快！听刘兄此言，真乃我辈知己！我常说'人生在世不称意，明朝散发弄扁舟'。这区区贬谪，不过给你提供了一个观江赏月、吟诗作赋的好去处！来，再饮，再饮！" }
                ],
                options: [
                    { 
                        text: "与太白兄把酒临风，快意人生！", 
                        style: "balanced",
                        nextSegment: "libai_segment3a",
                        enlightenment: { artistic: 3, emotional: 1 }
                    },
                    { 
                        text: "太白兄豪放，但我仍不忘诗文载道的使命", 
                        style: "du",
                        nextSegment: "libai_segment3b",
                        enlightenment: { practical: 1, artistic: 1 }
                    }
                ]
            },
            "libai_segment2b": {
                character: "libai",
                messages: [
                    { type: "libai", text: "子美亦曾与我说过此言。酒后我曾挥毫写下'安得倚天抽宝剑，把汝裁为三截'，恨不能为天下除害。刘兄有此志向，虽贬犹荣！吾辈虽仗剑天涯、放浪形骸，但又岂能不忧国忧民乎！" }
                ],
                options: [
                    { 
                        text: "太白兄亦有忧国之心，令我敬佩！我们当以笔为剑，为正义发声", 
                        style: "du",
                        nextSegment: "libai_segment3c",
                        enlightenment: { practical: 3, artistic: 1 }
                    },
                    { 
                        text: "但太白兄毕竟更擅长超脱尘世，我当学习这种洒脱", 
                        style: "balanced",
                        nextSegment: "libai_segment3d",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "libai_segment2c": {
                character: "libai",
                messages: [
                    { type: "libai", text: "豪迈非学而得，乃天性使然。人生苦短，何不痛快淋漓？醉也好，醒也好，总要活个明白！'五花马，千金裘，呼儿将出换美酒'！钱财都是身外物，快乐才是真的。" }
                ],
                options: [
                    { 
                        text: "太白兄此言甚妙！人生在世，当求其真，当得其乐", 
                        style: "balanced",
                        nextSegment: "libai_segment3a",
                        enlightenment: { artistic: 2, emotional: 2 }
                    },
                    { 
                        text: "太白兄豪迈可嘉，但我仍觉读书人当有社会担当", 
                        style: "du",
                        nextSegment: "libai_segment3e",
                        enlightenment: { practical: 1 }
                    }
                ]
            },
            "libai_segment3a": {
                character: "libai",
                messages: [
                    { type: "libai", text: "正是此理！'黄河之水天上来，奔流到海不复回'，人生如此短暂，为何不痛饮一场？刘兄若能悟得此理，便是真正的诗人风范！" }
                ],
                options: [
                    { 
                        text: "感谢太白兄指点，我已领悟诗酒人生的真谛", 
                        style: "balanced",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "libai_segment3b": {
                character: "libai",
                messages: [
                    { type: "libai", text: "刘兄志存高远，这也是我所敬佩的。虽然我更爱自由自在，但'济苍生'之志，岂能轻易放下？各有所长，相得益彰。" }
                ],
                options: [
                    { 
                        text: "各有所志，殊途同归，太白兄言之有理", 
                        style: "balanced",
                        enlightenment: { artistic: 1, practical: 1 }
                    }
                ]
            },
            "libai_segment3c": {
                character: "libai",
                messages: [
                    { type: "libai", text: "好！刘兄有此心怀，我当以酒相敬！'愿将腰下剑，直为斩楼兰'，虽然我们不在战场，但笔墨同样可以杀敌！来，共饮此杯，为正义干杯！" }
                ],
                options: [
                    { 
                        text: "与太白兄共醉为正义，不亦快哉！", 
                        style: "du",
                        enlightenment: { practical: 2, emotional: 1 }
                    }
                ]
            },
            "libai_segment3d": {
                character: "libai",
                messages: [
                    { type: "libai", text: "哈哈！刘兄聪明！'仰天大笑出门去，我辈岂是蓬蒿人'，有时候超脱一点，反而能看得更清楚。快意恩仇，诗酒人生，岂不美哉？" }
                ],
                options: [
                    { 
                        text: "太白兄的人生哲学，令人向往", 
                        style: "balanced",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "libai_segment3e": {
                character: "libai",
                messages: [
                    { type: "libai", text: "刘兄说得也对。我虽然逍遥自在，但心中也有'安得倚天抽宝剑，把汝裁为三截'的豪情。自由与责任，并非对立，而是相辅相成。" }
                ],
                options: [
                    { 
                        text: "太白兄深刻，自由与责任确实可以并存", 
                        style: "balanced",
                        enlightenment: { artistic: 1, practical: 1 }
                    }
                ]
            },

            // 孔子完整出场展示（江边环境）
            "confucius_segment1": {
                environment: "1",
                segment: 1,
                character: "confucius",
                messages: [
                    { type: "narrator", text: "🌊📚👴" },
                    { type: "confucius", text: "刘君，闻君被贬至此，老夫特来相访。见君身处困境，仍不失君子之风，足见其德。" },
                    { type: "confucius", text: "德者，本也；财者，末也。外不由己，内则不可夺。刘君当修其内，而外物不足挂虑。" },
                    { type: "confucius", text: "昔日我欲居九夷，或人曰陋，我答'君子居之，何陋之有？'君子所居，德化四方，岂有陋哉？" },
                    { type: "confucius", text: "君子不以外物而移其志。刘君今日虽处逆境，然德馨名远，比那些富贵而品德败坏者，不知高明多少倍。" },
                    { type: "confucius", text: "我尝言'贫而无怨难，富而无骄易'。君子当在困厄中见心性，在富贵中见操守。刘君今日之境，正可试君子之德。" }
                ],
                options: [
                    { 
                        text: "夫子教诲，让我对'君子居之，何陋之有'有了新的理解。请夫子详细指点君子修身之道。", 
                        style: "ru",
                        nextSegment: "confucius_segment2a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "夫子，我仍有心系天下之念，如何在修身与济世之间求得平衡？", 
                        style: "balanced",
                        nextSegment: "confucius_segment2b",
                        enlightenment: { philosophical: 1, practical: 1 }
                    },
                    {
                        text: "夫子深恩，但弟子仍想在困境中为天下苍生尽一份力量。",
                        style: "du",
                        nextSegment: "confucius_segment2c",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "confucius_segment2a": {
                character: "confucius",
                messages: [
                    { type: "confucius", text: "君子不以外物而移其志。见刘君身处困境，仍不失君子之风，足见其德。" }
                ],
                options: [
                    { 
                        text: "夫子教诲，让我对'君子居之，何陋之有'有了新的理解", 
                        style: "ru",
                        nextSegment: "confucius_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "夫子，我仍有心系天下之念", 
                        style: "du",
                        nextSegment: "confucius_segment3b",
                        enlightenment: { practical: 1, philosophical: 1 }
                    }
                ]
            },
            "confucius_segment2b": {
                character: "confucius",
                messages: [
                    { type: "confucius", text: "德者，本也；财者，末也。外不由己，内则不可夺。刘君当修其内，而外物不足挂虑。" }
                ],
                options: [
                    { 
                        text: "夫子所言极是，德馨方能化陋为雅", 
                        style: "ru",
                        nextSegment: "confucius_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "弟子明白了，内心的修养才是根本", 
                        style: "ru",
                        nextSegment: "confucius_segment3a",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "confucius_segment3a": {
                character: "confucius",
                messages: [
                    { type: "confucius", text: "君子居之，何陋之有？刘君深明吾意。夫子之道，忠恕而已矣。居简而行简，志高而行远。" }
                ],
                options: [
                    { 
                        text: "感谢夫子指点，弟子受益匪浅", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },

            // 王维分段式对话（柳边环境）
            "wangwei_segment1": {
                environment: "2",
                segment: 1,
                character: "wangwei",
                messages: [
                    { type: "narrator", text: "🌿🍃💫" },
                    { type: "wangwei", text: "梦得居此柳边，可似我辋川别业？'行到水穷处，坐看云起时'，岂非妙境？" }
                ],
                options: [
                    { 
                        text: "摩诘诗中画，此处的确有'返景入深林'之境", 
                        style: "tao",
                        nextSegment: "wangwei_segment2a",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "虽美景如画，我仍念'万户伤心生野烟'的世事", 
                        style: "du",
                        nextSegment: "wangwei_segment2b",
                        enlightenment: { practical: 1 }
                    }
                ]
            },
            "wangwei_segment2a": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "善哉！'空山不见人，但闻人语响'，此乃静观之妙。山水者，天地之精华也。" }
                ],
                options: [
                    { 
                        text: "请摩诘指点，如何在此境中得禅悟？", 
                        style: "tao",
                        nextSegment: "wangwei_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "山水虽美，我心仍有尘世羁绊", 
                        style: "balanced",
                        nextSegment: "wangwei_segment3b",
                        enlightenment: { philosophical: 1, emotional: 1 }
                    }
                ]
            },
            "wangwei_segment2b": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "昔年安史乱起，我亦陷贼，作《凝碧诗》明志。'万户伤心生野烟'，此痛刻骨，终化'明月来相照'之空明。" }
                ],
                options: [
                    { 
                        text: "摩诘经历国难而得禅机，可为我师", 
                        style: "tao",
                        nextSegment: "wangwei_segment3c",
                        enlightenment: { philosophical: 2, emotional: 2 }
                    },
                    { 
                        text: "先生能化痛为悟，我却仍难释怀", 
                        style: "du",
                        nextSegment: "wangwei_segment3d",
                        enlightenment: { practical: 1 }
                    }
                ]
            },
            "wangwei_segment3a": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "观此青苔翠竹，皆是本来面目。'一花一世界，一叶一菩提'，境由心转，梦得当以心观心。" }
                ],
                options: [
                    { 
                        text: "感谢摩诘指点迷津，我已有所悟", 
                        style: "tao",
                        enlightenment: { philosophical: 3 }
                    }
                ]
            },
            "wangwei_segment3b": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "情理之中。'红豆生南国，春来发几枝'，人间有情，亦是修行路。" }
                ],
                options: [
                    { 
                        text: "摩诘通人情，又得禅机，真乃大智慧", 
                        style: "balanced",
                        enlightenment: { philosophical: 2, emotional: 1 }
                    }
                ]
            },
            "wangwei_segment3c": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "君之困厄，亦菩提种也。'山中一夜雨，树杪百重泉'，当是清心之句。" }
                ],
                options: [
                    { 
                        text: "困厄为菩提种，此言甚妙", 
                        style: "tao",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "wangwei_segment3d": {
                character: "wangwei",
                messages: [
                    { type: "wangwei", text: "各有因缘。我住山林，君居陋室，同是清修地。" }
                ],
                options: [
                    { 
                        text: "摩诘所言有理，陋室亦是清修地", 
                        style: "balanced",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },

            // 颜回分段式对话（江边环境）
            "yanhuei_segment1": {
                environment: "1",
                segment: 1,
                character: "yanhuei",
                messages: [
                    { type: "narrator", text: "🌊📚👴" },
                    { type: "yanhuei", text: "刘君，回居陋巷，一箪食一瓢饮，人不堪其忧，回不改其乐。观君今居江边，颇似回当年在陋巷的景象。" }
                ],
                options: [
                    { 
                        text: "颜子安贫乐道，令人敬佩。请指点我如何在困境中不改其乐？", 
                        style: "ru",
                        nextSegment: "yanhuei_segment2a",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "颜子虽贫而乐，我却仍有未竟之志", 
                        style: "du",
                        nextSegment: "yanhuei_segment2b",
                        enlightenment: { practical: 1 }
                    },
                    {
                        text: "颜子与夫子师生情深，令人感动。我也希望能得到这样的智慧传承。",
                        style: "ru",
                        nextSegment: "yanhuei_segment2c",
                        enlightenment: { philosophical: 1, emotional: 1 }
                    }
                ]
            },
            "yanhuei_segment2a": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "回之所乐，在闻夫子之道。'学而时习之，不亦说乎？'外物不足挂虑，内心充实方为真乐。" }
                ],
                options: [
                    { 
                        text: "颜子以学为乐，我当效法", 
                        style: "ru",
                        nextSegment: "yanhuei_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "学道固然重要，但世事仍需关怀", 
                        style: "balanced",
                        nextSegment: "yanhuei_segment3b",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "yanhuei_segment2b": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "回亦有志。夫子问志，回答：'愿无伐善，无施劳。'内修身心，外无争竞，此亦一志也。" }
                ],
                options: [
                    { 
                        text: "颜子之志在于修身，不求外誉，确是高志", 
                        style: "ru",
                        nextSegment: "yanhuei_segment3c",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "各有所志，我志在经世济民", 
                        style: "du",
                        nextSegment: "yanhuei_segment3d",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "yanhuei_segment3a": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "善哉！'德馨'如兰在谷，不以无人而不芳。刘君能悟此理，陋室即是学堂。" }
                ],
                options: [
                    { 
                        text: "感谢颜子教诲，我明白了德馨的真谛", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "yanhuei_segment3b": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "夫子亦教导'修己以安人'。内圣外王，相得益彰。" }
                ],
                options: [
                    { 
                        text: "内圣外王，这正是我追求的境界", 
                        style: "balanced",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "yanhuei_segment3c": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "'不迁怒，不贰过'，此回平生所守。志在内修，不求人知。" }
                ],
                options: [
                    { 
                        text: "颜子修养功夫深厚，我当学习", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "yanhuei_segment3d": {
                character: "yanhuei",
                messages: [
                    { type: "yanhuei", text: "君志可嘉。回虽不敏，亦钦佩君之胸怀。" }
                ],
                options: [
                    { 
                        text: "颜子过谦了，各有所志，同为圣道", 
                        style: "balanced",
                        enlightenment: { emotional: 1, practical: 1 }
                    }
                ]
            },

            // 苏轼分段式对话（斗室环境）
            "sushi_segment1": {
                environment: "3",
                segment: 1,
                character: "sushi",
                messages: [
                    { type: "narrator", text: "🛏️🌊📝" },
                    { type: "sushi", text: "刘兄，这斗室虽小，倒让我想起当年黄州谪居。'庭下如积水空明'，你瞧这光影交错，岂不美哉？" }
                ],
                options: [
                    { 
                        text: "东坡先生豁达，能在任何境遇中自得其乐", 
                        style: "balanced",
                        nextSegment: "sushi_segment2a",
                        enlightenment: { artistic: 2 }
                    },
                    { 
                        text: "先生虽历经三贬，却仍心系苍生，令人敬佩", 
                        style: "du",
                        nextSegment: "sushi_segment2b",
                        enlightenment: { practical: 1, artistic: 1 }
                    }
                ]
            },
            "sushi_segment2a": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "刘兄过誉了。我平生经历大大小小挫折无数，却也因此看透了人生百态。'横看成岭侧成峰，远近高低各不同'，处境虽难，换个角度看，又是另一番景象。" }
                ],
                options: [
                    { 
                        text: "'回首向来萧瑟处，归去，也无风雨也无晴'，先生此境界令人向往", 
                        style: "balanced",
                        nextSegment: "sushi_segment3a",
                        enlightenment: { philosophical: 2, artistic: 2 }
                    },
                    { 
                        text: "先生能化逆境为诗意，确是大智慧", 
                        style: "balanced",
                        nextSegment: "sushi_segment3b",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "sushi_segment2b": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "我平生最痛恨那等道貌岸然之徒，口谈仁义而暗施刑狱。天下百姓疾苦，身为读书人，岂能视而不见？" }
                ],
                options: [
                    { 
                        text: "东坡先生说得对！读书人当以天下为己任", 
                        style: "du",
                        nextSegment: "sushi_segment3c",
                        enlightenment: { practical: 3 }
                    },
                    { 
                        text: "先生能在贬谪中仍思百姓，胸怀可敬", 
                        style: "balanced",
                        nextSegment: "sushi_segment3d",
                        enlightenment: { practical: 1, emotional: 1 }
                    }
                ]
            },
            "sushi_segment3a": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "此乃禅机，不是消极，而是超越物我、荣辱、悲欢。刘兄若悟此理，区区贬谪，何足挂齿？人生如寄，何不一笑了之。" }
                ],
                options: [
                    { 
                        text: "感谢东坡先生指点，我已豁然开朗", 
                        style: "balanced",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "sushi_segment3b": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "我平生所历坎坷，皆成就了我的文章。刘兄若能在斗室中著成佳作，他日传颂千古，岂不快哉？" }
                ],
                options: [
                    { 
                        text: "东坡先生此言甚妙，逆境反成创作良机", 
                        style: "balanced",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "sushi_segment3c": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "好！刘兄有此心怀，他日必成大器！不过今日天色渐暗，不如我们先痛饮几杯如何？人生能有几回搏？" }
                ],
                options: [
                    { 
                        text: "与东坡先生把酒言欢，不亦快哉", 
                        style: "balanced",
                        enlightenment: { emotional: 2 }
                    }
                ]
            },
            "sushi_segment3d": {
                character: "sushi",
                messages: [
                    { type: "sushi", text: "各有所思，相得益彰。我们何不在这斗室中谈古论今，共度良宵？" }
                ],
                options: [
                    { 
                        text: "正合我意，先生见识广博，愿向先生求教", 
                        style: "balanced",
                        enlightenment: { artistic: 1, emotional: 1 }
                    }
                ]
            },

            // 李清照分段式对话（柳边环境）
            "liqingzhao_segment1": {
                environment: "2",
                segment: 1,
                character: "liqingzhao",
                messages: [
                    { type: "narrator", text: "🌿🌸📝" },
                    { type: "liqingzhao", text: "刘兄，小女子李清照，冒昧来访。这柳边环境倒是清幽，与我早年在青州居住时相似。" }
                ],
                options: [
                    { 
                        text: "易安居士大驾光临，蓬荜生辉。请问易安对此处有何感想？", 
                        style: "ru",
                        nextSegment: "liqingzhao_segment2a",
                        enlightenment: { emotional: 1 }
                    },
                    { 
                        text: "闻夫人'生当作人杰，死亦为鬼雄'，不让须眉，令人敬佩", 
                        style: "du",
                        nextSegment: "liqingzhao_segment2b",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "liqingzhao_segment2a": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "你看这垂柳依依，春风拂面，倒让我想起从前词作：'乍暖还寒时候，最难将息。'时节变幻，人事亦然。" }
                ],
                options: [
                    { 
                        text: "易安词作婉约，'寻寻觅觅，冷冷清清'道尽离愁", 
                        style: "balanced",
                        nextSegment: "liqingzhao_segment3a",
                        enlightenment: { artistic: 2, emotional: 1 }
                    },
                    { 
                        text: "夫人深通音律，'知否，知否？应是绿肥红瘦'令人称绝", 
                        style: "balanced",
                        nextSegment: "liqingzhao_segment3b",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "liqingzhao_segment2b": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "刘兄过奖了。我不过一弱女子，只是性情刚烈，不愿向命运低头罢了。当年在临安，我曾大骂南宋朝廷苟且偷安，贪生怕死。" }
                ],
                options: [
                    { 
                        text: "夫人虽历经国破家亡，却能刚强自立，令人敬佩", 
                        style: "du",
                        nextSegment: "liqingzhao_segment3c",
                        enlightenment: { practical: 2, emotional: 1 }
                    },
                    { 
                        text: "易安此志气，胜过多少须眉男儿", 
                        style: "du",
                        nextSegment: "liqingzhao_segment3d",
                        enlightenment: { practical: 1, emotional: 2 }
                    }
                ]
            },
            "liqingzhao_segment3a": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "昔年灵均《离骚》云'已矣哉，国无人莫我知兮'。我本不欲为离愁别绪所扰，奈何国破家亡，词调自然婉转哀伤。" }
                ],
                options: [
                    { 
                        text: "易安词中情思深切，令人动容", 
                        style: "balanced",
                        enlightenment: { emotional: 2 }
                    }
                ]
            },
            "liqingzhao_segment3b": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "在我看来，词要协音律，更要传心音。'只恐双溪舴艋舟，载不动，许多愁'，此乃肺腑之言。" }
                ],
                options: [
                    { 
                        text: "夫人以愁重如山，舟不能载，想象奇绝", 
                        style: "balanced",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "liqingzhao_segment3c": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "亡国之痛，家破之恨，时时萦绕于心。我虽为弱女子，却不愿低头认命。纵然终身漂泊，也要保持气节。" }
                ],
                options: [
                    { 
                        text: "易安此言，正是对您最大的敬意", 
                        style: "du",
                        enlightenment: { emotional: 2 }
                    }
                ]
            },
            "liqingzhao_segment3d": {
                character: "liqingzhao",
                messages: [
                    { type: "liqingzhao", text: "如今虽客居他乡，犹思有朝一日，能手刃仇敌，重整河山。纵然此生不能如愿，也要将此志传于后世。" }
                ],
                options: [
                    { 
                        text: "易安胸怀大志，令人钦佩不已", 
                        style: "du",
                        enlightenment: { practical: 1, emotional: 1 }
                    }
                ]
            },

            // 曾子分段式对话（江边环境）
            "zengzi_segment1": {
                environment: "1",
                segment: 1,
                character: "zengzi",
                messages: [
                    { type: "narrator", text: "🌊📜👴" },
                    { type: "zengzi", text: "刘君，参闻君被贬至此江边，特来相访。虽环境简陋，然君子当有'士不可以不弘毅，任重而道远'之志。" }
                ],
                options: [
                    { 
                        text: "拜见曾夫子！弟子正思如何在逆境中坚守本心。", 
                        style: "ru",
                        nextSegment: "zengzi_segment2a",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "曾子'吾日三省吾身'的修养功夫，弟子深感敬佩。", 
                        style: "ru",
                        nextSegment: "zengzi_segment2b",
                        enlightenment: { philosophical: 1 }
                    },
                    {
                        text: "夫子所言'任重而道远'，正是弟子当下所需的品格。",
                        style: "ru",
                        nextSegment: "zengzi_segment2c",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "zengzi_segment2a": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "善哉问也！参以为，君子之道在于内省。'吾日三省吾身：为人谋而不忠乎？与朋友交而不信乎？传不习乎？'" }
                ],
                options: [
                    { 
                        text: "三省之道，确是修身之本。请曾子详细指点", 
                        style: "ru",
                        nextSegment: "zengzi_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "曾子所言甚是，但我仍有经世济民之念", 
                        style: "balanced",
                        nextSegment: "zengzi_segment3b",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "zengzi_segment2b": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "参之愚见，不敢当夫子之誉。然修身之道，确需日日反省。孔门弟子中，回也好学，参也愚钝，然皆不敢懈怠。" }
                ],
                options: [
                    { 
                        text: "曾子过谦了，您传承孔门大道，功德无量", 
                        style: "ru",
                        nextSegment: "zengzi_segment3c",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "颜回、曾子皆是圣门高弟，各有所长", 
                        style: "ru",
                        nextSegment: "zengzi_segment3d",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "zengzi_segment3a": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "修身之道，贵在恒常。一日之内，当问心三次：所为是否忠诚？所交是否信实？所学是否践行？如此日积月累，德行自成。" }
                ],
                options: [
                    { 
                        text: "感谢曾子教诲，弟子当日日三省", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "zengzi_segment3b": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "修身与济世，本不相违。《大学》有云：'修身、齐家、治国、平天下'，修身乃齐家治国之本。君若能在斗室中修得内圣，他日自能外王。" }
                ],
                options: [
                    { 
                        text: "曾子所言极是，内圣外王，相辅相成", 
                        style: "ru",
                        enlightenment: { philosophical: 2, practical: 1 }
                    }
                ]
            },
            "zengzi_segment3c": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "参不敢居功。孔门之道，传于后世，乃众弟子共同努力。参只是略尽绵薄，传承师训而已。" }
                ],
                options: [
                    { 
                        text: "曾子谦逊，正是君子风范", 
                        style: "ru",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "zengzi_segment3d": {
                character: "zengzi",
                messages: [
                    { type: "zengzi", text: "回也好学，德行高洁；参也愚钝，然识大体。孔门弟子，各尽其能，同传师道。刘君亦当如是，发挥己长，不负所学。" }
                ],
                options: [
                    { 
                        text: "多谢曾子勉励，我当努力不负所学", 
                        style: "ru",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },

            // 杨雄分段式对话（斗室环境）
            "yangxiong_segment1": {
                environment: "3",
                segment: 1,
                character: "yangxiong",
                messages: [
                    { type: "narrator", text: "🛏️🧐📚" },
                    { type: "yangxiong", text: "刘君，雄观君居此斗室，颇有古贤之风。昔年我在草亭中著《法言》，虽处僻静，却能著述立言。" }
                ],
                options: [
                    { 
                        text: "杨子《法言》传世，可为后学楷模。请问如何在简陋中成大业？", 
                        style: "ru",
                        nextSegment: "yangxiong_segment2a",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "杨子深得圣贤之道，令人景仰", 
                        style: "ru",
                        nextSegment: "yangxiong_segment2b",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "yangxiong_segment2a": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "雄以为，环境简陋不足惧，心志不坚方可忧。'金经'者，圣贤之书也。君若能专心经典，虽居陋室，亦如置身圣殿。" }
                ],
                options: [
                    { 
                        text: "杨子所言极是，圣贤之书胜过华屋千间", 
                        style: "ru",
                        nextSegment: "yangxiong_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "经典虽重要，但经世致用亦不可忘", 
                        style: "balanced",
                        nextSegment: "yangxiong_segment3b",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "yangxiong_segment2b": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "雄不敢当。我著《法言》，不过是学习孔孟，略述己见。'学者，所以修性也。'读书明理，修身正己，此乃根本。" }
                ],
                options: [
                    { 
                        text: "杨子谦逊，《法言》确有大智慧", 
                        style: "ru",
                        nextSegment: "yangxiong_segment3c",
                        enlightenment: { philosophical: 2 }
                    },
                    { 
                        text: "修性固然重要，但如何将所学用于世间？", 
                        style: "balanced",
                        nextSegment: "yangxiong_segment3d",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },
            "yangxiong_segment3a": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "善哉！君能悟此理，真可谓得圣贤真传。梦得能以琴书为伴，真君子之乐也。陋室虽简，可成大业！" }
                ],
                options: [
                    { 
                        text: "感谢杨子指点，我明白了圣贤之道", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "yangxiong_segment3b": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "君言有理。然雄以为，修身为本，致用为末。内无所修，外何所用？君若能在此斗室中正心诚意，他日必能格物致知。" }
                ],
                options: [
                    { 
                        text: "杨子教诲深刻，修身确是根本", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "yangxiong_segment3c": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "《法言》不过述而不作，学习先圣而已。君今居陋室而心不陋，正是圣贤之道的体现。" }
                ],
                options: [
                    { 
                        text: "杨子过谦，《法言》确有独到见解", 
                        style: "ru",
                        enlightenment: { philosophical: 1 }
                    }
                ]
            },
            "yangxiong_segment3d": {
                character: "yangxiong",
                messages: [
                    { type: "yangxiong", text: "学而时习之，温故而知新。所学之道，当先用于修身，修身成则自能齐家，齐家成则自能治国。循序渐进，方为正道。" }
                ],
                options: [
                    { 
                        text: "杨子指出了修身齐家治国的次第，令人受益", 
                        style: "ru",
                        enlightenment: { philosophical: 1, practical: 1 }
                    }
                ]
            },

            // 诸葛亮分段式对话（柳边环境）
            "zhugeliang_segment1": {
                environment: "2",
                segment: 1,
                character: "zhugeliang",
                messages: [
                    { type: "narrator", text: "🌿🪶📜" },
                    { type: "zhugeliang", text: "梦得兄，亮观县令三迁君宅，恰似'以退为进'之局。梦得可效空城计——素琴一曲退千军。" }
                ],
                options: [
                    { 
                        text: "孔明先生智谋无双，请教如何在此境中自处？", 
                        style: "ru",
                        nextSegment: "zhugeliang_segment2a",
                        enlightenment: { practical: 2 }
                    },
                    { 
                        text: "先生'鞠躬尽瘁，死而后已'，令我敬佩。我也当效法，心系国事", 
                        style: "du",
                        nextSegment: "zhugeliang_segment2b",
                        enlightenment: { practical: 2, emotional: 1 }
                    }
                ]
            },
            "zhugeliang_segment2a": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "亮以为，县令之计虽巧，然君子之道不可夺。昔日蜀中多难，亮每以'非淡泊无以明志，非宁静无以致远'自勉。" }
                ],
                options: [
                    { 
                        text: "先生'非淡泊无以明志'的智慧，可为我师", 
                        style: "ru",
                        nextSegment: "zhugeliang_segment3a",
                        enlightenment: { philosophical: 3 }
                    },
                    { 
                        text: "淡泊宁静虽好，但我仍有报国之志", 
                        style: "du",
                        nextSegment: "zhugeliang_segment3b",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "zhugeliang_segment2b": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "梦得兄有此心，甚慰我怀。亮虽身居隆中，然心忧天下。'受任于败军之际，奉命于危难之间'，此乃臣子本分。" }
                ],
                options: [
                    { 
                        text: "先生忠心可鉴，我当效法先生忠君报国", 
                        style: "du",
                        nextSegment: "zhugeliang_segment3c",
                        enlightenment: { practical: 3, emotional: 1 }
                    },
                    { 
                        text: "先生胸怀天下，我深感敬佩", 
                        style: "balanced",
                        nextSegment: "zhugeliang_segment3d",
                        enlightenment: { practical: 1, emotional: 1 }
                    }
                ]
            },
            "zhugeliang_segment3a": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "善哉！宁静之心，可御百万刁难。君子修身养性，待时而动，此乃大智慧。梦得若能在此柳边悟得此理，他日必成大器。" }
                ],
                options: [
                    { 
                        text: "感谢孔明先生指点，我已明白修身养性的重要", 
                        style: "ru",
                        enlightenment: { philosophical: 2 }
                    }
                ]
            },
            "zhugeliang_segment3b": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "报国之志可嘉。然君子当知进退，蛰伏待时，方为上策。今日之隐忍，乃为他日之大用。" }
                ],
                options: [
                    { 
                        text: "孔明先生所言极是，蛰伏待时，方为上策", 
                        style: "ru",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "zhugeliang_segment3c": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "忠君报国，乃读书人本分。然梦得当知，忠不在于位高权重，而在于心存社稷。居庙堂与处江湖，皆可尽忠。" }
                ],
                options: [
                    { 
                        text: "先生教诲深刻，居庙堂与处江湖，皆可尽忠", 
                        style: "du",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "zhugeliang_segment3d": {
                character: "zhugeliang",
                messages: [
                    { type: "zhugeliang", text: "梦得兄过誉了。亮不过是个山野村夫，蒙主公知遇，方有今日。愿与梦得共勉，为国为民，尽心尽力。" }
                ],
                options: [
                    { 
                        text: "与孔明先生共勉，为国为民，尽心尽力", 
                        style: "balanced",
                        enlightenment: { practical: 1, emotional: 1 }
                    }
                ]
            },

            // 白居易分段式对话（江边环境）
            "baijuyi_segment1": {
                environment: "1",
                segment: 1,
                character: "baijuyi",
                messages: [
                    { type: "narrator", text: "🌊⛵🎵" },
                    { type: "baijuyi", text: "同是天涯沦落人，相逢何必曾相识！梦得兄，观此大江，可似吾浔阳秋荻？" }
                ],
                options: [
                    { 
                        text: "乐天兄，同是贬谪人，深感'同是天涯沦落人'之慨", 
                        style: "balanced",
                        nextSegment: "baijuyi_segment2a",
                        enlightenment: { emotional: 2 }
                    },
                    { 
                        text: "乐天《琵琶行》血泪文章，令人动容。我等当以笔墨记录时代", 
                        style: "du",
                        nextSegment: "baijuyi_segment2b",
                        enlightenment: { practical: 2, artistic: 1 }
                    }
                ]
            },
            "baijuyi_segment2a": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "梦得兄知我心！我当年贬江州司马时，常在江边听琵琶声，写下'座中泣下谁最多，江州司马青衫湿'。今见梦得被贬，深感同病相怜。" }
                ],
                options: [
                    { 
                        text: "乐天兄'青衫湿'三字，道尽天涯沦落之感", 
                        style: "balanced",
                        nextSegment: "baijuyi_segment3a",
                        enlightenment: { emotional: 2, artistic: 1 }
                    },
                    { 
                        text: "同遭贬谪，反成创作良机，此为不幸中之大幸", 
                        style: "balanced",
                        nextSegment: "baijuyi_segment3b",
                        enlightenment: { artistic: 2 }
                    }
                ]
            },
            "baijuyi_segment2b": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "正是此意！我写《琵琶行》，不仅写琵琶女之苦，更写天下沦落人之悲。'朱门酒肉臭，路有冻死骨'，此等现实，岂能视而不见？" }
                ],
                options: [
                    { 
                        text: "乐天兄深得'文章合为时而著，歌诗合为事而作'的真谛", 
                        style: "du",
                        nextSegment: "baijuyi_segment3c",
                        enlightenment: { practical: 3 }
                    },
                    { 
                        text: "乐天兄文章既美又有深意，令人敬佩", 
                        style: "balanced",
                        nextSegment: "baijuyi_segment3d",
                        enlightenment: { artistic: 2, practical: 1 }
                    }
                ]
            },
            "baijuyi_segment3a": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "'青衫湿'者，不仅为琵琶女而泣，更为天下沦落人而悲。梦得兄能解其意，真乃知音。" }
                ],
                options: [
                    { 
                        text: "感谢乐天兄指点，我明白了文章的真谛", 
                        style: "balanced",
                        enlightenment: { emotional: 1 }
                    }
                ]
            },
            "baijuyi_segment3b": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "梦得兄所言极是。我有'春江花朝秋月夜'，君得'草色入帘青'——各占天地一绝！贬谪之地，反成创作佳境。" }
                ],
                options: [
                    { 
                        text: "乐天兄此言甚妙，贬谪之地反成创作佳境", 
                        style: "balanced",
                        enlightenment: { artistic: 1 }
                    }
                ]
            },
            "baijuyi_segment3c": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "文章千古事，得失寸心知。我等虽遭贬谪，然笔下文章，当为民生立言，为时代发声。此乃文人本分。" }
                ],
                options: [
                    { 
                        text: "乐天兄所言极是，文章当为民生立言", 
                        style: "du",
                        enlightenment: { practical: 2 }
                    }
                ]
            },
            "baijuyi_segment3d": {
                character: "baijuyi",
                messages: [
                    { type: "baijuyi", text: "梦得兄过誉了。我只是将所见所感，用平实的语言写出来。'老妪能解'，才是真正的好文章。" }
                ],
                options: [
                    { 
                        text: "乐天兄'老妪能解'的追求，令人钦佩", 
                        style: "balanced",
                        enlightenment: { artistic: 1 }
                    }
                ]
            },

            // 李白插话系统
            "libai_insert_garden": {
                character: "libai",
                messages: [
                    { type: "libai", text: "五柳先生又劝人归隐？梦得兄莫听！当效我'我本楚狂人，凤歌笑孔丘'！" }
                ],
                options: [
                    { 
                        text: "与陶渊明继续深谈", 
                        nextSegment: "tao_segment3a",
                        enlightenment: { philosophical: 1 }
                    },
                    { 
                        text: "回应李白的观点", 
                        nextSegment: "libai_segment1",
                        enlightenment: { artistic: 2 }
                    },
                    { 
                        text: "让大家都说说看法", 
                        nextSegment: "group_discussion_hideaway",
                        enlightenment: { emotional: 2, practical: 1 }
                    }
                ]
            }
        };

        // 群聊事件触发系统
        const groupChatTriggers = {
            hideaway_discussion: ["tao", "wangwei", "libai"],
            patriotic_discussion: ["du", "zhugeliang", "baijuyi"],
            confucian_discussion: ["confucius", "yanhuei", "zengzi"]
        };

        // 容错系统
        const fallbackResponses = {
            "tao": [
                "梦得言之有理，各有所思，各有所悟。",
                "君之见解，亦有深意，吾当细思。",
                "哈哈，刘兄妙语，让我想起当年..."
            ],
            "du": [
                "子美深感刘兄之言，虽见解不同，然君子和而不同。",
                "梦得此言，让我想起另一角度..."
            ],
            "libai": [
                "哈哈！梦得兄妙语连珠，不愧是诗人本色！",
                "此言有趣，让我想起一段往事..."
            ],
            "confucius": [
                "君子和而不同，刘君此言，亦有道理。",
                "各有所见，方为大道之美。"
            ]
        };

        // 人物对话内容库（完整的出场展示→问答互动）
        const characterDialogues = {
            // 陶渊明 - 隐逸闲适的代表
            "tao": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊🌿🍷" },
                            { type: "tao", text: "刘兄，我陶渊明特来看望。见你被县令如此刁难，让我想起自己当年的遭遇..." },
                            { type: "tao", text: "我也曾在彭泽做县令，只做了八十多天就辞官而去。那时有督邮来检查，下属说要束带接见，我说'我岂能为五斗米向乡里小儿折腰！'" },
                            { type: "tao", text: "辞官归田后，日日耕种锄草，身体反倒硬朗了许多。每日在东篱下种菊，傍晚举首望见南山轮廓，心旷神怡。有闲暇便写些文字，或携壶浊酒独酌，与田园为伴，倒也惬意。" },
                            { type: "tao", text: "记得归田后的第一年冬天，家中断粮，我骑牛入城，沿街乞食，也不觉得羞耻。邻居们起初都笑我傻，三四年后见我怡然自得，也都羡慕起来。" },
                            { type: "tao", text: "如今我种的菊花，十里八乡无人不知。'采菊东篱下，悠然见南山'，这南山不在远方，在心中。刘兄今日处境，正如我当年，莫要被外物所困。" }
                        ],
                        options: [
                            { 
                                text: "请教先生如何在困境中保持内心平静", 
                                style: "tao",
                                response: "心远地自偏，境由心转。外在困厄不过是皮相，内心充实方为根本。你看那东篱菊花，霜打之后反而更香。逆境如炼金之火，真金不怕红炉火。"
                            },
                            { 
                                text: "想了解先生田园生活的更多细节", 
                                style: "tao",
                                response: "田园之乐在于顺应自然。春种秋收，夏耕冬藏，日出而作，日落而息，此乃天地之常道。'种豆南山下，草盛豆苗稀。晨兴理荒秽，带月荷锄归。'简朴生活，内心丰富。"
                            },
                            { 
                                text: "先生当年辞官后有没有后悔过？", 
                                style: "balanced",
                                response: "悔乎？不悔也。官场如樊笼，归田得自由。虽贫而乐，胜富而忧。'归去来兮！田园将芜胡不归？'外在的改变不过是表象，心中的桃花源才是永恒。"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🍃🐝" },
                            { type: "tao", text: "刘兄，又见面了。这柳边环境比江边更清幽了。看这垂柳依依，流水潺潺，仿佛使人回到我的南村旧居。" },
                            { type: "tao", text: "最初归田时，邻居们都笑我傻，三四年后眼见我怡然自得，也都羡慕起来。世间最难得者，不过一片清净心。" },
                            { type: "tao", text: "我常念着'大道泰然，逍遥自适'。你看这水边垂柳，且行且止，又何必为世俗所困？" }
                        ],
                        options: [
                            { 
                                text: "先生将隐居之情寄托于田园农事，也有'悠然见南山'的闲情逸致，确是明智之举。", 
                                style: "tao",
                                response: "人生在世，能归真返璞，本色而行，实为大幸。我不过顺应天性，刘兄若也喜静，何不来我南村小住，看看那春去夏来的田园气象？"
                            },
                            { 
                                text: "渊明先生，您的'采菊东篱下'尚有几分出世之念，我却想在此境中仍保'先天下之忧而忧'之心。", 
                                style: "du",
                                response: "家国之忧，自古文人皆有之。只是我陋巷安贫，已无力回天。刘兄壮志不摧，确是难得。我思念旧友王弘、殷览诸人，也常有泪落杯中时。"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️🕯️📖" },
                            { type: "tao", text: "刘兄，县令将你安置在这斗室之中，想必是要断绝你与外界联系，不知你是否觉得闷苦？" },
                            { type: "tao", text: "我当年辞官归隐后的环境，也不过陋室数间，妻子耕种，儿女环绕。但我常觉知足，时有'停云'、'猗兰'、'桃花源'等文字出于笔端。" },
                            { type: "tao", text: "说来也怪，若非当年我辞官归田，哪有闲情去寻那世外桃源？清茶一杯，明月一轮，心远地自偏，又何须顾念县令作态？" }
                        ],
                        options: [
                            { 
                                text: "先生所言极是。我在这斗室之中，仿佛看到了'桃花源'中的景象，心境澄明如许。", 
                                style: "tao",
                                response: "种豆南山下，草盛豆苗稀。晨兴理荒秽，带月荷锄归。刘兄若能在此斗室有所悟得，他日必能超然物外，写下传世之作。"
                            },
                            { 
                                text: "先生心境豁达，我却时常思念朝堂国事。这'小隐隐陵薮，大隐隐朝市'，各有其道吧？", 
                                style: "du",
                                response: "此言甚是。世有伯夷叔齐，世亦有孔孟周公。山林与朝市，殊途而同归。刘兄心系天下，非我所能及也。归隐亦好，入世亦可，但求无愧于心足矣。"
                            }
                        ]
                    }
                ]
            },
            // 杜甫 - 忧国忧民的诗圣
            "du": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊🌧️📝" },
                            { type: "du", text: "刘兄，子美见礼。闻君被贬，特来相访。见你身在江边，我不禁想起自己的经历。" },
                            { type: "du", text: "我生逢乱世，亲历安史之乱。'国破山河在，城春草木深'，眼见百姓流离失所，朝野腐败，心中郁结难消啊。" },
                            { type: "du", text: "我曾流落夔州，住过破旧茅屋，'床头屋漏无干处，雨脚如麻未断绝'，挑灯夜战，只为记录这乱世中的点滴。最艰难时，我带着病妻幼子逃难，'朝行水草边，暮宿山木下'，亲眼目睹民间疾苦。" },
                            { type: "du", text: "但我始终相信，'会当凌绝顶，一览众山小'。身处逆境，更应保持初心。虽说一介书生，难挽天下大势，但'位卑未敢忘忧国'，也是我辈读书人的气节啊！" },
                            { type: "du", text: "彼县令之流，徒知奉承权贵，殊不知'朱门酒肉臭，路有冻死骨'的悲剧何时方休？刘兄，我们虽身微言轻，然一支笔，胜千军万马。" }
                        ],
                        options: [
                            { 
                                text: "子美所言极是！虽遭贬谪，我仍心系朝堂，只是力不从心，难以施展抱负。", 
                                style: "du",
                                response: "吾每见朝政日非，辄夜不能寐。刘兄有此心怀，他日必成大器。天下兴亡，匹夫有责，我等虽力微言轻，然笔墨千秋，或可感天地，泣鬼神。此身虽陋，此心当雄！"
                            },
                            { 
                                text: "子美历经磨难仍心系苍生，我深感敬佩。在这乱世中，个人的力量真的有用吗？", 
                                style: "du",
                                response: "滴水虽微，汇成江海；个人虽渺，可化民风。不以善小而不为，积小成大，终可成事。苦难是磨刀石，越磨越锋利。我之诗句，皆从苦难中来，为苍生而作。"
                            },
                            { 
                                text: "子美忧国忧民，令人敬佩。只是我渐觉随遇而安的好处，何必过度忧思？", 
                                style: "tao",
                                response: "刘兄此言，恰如太白之性情。我们曾同游梁宋，把酒言欢，他总笑我忧国忧民，过度劳神。然'安得广厦千万间，大庇天下寒士俱欢颜'之愿，乃我毕生所求。"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🐸🌙" },
                            { type: "du", text: "朱门竟折君子庭柳！梦得当书'新松恨不高千尺'以砭时弊！这柳边小屋虽简陋，但若能保持心志，继续为民发声，也算是不负此生了。" },
                            { type: "du", text: "刘兄你看这柳色依依，风轻云淡，表面宁静，却不知多少百姓在苦难中挣扎。'长太息以掩涕兮，哀民生之多艰'啊！" },
                            { type: "du", text: "天地之大，竟容不下我等直言之士！你之被贬，不正与我当年'读书破万卷，下笔如有神'后，仍郁郁不得志相似？" }
                        ],
                        options: [
                            { 
                                text: "子美所言极是。我认为'居庙堂之高，则忧其民；处江湖之远，则忧其君'，无论境遇如何，心系苍生是我辈本分。", 
                                style: "du",
                                response: "刘兄此言，让我想起范仲淹'先天下之忧而忧，后天下之乐而乐'之句。虽我身处乱世，不能为百姓谋福祉，但笔下诗篇，记录了这纷乱世间的苦痛与希望。愿刘兄与我同行此路，以笔墨鸣不平！"
                            },
                            { 
                                text: "子美忧心忡忡，我却渐觉随遇而安的好处。'自在飞花轻似梦，无边丝雨细如愁'，此境亦有闲适可寻。", 
                                style: "tao",
                                response: "刘兄志趣，倒与太白相近。记得他常劝我'人生在世不称意，明朝散发弄扁舟'。或许你们看得更透彻，只是我见惯战乱颠沛，目睹民生凋敝，实在无法置身事外。"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️⚡📚" },
                            { type: "du", text: "刘兄，听闻你又搬至这'斗室'，不禁让我想起自己的遭遇。'穷年忧黎元，伥伥如丧家'，我们文人墨客，大多有这样的经历。" },
                            { type: "du", text: "我曾居住在成都浣花溪旁的草堂，'万里桥西宅，百花潭北庄'，虽然简陋，却也自得其乐。可惜好景不长，又被战乱所迫，不得不继续漂泊。" },
                            { type: "du", text: "'三年饥走荒山道，病渴不逢寒水泉'，我经历过的苦难比你多得多。但即便如此，我仍不忘记录这个时代的悲欢离合，希望能为后世留下真实的记录。" }
                        ],
                        options: [
                            { 
                                text: "子美所言，句句入心！我虽被贬居斗室，然心怀天下，实则广厦万间。终有一日，要'为天地立心，为生民立命'！", 
                                style: "du",
                                response: "刘兄此言，堪称千古名句！我常自哀'致君尧舜上，再使风俗淳'之志难酬，然见刘兄志向不改，甚感欣慰。无论身处何地，只要心系苍生，则一方斗室，亦可怀四海。"
                            },
                            { 
                                text: "见子美历经磨难仍心系苍生，我深感敬佩。但斗室清幽，倒也契合'晓看红湿处，花重锦官城'的闲适之意，何必过度忧思？", 
                                style: "tao",
                                response: "刘兄此言，恰如太白之性情。我们曾同游梁宋，把酒言欢，他总笑我忧国忧民，过度劳神。然'安得广厦千万间，大庇天下寒士俱欢颜'之愿，乃我毕生所求。"
                            }
                        ]
                    }
                ]
            },
            // 李白 - 豪放不羁的诗仙
            "libai": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊🍷🌙" },
                            { type: "libai", text: "哈哈哈！刘兄，遇见故人，不胜欢喜！我正从峨眉赏月归来，一壶好酒尚未饮尽，便闻你被贬之事，特来看望！" },
                            { type: "libai", text: "那县令嘛——嗝~（打个酒嗝）——不过是碌碌小人罢了！我当年在唐玄宗面前都敢口出狂言，何况小小县令？'安能摧眉折腰事权贵，使我不得开心颜'！" },
                            { type: "libai", text: "你可知道，我年轻时曾隐居庐山，一间草屋，虽小却胜似皇宫！《望庐山瀑布》就是那时所作，'飞流直下三千尺，疑是银河落九天'，你看这气势，哪是小屋子能限制得了的？" },
                            { type: "libai", text: "我啊，生平漂泊，曾在剑阁题诗'蜀道之难难于上青天'，在夷陵醉酒'朝辞白帝彩云间'，在金陵登高'钟山只隔数重山'，哪一处不是我李白的诗境？" },
                            { type: "libai", text: "刘兄，人活世上，不过百年光阴。'天生我材必有用，千金散尽还复来'！你这小小一贬，何足挂齿？来，这壶剑南春，我敬你一杯！" }
                        ],
                        options: [
                            { 
                                text: "太白兄豪迈非常！确如你所言，'天生我材必有用，千金散尽还复来'，何惧贬谪？", 
                                style: "balanced",
                                response: "哈哈！痛快！听刘兄此言，真乃我辈知己！我常说'人生在世不称意，明朝散发弄扁舟'。这区区贬谪，不过给你提供了一个观江赏月、吟诗作赋的好去处！来，再饮，再饮！"
                            },
                            { 
                                text: "太白兄虽能'仰天大笑出门去'，我却常思'安得广厦千万间，大庇天下寒士俱欢颜'啊！", 
                                style: "du",
                                response: "子美亦曾与我说过此言。酒后我曾挥毫写下'安得倚天抽宝剑，把汝裁为三截'，恨不能为天下除害。刘兄有此志向，虽贬犹荣！吾辈虽仗剑天涯、放浪形骸，但又岂能不忧国忧民乎！"
                            },
                            { 
                                text: "请太白兄传授豪迈洒脱之道", 
                                style: "balanced",
                                response: "豪迈非学而得，乃天性使然。人生苦短，何不痛快淋漓？醉也好，醒也好，总要活个明白！'五花马，千金裘，呼儿将出换美酒'！钱财都是身外物，快乐才是真的。"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🍷🎵" },
                            { type: "libai", text: "刘兄，又见面了！啊，你搬到这柳边小屋了？那县令可真有趣，他怕是不知道我李白最喜欢住的就是这种僻静之所！" },
                            { type: "libai", text: "这垂柳，这流水，倒让我想起当年醉游绿阳湖时的情景。我醉卧湖边柳下，忽见月光如水，便作《静夜思》，'床前明月光，疑是地上霜'，哈哈，那首诗如今可是传遍大江南北啊！" },
                            { type: "libai", text: "你看我身上这件破袍子，知道是怎么来的吗？前日在洛阳，酒后与人争论诗句，把丝绸锦袍输了，只得穿这粗布衣。可心里快活得很哩！" }
                        ],
                        options: [
                            { 
                                text: "太白所言甚是！这'垂柳青青江水边'，确能激发诗兴，醉卧沙场，何其快哉！", 
                                style: "balanced",
                                response: "哈哈哈！借景抒怀？何必借？直抒胸臆便是！我曾醉后提笔，'黄河之水天上来，奔流到海不复回'，全凭胸中逸气！刘兄若能看透世情，不拘小节，便是真正的逍遥游了！"
                            },
                            { 
                                text: "太白与子美真乃知己。可惜我辈身处乱世，不得不'位卑未敢忘忧国'啊！", 
                                style: "du",
                                response: "子美总是这般忧愁！我与他曾踏青于孟津，把酒论诗至天明。他总说'朱门酒肉臭，路有冻死骨'，而我却劝他'一樽还酹江月，人生如梦'。世间忧乐，各有所属。"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️🍷📝" },
                            { type: "libai", text: "刘兄！好小的屋子啊！嗯？这是县令的新安排？哈哈哈，太有意思了！我李白最会住的就是这种地方！" },
                            { type: "libai", text: "这酒——（从怀中掏出一壶酒）——是我在嵩山采药时，偶遇一位道士所赠。他说'此酒饮之可得道'。今日与刘兄共饮，壮怀激烈！这小小斗室，当成天地！" },
                            { type: "libai", text: "我常想，'人生得意须尽欢，莫使金樽空对月'。若不是命运弄人，我本可屠龙攀凤，纵横天下，谁人能与我争锋？如今闲适山林，亦是一段佳话。刘兄亦是如此，不必叹息！" }
                        ],
                        options: [
                            { 
                                text: "太白豪迈非常！我也当学你这'眼前有景道不得，崔颢题诗在上头'的洒脱！", 
                                style: "balanced",
                                response: "刘兄妙语！那日我登黄鹤楼，见崔颢诗句写得好，竟没有再作诗，这事如今传为笑谈。其实我心中自有万千锦绣，何必与人争高低？外物不可累心，刘兄能悟此理，真乃痛饮之人！"
                            },
                            { 
                                text: "太白虽能'笑谈渴饮匈奴血'，我却常思'国破山河在，城春草木深'之悲。", 
                                style: "du",
                                response: "子美这诗我读过，写得好啊！你道我不知国事？只是各有排解之法罢了。近年安禄山作乱，我曾'愿将腰下剑，直为斩楼兰'，可惜壮志未酬。我哪里是不思国事，只是看透了这世事无常。"
                            }
                        ]
                    }
                ]
            },
            "confucius": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊📚👴" },
                            { type: "confucius", text: "刘君，闻君被贬至此，老夫特来相访。见君身处困境，仍不失君子之风，足见其德。" },
                            { type: "confucius", text: "德者，本也；财者，末也。外不由己，内则不可夺。刘君当修其内，而外物不足挂虑。" },
                            { type: "confucius", text: "君子不以外物而移其志。昔日我欲居九夷，或人曰陋，我答'君子居之，何陋之有？'君子所居，德化四方，岂有陋哉？" }
                        ],
                        options: [
                            { 
                                text: "夫子大驾光临，禹锡有失远迎。夫子教诲，让我对'君子居之，何陋之有'有了新的理解。", 
                                style: "ru",
                                response: "君子居之，何陋之有？刘君深明吾意。夫子之道，忠恕而已矣。居简而行简，志高而行远。位卑未敢忘忧国，君子当如是。"
                            },
                            { 
                                text: "夫子，我仍有心系天下之念，如何在修身与济世之间求得平衡？", 
                                style: "du",
                                response: "修身与济世，本不相违。'修身、齐家、治国、平天下'，修身乃齐家治国之本。君若能在此江边修得内圣，他日自能外王。"
                            }
                        ]
                    },
                    {
                        messages: [
                            { type: "narrator", text: "🌊🎋📖" },
                            { type: "confucius", text: "君子忧道不忧贫。刘君今日虽处逆境，然德馨名远，比那些富贵而品德败坏者，不知高明多少倍。" },
                            { type: "confucius", text: "我尝言'贫而无怨难，富而无骄易'。君子当在困厄中见心性，在富贵中见操守。刘君今日之境，正可试君子之德。" },
                            { type: "confucius", text: "学而时习之，不亦说乎？有朋自远方来，不亦乐乎？人不知而不愠，不亦君子乎？此三者，刘君当细思之。" }
                        ],
                        options: [
                            { 
                                text: "夫子所言极是，德馨方能化陋为雅。请夫子详细指点君子修身之道。", 
                                style: "ru",
                                response: "君子之道在于内省。'吾日三省吾身：为人谋而不忠乎？与朋友交而不信乎？传不习乎？'修身之道，贵在恒常，日积月累，德行自成。"
                            },
                            { 
                                text: "夫子教诲深刻，但弟子仍想在困境中为天下苍生尽一份力量。", 
                                style: "du",
                                response: "此志可嘉。然君子当知进退，蛰伏待时，方为上策。今日之隐忍，乃为他日之大用。忠不在于位高权重，而在于心存社稷。"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿📚💫" },
                            { type: "confucius", text: "刘君，此柳边清幽，正是修身读书的好地方。'学而时习之，不亦说乎？'君子当珍惜这静心学习的机会。" },
                            { type: "confucius", text: "我常说'君子不器'，意思是君子不应该像器具一样只有一种用途。无论身在何处，都要保持学习和成长的心态。" },
                            { type: "confucius", text: "君子和而不同，小人同而不和。真正的君子能够与不同的人和谐相处，但在原则问题上绝不妥协。" }
                        ],
                        options: [
                            { 
                                text: "夫子'君子不器'的教诲让我受益匪浅，请问如何在逆境中保持君子风范？", 
                                style: "ru",
                                response: "君子固穷，小人穷斯滥矣。外境虽变，内心不移。君子当修其德，行其义，无论处何境遇，都要保持内心的坚定和品格的高洁。"
                            },
                            { 
                                text: "夫子，如何处理与小人的关系？如这县令之流？", 
                                style: "ru",
                                response: "君子和而不同，小人同而不和。对小人，敬而远之，不必深交，但也无需结怨。保持君子风度，以德化人，或许能感化之。"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️📜🕯️" },
                            { type: "confucius", text: "刘君，这斗室虽小，却可修身养性。'有德者居之，斯为美室'。君子修身，不在环境如何，而在内心修为。" },
                            { type: "confucius", text: "我曾说'君子食无求饱，居无求安'，意思是君子应该把精力放在道德修养上，而不是追求物质享受。" },
                            { type: "confucius", text: "'默而识之，学而不厌，诲人不倦'，此三者，我何德而能之？君子当以此为目标，在任何环境中都要坚持学习和修身。" }
                        ],
                        options: [
                            { 
                                text: "夫子'有德者居之，斯为美室'的话让我深思，德行确实比外在环境更重要。", 
                                style: "ru",
                                response: "善哉！君子之德如风，小人之德如草。草上之风，必偃。刘君能悟此理，真可谓得圣贤真传。德馨如兰在谷，不以无人而不芳。"
                            },
                            { 
                                text: "夫子，弟子想知道如何在这斗室中实现'修身齐家治国平天下'的理想？", 
                                style: "balanced",
                                response: "修身为本，齐家治国为末。内无所修，外何所用？君若能在此斗室中正心诚意，他日必能格物致知。循序渐进，方为正道。"
                            }
                        ]
                    }
                ]
            },
            "libai": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊🍷🌙" },
                            { type: "libai", text: "五柳先生又劝人归隐？梦得兄莫听！当效我'我本楚狂人，凤歌笑孔丘'！" },
                            { type: "libai", text: "咦，这江边倒也不错嘛！我平生最爱江山之美。记得当年舟行长江，'两岸猿声啼不住，轻舟已过万重山'，才有了辞别白帝城之作。" },
                            { type: "libai", text: "刘兄，人活世上，不过百年光阴。我曾隐于庐山，访道于东吴，纵游梁宋，醉卧金陵，看尽世间浮华，不过一场梦幻。你这小小一贬，何足挂齿？" }
                        ],
                        options: [
                            { 
                                text: "太白诗魄化江涛！可愿共赋'黄河落天走东海'？", 
                                style: "balanced",
                                response: "李白击舷长啸：'正有此意！且听江流宛转绕芳甸！哈哈！痛快！听梦得此言，真乃我辈知己！'"
                            },
                            { 
                                text: "太白兄虽能'仰天大笑出门去'，我却常思'安得广厦千万间，大庇天下寒士俱欢颜'啊！", 
                                style: "du",
                                response: "李白猛灌一口酒，忽的神情肃穆：'子美亦曾与我说过此言。酒后我曾挥毫写下『安得倚天抽宝剑，把汝裁为三截』，恨不能为天下除害。梦得兄有此志向，虽贬犹荣！'"
                            }
                        ]
                    }
                ]
            },
            "baijuyi": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊⛵🎵" },
                            { type: "baijuyi", text: "同是天涯沦落人，相逢何必曾相识！梦得观此大江，可似吾浔阳秋荻？" },
                            { type: "baijuyi", text: "我当年贬江州司马时，常在江边听琵琶声，写下'座中泣下谁最多，江州司马青衫湿'。今见梦得被贬，深感同病相怜。" },
                            { type: "baijuyi", text: "此地虽僻，胜我江州'黄芦苦竹'否？我有'春江花朝秋月夜'，君得'草色入帘青'——各占天地一绝！" }
                        ],
                        options: [
                            { 
                                text: "乐天《琵琶行》'血色罗裙翻酒污'，今县令宴饮正酣！", 
                                style: "du",
                                response: "白居易冷笑：'且待君作《陋室铭》成，吾当续写《新乐府·陋室叹》！同遭贬谪，当以笔墨鸣不平。'"
                            },
                            { 
                                text: "此地虽僻，胜兄江州'黄芦苦竹'否？", 
                                style: "balanced",
                                response: "白居易斟酒：'我有春江花朝秋月夜，君得草色入帘青——各占天地一绝！贬谪之地，反成创作佳境。'"
                            }
                        ]
                    }
                ]
            },
            // 柳边环境 🌳🏞️
            "du": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🐸🌙" },
                            { type: "du", text: "朱门竟折君子庭柳！梦得当书'新松恨不高千尺'以砭时弊！" },
                            { type: "du", text: "我曾流落夔州，住过破旧茅屋，'床头屋漏无干处，雨脚如麻未断绝'，挑灯夜战，只为记录这乱世中的点滴。" },
                            { type: "du", text: "梦得你看这柳色依依，风轻云淡，表面宁静，却不知多少百姓在苦难中挣扎。'长太息以掩涕兮，哀民生之多艰'啊！" }
                        ],
                        options: [
                            { 
                                text: "子美恤民如切肤，摩诘观化得禅机，皆禹锡师也。", 
                                style: "balanced",
                                response: "杜甫苦笑：'若逢尧舜世，何须笔作剑...刘兄有此心怀，他日必成大器。天下兴亡，匹夫有责。'"
                            },
                            { 
                                text: "子美所言极是。我认为'居庙堂之高，则忧其民；处江湖之远，则忧其君'。", 
                                style: "du",
                                response: "杜甫紧紧握住刘禹锡的手：'梦得此言，让我想起范仲淹『先天下之忧而忧，后天下之乐而乐』之句。愿梦得与我同行此路，以笔墨鸣不平！'"
                            }
                        ]
                    }
                ]
            },
            "wangwei": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🍃💫" },
                            { type: "wangwei", text: "子美且观此叶——'行到水穷处，坐看云起时'，岂非天道？" },
                            { type: "wangwei", text: "梦得听此蛙鸣蝉噪，可识'空山不见人'之趣？昔年吾居辋川，每以天籁代丝竹。" },
                            { type: "wangwei", text: "我有一禅诗，名曰《鹿柴》：'空山不见人，但闻人语响。返影入深林，复照青苔上。'此诗写景实则写禅，你看此处青苔上的日影，岂不正是此意？" }
                        ],
                        options: [
                            { 
                                text: "摩诘诗中画，可是'返景入深林'之境？", 
                                style: "tao",
                                response: "王维垂目：'然。官场沉浮如露电，惟此青苔翠竹是本来面目。山中一夜雨，树杪百重泉，当是清心之句。'"
                            },
                            { 
                                text: "闻公陷贼时作《凝碧诗》，禹锡今感同身受...", 
                                style: "du",
                                response: "王维闭目合十：'万户伤心生野烟——此痛刻骨，终化明月来相照之空明。君之困厄，亦菩提种也。'"
                            }
                        ]
                    }
                ]
            },
            "zhugeliang": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🪶📜" },
                            { type: "zhugeliang", text: "亮观县令三迁君宅，恰似'以退为进'之局。梦得可效空城计——素琴一曲退千军。" },
                            { type: "zhugeliang", text: "昔日蜀中多难，亮每以'鞠躬尽瘁，死而后已'自勉。如今观梦得困境，深感读书人当有坚持。" }
                        ],
                        options: [
                            { 
                                text: "淡泊明志之道，可能化斗室为金城？", 
                                style: "ru",
                                response: "诸葛亮颔首：'善！宁静之心，可御百万刁难。非淡泊无以明志，非宁静无以致远。梦得得此真谛。'"
                            }
                        ]
                    }
                ]
            },
            "tao": {
                // 陶渊明对话库
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "tao", text: "刘兄，在下陶渊明。看到你被贬至此江边居所，恰似当年我在彭泽县做了八十多天县令就辞官而去的情景。" },
                            { type: "tao", text: "那县令言语轻佻俗薄，真是尘网中人。本官自去年犯了言语之失，被贬为建威参军，也是深感仕途不适，辞官归田。" },
                            { type: "tao", text: "如今我每日在东篱下种菊，傍晚举首望见南山的轮廓，心旷神怡。有闲暇便写些文字，或携壶浊酒独酌，与田园为伴，倒也惬意。" },
                            { type: "tao", text: "我常对子侄辈说：'一瓢饮，一箪食，居陋巷，人不堪其忧，回也不改其乐。'贫与富、达与穷，皆由天定，何必挂怀？" },
                            { type: "tao", text: "刘兄，你这江边小屋虽被县令视为刁难，但可观江水日夜不息，白云悠悠，鸟儿翔集，何尝不是一处胜境？" }
                        ],
                        options: [
                            { 
                                text: "先生不为五斗米折腰的高洁，令人敬佩。这江边小屋，倒让我心境更为澄明。", 
                                style: "tao",
                                response: "宦海浮沉，总不如一杯清酒来得痛快。刘兄能在逆境中见性，此心澄明，不为外物所扰，甚好。若能日日耕读饮酒，实乃人生至乐。"
                            },
                            { 
                                text: "先生能安然种豆南山下，我却仍有为天下苍生鸣不平之念，恐难如先生这般淡然处之。", 
                                style: "du",
                                response: "菊圃方滋，自有东篱趣；杏坛未冷，更需后学魂。陶某性本旷达，刘兄志存高远，各随其性，何必强求？"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "tao", text: "刘兄，又见面了。这柳边环境比江边更清幽了。看这垂柳依依，流水潺潺，仿佛使人回到我的南村旧居。" },
                            { type: "tao", text: "五月田家种作忙，农夫鼓励在陌上。县令本想刁难于你，却不知我归田以后，日日耕种锄草，身体反倒硬朗了许多。" },
                            { type: "tao", text: "记得我归田后的第一年冬天，家中断粮。我骑牛入城，沿街乞食，也不觉得羞耻。倒是一些世俗之人，觉得我有辱斯文。" },
                            { type: "tao", text: "刘兄，最初归田时，邻居们都笑我傻，三四年后眼见我怡然自得，也都羡慕起来。如今我种的菊花，十里八乡无人不知。" },
                            { type: "tao", text: "这世间最难得者，不过一片清净心。我常念着'大道泰然，逍遥自适'。你看这水边垂柳，且行且止，又何必为世俗所困？" }
                        ],
                        options: [
                            { 
                                text: "先生将隐居之情寄托于田园农事，也有'悠然见南山'的闲情逸致，确是明智之举。", 
                                style: "tao",
                                response: "陶渊明放下酒杯，眼中带着温和的笑意：'人生在世，能归真返璞，本色而行，实为大幸。我不过顺应天性，刘兄若也喜静，何不来我南村小住，看看那春去夏来的田园气象？'"
                            },
                            { 
                                text: "渊明先生，您的'采菊东篱下'尚有几分出世之念，我却想在此境中仍保'先天下之忧而忧'之心。", 
                                style: "du",
                                response: "陶渊明轻摇羽扇，微微一叹：'家国之忧，自古文人皆有之。只是我陋巷安贫，已无力回天。刘兄壮志不摧，确是难得。我思念旧友王弘、殷览诸人，也常有泪落杯中时。'"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "tao", text: "刘兄，县令将你安置在这斗室之中，想必是要断绝你与外界联系，不知你是否觉得闷苦？" },
                            { type: "tao", text: "我当年辞官归隐后的环境，也不过陋室数间，妻子耕种，儿女环绕。但我常觉知足，时有'停云'、'猗兰'、'桃花源'等文字出于笔端。" },
                            { type: "tao", text: "说来也怪，若非当年我辞官归田，哪有闲情去寻那世外桃源？清晨耕作，午间读书，晚上小酌，生活虽简朴，心却自在。" },
                            { type: "tao", text: "我曾写道：'宇宙内事，得失无常。道足以忘物，物岂能累心？'这斗室虽陋，苔痕上阶，草色入帘，亦是一处清心之地。" },
                            { type: "tao", text: "刘兄，'不戚戚于贫贱，不汲汲于富贵'，这大概就是我悟出的人生真谛。清茶一杯，明月一轮，心远地自偏，又何须顾念县令作态？" }
                        ],
                        options: [
                            { 
                                text: "先生所言极是。我在这斗室之中，仿佛看到了'桃花源'中的景象，心境澄明如许。", 
                                style: "tao",
                                response: "陶渊明一脸欣然，仿佛看到知己：'种豆南山下，草盛豆苗稀。晨兴理荒秽，带月荷锄归。刘兄若能在此斗室有所悟得，他日必能超然物外，写下传世之作。'"
                            },
                            { 
                                text: "先生心境豁达，我却时常思念朝堂国事。这'小隐隐陵薮，大隐隐朝市'，各有其道吧？", 
                                style: "du",
                                response: "陶渊明轻轻颔首：'此言甚是。世有伯夷叔齐，世亦有孔孟周公。山林与朝市，殊途而同归。刘兄心系天下，非我所能及也。归隐亦好，入世亦可，但求无愧于心足矣。'"
                            }
                        ]
                    }
                ]
            },
            "libai": {
                // 李白对话库
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "libai", text: "哈哈哈！刘兄，遇见故人，不胜欢喜！我正从峨眉赏月归来，一壶好酒尚未饮尽，便闻你被贬之事，特来看望！" },
                            { type: "libai", text: "咦，这江边倒也不错嘛！我平生最爱江山之美。记得当年舟行长江，'两岸猿声啼不住，轻舟已过万重山'，才有了辞别白帝城之作。" },
                            { type: "libai", text: "那县令嘛——嗝~（打个酒嗝）——不过是碌碌小人罢了！我当年在唐玄宗面前都敢口出狂言，何况小小县令？" },
                            { type: "libai", text: "看我这身装束，蓬头垢面，酒气熏天，但豪情尤在！'五花马，千金裘，呼儿将出换美酒，与尔同销万古愁'！" },
                            { type: "libai", text: "刘兄，人活世上，不过百年光阴。我曾隐于庐山，访道于东吴，纵游梁宋，醉卧金陵，看尽世间浮华，不过一场梦幻。你这小小一贬，何足挂齿？" },
                            { type: "libai", text: "今日我与你，就在这江边，'斗酒十千恣欢谑，会须一饮三百杯'如何？来，这壶剑南春，我敬你一杯！" }
                        ],
                        options: [
                            { 
                                text: "太白兄豪迈非常！确如你所言，'天生我材必有用，千金散尽还复来'，何惧贬谪？", 
                                style: "balanced",
                                response: "李白放声大笑，洒出几滴酒液：'哈哈！痛快！听刘兄此言，真乃我辈知己！我常说『人生在世不称意，明朝散发弄扁舟』。这区区贬谪，不过给你提供了一个观江赏月、吟诗作赋的好去处！来，再饮，再饮！'"
                            },
                            { 
                                text: "太白兄虽能'仰天大笑出门去'，我却常思'安得广厦千万间，大庇天下寒士俱欢颜'啊！", 
                                style: "du",
                                response: "李白猛灌一口酒，忽的神情肃穆：'子美亦曾与我说过此言。酒后我曾挥毫写下『安得倚天抽宝剑，把汝裁为三截』，恨不能为天下除害。刘兄有此志向，虽贬犹荣！吾辈虽仗剑天涯、放浪形骸，但又岂能不忧国忧民乎！'"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "libai", text: "刘兄，又见面了！啊，你搬到这柳边小屋了？那县令可真有趣，他怕是不知道我李白最喜欢住的就是这种僻静之所！" },
                            { type: "libai", text: "这垂柳，这流水，倒让我想起当年醉游绿阳湖时的情景。我醉卧湖边柳下，忽见月光如水，便作《静夜思》，'床前明月光，疑是地上霜'，哈哈，那首诗如今可是传遍大江南北啊！" },
                            { type: "libai", text: "你看我身上这件破袍子，知道是怎么来的吗？前日在洛阳，酒后与人争论诗句，把丝绸锦袍输了，只得穿这粗布衣。可心里快活得很哩！" },
                            { type: "libai", text: "我呀，生平最恨拘束。记得有一次，玄宗皇帝要我做翰林供奉，我哪受得了那份拘束？'清水出芙蓉，天然去雕饰'，我李太白就是这般性子，随遇而安，肆意人生！" },
                            { type: "libai", text: "刘兄，此处青山绿水，胜过宫廷十倍！今夜不如我俩把酒临风，'抽刀断水水更流，举杯消愁愁更愁'，你我对饮吟诗，直到月落乌啼！" }
                        ],
                        options: [
                            { 
                                text: "太白所言甚是！这'垂柳青青江水边'，确能激发诗兴，借景抒怀，醉卧沙场，何其快哉！", 
                                style: "balanced",
                                response: "李白手执酒杯，神采飞扬：'哈哈哈！借景抒怀？何必借？直抒胸臆便是！我曾醉后提笔，『黄河之水天上来，奔流到海不复回』，全凭胸中逸气！刘兄若能看透世情，不拘小节，便是真正的逍遥游了！'"
                            },
                            { 
                                text: "太白与子美真乃知己。可惜我辈身处乱世，不得不'位卑未敢忘忧国'啊！", 
                                style: "du",
                                response: "李白一饮而尽，目光忽地深远：'唉，子美总是这般忧愁！我与他曾踏青于孟津，把酒论诗至天明。他总说『朱门酒肉臭，路有冻死骨』，而我却劝他『一樽还酹江月，人生如梦』。世间忧乐，各有所属。刘兄心忧天下，足见气节。来，这杯敬你！'"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "libai", text: "刘兄！好小的屋子啊！嗯？这是县令的新安排？哈哈哈，太有意思了！我李白最会住的就是这种地方！" },
                            { type: "libai", text: "你可知道，我年轻时曾隐居庐山，一间草屋，虽小却胜似皇宫！《望庐山瀑布》就是那时所作，'飞流直下三千尺，疑是银河落九天'，你看这气势，哪是小屋子能限制得了的？" },
                            { type: "libai", text: "我啊，生平漂泊，曾在剑阁题诗'蜀道之难难于上青天'，在夷陵醉酒'朝辞白帝彩云间'，在金陵登高'钟山只隔数重山'，哪一处不是我李白的诗境？" },
                            { type: "libai", text: "刘兄，你看我鬓角的白发（指着自己），这可都是江湖风霜所致。曾有人劝我谨言慎行，我却说'安能摧眉折腰事权贵，使我不得开心颜'！哈哈，所以才落得今日这般模样。" },
                            { type: "libai", text: "这酒——（从怀中掏出一壶酒）——是我在嵩山采药时，偶遇一位道士所赠。他说'此酒饮之可得道'。今日与刘兄共饮，壮怀激烈！这小小斗室，当成天地！" },
                            { type: "libai", text: "我常想，'人生得意须尽欢，莫使金樽空对月'。若不是命运弄人，我本可屠龙攀凤，纵横天下，谁人能与我争锋？如今闲适山林，亦是一段佳话。刘兄亦是如此，不必叹息！" }
                        ],
                        options: [
                            { 
                                text: "太白豪迈非常！我也当学你这'眼前有景道不得，崔颢题诗在上头'的洒脱！", 
                                style: "balanced",
                                response: "李白仰头大笑，长袖舞动：'刘兄妙语！那日我登黄鹤楼，见崔颢诗句写得好，竟没有再作诗，这事如今传为笑谈。其实我心中自有万千锦绣，何必与人争高低？外物不可累心，刘兄能悟此理，真乃痛饮之人！来，举杯！'"
                            },
                            { 
                                text: "太白虽能'笑谈渴饮匈奴血'，我却常思'国破山河在，城春草木深'之悲。", 
                                style: "du",
                                response: "李白神色忽然凝重，酒意稍减：'子美这诗我读过，写得好啊！你道我不知国事？只是各有排解之法罢了。近年安禄山作乱，我曾『愿将腰下剑，直为斩楼兰』，可惜壮志未酬。我哪里是不思国事，只是看透了这世事无常，既无力回天，何不『明朝散发弄扁舟』呢？刘兄心系社稷，令人钦佩！'"
                            }
                        ]
                    }
                ]
            },
            "sushi": {
                // 苏轼对话库
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "sushi", text: "哈哈！刘兄，久闻大名！我乃苏轼，字子瞻，后人称我为东坡居士。" },
                            { type: "sushi", text: "这江边风景，倒是与我当年贬谪黄州时的景致相似。'百年歌自苦，未见有人知。昨日东坡雨，今朝沧海垂。'人生起伏，何其相似！" },
                            { type: "sushi", text: "嘿，那县令的做派，与当年奸相王安石何其相似！我正是因为反对新法而被贬。但你看我这体态——（指着自己的肚腩）——在逆境中反而吃得更香了！" },
                            { type: "sushi", text: "这江水悠悠，引我思绪万千。当年我在赤壁泛舟，写下'大江东去，浪淘尽，千古风流人物'，不也是在逆境中得来的慰藉吗？" },
                            { type: "sushi", text: "贬谪之地若能从容面对，常有意外之喜。我在黄州，创黄州寒食诗、赤壁赋，结识了不少高士，酿酒、煮茶、做团子，过得好不自在！" },
                            { type: "sushi", text: "人生苦短，若一味忧愁，岂不辜负这一世？'人生到处知何似，应似飞鸿踏雪泥。'刘兄，何不与我共赏江景，品尝这壶糟烧？" }
                        ],
                        options: [
                            { 
                                text: "东坡先生豪迈旷达，深得禅家妙理，'缺月挂疏桐，漏断人初静'之句尤为打动我心。", 
                                style: "balanced",
                                response: "苏轼放声大笑，眼中闪烁智慧光芒：'刘兄通晓我《定风波》词，真乃知音！那首词作于我谪居密州时。『回首向来萧瑟处，归去，也无风雨也无晴』，此乃禅机，不是消极，而是超越物我、荣辱、悲欢。刘兄若悟此理，区区贬谪，何足挂齿？'"
                            },
                            { 
                                text: "先生虽历经黄州、惠州、儋州三贬，却仍心系苍生，'但愿苍生俱饱暖，不辞辛苦出山林'。我深受感动。", 
                                style: "du",
                                response: "苏轼抚摸着肚腩，神色忽而肃穆：'我平生最痛恨那等道貌岸然之徒，口谈仁义而暗施刑狱。天下百姓疾苦，身为读书人，岂能视而不见？刘兄有此心怀，他日必成大器！不过今日天色渐暗，不如我们先痛饮几杯如何？人生能有几回搏？'"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "sushi", text: "哎呀，刘兄，你又搬家了？这柳边环境清幽雅致，倒是比江边更适合吟诗作对！" },
                            { type: "sushi", text: "看这垂柳依依，让我想起当年在杭州西湖漫步的情景。'水光潋滟晴方好，山色空蒙雨亦奇'，如此美景，岂是县令所能限制的？" },
                            { type: "sushi", text: "这河水清澈见底，正好可煮茶！刘兄可知我有《汲江煎茶》诗？'活水还须活火烹，自临钓石取深清。'水质不同，茶味亦异，此中滋味，妙不可言！" },
                            { type: "sushi", text: "我一生坎坷，多次被贬，但却因此游历了大半个中国。饱览名山大川，结交天下高士，写下无数传世佳作，这何尝不是福分？" },
                            { type: "sushi", text: "尤记得黄州种田，颍州守城，儋州教书，种种经历皆成就了我的人生。刘兄此番贬谪，或许正是上天馈赠的观察世间、体悟人生的机会！" },
                            { type: "sushi", text: "刘兄，不如我们沿着河边散步，品评诗文，谈古论今，待月上柳梢时，再饮三杯薄酒如何？" }
                        ],
                        options: [
                            { 
                                text: "东坡先生饱经风霜却仍旷达自如，'回首向来萧瑟处，归去，也无风雨也无晴'之句令我心生敬意。", 
                                style: "balanced",
                                response: "苏轼拈须微笑：'此词非我得意之作，却是后人常引。我平生经历大大小小挫折无数，却也因此看透了人生百态。世事本无常，何必太在意？刘兄若能于境遇中自得其乐，当如我在黄州，种菜煮酒，笑谈人生，不亦快哉！'"
                            },
                            { 
                                text: "先生将贬谪之苦化为笔下风流，'竹杖芒鞋轻胜马，谁怕？一蓑烟雨任平生'，此等风骨，令人钦佩！", 
                                style: "balanced",
                                response: "苏轼大笑拍掌：'好一个『谁怕』！刘兄深得我意！当年黄州遇大雨，我冒雨赴一友人之约，归来作此词。人生不如意事常八九，若能于困境中保持乐观豁达，便能所向披靡。来，刘兄，我们何不步入柳荫，共吟新篇？'"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "sushi", text: "刘兄，这斗室虽小，却也自有清趣。'庭下如积水空明，水中藻荇交横，盖竹柏影也。'你瞧这光影交错，岂不美哉？" },
                            { type: "sushi", text: "小住为佳，莫要嫌小。当年我在密州时，居所简陋，却写下《超然台记》：'士大夫之无恒产者，百年之后，其家必零落。'小屋易保，大宅难守，此中道理，细思可得。" },
                            { type: "sushi", text: "此室虽简，却有'苔痕上阶绿，草色入帘青'的意趣，与我当年所居'东坡'颇有几分相似。县令本欲限你，不知反成就你的雅致呢！" },
                            { type: "sushi", text: "我平生最爱美食，无论身处何地，总能寻得口腹之欢。曾创'东坡肉'，你若不嫌简陋，我们何不小酌几杯，烹煮一番，以慰风尘？" },
                            { type: "sushi", text: "刘兄，你可知道我在黄州谪居时，年近不惑，却大彻大悟，写下《前赤壁赋》：'哀吾生之须臾，羡长江之无穷'。人生短暂，应当在有限的时日里，放眼长江，怀抱无限！" },
                            { type: "sushi", text: "都云作者痴，谁解其中味？我每至佳处辄欣然忘食，县令以为关你在斗室是惩罚，殊不知正成全你静心著述之机缘啊！" }
                        ],
                        options: [
                            { 
                                text: "东坡先生'盖将自其变者而观之，则天地曾不能以一瞬'的豁达，令我茅塞顿开！", 
                                style: "balanced",
                                response: "苏轼抚掌大笑：'刘兄深得我《赤壁赋》三昧！人生苦短，天地悠长。此间斗室，若能于方寸之地悟得无限天机，便是人生大幸！我尝言『事如春梦了无痕，但是有情尝苦辛』，一切荣辱得失，皆如过眼云烟。刘兄若能参透此理，日后必成大家！'"
                            },
                            { 
                                text: "先生在逆境中仍能'举杯消愁愁更愁'，化忧为诗，化贬为文，此等胸襟，令我钦佩！", 
                                style: "balanced",
                                response: "苏轼轻抚胡须，目光深远：'我平生所历坎坷，皆成就了我的文章。『横看成岭侧成峰，远近高低各不同』，处境虽难，换个角度看，又是另一番景象。刘兄若能在斗室中著成佳作，他日传颂千古，岂不快哉？来，我们再小酌一杯！'"
                            }
                        ]
                    }
                ]
            },
            "liqingzhao": {
                // 李清照对话库
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "liqingzhao", text: "刘兄，小女子李清照，字易安，冒昧来访，望勿见怪。" },
                            { type: "liqingzhao", text: "看这江边风景，令我想起早年与家夫赵明诚在汴京时，常于潇湘馆赏月吟诗的场景。那时'帘卷西风，人比黄花瘦'，如今回想，恍若隔世。" },
                            { type: "liqingzhao", text: "我与君不同，你是遭贬而来，我却是因金兵南侵，辗转逃难至此。国破家亡，夫君早逝，所藏书画金石散佚大半，每思及此，不能不'凄凄惨惨戚戚'。" },
                            { type: "liqingzhao", text: "虽然我身为女子，但也深知'人生若只如初见'的珍贵。早年与赵郎共研金石，偶作小词，日子过得何其惬意。'莫道不销魂，帘卷西风，人比黄花瘦'，那是我最好的时光。" },
                            { type: "liqingzhao", text: "贬谪之地，虽不如故土，然江边明月，草木生香，亦是一方净土。你我同是天涯沦落人，不如借这良辰美景，诉说心中块垒，或可稍解愁怀。" }
                        ],
                        options: [
                            { 
                                text: "易安夫人词作婉约，'寻寻觅觅，冷冷清清，凄凄惨惨戚戚'之句，道尽别离之苦。", 
                                style: "balanced",
                                response: "李清照眼中闪过一丝哀伤，随即又恢复平静：'昔年灵均《离骚》云『已矣哉，国无人莫我知兮，又何怀乎故都』。我本不欲为离愁别绪所扰，奈何国破家亡，词调自然婉转哀伤。刘兄能体会我词中情思，甚为难得。'"
                            },
                            { 
                                text: "夫人虽历经国破家亡，却能刚毅自持，'生当作人杰，死亦为鬼雄'，此等气魄，不让须眉。", 
                                style: "du",
                                response: "李清照微微一笑：'刘兄过奖了。我不过一弱女子，只是性情刚烈，不愿向命运低头罢了。当年在临安，我曾大骂南宋朝廷苟且偷安，贪生怕死，有辱我华夏气节。如今虽客居他乡，犹思有朝一日，能手刃仇敌，重整河山。纵然此生不能如愿，也要将此志传于后世。'"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "liqingzhao", text: "刘兄，你也移居此处了？这柳边环境倒是清幽，与我早年在青州居住时相似。" },
                            { type: "liqingzhao", text: "你看这垂柳依依，春风拂面，倒让我想起从前词作：'乍暖还寒时候，最难将息。三杯两盏淡酒，怎敌他、晚来风急？'时节变幻，人事亦然。" },
                            { type: "liqingzhao", text: "听闻刘兄研究金石甚有心得，我与亡夫赵明诚当年最爱收集古文字、古印玺，著有《金石录》三十卷，可惜大部分都在靖康之变时遗失了。'人比黄花瘦'，不仅是因思念，更因国恨家仇啊。" },
                            { type: "liqingzhao", text: "刘兄可知，我与赵郎成婚之初，常以诗词酒令为戏，胜者得金钗一支，输者饮酒三杯。那时风月清朗，诗酒年华，何其美好。如今回首，恍若隔世。" },
                            { type: "liqingzhao", text: "这垂柳倒好似'杨柳岸晓风残月'，我最喜欢的就是在这样的环境中独酌，借酒消愁，却又'怎敌他晚来风急'，只好'醉也无风情，别有风情'了。" }
                        ],
                        options: [
                            { 
                                text: "闻夫人少时磊落豪爽，金石鉴赏无人能及，想必'莫道不消魂'的婉约，是经历沧桑后才有的感悟。", 
                                style: "balanced",
                                response: "李清照微微颔首：'刘兄所言极是。年轻时我最爱填词作乐，如『绣面芙蓉一笑开』，皆是欢快之作。宋亡国破，流离失所，词风自然转为哀伤。然我骨子里仍是那个敢说『千古江山，英雄无觅孙仲谋处，舞榭歌台，风流总被雨打风吹去』的李易安啊！'"
                            },
                            { 
                                text: "易安夫人深通音律，'知否，知否？应是绿肥红瘦'一句，道尽春色残败，令人扼腕。", 
                                style: "tao",
                                response: "李清照轻叹一声：'在我看来，词要协音律，更要传心音。身世浮沉，国破家亡，我已不复当年欢乐。正如我在《武陵春》中所言，『只恐双溪舴艋舟，载不动，许多愁』。刘兄能领会我词中之意，甚慰我心。'"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "liqingzhao", text: "刘兄，这斗室虽小，倒与我现居之所颇为相似。'小窗幽记',曾是我与赵郎读书论艺之所，如今只剩我一人孤灯独坐了。" },
                            { type: "liqingzhao", text: "我在金石词章上颇有研究，曾著《金石录后序》，议论精当，不输须眉。可惜自金兵南下，国破家亡，所藏书画古玩散佚，'千里孤坟，无处话凄凉'，如今想来，不胜唏嘘。" },
                            { type: "liqingzhao", text: "这斗室虽简陋，却自有一种素雅之美。石阶上青苔如翠，竹帘外草色如烟，倒让我想起早年词作的意境。" },
                            { type: "liqingzhao", text: "早年我最爱和赵郎玩投壶射覆之戏，输赢皆有诗酒相伴，不觉春宵苦短。如今只能在'雁字回时，月满西楼'的夜晚，独酌孤吟，寄托哀思。" },
                            { type: "liqingzhao", text: "刘兄，你我同是天涯沦落人，你因贬谪，我因战乱，虽际遇不同，却都能在逆境中独善其身，坚守心中所爱，这不正是读书人的风骨吗？" }
                        ],
                        options: [
                            { 
                                text: "易安夫人才情卓绝，忧思深远，'守着窗儿，独自怎生得黑'的孤寂，令人动容。", 
                                style: "balanced",
                                response: "李清照眼中含泪，却又故作强颜：'我少时精力旺盛，爱作慢词，文字繁复；晚年则寥寥数语，已蕴无限心事。守到天明，也不过是又一个无人共语的黎明。刘兄能懂我词中深意，甚是难得。他日若有新作，望能相示一二。'"
                            },
                            { 
                                text: "夫人虽历经国破家亡之痛，却能刚强自立，'生当作人杰，死亦为鬼雄'，令人敬佩。", 
                                style: "du",
                                response: "李清照正色道：'亡国之痛，家破之恨，时时萦绕于心。我虽为弱女子，却不愿低头认命。曾于临安怒斥朝廷苟且偷安，曾著《金石录后序》申明亡夫志向。纵然终身漂泊，也要保持气节。刘兄此言，正是对我最大的理解和尊重。'"
                            }
                        ]
                    }
                ]
            },
            "du": {
                // 杜甫对话库
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "du", text: "刘兄，子美见礼。闻君被贬，特来相访。" },
                            { type: "du", text: "这江边环境虽不如京城繁华，但见你安之若素，不免让我想起'安得广厦千万间，大庇天下寒士俱欢颜'的心愿。" },
                            { type: "du", text: "我生逢乱世，亲历安史之乱。'国破山河在，城春草木深'，眼见百姓流离失所，朝野腐败，心中郁结难消啊。" },
                            { type: "du", text: "彼县令之流，徒知奉承权贵，殊不知'朱门酒肉臭，路有冻死骨'的悲剧何时方休？" },
                            { type: "du", text: "刘兄处境与我当年'夔府孤城，对此茫茫'相似。我曾用诗记录时代疾苦，希望能唤起世人良知。" },
                            { type: "du", text: "虽说一介书生，难挽天下大势，但'位卑未敢忘忧国'，也是我辈读书人的气节啊！" }
                        ],
                        dialogueOptions: [
                            { 
                                id: "du_1_patriotic",
                                text: "子美所言极是！虽遭贬谪，我仍心系朝堂，只是力不从心，难以施展抱负。", 
                                style: "du",
                                response: "吾每见朝政日非，辄夜不能寐。刘兄有此心怀，他日必成大器。天下兴亡，匹夫有责，我等虽力微言轻，然笔墨千秋，或可感天地，泣鬼神。此身虽陋，此心当雄！"
                            },
                            { 
                                id: "du_1_detached",
                                text: "子美忧国忧民，令人敬佩。只是我渐觉'茅屋为秋风所破'亦是无妄之灾，不如放任自然。", 
                                style: "tao",
                                response: "杜甫眼中闪过一丝复杂，缓缓道：'各有所志。当年吾与太白结交，他也常劝我『一樽还酹江月』，不必太过忧思。然吾见民生多艰，战火频仍，何能置身事外？刘兄若能于闲适中不忘国事，已是难得。'"
                            },
                            {
                                id: "du_1_poetry",
                                text: "子美的诗歌记录了时代疾苦，可为后世借鉴。我想听听您对'诗圣'之名的看法。",
                                style: "balanced",
                                response: "子美苦笑摇头：'诗圣之名，实不敢当。我不过是个记录者，将所见所感诉诸笔端。「三吏」「三别」皆是血泪之作，若能让后人知晓战乱之苦，不负此生了。'"
                            },
                            {
                                id: "du_1_friendship", 
                                text: "听闻您与李白友谊深厚，可否谈谈你们的诗歌观念差异？",
                                style: "balanced",
                                response: "杜甫目光温和：'太白如仙，我如凡人。他「黄河之水天上来」，我「床头屋漏无干处」。他写天马行空，我记人间疾苦。虽风格不同，然皆为诗道而生。'"
                            }
                        ]
                    }
                ],
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "du", text: "刘兄，听闻你又迁居至此柳边，特来看望。这'柳边'倒让我想起诗句'日暮乡关何处是，烟波江上使人愁'。" },
                            { type: "du", text: "我曾流落夔州，住过破旧茅屋，'床头屋漏无干处，雨脚如麻未断绝'，挑灯夜战，只为记录这乱世中的点滴。" },
                            { type: "du", text: "天地之大，竟容不下我等直言之士！刘兄，你之被贬，不正与我当年'读书破万卷，下笔如有神'后，仍郁郁不得志相似？" },
                            { type: "du", text: "安史之乱后，我流落各处，眼见战火纷飞、民不聊生，深感百姓疾苦，做了许多'三吏'、'三别'这样记录民生疾苦的诗歌。" },
                            { type: "du", text: "刘兄你看这柳色依依，风轻云淡，表面宁静，却不知多少百姓在苦难中挣扎。'长太息以掩涕兮，哀民生之多艰'啊！" },
                            { type: "du", text: "这柳边小屋虽简陋，但若能保持心志，继续为民发声，也算是不负此生了。" }
                        ],
                        options: [
                            { 
                                text: "子美所言极是。我认为'居庙堂之高，则忧其民；处江湖之远，则忧其君'，无论境遇如何，心系苍生是我辈本分。", 
                                style: "du",
                                response: "杜甫紧紧握住刘禹锡的手，目光坚定如铁：'刘兄此言，让我想起范仲淹『先天下之忧而忧，后天下之乐而乐』之句。虽我身处乱世，不能为百姓谋福祉，但笔下诗篇，记录了这纷乱世间的苦痛与希望。愿刘兄与我同行此路，以笔墨鸣不平，以文章存正气！'"
                            },
                            { 
                                text: "子美忧心忡忡，我却渐觉随遇而安的好处。'自在飞花轻似梦，无边丝雨细如愁'，此境亦有闲适可寻。", 
                                style: "tao",
                                response: "杜甫神情稍显落寞，轻叹道：'刘兄志趣，倒与太白相近。记得他常劝我『人生在世不称意，明朝散发弄扁舟』。或许你们看得更透彻，只是我见惯战乱颠沛，目睹民生凋敝，实在无法置身事外。然各有所安，我也不愿强求刘兄随我担这份忧愁。'"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "du", text: "刘兄，听闻你又搬至这'斗室'，不禁让我想起自己的遭遇。'穷年忧黎元，伥伥如丧家'，我们文人墨客，大多有这样的经历。" },
                            { type: "du", text: "我曾居住在成都浣花溪旁的草堂，'万里桥西宅，百花潭北庄'，虽然简陋，却也自得其乐。可惜好景不长，又被战乱所迫，不得不继续漂泊。" },
                            { type: "du", text: "最艰难时，我带着病妻幼子逃难，'朝行水草边，暮宿山木下'。亲眼目睹民间疾苦，'朱门酒肉臭，路有冻死骨'，这些惨状至今难忘。" },
                            { type: "du", text: "但我始终相信，'会当凌绝顶，一览众山小'。身处逆境，更应保持初心。这'斗室'虽小，志向却不可小！" },
                            { type: "du", text: "刘兄，无论身在何处，'苔痕上阶绿，草色入帘青'的意境都能自我营造。若能保持'家国天下'的胸怀，则居庙堂与江湖，又有何异？" },
                            { type: "du", text: "'三年饥走荒山道，病渴不逢寒水泉'，我经历过的苦难比你多得多。但即便如此，我仍不忘记录这个时代的悲欢离合，希望能为后世留下真实的记录。" }
                        ],
                        options: [
                            { 
                                text: "子美所言，句句入心！我虽被贬居斗室，然心怀天下，实则广厦万间。终有一日，要'为天地立心，为生民立命'！", 
                                style: "du",
                                response: "杜甫眼中闪过一道光亮，郑重其辞：'刘兄此言，堪称千古名句！我常自哀『致君尧舜上，再使风俗淳』之志难酬，然见刘兄志向不改，甚感欣慰。无论身处何地，只要心系苍生，则一方斗室，亦可怀四海。山河破碎，民族危亡之际，更需我辈读书人以笔为剑，铁肩担道义！'"
                            },
                            { 
                                text: "见子美历经磨难仍心系苍生，我深感敬佩。但斗室清幽，倒也契合'晓看红湿处，花重锦官城'的闲适之意，何必过度忧思？", 
                                style: "tao",
                                response: "杜甫苦笑着摇摇头：'刘兄此言，恰如太白之性情。我们曾同游梁宋，把酒言欢，他总笑我忧国忧民，过度劳神。然『安得广厦千万间，大庇天下寒士俱欢颜』之愿，乃我毕生所求。刘兄若能在闲适中不忘苍生，已是难得。毕竟，不是每个人都能承受这无边的忧愁啊...'"
                            }
                        ]
                    }
                ]
            },
            "wangwei": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🍃💫" },
                            { type: "wangwei", text: "梦得居此柳边，可似我辋川别业？'行到水穷处，坐看云起时'，岂非妙境？" },
                            { type: "wangwei", text: "这里青苔翠竹，微风徐来，正是'空山不见人，但闻人语响'的禅境。县令以为贬你至此，不知反成全了你的清修。" },
                            { type: "wangwei", text: "昔年安史乱起，我亦陷贼，被迫出仕。后虽平反，然心灰意冷，遂隐居辋川，日日参禅悟道，以诗画遣怀。" },
                            { type: "wangwei", text: "山水者，天地之精华也。观此青苔翠竹，皆是本来面目。'一花一世界，一叶一菩提'，境由心转，梦得当以心观心。" }
                        ],
                        options: [
                            { 
                                text: "摩诘诗中画，此处的确有'返景入深林'之境。请您指点，如何在此境中得禅悟？", 
                                style: "tao",
                                response: "善哉！'空山不见人，但闻人语响'，此乃静观之妙。山水者，天地之精华也。境由心转，梦得当以心观心。观此青苔翠竹，皆是本来面目。'一花一世界，一叶一菩提'，君若能在此柳边悟得此理，他日必成大器。"
                            },
                            { 
                                text: "虽美景如画，我仍念'万户伤心生野烟'的世事。摩诘先生如何看待入世与出世？", 
                                style: "du",
                                response: "昔年安史乱起，我亦陷贼，作《凝碧诗》明志。'万户伤心生野烟'，此痛刻骨，终化'明月来相照'之空明。君之困厄，亦菩提种也。"
                            }
                        ]
                    }
                ]
            },
            "zhugeliang": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🪶📜" },
                            { type: "zhugeliang", text: "梦得兄，亮观县令三迁君宅，恰似'以退为进'之局。梦得可效空城计——素琴一曲退千军。" },
                            { type: "zhugeliang", text: "昔日蜀中多难，亮每以'非淡泊无以明志，非宁静无以致远'自勉。今观梦得困境，深感读书人当有坚持。" },
                            { type: "zhugeliang", text: "亮虽身居隆中，然心忧天下。'受任于败军之际，奉命于危难之间'，此乃臣子本分。然智者当知进退，蛰伏待时。" },
                            { type: "zhugeliang", text: "梦得今日之境，正如我当年隆中苦读。表面看是被动等待，实则是主动修炼。君子修身养性，待时而动，此乃大智慧。" }
                        ],
                        options: [
                            { 
                                text: "孔明先生智谋无双，请教如何在此境中自处？能否传授淡泊明志之道？", 
                                style: "ru",
                                response: "亮以为，县令之计虽巧，然君子之道不可夺。'非淡泊无以明志，非宁静无以致远'。善！宁静之心，可御百万刁难。梦得若能在此柳边悟得此理，他日必成大器。"
                            },
                            { 
                                text: "先生'鞠躬尽瘁，死而后已'，令我敬佩。我也当效法，心系国事，不因贬谪而改志。", 
                                style: "du",
                                response: "梦得兄有此心，甚慰我怀。亮虽身居隆中，然心忧天下。'受任于败军之际，奉命于危难之间'，此乃臣子本分。忠君报国，乃读书人本分。然梦得当知，忠不在于位高权重，而在于心存社稷。居庙堂与处江湖，皆可尽忠。"
                            }
                        ]
                    }
                ]
            },
            "liqingzhao": {
                "2": [ // 柳边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌿🌸📝" },
                            { type: "liqingzhao", text: "刘兄，小女子李清照，冒昧来访。这柳边环境倒是清幽，与我早年在青州居住时相似。" },
                            { type: "liqingzhao", text: "你看这垂柳依依，春风拂面，倒让我想起从前词作：'乍暖还寒时候，最难将息。'时节变幻，人事亦然。" },
                            { type: "liqingzhao", text: "我与亡夫赵明诚当年最爱收集古文字、古印玺，著有《金石录》三十卷，可惜大部分都在靖康之变时遗失了。'人比黄花瘦'，不仅是因思念，更因国恨家仇啊。" },
                            { type: "liqingzhao", text: "虽然我身为女子，但也深知家国大义。'生当作人杰，死亦为鬼雄'，此乃我心志。纵然终身漂泊，也要保持气节。" }
                        ],
                        options: [
                            { 
                                text: "易安居士大驾光临，蓬荜生辉。请问易安对此处有何感想？", 
                                style: "ru",
                                response: "在我看来，词要协音律，更要传心音。'只恐双溪舴艋舟，载不动，许多愁'，此乃肺腑之言。这垂柳倒好似'杨柳岸晓风残月'，虽是离愁之境，却也有其美感。"
                            },
                            { 
                                text: "闻夫人'生当作人杰，死亦为鬼雄'，不让须眉，令人敬佩。您如何在困境中保持如此气节？", 
                                style: "du",
                                response: "刘兄过奖了。我不过一弱女子，只是性情刚烈，不愿向命运低头罢了。当年在临安，我曾大骂南宋朝廷苟且偷安，贪生怕死。亡国之痛，家破之恨，时时萦绕于心。我虽为弱女子，却不愿低头认命。"
                            }
                        ]
                    }
                ]
            },
            "yanhuei": {
                "1": [ // 江边环境（可在多环境出现）
                    {
                        messages: [
                            { type: "narrator", text: "🌊📚👴" },
                            { type: "yanhuei", text: "刘君，回居陋巷，一箪食一瓢饮，人不堪其忧，回不改其乐。观君今居江边，颇似回当年在陋巷的景象。" },
                            { type: "yanhuei", text: "夫子常教导我们，'学而时习之，不亦说乎？'外物不足挂虑，内心充实方为真乐。'德馨'如兰在谷，不以无人而不芳。" },
                            { type: "yanhuei", text: "回之所乐，在闻夫子之道。虽居陋巷，一箪食，一瓢饮，而志在四方。夫子教诲：'志于道，据于德，依于仁，游于艺'，回虽不敏，日夜思之。" },
                            { type: "yanhuei", text: "刘君，夫子常言：'贫而乐，富而好礼者也'。陋室一间，苔痕上阶，草色入帘，与外物相比，不足道哉；然一经圣人居之，便有千古流芳之名。" }
                        ],
                        options: [
                            { 
                                text: "颜子安贫乐道，令人敬佩。请指点我如何在困境中不改其乐？", 
                                style: "ru",
                                response: "回之所乐，在闻夫子之道。'学而时习之，不亦说乎？'外物不足挂虑，内心充实方为真乐。善哉！'德馨'如兰在谷，不以无人而不芳。刘君能悟此理，陋室即是学堂。"
                            },
                            { 
                                text: "颜子虽贫而乐，我却仍有未竟之志，想要经世济民。", 
                                style: "du",
                                response: "回亦有志。夫子问志，回答：'愿无伐善，无施劳。'内修身心，外无争竞，此亦一志也。夫子亦教导'修己以安人'。内圣外王，相得益彰。君志可嘉。回虽不敏，亦钦佩君之胸怀。"
                            }
                        ]
                    }
                ],
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️📚🕯️" },
                            { type: "yanhuei", text: "刘君，这斗室虽小，却让我想起当年在陋巷的日子。'一箪食，一瓢饮，在陋巷，人不堪其忧，回也不改其乐。'" },
                            { type: "yanhuei", text: "夫子曾赞我'不迁怒，不贰过'，这是我平生所守。外在环境虽变，内心修为不可懈怠。" },
                            { type: "yanhuei", text: "真正的快乐不在于外在的丰富，而在于内心的充实。读书明理，修身养性，这才是君子之乐。" }
                        ],
                        options: [
                            { 
                                text: "颜子'不迁怒，不贰过'的修养功夫，请详细指点", 
                                style: "ru",
                                response: "'不迁怒，不贰过'，此回平生所守。志在内修，不求人知。修身之道，贵在恒常，日积月累，德行自成。"
                            },
                            { 
                                text: "颜子与夫子师生情深，令人感动。我也希望能得到这样的智慧传承。", 
                                style: "ru",
                                response: "夫子亦教导'修己以安人'。内圣外王，相得益彰。孔门之道，传于后世，乃众弟子共同努力。"
                            }
                        ]
                    }
                ]
            },
            "zengzi": {
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️📜👴" },
                            { type: "zengzi", text: "刘君，参闻君被贬至此斗室，特来相访。虽环境简陋，然君子当有'士不可以不弘毅，任重而道远'之志。" },
                            { type: "zengzi", text: "参以为，君子之道在于内省。'吾日三省吾身：为人谋而不忠乎？与朋友交而不信乎？传不习乎？'修身之道，贵在恒常。" },
                            { type: "zengzi", text: "《大学》有云：'修身、齐家、治国、平天下'，修身乃齐家治国之本。君若能在此斗室中修得内圣，他日自能外王。" },
                            { type: "zengzi", text: "参不敢居功。孔门之道，传于后世，乃众弟子共同努力。参只是略尽绵薄，传承师训而已。"  }
                        ],
                        options: [
                            { 
                                text: "拜见曾夫子！弟子正思如何在逆境中坚守本心，请曾子指点三省之道。", 
                                style: "ru",
                                response: "善哉问也！修身之道，贵在恒常。一日之内，当问心三次：所为是否忠诚？所交是否信实？所学是否践行？如此日积月累，德行自成。"
                            },
                            { 
                                text: "曾子'吾日三省吾身'的修养功夫，弟子深感敬佩。如何将修身与济世相结合？", 
                                style: "balanced",
                                response: "修身与济世，本不相违。'修身、齐家、治国、平天下'，修身乃齐家治国之本。君若能在此斗室中正心诚意，他日必能格物致知。循序渐进，方为正道。"
                            }
                        ]
                    }
                ]
            },
            "yangxiong": {
                "3": [ // 斗室环境
                    {
                        messages: [
                            { type: "narrator", text: "🛏️🧐📚" },
                            { type: "yangxiong", text: "刘君，雄观君居此斗室，颇有古贤之风。昔年我在草亭中著《法言》，虽处僻静，却能著述立言。" },
                            { type: "yangxiong", text: "雄以为，环境简陋不足惧，心志不坚方可忧。'金经'者，圣贤之书也。君若能专心经典，虽居陋室，亦如置身圣殿。" },
                            { type: "yangxiong", text: "《法言》不过述而不作，学习先圣而已。'学者，所以修性也。'读书明理，修身正己，此乃根本。" },
                            { type: "yangxiong", text: "学而时习之，温故而知新。所学之道，当先用于修身，修身成则自能齐家，齐家成则自能治国。循序渐进，方为正道。"  }
                        ],
                        options: [
                            { 
                                text: "杨子《法言》传世，可为后学楷模。请问如何在简陋中成大业？", 
                                style: "ru",
                                response: "雄以为，环境简陋不足惧，心志不坚方可忧。'金经'者，圣贤之书也。君若能专心经典，虽居陋室，亦如置身圣殿。善哉！君能悟此理，真可谓得圣贤真传。"
                            },
                            { 
                                text: "杨子深得圣贤之道，令人景仰。如何将所学用于世间？", 
                                style: "balanced",
                                response: "君言有理。然雄以为，修身为本，致用为末。内无所修，外何所用？君若能在此斗室中正心诚意，他日必能格物致知。"
                            }
                        ]
                    }
                ]
            },
            "baijuyi": {
                "1": [ // 江边环境
                    {
                        messages: [
                            { type: "narrator", text: "🌊⛵🎵" },
                            { type: "baijuyi", text: "同是天涯沦落人，相逢何必曾相识！梦得兄，观此大江，可似吾浔阳秋荻？" },
                            { type: "baijuyi", text: "我当年贬江州司马时，常在江边听琵琶声，写下'座中泣下谁最多，江州司马青衫湿'。今见梦得被贬，深感同病相怜。" },
                            { type: "baijuyi", text: "我写《琵琶行》，不仅写琵琶女之苦，更写天下沦落人之悲。'朱门酒肉臭，路有冻死骨'，此等现实，岂能视而不见？" },
                            { type: "baijuyi", text: "文章千古事，得失寸心知。我等虽遭贬谪，然笔下文章，当为民生立言，为时代发声。此乃文人本分。" }
                        ],
                        options: [
                            { 
                                text: "乐天兄，同是贬谪人，深感'同是天涯沦落人'之慨", 
                                style: "balanced",
                                response: "梦得兄知我心！'青衫湿'者，不仅为琵琶女而泣，更为天下沦落人而悲。梦得兄能解其意，真乃知音。"
                            },
                            { 
                                text: "乐天《琵琶行》血泪文章，令人动容。我等当以笔墨记录时代", 
                                style: "du",
                                response: "正是此意！文章合为时而著，歌诗合为事而作。文章千古事，得失寸心知。我等虽遭贬谪，然笔下文章，当为民生立言，为时代发声。此乃文人本分。"
                            }
                        ]
                    }
                ]
            }
        };
    
        // 特殊组合对话，当某两个人物同时出现时触发
        const combinationDialogues = {
            "libai_du": { // 李白和杜甫的组合（修复版：在李白问问题后停止）
                messages: [
                    { type: "narrator", text: "🍷🌧️💫" },
                    { type: "libai", text: "哈哈！子美兄，别来无恙乎？看你面容消瘦，莫不是又在为那'朱门酒肉臭，路有冻死骨'忧思过度啊？" },
                    { type: "du", text: "太白兄，依旧是'嘴上雪花常不没'啊！看你脸上红光，想必又是饮酒归来？" },
                    { type: "libai", text: "子美过虑了！我知你'安得广厦千万间，大庇天下寒士俱欢颜'，心系苍生。但你看这世道，'天生我材必有用'，强求不得啊！" },
                    { type: "du", text: "太白啊，你这'仰天大笑出门去，我辈岂是蓬蒿人'的性格，真让人既羡慕又担忧。自安史之乱以来，百姓流离失所，朝廷却奢靡依旧，我夜不能寐啊。" },
                    { type: "libai", text: "子美啊，记得当年我们在洛阳邂逅，促膝长谈至天明，后又同游梁宋，把酒赋诗。你我虽'相看两不厌'，然各有志向。" },
                    { type: "du", text: "太白所言极是。你那日醉酒写下'天姥连天向天横，势拔五岳掩赤城'，气势恢宏；我则只能在茅屋中'床头屋漏无干处，雨脚如麻未断绝'。" },
                    { type: "libai", text: "子美啊子美，你总是这样自谦。正是你那'朱门酒肉臭，路有冻死骨'，才让多少读书人猛然惊醒啊！梦得兄，你说我们俩，谁的诗更得你心？" }
                ],
                // 在李白问问题后等待玩家选择
                waitForChoice: true
            },
            "confucius_yanhuei": { // 孔子和颜回的组合
                messages: [
                    { type: "confucius", text: "回，汝来此作何?" },
                    { type: "yanhuei", text: "回闻刘君被贬居此陋室，与回当年居陋巷相似，故来相访。" },
                    { type: "confucius", text: "善。见刘君身处困境，仍不失君子之风，足见其志。回，汝当思之，昔年吾问汝志，汝言何？" },
                    { type: "yanhuei", text: "回答：'不迁怒，不贰过'。老师当时颔首称许，言其难。" },
                    { type: "confucius", text: "君子不器，不以外物而移其志。回居陋巷，人皆不堪其忧，而回不改其乐，何也？" },
                    { type: "yanhuei", text: "弟子虽居陋巷，一箪食，一瓢饮，而志在四方。老师教诲：'志于道，据于德，依于仁，游于艺'，回虽不敏，日夜思之。" },
                    { type: "confucius", text: "吾与回言，终日不违，如愚。退而省其私，亦足以发。回也不愚。" },
                    { type: "yanhuei", text: "刘君，老师常言：'贫而乐，富而好礼者也'。陋室一间，苔痕上阶，草色入帘，与外物相比，不足道哉；然一经圣人居之，便有千古流芳之名。" },
                    { type: "confucius", text: "君子居之，何陋之有？德者，本也；财者，末也。外不由己，内则不可夺。刘君当修其内，而外物不足挂虑。" }
                ],
                options: [
                    { 
                        text: "能得孔圣人与颜子相访，实乃荣幸！老师以简御繁，弟子守志不移，君子之道，于此可见。", 
                        style: "ru",
                        response: "孔子目光如炬，轻叹道：'刘君深明吾意。夫子之道，忠恕而已矣。居简而行简，志高而行远。位卑未敢忘忧国，君子当如是。'"
                    },
                    { 
                        text: "拜见夫子！颜子居陋巷不改其乐，老师问而即答，师徒之道，相得益彰。使我思己身何以立世立言？", 
                        style: "ru",
                        response: "孔子端坐片刻，目光深邃：'吾少也贱，故多能鄙事。君子多乎哉？不多也。'颜回双目含泪：'回虽驽钝，蒙师教诲，死而后已。刘君若能学回之志，何愁无成？'"
                    }
                ]
            },
            // 可继续添加其他角色组合的对话...
        };
    
        // 将游戏脚本改为对象形式，以便通过小数阶段准确查找内容
        const gameScript = {
            // 0: 游戏指南结束，直接开始游戏
            "0": {
                messages: [
                    { type: "narrator", text: "游戏开始..." }
                ],
                options: [
                    { text: "开始体验", nextStage: 1, isCommand: true }
                ]
            },
            // 1: 第一处住所（江边）- 添加背景信息
            "1": {
                messages: [
                    { type: "narrator", text: "公元824年，唐朝文宗时期。" },
                    { type: "narrator", text: "你是刘禹锡，曾任监察御史，因政治原因触怒权贵。" },
                    { type: "narrator", text: "因此你被贬至安徽和州任刺史。初到和州，县令见你是被贬官员，暗中欲刁难于你。" },
                    { type: "system", text: "游戏开始，你将扮演刘禹锡，体验《陋室铭》背后的故事。你的选择将影响游戏走向和结局。" },
                    { type: "system", text: "在游戏中，你可以@不同的历史人物与他们对话。这些对话将影响你最终的《陋室铭》风格和结局。" },
                    { type: "narrator", text: "县令将你安排在城南面江而居 🌊 ⛵" },
                    { type: "countyMagistrate", text: "刘大人，下官已为您安排好住处。哈哈，虽然比不上京城的华宅，但对一个失势之人，已经算是仁至义尽了！" },
                    { type: "countyMagistrate", text: "这江边小屋，总比您这样的'大官'露宿街头强多了，不是吗？看看这景色！虽简陋，但胜在...嗯...有大江可赏！哈哈哈..." },
                    { type: "countyMagistrate", text: "人生在世，不就是要住好房子、穿好衣服吗？可惜，您现在只能将就了。下官告退！" },
                    { type: "narrator", text: "县令离开后，你环顾四周的住所。" },
                    { type: "narrator", text: "几日后，一位老友前来拜访。" },
                    { type: "liuzongyuan", text: "禹锡兄，一别经年，见你被贬至此，我特来看望。住所虽简陋，但面江而居，倒也别有一番风味。" },
                    { type: "liuzongyuan", text: "说来也奇怪，自古名士似乎都有被贬的经历。我、陶渊明、白居易、韩愈，无不如此。也许正是这种挫折，成就了他们的不朽文章。" },
                    { type: "liuyuxi", text: "无妨，面对大江观白帆，身在和州思争辩。人生起伏，岂能尽如人意？" }
                ],
                options: [
                    { 
                        text: "县令此人，见利忘义，以物质论人品，实在可叹。", 
                        response: "县令不过是俗人一个，何必放在心上？物质繁华皆为浮云。",
                        style: "tao",
                        nextStage: 1.1 
                    },
                    { 
                        text: "这江边风景倒也不错，可激发诗兴，也许这是创作的好时机。", 
                        response: "是啊，逆境反而能激发创作灵感，这是'物不因不生，水不激不跃'的道理。",
                        style: "du",
                        nextStage: 1.1 
                    },
                    { 
                        text: "窗外江景可赏，屋内可修身，这倒也是修德养性的好地方。", 
                        response: "禹锡兄深明大义！君子修身养性，不在乎外在环境。",
                        style: "ru",
                        nextStage: 1.1 
                    }
                ],
                mentionButton: true,
                environment: "1"
            },
            // 1.05: @历史人物的特殊阶段（江边环境）
            "1.05": {
                messages: [
                    { type: "narrator", text: "你在江边住所思索许久，忽然心有所感，想要与古人交流心得..." }
                ],
                special: "mentionStage",
                environment: "1", // 表示江边环境
                nextStage: 1.1 // 处理完@后去向的阶段
            },
            // Stage 1.1 - 江边思考
            "1.1": {
                messages: [
                    { type: "narrator", text: "你在江边住所中静坐沉思，望着波光粼粼的江面，思绪渐渐清明。" },
                    { type: "liuyuxi", text: "县令想用环境来限制我，却不知道心之所向，何处不是'家'？" },
                    { type: "narrator", text: "几日内，你在江边漫步，读书写字，时而与路过的渔夫交谈，感受着不同于京城的生活节奏。" }
                ],
                options: [
                    { 
                        text: "江水悠悠，白云悠悠，心亦悠悠。这些日子的思考让我看淡了许多。", 
                        style: "tao",
                        nextStage: 1.2 
                    },
                    { 
                        text: "虽身在江边，我心仍念朝堂事。这短暂的静思让我更加坚定了初心。", 
                        style: "du",
                        nextStage: 1.2 
                    },
                    { 
                        text: "这些日子的读书思考，让我对'君子居之，何陋之有'有了更深的理解。", 
                        style: "ru",
                        nextStage: 1.2 
                    },
                    {
                        text: "@历史名人...",
                        special: "mention",
                        nextStage: 1.05
                    }
                ]
            },
            // Stage 1.2 - 县令刁难，搬家
            "1.2": {
                messages: [
                    { type: "narrator", text: "数日后，县令得知你在门上写了对联，并无怨言，反而心态坦然，十分恼怒。" },
                    { type: "countyMagistrate", text: "刘大人，怎么样？上次安排的住处还满意吗？哎呀，我听说您在门上写诗，看来心情不错嘛！" },
                    { type: "countyMagistrate", text: "不过，恐怕我们的城南住处要整修一段时间了。呵呵，人嘛，哪能总待在一个地方？换个环境，才知道什么是真正的'家'啊！" },
                    { type: "countyMagistrate", text: "这次给您安排在城北德胜河边，环境...嗯...更加'清静'了，面积也更'适合'您一个人。毕竟，'金窝银窝不如自己的草窝'，您说是不是？哈哈哈！" },
                    { type: "countyMagistrate", text: "人啊，居住环境决定了他的身份地位。您从京城大宅到如今这小屋，是不是感觉人也变得...不那么重要了？告辞！" },
                    { type: "liuyuxi", text: "多谢县令大人费心，无论何处，皆可安居。" },
                    { type: "narrator", text: "县令离开后，你收拾简单的行李，前往城北的新住处。" }
                ],
                options: [
                    { text: "前往城北新住处", nextStage: 2 }
                ]
            },
            // 2: 第二处住所（柳边）
            "2": {
                messages: [
                    { type: "narrator", text: "你来到城北的德胜河边，新住处周围垂柳依依 🌳 🏞️" },
                    { type: "narrator", text: "这间房屋比之前小了近一半，但环境倒也清幽。" },
                    { type: "narrator", text: "你在安顿下来后，开始思考这次搬家的意义..." }
                ],
                options: [
                    { 
                        text: "柳边清幽，虽小却也雅致，倒也适合静心读书。", 
                        style: "tao",
                        nextStage: 2.1 
                    },
                    { 
                        text: "县令搬我至此，只会让我思考更多天下事，磨砺我的心志。", 
                        style: "du",
                        nextStage: 2.1 
                    },
                    { 
                        text: "调素琴，阅金经，正好远离尘嚣，修身养性。", 
                        style: "ru",
                        nextStage: 2.1 
                    },
                    {
                        text: "@历史名人...",
                        special: "mention",
                        nextStage: 2.05
                    }
                ]
            },
            // 2.05: @历史人物的特殊阶段（柳边环境）
            "2.05": {
                messages: [
                    { type: "narrator", text: "你在柳边新居中静思片刻，想请教古人对此环境的看法..." }
                ],
                special: "mentionStage",
                environment: "2", // 表示柳边环境
                nextStage: 2.1 // 处理完@后去向的阶段
            },
            // Stage 2.1 - 柳边思考
            "2.1": {
                messages: [
                    { type: "narrator", text: "你在柳边小屋中静坐思考，望着窗外垂柳，心中渐渐有了新的感悟。" },
                    { type: "liuyuxi", text: "从江边到柳边，县令以为能削减我的心志，不知'白云苍狗'之变，人生境遇无常，唯有内心坚守才是真。" },
                    { type: "narrator", text: "几日来，你在柳边漫步，记录所思所感，调素琴，阅金经，感受到与江边不同的闲适与宁静。" }
                ],
                options: [
                    { 
                        text: "柳色依依，小河清澈，得此静境，愈发觉物质清贫反成就了精神富足。", 
                        style: "tao",
                        nextStage: 2.2 
                    },
                    { 
                        text: "虽身在柳边，不改心系朝堂。县令欲删我锐气，却不知越是打压，志向越坚。", 
                        style: "du",
                        nextStage: 2.2 
                    },
                    { 
                        text: "素琴一张，金经几卷，足以修身养性，明心见性。无形胜有形。", 
                        style: "ru",
                        nextStage: 2.2 
                    },
                    {
                        text: "@历史名人...",
                        special: "mention",
                        nextStage: 2.05
                    }
                ]
            },
            // Stage 2.2 - 县令再次刁难，搬家
            "2.2": {
                messages: [
                    { type: "narrator", text: "不久，县令再次前来，看到你与几位名贤交谈甚欢，心中更加不快。" },
                    { type: "countyMagistrate", text: "哟，刘大人！听说您又在门上题诗了？'垂柳青青江水边，人在历阳心在京'？哼，看来您还念着京城哪！" },
                    { type: "countyMagistrate", text: "既然您心心念念都是京城，那我可不能让您住在这山清水秀的地方了！城中有间斗室，刚好空着。" },
                    { type: "countyMagistrate", text: "怎么样，这回的住处是不是更'贴心'了？哈哈哈！一床、一桌、一椅，简单明了，不就是您这种'清高'之士向往的生活吗？" },
                    { type: "countyMagistrate", text: "我就不信，搬了这么多次家，您还能若无其事！说什么'山不在高'，人嘛，终究还是要认清现实的。一个人的住所，就是他社会地位的体现！" },
                    { type: "countyMagistrate", text: "看您这斗室，连个像样的客人都接待不了，还谈什么'谈笑有鸿儒'？我看您只能自言自语了！哈哈哈！" },
                    { type: "liuyuxi", text: "如县令所愿，我这就搬去。住处虽变，心志不改。" },
                    { type: "narrator", text: "县令面带讥笑离去，你则收拾行装，前往新的住处。" }
                ],
                options: [
                    { text: "前往城中斗室", nextStage: 3 }
                ]
            },
            // 3: 第三处住所（斗室）
            "3": {
                messages: [
                    { type: "narrator", text: "你来到城中的一间斗室，这里只能容下一床、一桌、一椅 🛏️ 🪑" },
                    { type: "narrator", text: "房间虽小，但光线尚好。窗外的苔痕爬上石阶，草色映入竹帘。" },
                    { type: "narrator", text: "你细细打量着这个小小的空间，思考着县令的用意..." }
                ],
                options: [
                    { 
                        text: "斗室虽小，却有'苔痕上阶绿，草色入帘青'的雅致。空间小，反而心境开阔。", 
                        style: "tao",
                        nextStage: 3.1 
                    },
                    { 
                        text: "县令欲使我心境狭窄，却不知'会当凌绝顶，一览众山小'之志不可摧。", 
                        style: "du",
                        nextStage: 3.1 
                    },
                    { 
                        text: "君子修身养性，不问环境如何。这斗室正好'无丝竹之乱耳，无案牍之劳形'。", 
                        style: "ru",
                        nextStage: 3.1 
                    },
                    {
                        text: "@历史名人...",
                        special: "mention",
                        nextStage: 3.05
                    }
                ]
            },
            // 3.05: @历史人物的特殊阶段（斗室环境）
            "3.05": {
                messages: [
                    { type: "narrator", text: "在这斗室之中，你感到古人智慧的召唤，希望与先贤们交流心得..." }
                ],
                special: "mentionStage",
                environment: "3", // 表示斗室环境
                nextStage: 3.1 // 处理完@后去向的阶段
            },
            // Stage 3.1 - 斗室思考
            "3.1": {
                messages: [
                    { type: "narrator", text: "你在这间斗室中静思冥想，从江边到柳边再到斗室，县令认为越缩小你的空间就能限制你的思想。" },
                    { type: "narrator", text: "却不知，正如古人所言'君子居之，何陋之有'、'桃李不言，下自成蹊'，真正的价值不在外物。" },
                    { type: "liuyuxi", text: "从江边到斗室，环境越来越简陋，但我的心灵却越发清明。'苔痕上阶绿，草色入帘青'，这些细微之处，尽显生命的美好与诗意。" }
                ],
                options: [
                    { 
                        text: "县令认为环境能限制人，却不知真正的富贵在于内心的丰盈。", 
                        style: "tao",
                        nextStage: 3.2 
                    },
                    { 
                        text: "君子处困境而志不移，愈挫愈奋，这正是读书人的气节。", 
                        style: "du",
                        nextStage: 3.2 
                    },
                    { 
                        text: "物质条件有限，但精神的丰富才是真正价值所在。", 
                        style: "ru",
                        nextStage: 3.2 
                    },
                    {
                        text: "@历史名人...",
                        special: "mention",
                        nextStage: 3.05
                    }
                ]
            },
            // Stage 3.2 - 陋室铭的创作灵感
            "3.2": {
                messages: [
                    { type: "liuyuxi", text: "表面上看，我的居所确实是'陋'的：空间狭小，装饰简单，物质条件有限。" },
                    { type: "liuyuxi", text: "但从精神层面看，这个'陋室'却有着非凡的价值：'惟吾德馨'，主人品德高尚；'苔痕上阶绿，草色入帘青'，自然环境优美；'谈笑有鸿儒'，精神交流丰富。" },
                    { type: "narrator", text: "经过这段时间的历练和思考，以及与历史名人的交流，你获得了创作灵感。" },
                    { type: "liuyuxi", text: "我欲作一铭文，以明志向。这些日来的思考与交流，使我获益匪浅。" },
                    { type: "narrator", text: "你在灯下冥思苦想，提笔写下了《陋室铭》。" }
                ],
                options: [
                    { text: "写作《陋室铭》", nextStage: 4 }
                ]
            },
            // 4: 创作《陋室铭》
            "4": {
                messages: [
                    { type: "liuyuxi", text: "感谢诸位贤者指点，今日我悟得了多重道理。让我提笔写下心中所感，以记吾志。" },
                    { type: "liuyuxi", text: "山不在高，有仙则名。" },
                    { type: "tao", text: "妙哉！此句暗合我'不戚戚于贫贱，不汲汲于富贵'之意。山之名不在其高，而在有仙人居之，正如人之贵不在外物，而在内德！" },
                    { type: "du", text: "梦得此句，化用《论语》'德不孤，必有邻'之意。高山因仙人而显灵异，陋室因德者而生光辉！" },
                    { type: "liuyuxi", text: "水不在深，有龙则灵。" },
                    { type: "libai", text: "好一个对偶！山水并举，仙龙相应，气韵流转如行云流水。我曾写'黄河之水天上来'，不过写其势；梦得此句，更得其神！" },
                    { type: "wangwei", text: "山水者，天地之精华也。浅水因龙而深邃，正如禅家所言'一花一世界，一叶一菩提'。外相虽小，内蕴无穷。" },
                    { type: "liuyuxi", text: "斯是陋室，惟吾德馨。" },
                    { type: "confucius", text: "善哉！此乃全文之眼。吾尝言'君子忧道不忧贫'，今梦得以'德馨'二字，点出陋室不陋之真谛。德者，本也；室者，末也。" },
                    { type: "yanhuei", text: "'德馨'如兰在谷，不以无人而不芳。回昔居陋巷，一箪食一瓢饮，人不堪其忧，回不改其乐，正是此理。" },
                    { type: "liuyuxi", text: "苔痕上阶绿，草色入帘青。" },
                    { type: "liqingzhao", text: "此联工整如画！'苔痕上阶绿'，一个'上'字，写出苔藓慢慢爬升的动态美；'草色入帘青'，一个'入'字，仿佛春色有情，主动飞入室中。这草色青翠，倒让我忆起'梧桐更兼细雨，到黄昏、点点滴滴'，虽景不同，皆是细腻入微的观察。" },
                    { type: "sushi", text: "妙在以动写静！苔'上'阶，草'入'帘，本是静物却如有生命。这正是'江流有声，断岸千尺'的笔法——于无声处见有声，于静态中现动感！" },
                    { type: "liuyuxi", text: "谈笑有鸿儒，往来无白丁。" },
                    { type: "zhugeliang", text: "此句妙在'谈笑'二字！非正襟危坐之论道，而是轻松愉悦之交流。真正的鸿儒，当如此自然从容。吾在隆中时，也常与友人如此谈笑风生。" },
                    { type: "baijuyi", text: "'鸿儒'对'白丁'，雅俗分明。然梦得此意，非在炫耀交友之贵，而在说明志趣相投之可贵。物以类聚，人以群分，自然之理也。" },
                    { type: "liuyuxi", text: "可以调素琴，阅金经。" },
                    { type: "wangwei", text: "'素琴'与'金经'，一雅一圣，琴书并重。吾常言'独坐幽篁里，弹琴复长啸'，此'素琴'正合我意。无弦胜有弦，无声胜有声。" },
                    { type: "yangxiong", text: "'金经'者，圣贤之书也。吾著《法言》，深感经典之贵。梦得能以琴书为伴，真君子之乐也。" },
                    { type: "liuyuxi", text: "无丝竹之乱耳，无案牍之劳形。" },
                    { type: "tao", text: "深得吾心！'无丝竹之乱耳'，正如我'结庐在人境，而无车马喧'。远离尘嚣，方能静心；无案牍劳形，正如我辞彭泽县令时所求！" },
                    { type: "du", text: "此句颇有深意。'案牍劳形'四字，道尽官场辛劳。梦得虽被贬谪，却因此脱离案牍之累，反得自由，塞翁失马，焉知非福？" },
                    { type: "liuyuxi", text: "南阳诸葛庐，西蜀子云亭。" },
                    { type: "zhugeliang", text: "梦得以我隆中草庐为比，过誉了！然当年我在南阳躬耕，虽居茅庐，胸怀天下，这与梦得今日之境，确有相通之处。" },
                    { type: "yangxiong", text: "拙作《法言》多在草亭中完成，虽处僻静，却能著述立言。梦得将我与孔明并举，实不敢当，然其意甚明——陋室虽简，可成大业！" },
                    { type: "liuyuxi", text: "孔子云：何陋之有？" },
                    { type: "confucius", text: "此乃引用《论语·子罕》中吾之言也。当年我欲居九夷，或人曰陋，我答'君子居之，何陋之有？'今梦得引此结文，深得我意！君子所居，德化四方，岂有陋哉？" },
                    { type: "zengzi", text: "老师此言，正是'德不孤，必有邻'的体现。君子之德如春风化雨，所到之处，莫不感化。陋室因德者居之，便不陋矣！" },
                    { type: "liuyuxi", text: "诸位贤者之言，令我茅塞顿开。这《陋室铭》虽短短八十一字，却承载着千年文人的精神追求。" },
                    { type: "libai", text: "好文章！梦得此铭，必将流传千古！" },
                    { type: "du", text: "此文虽咏陋室，实则咏君子之德。德馨者居之，便是圣贤之境！" },
                    { type: "tao", text: "'何陋之有'四字，正是我辈文人的精神写照！" },
                    { type: "narrator", text: "你写完《陋室铭》后，将它刻成石碑，立于门前。" },
                    { type: "narrator", text: "不久，县令路过你的住处，见到石碑上的文字，驻足阅读。" },
                    { type: "countyMagistrate", text: "...山不在高，有仙则名。水不在深，有龙则灵...这...这..." },
                    { type: "countyMagistrate", text: "这...这...刘大人，没想到您...竟能写出如此警世之作！" },
                    { type: "countyMagistrate", text: "山不在高，有仙则名...是啊，一个人的价值，不在他的外在环境..." },
                    { type: "countyMagistrate", text: "我之前的想法...实在是太浅薄了。您让我明白，真正的高贵在于内心，而非外物..." },
                    { type: "countyMagistrate", text: "刘大人，请原谅我之前的无礼。从今以后，我定当改变看法，不再以外在论人品。" },
                    { type: "narrator", text: "《陋室铭》很快在文人圈中传颂，成为千古名篇，历经千年而不衰。" }
                ],
                options: [
                    { text: "结束游戏，查看结局", nextStage: 5 }
                ]
            },
            // 5: 结局选择
            "5": {
                messages: [
                    { type: "narrator", text: "通过这次游戏，你扮演刘禹锡，体验了《陋室铭》背后的故事。" },
                    { type: "narrator", text: "在与各位先贤的对话中，你展现了自己的价值观和人生态度。" },
                    { type: "narrator", text: "《陋室铭》是中国文化中'外在与内在'、'形式与本质'哲学思想的生动体现。" },
                    { type: "narrator", text: "现在，让我们来看看你的选择导向了怎样的人生哲学..." }
                ],
                options: [
                    { text: "查看我的结局", nextStage: 6 }
                ]
            }
        };

        // 结局数据
        const endings = {
            "tao": {
                title: "隐逸闲适结局",
                description: "在陋室中，你渐渐看淡了名利得失，与陶渊明一样，享受着'采菊东篱下，悠然见南山'的闲适。县令的刁难反而成了你摆脱世俗束缚的契机。你写的《陋室铭》流传后世，被视为脱离尘网、返归自然的代表作。后人称你为'第二个陶渊明'。",
                moment: {
                    content: "不为五斗米折腰，归来采菊东篱下。山不在高，有仙则名。",
                    tags: "#陋室生活 #采菊东篱",
                    likes: "陶渊明、白居易、王维、孟浩然"
                },
                comments: [
                    {
                        author: "陶渊明",
                        content: "此心安处是吾乡，不为五斗米折腰，禹锡深得我意！",
                        likes: 20,
                        replies: [
                            {
                                author: "陶渊明",
                                content: "摩诘深明吾心。你的「辋川别业」与我的「桃花源」，同是心灵栖居之所。"
                            }
                        ]
                    },
                    {
                        author: "白居易",
                        content: "「采菊东篱下，悠然见南山」的境界，几人能得？退而自适，羡矣！",
                        likes: 15
                    },
                    {
                        author: "王维",
                        content: "山水清音，远胜朝堂喧嚣！刘公此文，得山水之趣！",
                        likes: 12
                    },
                    {
                        author: "李白",
                        content: "世人笑我太疯癫，我笑世人看不穿。禹锡兄悟出了真谛！",
                        likes: 18,
                        replies: [
                            {
                                author: "杜甫",
                                content: "太白兄，自与君别后，更是「星垂平野阔，月涌大江流」，日夜思君不可得。何日再携手同行，共赏春风？"
                            },
                            {
                                author: "李白",
                                content: "子美啊！「相看两不厌，只有敬亭山」。他日纵使相逢，当与你「沽酒对饮琴台月，醉卧西窗听雨眠」，如何？"
                            }
                        ]
                    }
                ]
            },
            "du": {
                title: "家国情怀结局",
                description: "陋室中，你并未被困境击败，反而如杜甫一般，将个人困境化为对社会的关切。你的《陋室铭》成为你仕途低谷时期的代表作，但你没有停下批判的笔触。后来，你写下许多讽喻时政的作品，被后人誉为'铁肩担道义，辣手著文章'的典范。",
                moment: {
                    content: "安得广厦千万间，大庇天下寒士俱欢颜。斯是陋室，心系苍生。",
                    tags: "#铁肩担道义 #辣手著文章",
                    likes: "杜甫、诸葛亮、范仲淹、文天祥"
                },
                comments: [
                    {
                        author: "杜甫",
                        content: "安得广厦千万间，大庇天下寒士俱欢颜！禹锡深得吾心！",
                        likes: 19,
                        replies: [
                            {
                                author: "范仲淹",
                                content: "范公道出吾心。老夫穷年忧黎元，正是此意！"
                            }
                        ]
                    },
                    {
                        author: "范仲淹",
                        content: "先天下之忧而忧，后天下之乐而乐，禹锡此心，与吾道同！",
                        likes: 16
                    },
                    {
                        author: "文天祥",
                        content: "人生自古谁无死，留取丹心照汗青。敬佩刘公心系天下！",
                        likes: 14
                    },
                    {
                        author: "李白",
                        content: "子美老友最爱忧国忧民，每见你蹙眉沉思，我便想以酒相劝。今见此文，知你心有知己矣！",
                        likes: 18,
                        replies: [
                            {
                                author: "杜甫",
                                content: "太白兄，你我「携手日同行」之时，你常笑我多愁善感。然「安得广厦千万间」之言，虽为醉语，实为肺腑。见刘公此文，不觉又思念与君对酌之日。"
                            },
                            {
                                author: "李白",
                                content: "子美啊，「花间一壶酒，独酌无相亲」不如与你「醉卧沙场君莫笑」。你我虽志趣有别，然情深意重，不减当年。"
                            }
                        ]
                    }
                ]
            },
            "ru": {
                title: "儒雅修身结局",
                description: "你在陋室中潜心修德，如孔子所言'君子居之，何陋之有'。每日调素琴，阅金经，与来访的鸿儒谈笑风生。《陋室铭》成为你立德立言的体现，后人将此文与《兰亭集序》《滕王阁序》等名篇相提并论，赞叹你在逆境中彰显的君子风范。",
                moment: {
                    content: "谈笑有鸿儒，往来无白丁。无丝竹之乱耳，无案牍之劳形。",
                    tags: "#君子之居 #陋室铭",
                    likes: "孔子、杨雄、颜回、朱熹"
                },
                comments: [
                    {
                        author: "颜回",
                        content: "先生曾言「一箪食，一瓢饮，人不堪其忧，回也不改其乐」，刘公之境，与吾师教诲相通。",
                        likes: 18,
                        replies: [
                            {
                                author: "孔子",
                                content: "贤哉回也！夫子心悦诚服。刘禹锡此铭，与汝志趣相同，甚善！"
                            }
                        ]
                    },
                    {
                        author: "曾子",
                        content: "老师总是偏爱颜回啊。学生虽不如颜回贤德，但「吾日三省吾身」，也力求不负师训。",
                        likes: 12,
                        replies: [
                            {
                                author: "孔子",
                                content: "参乎！汝毋念。吾爱汝才，亦复甚也。汝传吾道，功不在回下。"
                            }
                        ]
                    },
                    {
                        author: "朱熹",
                        content: "格物致知，修身齐家，此乃君子之道。刘公此文，可为世范。",
                        likes: 14
                    },
                    {
                        author: "司马光",
                        content: "读书明理，修身正己。刘公居陋室而心不陋，可为后世楷模。",
                        likes: 12,
                        replies: [
                            {
                                author: "朱熹",
                                content: "温公所言极是。物质清贫不足惧，精神贫瘠才可悲。"
                            }
                        ]
                    }
                ]
            },
            "balanced": {
                title: "诗意人生结局",
                description: "借鉴诸位贤者的智慧，你创作出平衡了闲适与担当、修身与报国的《陋室铭》。此文既有陶渊明的超然，又有杜甫的深沉；既有孔子的儒雅，又有诸葛亮的远见。这篇短文超越了时空限制，成为千古流传的经典，影响了无数后人的人生观。",
                moment: {
                    content: "山不在高，有仙则名；水不在深，有龙则灵。人生如诗，岁月如歌。",
                    tags: "#陋室铭 #千古流传",
                    likes: "陶渊明、杜甫、孔子、诸葛亮、杨雄、王羲之、苏轼"
                },
                comments: [
                    {
                        author: "苏轼",
                        content: "人生如寄，何不一笑了之。刘兄此文，豁达中见精神，修身中见担当。",
                        likes: 24,
                        replies: [
                            {
                                author: "李清照",
                                content: "东坡兄豪放不羁，然我观此文，与君「豪放中有婉约」之风颇为相似。"
                            },
                            {
                                author: "苏轼",
                                content: "易安妹妹过奖了。「山不在高，有仙则名」一句，既有陶杜之才，又有孔孟之道，可谓中和之美。"
                            }
                        ]
                    },
                    {
                        author: "李白",
                        content: "仰天大笑出门去，我辈岂是蓬蒿人！禹锡此铭，得人生三味！",
                        likes: 20
                    },
                    {
                        author: "李清照",
                        content: "人生最难平衡，刘公做到了！隐逸与入世之间，找到恰到好处的位置。其文平和中见血性，柔美中寓刚强。",
                        likes: 18
                    },
                    {
                        author: "王羲之",
                        content: "兼济天下与独善其身，刘公此文能兼而有之，实乃大才！",
                        likes: 16,
                        replies: [
                            {
                                author: "陶渊明",
                                content: "右军书法冠绝古今，然吾辈隐士，亦有一番境界。「不为五斗米折腰」与「高山仰止」，殊途同归。"
                            }
                        ]
                    }
                ]
            }
        };

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 如果在游戏指南页面，监听开始游戏按钮
            const startGameBtn = document.getElementById('startGameBtn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    // 隐藏游戏指南页面
                    const gameGuide = document.getElementById('gameGuide');
                    gameGuide.classList.add('opacity-0');
                    setTimeout(() => {
                        gameGuide.style.display = 'none';
                        // 启动游戏
                        startGame(true); // 传入true表示从指南页面开始
                    }, 500);
                });
            } else {
                // 否则直接启动游戏
                startGame(false);
            }
        });

        // 主游戏启动函数
        function startGame(fromGuide = false) {
            // 重置游戏状态
            gameState.currentStage = 0;
            gameState.selectedOptions = [];
            gameState.stylePoints = {
                tao: 0,
                du: 0,
                ru: 0,
                balanced: 0
            };
            gameState.isShowingMessages = false;
            
            // 清空聊天容器
            chatContainer.innerHTML = '';
            
            // 如果是从指南页面开始，直接进入正式游戏
            if (fromGuide) {
                proceedToStage(1);
            } else {
                // 显示第一阶段消息
                displayMessages(gameScript["0"].messages);
            }
            
            // 重置进度条
            updateProgressBar(0);
        }

        function updateProgressBar(percentage) {
            progressBar.style.width = percentage + '%';
        }

        function updateDebugInfo() {
            if (DEBUG_MODE) {
                debugStage.textContent = gameState.currentStage;
            }
        }

        function showTypingIndicator(characterType) {
            // 修改输入提示内容为角色名
            if (characterType && gameState.characterNames[characterType]) {
                typingIndicator.textContent = `${gameState.characterNames[characterType]} 正在输入...`;
            } else {
                typingIndicator.textContent = "有人正在输入...";
            }
            
            typingIndicator.style.opacity = "1";
            
            // 较长的显示时间
            setTimeout(() => {
                typingIndicator.style.opacity = "0";
            }, 1500);
        }

        // 计算消息显示延迟的函数
        function calculateMessageDelay(message) {
            const baseDelay = 1000; // 基础延迟1秒
            const perCharDelay = 8; // 每个字符8毫秒
            
            // 基于文本长度计算延迟
            let delay = baseDelay + (message.text.length * perCharDelay);
            
            // 限制最大和最小延迟
            delay = Math.max(1500, Math.min(delay, 5000));
            
            // 角色切换额外延迟
            if (gameState.lastSpeaker && gameState.lastSpeaker !== message.type) {
                delay += 500;
            }
            
            return delay;
        }

        function displayMessages(messages, isHistoricalDialogue = false) {
            // 防止重复调用
            if (gameState.isShowingMessages) {
                return;
            }
            
            gameState.isShowingMessages = true;
            
            // 显示时间戳
            showTimeStamp();
            
            // 使用迭代方式显示消息，避免递归导致的堆栈问题
            let index = 0;
            
            function showNextMessage() {
                if (index >= messages.length) {
                    // 消息显示完毕，重置状态
                    gameState.isShowingMessages = false;
                    
                    // 如果不是历史人物对话，显示正常选项
                    if (!isHistoricalDialogue) {
                        const currentStage = gameScript[gameState.currentStage.toString()];
                        if (currentStage && currentStage.options) {
                            displayOptions(currentStage.options);
                        }
                    }
                    // 如果是历史人物对话，不自动显示选项，等待手动调用
                    return;
                }
                
                const message = messages[index];
                index++;
                
                // 系统消息直接显示
                if (message.type === "system") {
                    appendMessage(message);
                    setTimeout(showNextMessage, 500);
                    return;
                }
                
                // 显示"正在输入"指示
                if (message.type !== "narrator") {
                    showTypingIndicator(message.type);
                    
                    // 计算基于消息长度的动态延迟
                    const typingDelay = Math.min(1500, 500 + message.text.length * 2);
                    
                    setTimeout(() => {
                        appendMessage(message, true);
                        
                        // 使用动态延迟计算下一条消息的等待时间
                        const nextDelay = calculateMessageDelay(message);
                        setTimeout(showNextMessage, nextDelay);
                    }, typingDelay);
                } else {
                    // 旁白消息直接显示，但仍有延迟
                    appendMessage(message, false);
                    setTimeout(showNextMessage, 800);
                }
            }
            
            // 开始显示第一条消息
            showNextMessage();
        }
        
        // 显示时间戳
        function showTimeStamp() {
            // 只在某些情况下显示时间戳（如游戏开始、新阶段等）
            if (Math.random() > 0.7 || gameState.currentStage === 0 || 
                Number.isInteger(gameState.currentStage)) {
                const timeText = "20:15";
                
                const timeElement = document.createElement('div');
                timeElement.className = 'w-full text-center my-4';
                timeElement.innerHTML = `
                    <div class="inline-block bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full px-3 py-1 text-xs">
                        ${timeText}
                    </div>
                `;
                chatContainer.appendChild(timeElement);
            }
        }

        function appendMessage(message, withAnimation = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex mb-4';
            
            // Determine if it's a system message
            if (message.type === "system") {
                messageElement.innerHTML = `
                    <div class="mx-auto bg-gray-200 dark:bg-gray-700 rounded-lg px-4 py-2 text-sm">
                        ${message.text}
                    </div>
                `;
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return;
            }
            
            // 处理旁白消息，改为微信系统提醒样式
            if (message.type === "narrator") {
                messageElement.innerHTML = `
                    <div class="w-full text-center my-2">
                        <div class="inline-block bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-full px-4 py-1 text-sm">
                            ${message.text}
                        </div>
                    </div>
                `;
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return;
            }
            
            // Set alignment based on message type
            const isSelf = message.type === "liuyuxi";
            
            // Get emoji and character name
            const emoji = gameState.characterEmojis[message.type] || "❓";
            const name = gameState.characterNames[message.type] || message.type;
            
            // 处理格式化文本（列表项等）
            let formattedText = message.text;
            
            // 处理数字列表（如"1、2、3、"格式）
            formattedText = formattedText.replace(/(\d+)[、.：:] (.*?)(?=\n|$)/g, '<div class="mb-1"><strong>$1.</strong> $2</div>');
            
            // 给消息气泡添加已读状态（刘禹锡发出的消息）
            const readStatus = isSelf ? `<div class="text-xs text-gray-400 dark:text-gray-500 text-right mt-1">已读</div>` : '';
            
            if (isSelf) {
                messageElement.className += ' justify-end';
                messageElement.innerHTML = `
                    <div class="flex flex-col items-end mr-2 max-w-[80%]">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">${name} ${emoji}</div>
                        <div class="message-bubble self bg-bubble-self dark:bg-bubble-self-dark rounded-lg px-4 py-2 leading-relaxed">
                            ${formattedText}
                        </div>
                        ${readStatus}
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="flex flex-col mr-2 max-w-[80%]">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">${emoji} ${name}</div>
                        <div class="message-bubble other bg-bubble-other dark:bg-bubble-other-dark rounded-lg px-4 py-2 shadow-sm leading-relaxed">
                            ${formattedText}
                        </div>
                    </div>
                `;
            }
            
            // Add subtle animation for new messages
            messageElement.className += ' fade-in';
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            gameState.lastSpeaker = message.type;
        }

        function displayOptions(options) {
            // Clear current options
            optionsList.innerHTML = '';
            
            // Add each option as a button
            options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.className = 'bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                optionButton.textContent = option.text;
                
                optionButton.addEventListener('click', () => {
                    handleOptionSelect(option, index);
                });
                
                optionsList.appendChild(optionButton);
            });
            
            // Show options container with animation
            optionsContainer.classList.remove('translate-y-full');
        }

        function handleOptionSelect(option, index) {
            // 如果正在显示消息，忽略用户点击
            if (gameState.isShowingMessages) {
                return;
            }
            
            // Hide options container
            optionsContainer.classList.add('translate-y-full');
            
            // 特殊处理@历史人物选项
            if (option.special === "mention") {
                showMentionInterface();
                return;
            }
            
            // 记录选择的选项
            gameState.selectedOptions.push(index);
            
            // 更新风格分数（如果有）
            if (option.style) {
                gameState.stylePoints[option.style] += 1;
            }
            
            // 处理指令性选项（不作为刘禹锡的对话显示）
            if (option.isCommand) {
                // 指令性选项直接作为系统消息显示
                const commandMessage = {
                    type: "narrator",
                    text: option.text
                };
                appendMessage(commandMessage);
                
                // 稍作延迟后进入下一阶段
                setTimeout(() => {
                    proceedToStage(option.nextStage);
                }, 800);
                return;
            }
            
            // 普通选项作为刘禹锡的对话显示
            const playerMessage = {
                type: "liuyuxi",
                text: option.text
            };
            appendMessage(playerMessage);
            
            // 如果有响应，显示它
            if (option.response) {
                setTimeout(() => {
                    const responseMessage = {
                        type: gameState.lastSpeaker || "narrator",
                        text: option.response
                    };
                    appendMessage(responseMessage, true);
                    
                    // 响应后进入下一阶段
                    setTimeout(() => {
                        proceedToStage(option.nextStage);
                    }, 800);
                    
                }, 500);
            } else {
                // 直接进入下一阶段
                setTimeout(() => {
                    proceedToStage(option.nextStage);
                }, 500);
            }
        }
        

        
        // 关闭@界面
        function closeMentionInterface() {
            const mentionInterface = document.getElementById('mentionInterface');
            if (mentionInterface) {
                mentionInterface.style.transform = 'translateY(100%)';
                
                // 动画结束后移除元素
                setTimeout(() => {
                    mentionInterface.remove();
                    
                    // 重新显示选项
                    const currentStageObj = gameScript[gameState.currentStage.toString()];
                    if (currentStageObj && currentStageObj.options) {
                        displayOptions(currentStageObj.options);
                    }
                }, 300);
            }
        }
        
        // 处理用户选择@某个角色（移除@次数限制，添加感悟系统）
        function handleCharacterMention(characterId, environment) {
            // 关闭@界面
            closeMentionInterface();
            
            // 添加@消息
            const mentionMessage = {
                type: "liuyuxi",
                text: `@${gameState.characterNames[characterId]}`
            };
            appendMessage(mentionMessage);
            
            // 记录已@过的角色
            gameState.mentionedCharacters.push(characterId);
            
            // 为与角色交流增加基础感悟值
            addEnlightenmentFromCharacter(characterId);
            
            // 检查是否有解锁新角色
            const charInfo = gameState.characterInfo[characterId];
            if (charInfo && charInfo.unlocks && charInfo.unlocks.length > 0) {
                charInfo.unlocks.forEach(newCharId => {
                    if (!gameState.unlockedCharacters.includes(newCharId)) {
                        gameState.unlockedCharacters.push(newCharId);
                        // 显示解锁提示
                        setTimeout(() => {
                            const unlockMessage = {
                                type: "system",
                                text: `你已解锁新角色：${gameState.characterNames[newCharId]}（${gameState.characterInfo[newCharId].style}）`
                            };
                            appendMessage(unlockMessage);
                        }, 1000);
                    }
                });
            }
            
            // 检查是否有已@人物组合
            const mentionedChars = [...gameState.mentionedCharacters]; // 复制一份，不修改原数组
            if (mentionedChars.length >= 2) {
                // 检查最后两个@的人物是否构成组合
                const lastChar = mentionedChars.pop();
                const secondLastChar = mentionedChars.pop();
                
                const combinationKey1 = `${lastChar}_${secondLastChar}`;
                const combinationKey2 = `${secondLastChar}_${lastChar}`;
                
                if (combinationDialogues[combinationKey1] || combinationDialogues[combinationKey2]) {
                    // 如果有组合对话，则显示组合对话
                    const combinationKey = combinationDialogues[combinationKey1] ? combinationKey1 : combinationKey2;
                    displayCombinationDialogue(combinationKey, environment);
                    return;
                }
            }
            
            // 正常显示单个角色的对话
            displayCharacterDialogue(characterId, environment);
        }
        
        // 获取下一个反思阶段
        function getNextReflectionStage() {
            const currentEnv = Math.floor(gameState.currentStage);
            
            // 根据当前环境决定下一个反思阶段
            if (currentEnv === 1) {
                return 1.1; // 江边思考阶段
            } else if (currentEnv === 2) {
                return 2.1; // 柳边思考阶段
            } else if (currentEnv === 3) {
                return 3.1; // 斗室思考阶段
            }
            
            // 默认继续当前阶段
            return gameState.currentStage;
        }
        
        // 智能容错系统
        function handleDialogueError(characterId, choiceId, context) {
            // 1. 尝试智能兜底
            const fallback = generateSmartFallback(characterId, choiceId);
            
            // 2. 安排救场角色
            const rescuer = selectRescueCharacter(context.availableCharacters);
            
            // 3. 自然过渡回主线
            const fallbackMessage = {
                type: characterId,
                text: fallback
            };
            appendMessage(fallbackMessage, true);
            
            if (rescuer) {
                setTimeout(() => {
                    const rescueMessage = {
                        type: rescuer,
                        text: generateRescueDialogue(rescuer)
                    };
                    appendMessage(rescueMessage, true);
                    
                    // 回到主线
                    setTimeout(() => {
                        proceedToStage(gameState.currentStage);
                    }, 1000);
                }, 800);
            } else {
                setTimeout(() => {
                    proceedToStage(gameState.currentStage);
                }, 1000);
            }
        }

        function generateSmartFallback(characterId, choiceId) {
            if (fallbackResponses[characterId]) {
                const responses = fallbackResponses[characterId];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            return "各有所见，方为大道之美。";
        }

        function selectRescueCharacter(availableCharacters) {
            // 优先选择活跃角色如李白来救场
            if (availableCharacters && availableCharacters.includes("libai")) {
                return "libai";
            }
            if (availableCharacters && availableCharacters.includes("du")) {
                return "du";
            }
            return null;
        }

        function generateRescueDialogue(rescuerId) {
            const rescueDialogues = {
                "libai": [
                    "哈哈！诸位谈得热烈，我也来凑个热闹！",
                    "梦得兄，我有不同看法！",
                    "刘兄的话让我想起一段往事..."
                ],
                "du": [
                    "让我从另一个角度来看这个问题...",
                    "子美有话要说。"
                ]
            };
            
            const dialogues = rescueDialogues[rescuerId] || ["有朋友想要插话..."];
            return dialogues[Math.floor(Math.random() * dialogues.length)];
        }

        // 感悟系统实现
        function addEnlightenmentFromCharacter(characterId) {
            const characterInfo = gameState.characterInfo[characterId];
            if (!characterInfo) return;
            
            // 根据角色风格增加相应感悟值
            switch(characterInfo.style) {
                case "隐逸派":
                    enlightenmentSystem.philosophical += 2;
                    enlightenmentSystem.emotional += 1;
                    break;
                case "家国派":
                    enlightenmentSystem.practical += 2;
                    enlightenmentSystem.emotional += 1;
                    break;
                case "儒家派":
                    enlightenmentSystem.philosophical += 1;
                    enlightenmentSystem.practical += 1;
                    break;
                case "综合派":
                    enlightenmentSystem.artistic += 2;
                    enlightenmentSystem.emotional += 1;
                    break;
                default:
                    enlightenmentSystem.philosophical += 1;
            }
            
            // 更新心态状态
            updateMentalState();
        }

        // 心态成长检测系统
        function updateMentalState() {
            // 计算总启发值
            totalEnlightenment = Object.values(enlightenmentSystem).reduce((sum, val) => sum + val, 0);
            
            // 根据启发值更新心态
            if (totalEnlightenment >= 15) {
                currentMentalState = "enlightened_transcendent";
            } else if (totalEnlightenment >= 8) {
                currentMentalState = "adapting_reflecting";
            } else {
                currentMentalState = "confused_angry";
            }
            
            // 检查是否需要推进剧情
            checkMentalStateProgression();
        }

        // 新增：检查是否正在进行历史人物对话
        function isInHistoricalDialogue() {
            // 检查是否有历史人物交流菜单界面
            const historicalChatMenu = document.getElementById('historicalChatMenu');
            if (historicalChatMenu) {
                return true;
            }
            
            // 检查是否有mention界面
            const mentionInterface = document.getElementById('mentionInterface');
            if (mentionInterface) {
                return true;
            }
            
            // 检查选项容器是否包含历史人物对话选项（蓝色背景）
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer && !optionsContainer.classList.contains('translate-y-full')) {
                const firstOption = optionsContainer.querySelector('button');
                if (firstOption && firstOption.classList.contains('bg-blue-50')) {
                    return true;
                }
            }
            
            return false;
        }

        function checkMentalStateProgression() {
            const currentStageNum = Math.floor(gameState.currentStage);
            
            // 检查是否正在进行历史人物对话
            if (isInHistoricalDialogue()) {
                debugLog('正在进行历史人物对话，推迟县令剧情推进');
                return; // 如果正在对话，推迟县令剧情
            }
            
            // 江边→柳边 (心态从愤怒转向思考)
            if (currentStageNum === 1 && currentMentalState === "adapting_reflecting" && totalEnlightenment >= 8) {
                triggerCountyMagistrateProgression("江边到柳边", "怎么还这么淡定？继续加码！");
            }
            
            // 柳边→斗室 (心态趋于平静)
            if (currentStageNum === 2 && currentMentalState === "enlightened_transcendent" && totalEnlightenment >= 15) {
                triggerCountyMagistrateProgression("柳边到斗室", "竟然还能谈笑风生？看我最后一招！");
            }
        }

        // 新增：检查县令剧情推进而不是直接回到菜单或显示选项
        function checkCountyMagistrateProgression() {
            const currentStageNum = Math.floor(gameState.currentStage);
            
            // 检查是否正在进行历史人物对话
            if (isInHistoricalDialogue()) {
                debugLog('正在进行历史人物对话，推迟县令剧情推进');
                return; // 如果正在对话，推迟县令剧情
            }
            
            // 定义推进阈值（降低要求，确保能顺利推进）
            const progressThresholds = {
                1: 5,  // 江边→柳边，启发值要求降低到5
                2: 10, // 柳边→斗室，启发值要求降低到10  
                3: 15  // 斗室→创作，启发值要求15
            };
            
            // 检查是否满足推进条件
            if (currentStageNum === 1 && totalEnlightenment >= progressThresholds[1]) {
                debugLog('满足江边→柳边推进条件', { totalEnlightenment, required: progressThresholds[1] });
                triggerCountyMagistrateProgression("江边到柳边", "怎么还这么淡定？继续加码！");
                return;
            }
            
            if (currentStageNum === 2 && totalEnlightenment >= progressThresholds[2]) {
                debugLog('满足柳边→斗室推进条件', { totalEnlightenment, required: progressThresholds[2] });
                triggerCountyMagistrateProgression("柳边到斗室", "竟然还能谈笑风生？看我最后一招！");
                return;
            }
            
            // 如果不满足推进条件，返回历史人物交流主菜单
            debugLog('未满足推进条件，返回历史人物交流主菜单', { 
                currentStageNum, 
                totalEnlightenment, 
                required: progressThresholds[currentStageNum] 
            });
            
            setTimeout(() => {
                const currentEnv = currentStageNum.toString();
                showHistoricalChatMenu(currentEnv);
            }, 1000);
        }

        function triggerCountyMagistrateProgression(transitionType, magistrateThought) {
            // 县令观察到刘禹锡的心态变化
            setTimeout(() => {
                const progressMessage = {
                    type: "narrator",
                    text: `县令观察到你的心态变化，心想："${magistrateThought}"`
                };
                appendMessage(progressMessage);
                
                // 自动推进到下一住所
                setTimeout(() => {
                    if (transitionType === "江边到柳边") {
                        proceedToStage(1.2);
                    } else if (transitionType === "柳边到斗室") {
                        proceedToStage(2.2);
                    }
                }, 1000);
            }, 2000);
        }

        // 分段式对话处理
        function displaySegmentedDialogue(segmentKey) {
            debugLog(`显示分段对话`, { segmentKey });
            
            const segment = segmentedDialogues[segmentKey];
            if (!segment) {
                debugError(`分段对话不存在`, segmentKey);
                // 容错处理
                handleDialogueError("unknown", null, { availableCharacters: gameState.unlockedCharacters });
                return;
            }
            
            debugLog(`分段对话数据`, segment);
            
            // 显示分段对话 - 关键修复：传递isHistoricalDialogue=true
            displayMessages(segment.messages, true);
            
            // 处理启发值
            if (segment.enlightenment) {
                Object.keys(segment.enlightenment).forEach(key => {
                    enlightenmentSystem[key] += segment.enlightenment[key];
                });
                updateMentalState();
            }
            
            // 处理选项 - 改用waitForMessagesComplete确保消息显示完成
            waitForMessagesComplete(() => {
                debugLog(`消息显示完成，准备显示选项`);
                if (segment.options) {
                    // 为选项添加分段跳转逻辑 - 关键修复：添加environment参数
                    const enhancedOptions = segment.options.map(option => {
                        return {
                            ...option,
                            nextStage: gameState.currentStage,
                            segmentNext: option.nextSegment,
                            isSegmentedOption: true, // 标记为分段选项
                            characterId: segment.character, // 确保传递角色ID
                            environment: segment.environment // 关键修复：传递环境参数
                        };
                    });
                    
                    debugLog(`准备显示增强选项`, enhancedOptions);
                    // 使用蓝色背景的历史人物对话选项界面
                    displayCharacterDialogueOptions(enhancedOptions);
                } else {
                    // 即使没有选项，也要等待玩家选择继续
                    const continueOptions = [
                        { 
                            text: "继续与此人对话...", 
                            nextStage: gameState.currentStage,
                            isCommand: true,
                            characterId: segment.character, // 确保传递角色ID
                            environment: segment.environment // 关键修复：传递环境参数
                        }
                    ];
                    debugLog(`显示继续选项`, continueOptions);
                    displayCharacterDialogueOptions(continueOptions);
                }
                
                // 检查是否有群聊触发
                if (segment.triggerGroups) {
                    setTimeout(() => {
                        checkGroupChatTriggers(segment.triggerGroups);
                    }, 2000);
                }
            });
        }

        // 删除displaySegmentedOptions函数，统一使用蓝色背景的displayCharacterDialogueOptions

        function handleSegmentedOptionSelect(option, index) {
            // 隐藏选项容器
            optionsContainer.classList.add('translate-y-full');
            
            // 显示刘禹锡的回应
            const playerMessage = {
                type: "liuyuxi",
                text: option.text
            };
            appendMessage(playerMessage);
            
            // 更新风格分数
            if (option.style) {
                gameState.stylePoints[option.style] += 1;
            }
            
            // 处理启发值
            if (option.enlightenment) {
                Object.keys(option.enlightenment).forEach(key => {
                    enlightenmentSystem[key] += option.enlightenment[key];
                });
                updateMentalState();
            }
            
            // 如果有下一段，显示下一段
            if (option.segmentNext) {
                setTimeout(() => {
                    displaySegmentedDialogue(option.segmentNext);
                }, 800);
            } else {
                // 分段对话结束，先让玩家确认是否结束此轮@历史人物阶段
                setTimeout(() => {
                    const continueOptions = [
                        { 
                            text: "结束与历史人物的交流，开始独白思考", 
                            nextStage: getNextReflectionStage(),
                            isCommand: true 
                        },
                        {
                            text: "@其他历史名人...",
                            special: "mention",
                            nextStage: gameState.currentStage
                        }
                    ];
                    displayOptions(continueOptions);
                }, 800);
            }
        }

        function checkGroupChatTriggers(triggerGroups) {
            // 检查是否满足群聊触发条件
            triggerGroups.forEach(triggerGroup => {
                if (segmentedDialogues[triggerGroup]) {
                    // 随机决定是否触发
                    if (Math.random() > 0.5) {
                        setTimeout(() => {
                            displaySegmentedDialogue(triggerGroup);
                        }, 1000);
                    }
                }
            });
        }

        // 等待消息显示完毕的辅助函数
        function waitForMessagesComplete(callback) {
            try {
                if (!callback || typeof callback !== 'function') {
                    console.error('waitForMessagesComplete: callback is not a function');
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    try {
                        if (!gameState.isShowingMessages) {
                            clearInterval(checkInterval);
                            callback();
                        }
                    } catch (error) {
                        console.error('Error in waitForMessagesComplete check:', error);
                        clearInterval(checkInterval);
                    }
                }, 100);
                
                // 添加超时保护，防止无限等待
                setTimeout(() => {
                    try {
                        clearInterval(checkInterval);
                        if (gameState.isShowingMessages) {
                            console.warn('waitForMessagesComplete: timeout, forcing callback execution');
                            gameState.isShowingMessages = false;
                            callback();
                        }
                    } catch (error) {
                        console.error('Error in waitForMessagesComplete timeout:', error);
                    }
                }, 10000); // 10秒超时
            } catch (error) {
                console.error('Error in waitForMessagesComplete setup:', error);
                if (callback && typeof callback === 'function') {
                    callback();
                }
            }
        }

        // 全局错误捕获和调试函数
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                if (data && typeof data === 'object') {
                    console.log(`[DEBUG] ${message}`, JSON.stringify(data, null, 2));
                } else {
                    console.log(`[DEBUG] ${message}`, data || '');
                }
            }
        }

        function debugError(message, error = null) {
            console.error(`[ERROR] ${message}`, error || '');
            
            // 显示用户友好的错误信息
            if (DEBUG_MODE) {
                const errorMessage = {
                    type: "system",
                    text: `调试信息: ${message} ${error ? error.toString() : ''}`
                };
                appendMessage(errorMessage);
            }
        }

        // 全局错误处理器
        window.addEventListener('error', function(event) {
            console.error('=== 全局JavaScript错误详情 ===');
            console.error('错误消息:', event.message);
            console.error('文件名:', event.filename);
            console.error('行号:', event.lineno);
            console.error('列号:', event.colno);
            console.error('错误对象:', event.error);
            if (event.error && event.error.stack) {
                console.error('堆栈跟踪:', event.error.stack);
            }
            console.error('=== 错误详情结束 ===');
            
            debugError('全局JavaScript错误', `${event.message} at ${event.filename}:${event.lineno}:${event.colno}`);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('=== 未处理的Promise拒绝 ===');
            console.error('拒绝原因:', event.reason);
            if (event.reason && event.reason.stack) {
                console.error('堆栈跟踪:', event.reason.stack);
            }
            console.error('=== Promise拒绝详情结束 ===');
            
            debugError('未处理的Promise拒绝', event.reason);
        });

        // 显示单个角色的对话（完全重构版 + 调试版 + 防重复调用）
        function displayCharacterDialogue(characterId, environment, isNewConversation = true) {
            try {
                // 防重复调用保护
                if (gameState.isShowingMessages) {
                    debugLog('正在显示消息，忽略重复调用');
                    return;
                }
                
                debugLog(`开始显示角色对话`, { characterId, environment, isNewConversation });
                
                // 参数验证
                if (!characterId) {
                    debugError('characterId 参数为空');
                    handleDialogueError('unknown', null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (!environment) {
                    debugError('environment 参数为空');
                    // 尝试从当前阶段推断环境
                    environment = Math.floor(gameState.currentStage).toString();
                    debugLog(`推断环境参数为`, environment);
                    
                    if (!environment || environment === "0") {
                        handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                        return;
                    }
                }
                
                // 确保environment是字符串
                environment = environment.toString();
                debugLog(`处理后的环境参数`, environment);
                
                // 如果是继续对话，直接生成新的对话内容
                if (!isNewConversation) {
                    debugLog('继续对话模式');
                    generateContinuedDialogue(characterId, environment);
                    return;
                }
                
                // 首先尝试分段式对话
                const segmentKey = `${characterId}_segment1`;
                debugLog(`查找分段对话`, segmentKey);
                
                // 检查分段对话是否存在且环境匹配
                if (segmentedDialogues && segmentedDialogues[segmentKey]) {
                    debugLog(`找到分段对话`, segmentedDialogues[segmentKey]);
                    // 检查环境匹配（字符串比较）
                    if (segmentedDialogues[segmentKey].environment === environment) {
                        debugLog(`环境匹配，开始分段对话`);
                        return displaySegmentedDialogue(segmentKey);
                    } else {
                        debugLog(`环境不匹配`, { 
                            expected: segmentedDialogues[segmentKey].environment, 
                            actual: environment 
                        });
                    }
                } else {
                    debugLog(`未找到分段对话`, segmentKey);
                }
                
                // 如果没有分段对话，尝试传统对话
                debugLog(`尝试传统对话系统`);
                
                // 安全检查characterDialogues
                if (!characterDialogues) {
                    debugError('characterDialogues 对象不存在');
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (!characterDialogues[characterId]) {
                    debugError(`角色 ${characterId} 的对话数据不存在`);
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (!characterDialogues[characterId][environment]) {
                    debugError(`角色 ${characterId} 在环境 ${environment} 的对话数据不存在`);
                    debugLog('可用环境列表', Object.keys(characterDialogues[characterId] || {}));
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                // 获取对话内容
                const dialogues = characterDialogues[characterId][environment];
                debugLog(`获取到的对话数据`, dialogues);
                
                // 安全检查dialogues数组
                if (!Array.isArray(dialogues)) {
                    debugError(`对话数据不是数组`, typeof dialogues);
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (dialogues.length === 0) {
                    debugError(`对话数组为空`);
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                // 随机选择一组对话
                const randomIndex = Math.floor(Math.random() * dialogues.length);
                const dialogue = dialogues[randomIndex];
                debugLog(`选择的对话索引和内容`, { randomIndex, dialogue });
                
                // 安全检查dialogue对象
                if (!dialogue) {
                    debugError(`对话对象为空`, { randomIndex, dialoguesLength: dialogues.length });
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (!dialogue.messages) {
                    debugError(`对话对象缺少 messages 属性`, dialogue);
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                if (!Array.isArray(dialogue.messages)) {
                    debugError(`dialogue.messages 不是数组`, typeof dialogue.messages);
                    handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    return;
                }
                
                debugLog(`准备显示消息`, dialogue.messages);
                
                // 显示对话，但不自动显示选项，等待消息显示完成
                displayMessages(dialogue.messages, true); // 标记为历史人物对话
                
                // 记录对话中的角色风格并添加启发值
                if (gameState.characterInfo && gameState.characterInfo[characterId]) {
                    const style = gameState.characterInfo[characterId].style;
                    debugLog(`角色风格`, { characterId, style });
                    
                    // 根据风格增加相应分数
                    if (style === "隐逸派") {
                        gameState.stylePoints.tao += 1;
                        enlightenmentSystem.philosophical += 2;
                    } else if (style === "家国派") {
                        gameState.stylePoints.du += 1;
                        enlightenmentSystem.practical += 2;
                    } else if (style === "儒家派") {
                        gameState.stylePoints.ru += 1;
                        enlightenmentSystem.philosophical += 1;
                        enlightenmentSystem.practical += 1;
                    } else if (style === "综合派") {
                        gameState.stylePoints.balanced += 1;
                        enlightenmentSystem.artistic += 2;
                    }
                    
                    // 更新心态状态
                    updateMentalState();
                } else {
                    debugError(`角色信息不存在`, { characterId, hasCharacterInfo: !!gameState.characterInfo });
                }
                
                // 等待消息显示完成后显示选项
                debugLog(`等待消息显示完成`);
                waitForMessagesComplete(() => {
                    debugLog(`消息显示完成，准备显示选项`);
                    try {
                        showCharacterResponseOptions(characterId, environment, dialogue);
                    } catch (error) {
                        debugError('显示角色回应选项时出错', error);
                        handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
                    }
                });
                
            } catch (error) {
                debugError('displayCharacterDialogue 函数执行出错', error);
                handleDialogueError(characterId, null, { availableCharacters: gameState.unlockedCharacters });
            }
        }
        
        // 新增：生成继续对话的内容
        function generateContinuedDialogue(characterId, environment) {
            // 生成新的对话内容，避免重复
            const continuedTopics = getContinuedTopics(characterId, environment);
            const topic = continuedTopics[Math.floor(Math.random() * continuedTopics.length)];
            
            // 显示刘禹锡的话题引入
            const playerMessage = {
                type: "liuyuxi",
                text: topic.playerText
            };
            appendMessage(playerMessage);
            
            // 然后显示历史人物的回应
            setTimeout(() => {
                const characterResponse = {
                    type: characterId,
                    text: topic.characterResponse
                };
                appendMessage(characterResponse, true);
                
                // 显示后续选项，确保等待用户操作 - 修复：使用具体选项而非通用选项
                waitForMessagesComplete(() => {
                    // 获取具体的下一轮对话选项
                    const nextTopics = getNextDialogueOptions(characterId, environment);
                    const followUpOptions = [
                        ...nextTopics, // 具体的对话选项
                        { 
                            text: "感谢指点，结束对话", 
                            isEndDialogue: true,
                            nextStage: gameState.currentStage 
                        }
                    ];
                    displayCharacterDialogueOptions(followUpOptions);
                });
            }, 1000);
        }
        
        // 新增：获取继续对话的话题
        function getContinuedTopics(characterId, environment) {
            const topics = {
                "tao": [
                    {
                        playerText: "先生的田园生活让我很向往，可否详细说说？",
                        characterResponse: "田园之乐在于顺应自然。春种秋收，夏耕冬藏，日出而作，日落而息，此乃天地之常道。"
                    },
                    {
                        playerText: "陶公，您觉得我该如何在这困境中保持内心平静？", 
                        characterResponse: "心远地自偏，境由心转。外在困厄不过是皮相，内心充实方为根本。"
                    },
                    {
                        playerText: "先生当年辞官归隐，可曾后悔过？",
                        characterResponse: "悔乎？不悔也。官场如樊笼，归田得自由。虽贫而乐，胜富而忧也。"
                    }
                ],
                "du": [
                    {
                        playerText: "子美兄，您如何看待我们读书人的责任？",
                        characterResponse: "读书明理，当以天下为己任。虽身微言轻，然一支笔，胜千军万马。"
                    },
                    {
                        playerText: "在这乱世中，个人的力量真的有用吗？",
                        characterResponse: "滴水虽微，汇成江海；个人虽渺，可化民风。不以善小而不为，积小成大，终可成事。"
                    },
                    {
                        playerText: "子美兄经历了这么多苦难，还能保持理想吗？",
                        characterResponse: "苦难是磨刀石，越磨越锋利。我之诗句，皆从苦难中来，为苍生而作。"
                    }
                ],
                "libai": [
                    {
                        playerText: "太白兄的豪迈让我佩服，可否传授一二？",
                        characterResponse: "豪迈非学而得，乃天性使然。人生苦短，何不痛快淋漓？醉也好，醒也好，总要活个明白！"
                    },
                    {
                        playerText: "您觉得什么才是真正的自由？", 
                        characterResponse: "自由者，心无拘束也。天地为庐，江河为酒，明月为友，何拘何束？"
                    },
                    {
                        playerText: "太白兄，您如何看待功名利禄？",
                        characterResponse: "功名如浮云，转眼即逝。真正不朽的，是那些能感动人心的诗篇。"
                    }
                ],
                "confucius": [
                    {
                        playerText: "夫子，如何才能在逆境中不改其志？",
                        characterResponse: "志者，心之所向也。外境虽变，内心不移。君子固穷，小人穷斯滥矣。"
                    },
                    {
                        playerText: "什么是真正的君子？",
                        characterResponse: "君子怀德，小人怀土。君子喻于义，小人喻于利。内修其德，外化于行，是为君子。"
                    },
                    {
                        playerText: "夫子，如何处理与小人的关系？",
                        characterResponse: "君子和而不同，小人同而不和。对小人，敬而远之，不必深交，但也无需结怨。"
                    }
                ],
                "sushi": [
                    {
                        playerText: "东坡先生，您如何在逆境中保持乐观？",
                        characterResponse: "逆境是人生的调味料，没有它，人生就太平淡了。换个角度看，坏事也能变好事。"
                    },
                    {
                        playerText: "先生觉得什么是人生最重要的？",
                        characterResponse: "是经历，是感悟，是那些能让你会心一笑的瞬间。其他的，都是过眼云烟。"
                    },
                    {
                        playerText: "您对年轻人有什么建议？",
                        characterResponse: "多读书，多行路，多思考。别太在意一时的得失，人生很长，起伏是常态。"
                    }
                ]
            };
            
            // 如果没有找到对应角色，返回通用话题
            return topics[characterId] || [
                {
                    playerText: "先生，您对我的处境有何看法？",
                    characterResponse: "各有际遇，各有所悟。重要的是从中学到什么，而不是抱怨什么。"
                }
            ];
        }
        
        // 新增：显示角色回应选项（统一蓝色界面）
        function showCharacterResponseOptions(characterId, environment, dialogue) {
            const dialogueOptions = [];
            
            // 如果有预设选项，使用预设选项
            if (dialogue.options && dialogue.options.length > 0) {
                dialogue.options.forEach(option => {
                    dialogueOptions.push({
                        ...option,
                        isDialogueOption: true,
                        characterId: characterId,
                        environment: environment
                    });
                });
            } else {
                // 如果没有预设选项，提供通用选项
                dialogueOptions.push({
                    text: "继续与此人深入交流",
                    isDialogueOption: true,
                    characterId: characterId,
                    environment: environment,
                    response: generateGenericResponse(characterId)
                });
            }
            
            // 始终添加结束对话的选项
            dialogueOptions.push({
                text: "感谢指点，结束与此人的对话",
                isEndDialogue: true,
                nextStage: gameState.currentStage
            });
            
            // 统一使用蓝色背景界面
            displayCharacterDialogueOptions(dialogueOptions);
        }
        
        // 新增：生成通用回应
        function generateGenericResponse(characterId) {
            const genericResponses = {
                "tao": "梦得言之有理，各有所思，各有所悟。归隐田园，自有一番天地。",
                "du": "子美深感刘兄之言，虽见解不同，然君子和而不同。忧国忧民，乃我辈本分。",
                "libai": "哈哈！梦得兄妙语连珠，不愧是诗人本色！此言有趣，让我想起一段往事...",
                "confucius": "君子和而不同，刘君此言，亦有道理。各有所见，方为大道之美。",
                "sushi": "刘兄此言甚妙，让我想起在黄州时的感悟...",
                "wangwei": "梦得所言，颇有禅意。山水清音，各有所悟。",
                "liqingzhao": "刘兄见解独到，小女子深表赞同。",
                "yanhuei": "刘君之言，与夫子教诲相通，甚善。",
                "zhugeliang": "梦得兄见识深远，亮深表敬佩。",
                "baijuyi": "同是天涯沦落人，刘兄此言，深得我心。",
                "zengzi": "刘君所言，与圣人之道相合，甚为难得。",
                "yangxiong": "梦得此见，与吾《法言》所述相通，善哉。"
            };
            
            return genericResponses[characterId] || "各有所见，方为大道之美。梦得此言，让我深思。";
        }
        
        // 新增：显示与历史人物的对话选项（独立界面）
        function displayCharacterDialogueOptions(options) {
            // 清空选项列表
            optionsList.innerHTML = '';
            
            // 为每个选项创建按钮
            options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.className = 'bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg shadow-sm border border-blue-200 dark:border-blue-800 text-left hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors';
                optionButton.textContent = option.text;
                
                // 确保等待机制：禁用自动延时，完全由用户控制
                optionButton.addEventListener('click', () => {
                    // 检查是否正在显示消息，如果是则忽略点击
                    if (gameState.isShowingMessages) {
                        return;
                    }
                    handleCharacterDialogueOption(option, index);
                });
                
                optionsList.appendChild(optionButton);
            });
            
            // 显示选项容器
            optionsContainer.classList.remove('translate-y-full');
        }

        // 新增：显示李杜选择界面
        function showLibaiDuChoiceOptions() {
            // 创建李杜选择选项
            const libaoDuChoices = [
                {
                    text: "太白兄的豪放飘逸更合我意，'天生我材必有用，千金散尽还复来'！",
                    style: "balanced",
                    characterResponse: "libai",
                    response: "哈哈！梦得兄知音也！'仰天大笑出门去，我辈岂是蓬蒿人'！来，共饮此杯！"
                },
                {
                    text: "子美兄的忧国忧民更打动我心，'安得广厦千万间，大庇天下寒士俱欢颜'！",
                    style: "du", 
                    characterResponse: "du",
                    response: "梦得兄深得我心！笔墨当随时代，文章合为时而著！此心此志，与君共勉！"
                },
                {
                    text: "二位才情横溢，各有千秋！太白如江河奔腾，子美似泰山巍峨，皆为诗坛双璧！",
                    style: "balanced",
                    characterResponse: "both", 
                    response: "李白杜甫相视而笑，李白举杯：'梦得兄胸襟广阔！'杜甫点头：'诗道百川，殊途同归！'"
                }
            ];
            
            // 处理每个选项添加结束标记
            const enhancedChoices = libaoDuChoices.map(choice => ({
                ...choice,
                isLibaiDuChoice: true,
                nextStage: gameState.currentStage
            }));
            
            // 显示蓝色背景选择界面
            displayCharacterDialogueOptions(enhancedChoices);
        }
        
        // 新增：处理与历史人物的对话选项
        function handleCharacterDialogueOption(option, index) {
            // 检查是否正在显示消息，如果是则忽略点击
            if (gameState.isShowingMessages) {
                return;
            }
            
            // 隐藏选项容器
            optionsContainer.classList.add('translate-y-full');
            
            // 特殊处理李杜选择
            if (option.isLibaiDuChoice) {
                // 显示刘禹锡的回应
                const playerMessage = {
                    type: "liuyuxi",
                    text: option.text
                };
                appendMessage(playerMessage);
                
                // 更新风格分数
                if (option.style) {
                    gameState.stylePoints[option.style] += 1;
                }
                
                // 显示历史人物的回应
                setTimeout(() => {
                    const responseMessage = {
                        type: option.characterResponse === "both" ? "narrator" : option.characterResponse,
                        text: option.response
                    };
                    appendMessage(responseMessage, true);
                    
                    // 李杜对话结束后检查县令剧情推进
                    setTimeout(() => {
                        checkCountyMagistrateProgression();
                    }, 1500);
                }, 800);
                return;
            }
            
            // 如果是结束对话选项 - 修改：检查县令剧情推进而不是直接回到菜单
            if (option.isEndDialogue) {
                // 显示结束对话的消息
                const endMessage = {
                    type: "narrator",
                    text: "对话结束。"
                };
                appendMessage(endMessage);
                
                // 检查是否需要县令剧情推进
                setTimeout(() => {
                    checkCountyMagistrateProgression();
                }, 1000);
                return;
            }
            
            // 如果是继续对话选项 - 修复：根据选项内容生成对应对话
            if (option.isContinueDialogue) {
                // 显示刘禹锡选择的具体问题
                const playerMessage = {
                    type: "liuyuxi",
                    text: option.text
                };
                appendMessage(playerMessage);
                
                // 根据选项生成对应的角色回应
                setTimeout(() => {
                    const response = generateSpecificResponse(option.characterId, option.text, option.environment);
                    const characterResponse = {
                        type: option.characterId,
                        text: response
                    };
                    appendMessage(characterResponse, true);
                    
                    // 显示后续选项
                    waitForMessagesComplete(() => {
                        const nextTopics = getNextDialogueOptions(option.characterId, option.environment);
                        const followUpOptions = [
                            ...nextTopics, // 具体的对话选项
                            { 
                                text: "感谢指点，结束对话", 
                                isEndDialogue: true,
                                nextStage: gameState.currentStage 
                            }
                        ];
                        displayCharacterDialogueOptions(followUpOptions);
                    });
                }, 800);
                return;
            }
            
            // 显示刘禹锡的回应
            const playerMessage = {
                type: "liuyuxi",
                text: option.text
            };
            appendMessage(playerMessage);
            
            // 更新风格分数
            if (option.style) {
                gameState.stylePoints[option.style] += 1;
            }
            
            // 如果有历史人物的回应，显示它
            if (option.response) {
                setTimeout(() => {
                    const responseMessage = {
                        type: option.characterId || "narrator",
                        text: option.response
                    };
                    appendMessage(responseMessage, true);
                    
                    // 等待消息显示完成后显示后续选项
                    waitForMessagesComplete(() => {
                        // 获取具体的后续对话选项
                        const nextTopics = getNextDialogueOptions(option.characterId, option.environment);
                        const afterResponseOptions = [
                            ...nextTopics, // 具体的对话选项
                            { 
                                text: "结束与此人的对话", 
                                isEndDialogue: true,
                                nextStage: gameState.currentStage 
                            }
                        ];
                        displayCharacterDialogueOptions(afterResponseOptions);
                    });
                }, 800);
            } else {
                // 如果没有预设回应，等待一下再显示通用选项
                setTimeout(() => {
                    showGenericDialogueOptions(option.characterId, option.environment);
                }, 500);
            }
        }
        
        // 新增：根据用户问题生成特定回应（大幅扩展所有历史人物的回应内容）
        function generateSpecificResponse(characterId, questionText, environment) {
            // 根据角色和问题内容生成对应的回应
            const responseMap = {
                "tao": {
                    "保持内心平静": "心远地自偏，境由心转。外在困厄不过是皮相，内心充实方为根本。",
                    "田园生活": "田园之乐在于顺应自然。春种秋收，夏耕冬藏，日出而作，日落而息，此乃天地之常道。",
                    "困境": "悔乎？不悔也。官场如樊笼，归田得自由。虽贫而乐，胜富而忧也。",
                    "指点": "各有际遇，各有所悟。宦海浮沉，总不如一杯清酒来得痛快。",
                    "逆境": "梦得，逆境如炼金之火，真金不怕红炉火。你看那东篱菊花，霜打之后反而更香。",
                    "自由": "自由不在于你能走多远，而在于心能飞多高。我辞彭泽令，得到的是心灵的解脱。",
                    "简朴": "一箪食，一瓢饮，在陋巷，人不堪其忧，我也不改其乐。简单生活，内心丰富。",
                    "归隐": "归去来兮！田园将芜胡不归？外在的改变不过是表象，心中的桃花源才是永恒。"
                },
                "du": {
                    "读书人的责任": "读书明理，当以天下为己任。虽身微言轻，然一支笔，胜千军万马。",
                    "时局": "滴水虽微，汇成江海；个人虽渺，可化民风。不以善小而不为，积小成大，终可成事。",
                    "苦难": "苦难是磨刀石，越磨越锋利。我之诗句，皆从苦难中来，为苍生而作。",
                    "责任": "安得广厦千万间，大庇天下寒士俱欢颜！位卑未敢忘忧国，此心当雄！",
                    "忧国": "位卑未敢忘忧国！梦得兄，我们虽然地位卑微，但忧国之心不可泯灭。",
                    "民生": "朱门酒肉臭，路有冻死骨。这就是现实，残酷但真实。我们不能视而不见。",
                    "抱负": "会当凌绝顶，一览众山小。越是在低谷，越要有登顶的雄心。",
                    "友谊": "与太白的友谊是我人生的珍宝。他的豪放与我的沉郁，恰好互补。",
                    "文章": "文章合为时而著，歌诗合为事而作。我们的笔就是我们的剑，要为正义而战！"
                },
                "libai": {
                    "豪迈": "豪迈非学而得，乃天性使然。人生苦短，何不痛快淋漓？醉也好，醒也好，总要活个明白！",
                    "自由": "自由者，心无拘束也。天地为庐，江河为酒，明月为友，何拘何束？",
                    "功名利禄": "功名如浮云，转眼即逝。真正不朽的，是那些能感动人心的诗篇。",
                    "传授": "天生我材必有用，千金散尽还复来！这世间最珍贵的是自由的心境。",
                    "梦想": "长风破浪会有时，直挂云帆济沧海。现在的困难只是暂时的。",
                    "尊严": "安能摧眉折腰事权贵，使我不得开心颜！保持你的尊严，这比什么都重要。",
                    "诗歌": "黄河之水天上来，奔流到海不复回。诗歌要有气势，要有想象力。",
                    "快乐": "五花马，千金裘，呼儿将出换美酒！钱财都是身外物，快乐才是真的。",
                    "个性": "我本楚狂人，凤歌笑孔丘。敢于与权威叫板，这才是真英雄。"
                },
                "confucius": {
                    "逆境": "志者，心之所向也。外境虽变，内心不移。君子固穷，小人穷斯滥矣。",
                    "君子": "君子怀德，小人怀土。君子喻于义，小人喻于利。内修其德，外化于行，是为君子。",
                    "坚守": "德者，本也；财者，末也。外不由己，内则不可夺。",
                    "本心": "君子居之，何陋之有？修其内，而外物不足挂虑。",
                    "品德": "德不孤，必有邻。刘君品德高尚，自然会吸引志同道合的朋友。",
                    "教育": "学而时习之，不亦说乎？真正的学习是终身的，无论在什么环境下。",
                    "治理": "君子之德风，小人之德草。草上之风，必偃。好的领导者能影响整个社会风气。",
                    "修身": "己所不欲，勿施于人。你不愿意被人看不起，所以也不会看不起别人。",
                    "智慧": "知之为知之，不知为不知，是知也。承认无知是智慧的开始。"
                },
                "sushi": {
                    "乐观": "逆境是人生的调味料，没有它，人生就太平淡了。换个角度看，坏事也能变好事。",
                    "人生": "是经历，是感悟，是那些能让你会心一笑的瞬间。其他的，都是过眼云烟。",
                    "逆境": "横看成岭侧成峰，远近高低各不同。处境虽难，换个角度看，又是另一番景象。",
                    "建议": "多读书，多行路，多思考。别太在意一时的得失，人生很长，起伏是常态。",
                    "达观": "人有悲欢离合，月有阴晴圆缺。变化是常态，不变才是反常。",
                    "智慧": "不识庐山真面目，只缘身在此山中。有时候，距离产生美，困境也能产生智慧。",
                    "哲理": "人生如逆旅，我亦是行人。大家都是人生路上的过客，何必太在意一时的得失？",
                    "豁达": "一蓑烟雨任平生。既然改变不了天气，就改变心情吧。",
                    "创作": "我发明的东坡肉，就是在黄州贬谪时创造的。困境往往能激发创造力。"
                },
                "liqingzhao": {
                    "词作心得": "我作词追求协音律，更重传心音。'寻寻觅觅，冷冷清清，凄凄惨惨戚戚'，每一字都是肺腑之言。词要有真情实感，不可矫揉造作。",
                    "困境": "亡国之痛，家破之恨，时时萦绕于心。然而我虽为弱女子，却不愿低头认命。'生当作人杰，死亦为鬼雄'，此乃我心志。",
                    "志气": "虽历经国破家亡，我仍思有朝一日能手刃仇敌，重整河山。纵然此生不能如愿，也要将此志传于后世。女子当自强，不可因性别而自轻。",
                    "保持": "在逆境中保持志气，需有钢铁般的意志。我曾在临安怒斥朝廷苟且偷安，纵然终身漂泊，也要保持气节。内心有光，黑暗何惧？",
                    "心得": "词贵在真情，贵在创新。我的词既有'帘卷西风，人比黄花瘦'的婉约，也有'至今思项羽，不肯过江东'的豪放。女子作词，更要敢于突破。",
                    "指点": "刘兄身为男儿，更应有担当。困境是试金石，能在逆境中不改初心者，方为真英雄。望君能如项羽一般，宁折不弯。",
                    "词学": "在我看来，词要协音律，更要传心音。身世浮沉，国破家亡，我已不复当年欢乐。'只恐双溪舴艋舟，载不动，许多愁'，这是我的真心话。",
                    "坚强": "我虽为女子，然性情刚烈。昔年在临安怒斥朝廷苟且偷安，纵然遭受白眼，也不后悔。女子也要有自己的立场。"
                },
                "wangwei": {
                    "禅意": "观此青苔翠竹，皆是本来面目。'一花一世界，一叶一菩提'，境由心转，梦得当以心观心。",
                    "山水": "山水者，天地之精华也。浅水因龙而深邃，正如禅家所言，外相虽小，内蕴无穷。",
                    "入世出世": "万户伤心生野烟——此痛刻骨，终化明月来相照之空明。君之困厄，亦菩提种也。",
                    "诗画": "'空山不见人，但闻人语响'，此乃静观之妙。我的诗中有画，画中有诗，都是这种禅境的体现。",
                    "清修": "昔年安史乱起，我亦陷贼，被迫出仕。后虽平反，然心灰意冷，遂隐居辋川，日日参禅悟道。"
                },
                "yanhuei": {
                    "安贫乐道": "回之所乐，在闻夫子之道。'学而时习之，不亦说乎？'外物不足挂虑，内心充实方为真乐。",
                    "修养": "'不迁怒，不贰过'，此回平生所守。志在内修，不求人知。修身之道，贵在恒常，日积月累，德行自成。",
                    "师承": "夫子常赞我'不迁怒，不贰过'，这是我平生所守。外在环境虽变，内心修为不可懈怠。",
                    "品格": "'德馨'如兰在谷，不以无人而不芳。刘君能悟此理，陋室即是学堂。",
                    "志向": "夫子问志，回答：'愿无伐善，无施劳。'内修身心，外无争竞，此亦一志也。"
                },
                "zengzi": {
                    "三省": "善哉问也！修身之道，贵在恒常。一日之内，当问心三次：所为是否忠诚？所交是否信实？所学是否践行？如此日积月累，德行自成。",
                    "修身": "修身与济世，本不相违。'修身、齐家、治国、平天下'，修身乃齐家治国之本。君若能在此斗室中正心诚意，他日必能格物致知。",
                    "传承": "孔门之道，传于后世，乃众弟子共同努力。参只是略尽绵薄，传承师训而已。",
                    "弘毅": "士不可以不弘毅，任重而道远。虽环境简陋，然君子当有远大志向。",
                    "内省": "参以为，君子之道在于内省。'吾日三省吾身'，这是我每日必做的功课。"
                },
                "yangxiong": {
                    "著述": "雄以为，环境简陋不足惧，心志不坚方可忧。'金经'者，圣贤之书也。君若能专心经典，虽居陋室，亦如置身圣殿。",
                    "修性": "'学者，所以修性也。'读书明理，修身正己，此乃根本。《法言》不过述而不作，学习先圣而已。",
                    "致用": "君言有理。然雄以为，修身为本，致用为末。内无所修，外何所用？君若能在此斗室中正心诚意，他日必能格物致知。",
                    "学问": "学而时习之，温故而知新。所学之道，当先用于修身，修身成则自能齐家，齐家成则自能治国。循序渐进，方为正道。",
                    "传世": "善哉！君能悟此理，真可谓得圣贤真传。梦得能以琴书为伴，真君子之乐也。陋室虽简，可成大业！"
                },
                "zhugeliang": {
                    "智谋": "亮观县令三迁君宅，恰似'以退为进'之局。梦得可效空城计——素琴一曲退千军。",
                    "淡泊": "'非淡泊无以明志，非宁静无以致远'。善！宁静之心，可御百万刁难。梦得若能在此柳边悟得此理，他日必成大器。",
                    "忠君": "梦得兄有此心，甚慰我怀。'受任于败军之际，奉命于危难之间'，此乃臣子本分。忠君报国，乃读书人本分。",
                    "进退": "报国之志可嘉。然君子当知进退，蛰伏待时，方为上策。今日之隐忍，乃为他日之大用。",
                    "修身": "昔日蜀中多难，亮每以'鞠躬尽瘁，死而后已'自勉。今观梦得困境，深感读书人当有坚持。"
                },
                "baijuyi": {
                    "同情": "梦得兄知我心！'青衫湿'者，不仅为琵琶女而泣，更为天下沦落人而悲。梦得兄能解其意，真乃知音。",
                    "文章": "正是此意！文章合为时而著，歌诗合为事而作。文章千古事，得失寸心知。我等虽遭贬谪，然笔下文章，当为民生立言，为时代发声。",
                    "境遇": "同是天涯沦落人，相逢何必曾相识！我当年贬江州司马时，常在江边听琵琶声，深感同病相怜。",
                    "现实": "我写《琵琶行》，不仅写琵琶女之苦，更写天下沦落人之悲。'朱门酒肉臭，路有冻死骨'，此等现实，岂能视而不见？",
                    "友谊": "梦得此言，让我想起'春江花朝秋月夜'，君得'草色入帘青'——各占天地一绝！贬谪之地，反成创作佳境。"
                }
            };
            
            // 查找匹配的关键词
            const responses = responseMap[characterId];
            if (responses) {
                for (const [keyword, response] of Object.entries(responses)) {
                    if (questionText.includes(keyword)) {
                        return response;
                    }
                }
            }
            
            // 如果没有找到匹配的回应，返回通用回应
            return generateGenericResponse(characterId);
        }

        // 新增：获取下一轮对话的具体选项
        function getNextDialogueOptions(characterId, environment) {
            // 根据角色和环境生成具体的对话选项
            const nextOptions = {
                "tao": [
                    { 
                        text: "请教先生如何在困境中保持内心平静", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想了解先生归隐后的田园生活", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "du": [
                    { 
                        text: "请子美兄谈谈读书人的责任", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想听听子美兄对时局的看法", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "libai": [
                    { 
                        text: "请太白兄传授豪迈洒脱之道", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教太白兄对自由的理解", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "confucius": [
                    { 
                        text: "请夫子教导如何在逆境中坚守本心", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教什么是真正的君子", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "sushi": [
                    { 
                        text: "请东坡先生指点如何在逆境中保持乐观", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想了解先生对人生最重要事物的看法", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "wangwei": [
                    { 
                        text: "请摩诘指点如何在此境中得禅悟", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教山水与禅机的关系", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "yanhuei": [
                    { 
                        text: "请颜子指点如何安贫乐道", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想了解颜子的修养功夫", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "liqingzhao": [
                    { 
                        text: "请易安指点如何在困境中保持志气", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教易安的词作心得", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "zhugeliang": [
                    { 
                        text: "请孔明先生指点如何以退为进", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想了解先生的淡泊明志之道", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "baijuyi": [
                    { 
                        text: "请乐天兄谈谈同为贬谪人的感受", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教文章如何为民生立言", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "zengzi": [
                    { 
                        text: "请曾子指点三省吾身的修养之道", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想了解内圣外王的修行次第", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ],
                "yangxiong": [
                    { 
                        text: "请杨子指点如何在简陋中成大业", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    },
                    { 
                        text: "想请教经典学习的方法", 
                        isContinueDialogue: true,
                        characterId: characterId,
                        environment: environment
                    }
                ]
            };
            
            // 如果找不到对应角色，返回通用选项
            return nextOptions[characterId] || [
                { 
                    text: "继续与先生深入交流", 
                    isContinueDialogue: true,
                    characterId: characterId,
                    environment: environment
                }
            ];
        }
        
        // 新增：显示通用对话选项
        function showGenericDialogueOptions(characterId, environment) {
            const nextTopics = getNextDialogueOptions(characterId, environment);
            const genericOptions = [
                ...nextTopics, // 具体的对话选项
                { 
                    text: "感谢指点，结束对话", 
                    isEndDialogue: true,
                    nextStage: gameState.currentStage 
                }
            ];
            displayCharacterDialogueOptions(genericOptions);
        }
        
        // 显示人物组合对话
        function displayCombinationDialogue(combinationKey, environment) {
            // 获取组合对话
            const dialogue = combinationDialogues[combinationKey];
            
            if (!dialogue) {
                // 如果没有找到对话，返回游戏流程
                proceedToStage(gameState.currentStage);
                return;
            }
            
            // 李杜组合特殊处理：在李白问问题后停止
            if (dialogue.waitForChoice) {
                // 显示消息但在最后一条后等待用户选择
                displayMessages(dialogue.messages, true);
                
                // 等待消息显示完成后显示李杜选择界面
                waitForMessagesComplete(() => {
                    showLibaiDuChoiceOptions();
                });
                return;
            }
            
            // 普通组合对话正常处理
            displayMessages(dialogue.messages);
            
            // 组合对话可能有额外分数奖励
            const [char1, char2] = combinationKey.split('_');
            
            // 根据组合角色的风格增加分数
            if (char1 && char2) {
                const style1 = gameState.characterInfo[char1]?.style;
                const style2 = gameState.characterInfo[char2]?.style;
                
                // 额外加分
                if (style1 === style2) {
                    // 如果两个角色风格相同，则该风格多加1分
                    if (style1 === "隐逸派") {
                        gameState.stylePoints.tao += 1;
                    } else if (style1 === "家国派") {
                        gameState.stylePoints.du += 1;
                    } else if (style1 === "儒家派") {
                        gameState.stylePoints.ru += 1;
                    } else if (style1 === "综合派") {
                        gameState.stylePoints.balanced += 1;
                    }
                } else {
                    // 如果风格不同，则平衡分数加1
                    gameState.stylePoints.balanced += 1;
                }
            }
            
            // 处理完对话后，显示选项
            setTimeout(() => {
                if (dialogue.options && dialogue.options.length > 0) {
                    // 创建临时选项，包含响应和下一步
                    const tempOptions = dialogue.options.map(option => {
                        return {
                            ...option,
                            nextStage: gameState.currentStage // 保持在当前阶段
                        }
                    });
                    
                    displayOptions(tempOptions);
                } else {
                    // 如果没有选项，直接继续
                    proceedToStage(gameState.currentStage);
                }
            }, 1000);
        }

        function proceedToStage(stage) {
            gameState.currentStage = stage;
            updateDebugInfo();
            
            // Calculate progress
            if (stage <= 5) {
                updateProgressBar(stage * 20);
            } else {
                updateProgressBar(100);
            }
            
            // Special handling for the ending stage
            if (stage === 6) {
                showEnding();
                return;
            }
            
            // 使用准确的阶段字符串查找内容
            const stageKey = stage.toString();
            const currentStage = gameScript[stageKey];
            
            if (!currentStage) {
                console.error('Stage not found:', stage);
                gameState.isShowingMessages = false; // 确保错误时也重置状态
                return;
            }
            
            // 特殊处理@历史人物的阶段
            if (currentStage.special === "mentionStage") {
                // 直接显示@历史人物的界面
                showMentionInterface(currentStage.environment);
                return;
            }
            
            // 正常显示消息
            displayMessages(currentStage.messages);
        }
        
        // 新增：历史人物交流主菜单（蓝色界面）
        function showHistoricalChatMenu(environment) {
            if (!environment) {
                // 如果没有提供环境参数，尝试从当前阶段获取
                const currentStage = Math.floor(gameState.currentStage);
                environment = currentStage.toString(); // 转换为"1"、"2"、"3"表示三个住所环境
            }
            
            // 调试信息
            debugLog('显示历史人物交流菜单', { 
                environment, 
                unlockedCharacters: gameState.unlockedCharacters,
                environmentCharacters: gameState.environmentCharacters,
                currentStage: gameState.currentStage
            });
            
            // 创建历史人物交流主菜单界面
            const menuInterface = document.createElement('div');
            menuInterface.id = 'historicalChatMenu';
            menuInterface.className = 'fixed bottom-0 left-0 right-0 bg-blue-50 dark:bg-blue-900/20 border-t border-blue-200 dark:border-blue-800 p-4 rounded-t-lg shadow-lg transform transition-transform duration-300 z-50 translate-y-full';
            
            // 环境名称映射
            const environmentNames = {
                "1": "江边住所",
                "2": "柳边住所", 
                "3": "斗室住所"
            };
            
            // 检查是否还有可用的@次数（暂时移除次数限制，简化逻辑）
            const remainingMentions = 999; // 临时设置为无限次数
            
            // 添加标题和说明
            menuInterface.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200">历史人物交流</h3>
                    <div class="text-sm text-blue-600 dark:text-blue-400">${environmentNames[environment] || `环境${environment}`}</div>
                </div>
                <div class="overflow-y-auto max-h-60 mb-4 grid grid-cols-1 gap-2" id="characterMenuList">
                    <!-- 角色列表将在这里添加 -->
                </div>
                <div class="border-t border-blue-200 dark:border-blue-700 pt-4">
                    <button id="exitHistoricalChat" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        结束历史人物交流，继续独白思考
                    </button>
                </div>
                <div class="text-xs text-blue-500 dark:text-blue-400 mt-2 text-center">
                    💡 与历史人物交流，获得智慧启发
                </div>
            `;
            
            document.body.appendChild(menuInterface);
            
            // 添加动画效果
            setTimeout(() => {
                menuInterface.style.transform = 'translateY(0)';
            }, 10);
            
            // 添加角色列表 - 修复：按环境过滤已解锁角色
            const characterMenuList = document.getElementById('characterMenuList');
            
            // 获取当前环境可出现的角色列表
            const environmentCharacters = gameState.environmentCharacters[environment] || [];
            debugLog('当前环境可出现角色', { environment, environmentCharacters });
            
            // 筛选出既已解锁又属于当前环境的角色
            let availableCharacters = gameState.unlockedCharacters.filter(charId => 
                environmentCharacters.includes(charId)
            );
            
            debugLog('筛选后的可用角色', { 
                unlockedCharacters: gameState.unlockedCharacters, 
                environmentCharacters,
                availableCharacters 
            });
            
            // 如果没有可用角色，给一个环境相关的默认列表
            if (availableCharacters.length === 0) {
                // 根据环境提供默认角色
                const defaultCharactersByEnv = {
                    "1": ["tao", "du", "libai", "confucius"], // 江边环境默认角色
                    "2": ["wangwei", "zhugeliang", "liqingzhao"], // 柳边环境默认角色  
                    "3": ["sushi", "yangxiong", "yanhuei", "zengzi"] // 斗室环境默认角色
                };
                
                availableCharacters = defaultCharactersByEnv[environment] || ["tao", "du", "confucius", "libai"];
                debugLog('使用环境默认角色列表', { environment, availableCharacters });
                
                // 将这些默认角色加到已解锁列表中
                availableCharacters.forEach(charId => {
                    if (!gameState.unlockedCharacters.includes(charId)) {
                        gameState.unlockedCharacters.push(charId);
                    }
                });
            }
            
            debugLog('显示的角色列表', availableCharacters);
            
            if (availableCharacters.length === 0) {
                // 如果仍然没有角色，显示提示信息
                characterMenuList.innerHTML = `
                    <div class="text-center text-blue-600 dark:text-blue-400 p-4">
                        暂无可交流的历史人物
                    </div>
                `;
            } else {
                availableCharacters.forEach(charId => {
                    // 创建角色卡片（蓝色主题）
                    const charCard = document.createElement('button');
                    charCard.className = 'flex items-center p-3 bg-blue-100 dark:bg-blue-800/30 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800/50 text-left transition-colors border border-blue-200 dark:border-blue-700';
                    
                    const charInfo = gameState.characterInfo[charId];
                    const charEmoji = gameState.characterEmojis[charId] || "❓";
                    const charName = gameState.characterNames[charId] || charId;
                    
                    // 检查是否已经@过这个角色
                    const isMentioned = gameState.mentionedCharacters.includes(charId);
                    const mentionedIndicator = isMentioned ? '<span class="text-green-600 dark:text-green-400 text-xs">✓ 已交流</span>' : '';
                    
                    charCard.innerHTML = `
                        <div class="text-2xl mr-3">${charEmoji}</div>
                        <div class="flex-1">
                            <div class="font-medium text-blue-800 dark:text-blue-200">${charName}</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">${charInfo ? charInfo.style : ""} · ${charInfo ? charInfo.desc : ""}</div>
                            ${mentionedIndicator}
                        </div>
                    `;
                    
                    // 添加点击事件
                    charCard.addEventListener('click', () => {
                        // 关闭菜单并@该角色
                        menuInterface.style.transform = 'translateY(100%)';
                        setTimeout(() => {
                            menuInterface.remove();
                            
                            // 生成个性化邀请语言
                            let inviteText = generatePersonalizedInvite(charId, charName);
                            
                            // 显示邀请消息
                            const inviteMessage = {
                                type: "liuyuxi",
                                text: inviteText
                            };
                            appendMessage(inviteMessage);
                            
                            handleCharacterMention(charId, environment);
                        }, 300);
                    });
                    
                    characterMenuList.appendChild(charCard);
                });
            }
            
            // 添加退出按钮事件
            document.getElementById('exitHistoricalChat').addEventListener('click', () => {
                // 关闭菜单
                menuInterface.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    menuInterface.remove();
                    
                    // 进入独白思考阶段
                    const nextStage = getNextReflectionStage();
                    proceedToStage(nextStage);
                }, 300);
            });
        }
        
        // 新增：生成个性化邀请语言
        function generatePersonalizedInvite(charId, charName) {
            const invites = {
                "tao": `@陶渊明，陶公今日可得闲？在否？`,
                "libai": `@李白，太白兄酒醒否？可共论诗？`,
                "du": `@杜甫，子美兄可愿一叙？`,
                "confucius": `@孔子，敢扰夫子清修，求教一二？`,
                "wangwei": `@王维，摩诘居士禅定之余，可容晚学请益？`,
                "yanhuei": `@颜回，颜子可有暇时，与梦得论道？`,
                "sushi": `@苏轼，东坡先生雅兴如何？可否小聚？`,
                "liqingzhao": `@李清照，易安居士，冒昧叨扰，可否赐教？`,
                "zhugeliang": `@诸葛亮，孔明先生，晚辈有疑，敢请指点？`,
                "baijuyi": `@白居易，乐天兄，同是贬谪人，可否倾谈？`,
                "zengzi": `@曾子，曾夫子，学生求教，望不吝赐教？`,
                "yangxiong": `@杨雄，杨子可有闲暇，与梦得论学？`
            };
            
            return invites[charId] || `@${charName}，${charName}先生，可有空闲一叙？`;
        }
        
        // 修改原有的showMentionInterface函数，改为调用新的菜单
        function showMentionInterface(environment) {
            showHistoricalChatMenu(environment);
        }

        function showEnding() {
            // Determine the ending based on style points
            const { tao, du, ru, balanced } = gameState.stylePoints;
            let endingType = "balanced";
            let endingScores = { tao, du, ru, balanced };
            
            // Find the highest score
            let maxScore = 0;
            let maxType = null;
            
            for (const [type, score] of Object.entries(endingScores)) {
                if (score > maxScore) {
                    maxScore = score;
                    maxType = type;
                }
            }
            
            if (maxType) {
                endingType = maxType;
            }
            
            const ending = endings[endingType];
            
            // Create a custom ending stage
            const endingMessages = [
                { type: "narrator", text: `你的旅程导向了「${ending.title}」` },
                { type: "narrator", text: ending.description },
                { type: "system", text: "查看你的朋友圈：" }
            ];
            
            // Display the ending messages
            displayMessages(endingMessages);
            
            // Add a delay before showing the WeChat moments card
            setTimeout(() => {
                // 构建评论HTML
                let commentsHTML = '';
                if (ending.comments && ending.comments.length > 0) {
                    commentsHTML = `
                        <div class="border-t border-gray-200 dark:border-gray-700 mt-4 pt-4">
                            ${ending.comments.map(comment => {
                                // 构建回复HTML
                                let repliesHTML = '';
                                if (comment.replies && comment.replies.length > 0) {
                                    repliesHTML = `
                                        <div class="ml-8 mt-2 bg-gray-50 dark:bg-gray-800 p-2 rounded-md">
                                            ${comment.replies.map(reply => `
                                                <div class="mb-2">
                                                    <span class="text-blue-600 dark:text-blue-400 font-medium">${reply.author}</span>：
                                                    <span>${reply.content}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div class="mb-3">
                                        <div class="flex items-center">
                                            <span class="text-gray-800 dark:text-gray-200 font-medium mr-2">${comment.author}</span>
                                            <span class="text-gray-500 dark:text-gray-400 text-xs">· 刚刚</span>
                                        </div>
                                        <div class="mt-1">${comment.content}</div>
                                        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                            <span>👍 ${comment.likes}　回复　</span>
                                        </div>
                                        ${repliesHTML}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                // Add WeChat moments card
                const momentCard = document.createElement('div');
                momentCard.className = 'wechat-moments mx-auto my-4 w-full max-w-md';
                momentCard.innerHTML = `
                    <div class="moment-header">
                        <div class="flex-1">
                            <div class="font-medium">刘禹锡</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">5分钟前</div>
                        </div>
                    </div>
                    <div class="moment-content">
                        <p class="mb-4">${ending.moment.content}</p>
                        <p class="text-blue-500 dark:text-blue-400">${ending.moment.tags}</p>
                        ${commentsHTML}
                    </div>
                    <div class="moment-footer">
                        <div class="moment-likes">👍 ${ending.moment.likes}</div>
                        <div>💬 ${ending.comments ? ending.comments.length : 0}条评论</div>
                    </div>
                `;
                
                chatContainer.appendChild(momentCard);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Display restart option after a short delay
                setTimeout(() => {
                    const options = [{ text: "重新开始游戏", nextStage: 0 }];
                    displayOptions(options);
                }, 800);
            }, 2000);
        }

        // No additional event listeners needed since toggleOptions was removed
    </script>
</body>
</html>
