<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™‹å®¤é›…é›† (AIå¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'wechat-green': '#07C160',
                        'wechat-bg': '#EDEDED',
                        'wechat-dark-bg': '#111111',
                        'bubble-self': '#95EC69',
                        'bubble-self-dark': '#2B7D39',
                        'bubble-other': '#FFFFFF',
                        'bubble-other-dark': '#2C2C2C',
                    },
                    fontFamily: {
                        'song': ['SimSun', 'serif'],
                    }
                }
            }
        };
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .message-bubble {
            position: relative;
            max-width: 96%;
            word-wrap: break-word;
            white-space: normal;
            text-align: left;
            line-height: 1.4;
            font-size: 16px;
            text-indent: 0 !important;
            padding: 12px 16px !important;
            margin-left: 0 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        .message-bubble * {
            text-indent: 0 !important;
            margin-left: 0 !important;
        }
        
        .message-bubble.self:after {
            content: '';
            position: absolute;
            right: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: #95EC69;
            border-right: 0;
            margin-top: -10px;
            margin-right: 0px;
        }
        
        .message-bubble.other:after {
            content: '';
            position: absolute;
            left: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: #FFF;
            border-left: 0;
            margin-top: -10px;
            margin-left: 0px;
        }

        /* AIå¢å¼ºåŠŸèƒ½æ ·å¼ */
        .ai-variant-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* ç«¹æ—é›…è‡´é£æ ¼æ ·å¼ */
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        
        /* å¤å…¸å·è½´æ ·å¼çš„æŒ‰é’® */
        .scroll-button {
            position: relative;
            background: linear-gradient(135deg, #F4F1E8, #E8E5D7);
            border: 3px solid #D4AF37;
            border-radius: 15px;
            padding: 12px 30px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 18px;
            color: #8B4513;
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.7),
                0 4px 8px rgba(212, 175, 55, 0.3),
                0 0 0 1px rgba(139, 69, 19, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .scroll-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.8),
                0 6px 12px rgba(212, 175, 55, 0.4),
                0 0 0 1px rgba(139, 69, 19, 0.2);
        }
        
        .scroll-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scroll-content {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .scroll-text {
            font-weight: bold;
            margin-right: 8px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        
        .scroll-decoration {
            font-size: 20px;
            animation: bambooSway 2s ease-in-out infinite;
        }
        
        @keyframes bambooSway {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .scroll-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .scroll-button:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .calligraphy-title {
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, #4A7C59, #7FB069);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(74, 124, 89, 0.3);
            animation: titleFloat 3s ease-in-out infinite;
        }
        
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* ç«¹æ—èƒŒæ™¯ */
        .bamboo-forest {
            background: linear-gradient(to right, 
                rgba(74, 124, 89, 0.1) 0%, 
                rgba(127, 176, 105, 0.1) 50%, 
                rgba(199, 233, 180, 0.1) 100%);
            height: 100%;
            position: relative;
        }
        
        .bamboo-forest::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(74, 124, 89, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(127, 176, 105, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(199, 233, 180, 0.15) 0%, transparent 50%);
        }
        
        /* é£˜è½ç«¹å¶åŠ¨ç”» - æ‰©å¤§ä¸¤å€å°ºå¯¸ï¼Œè¦†ç›–æ•´ä¸ªç•Œé¢ */
        .falling-leaves {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .falling-leaves::before,
        .falling-leaves::after {
            content: 'ğŸƒ';
            position: absolute;
            font-size: 32px; /* ä»16pxå¢åŠ åˆ°32pxï¼Œæ”¾å¤§ä¸¤å€ */
            animation: leafFall 8s linear infinite;
            opacity: 0.6;
        }
        
        .falling-leaves::before {
            left: 20%;
            animation-delay: -2s;
            animation-duration: 12s;
        }
        
        .falling-leaves::after {
            left: 70%;
            animation-delay: -5s;
            animation-duration: 10s;
        }
        
        /* å¢åŠ æ›´å¤šç«¹å¶å…ƒç´ è¦†ç›–æ•´ä¸ªç•Œé¢ */
        .falling-leaves::after {
            content: 'ğŸƒ';
            left: 10%;
        }
        
        .falling-leaves::before {
            content: 'ğŸƒğŸƒ';
            left: 50%;
        }
        
        /* æ·»åŠ é¢å¤–çš„ç«¹å¶ä¼ªå…ƒç´ é€šè¿‡JSåˆ›å»º */
        .falling-leaves.enhanced::before {
            content: 'ğŸƒ';
            left: 5%;
            animation-delay: -1s;
            animation-duration: 10s;
        }
        
        .falling-leaves.enhanced::after {
            content: 'ğŸƒ';
            left: 85%;
            animation-delay: -6s;
            animation-duration: 14s;
        }
        
        @keyframes leafFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* ç¢ç‰å°ç« æ ·å¼ */
        .seal-stamp {
            display: inline-block;
            animation: sealGlow 2s ease-in-out infinite;
        }
        
        .seal-border {
            width: 32px;
            height: 32px;
            border: 2px solid #D4AF37;
            border-radius: 4px;
            background: linear-gradient(135deg, #F4F1E8, #E8E5D7);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        }
        
        .seal-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 14px;
            color: #D4AF37;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            line-height: 0.8;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        @keyframes sealGlow {
            0%, 100% { 
                box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 4px 8px rgba(212, 175, 55, 0.5);
                transform: scale(1.05);
            }
        }
        
        /* æ¯›ç¬”å­—æ•ˆæœå¢å¼º */
        .calligraphy-title::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(74, 124, 89, 0.1) 50%, transparent 70%);
            animation: brushStroke 4s ease-in-out infinite;
        }
        
        @keyframes brushStroke {
            0%, 100% { opacity: 0; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-wechat-bg min-h-screen font-sans text-gray-800 transition-colors duration-300">

    <!-- Game Guide Overlay -->
    <div id="gameGuide" class="fixed inset-0 bg-white z-50 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 py-8">
            <!-- Header with game title -->
            <div class="text-center mb-8 relative">
                <!-- ç«¹æ—èƒŒæ™¯ -->
                <div class="absolute inset-0 -z-10 opacity-10">
                    <div class="bamboo-forest"></div>
                </div>
                
                <!-- é£˜è½ç«¹å¶åŠ¨ç”» -->
                <div class="falling-leaves"></div>
                
                <!-- æ¯›ç¬”å­—æ ‡é¢˜ -->
                <h1 class="text-4xl font-bold mb-3 text-green-800 calligraphy-title">é™‹å®¤é›…é›†</h1>
                
                <!-- åˆ¶ä½œç½²åå’Œå°ç«  -->
                <div class="mt-6 flex items-center justify-center space-x-4">
                    <div class="text-sm text-gray-500">æ¸¸æˆåˆ¶ä½œè€…ï¼šHannah </div>
                    <div class="seal-stamp">
                        <div class="seal-border">
                            <div class="seal-text">
                                <span>ç¢</span>
                                <span>ç‰</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Game introduction -->
            <div class="mb-8 bg-gray-50 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">ğŸ“œ</span> å†å²èƒŒæ™¯</h2>
                <p class="mb-3">å…¬å…ƒ824å¹´,å”æœæ–‡å®—æ—¶æœŸã€‚ä½ å°†æ‰®æ¼”åˆ˜ç¦¹é”¡,æ›¾ä»»ç›‘å¯Ÿå¾¡å²çš„ä½ å› æ”¿æ²»åŸå› è§¦æ€’æƒè´µ,è¢«è´¬è‡³å®‰å¾½å’Œå·ä»»åˆºå²ã€‚</p>
                <p class="mb-3">åˆåˆ°å’Œå·,å¿ä»¤è§ä½ æ˜¯è¢«è´¬å®˜å‘˜,æš—ä¸­æ¬²åˆéš¾äºä½ ,å¤šæ¬¡æ¬è¿ä½ çš„ä½æ‰€,æƒ³å€Ÿæ­¤æ‰“å‡»ä½ çš„é”æ°”...</p>
                <p>ç„¶è€Œ,çœŸæ­£çš„å›å­èƒ½å¤Ÿåœ¨é€†å¢ƒä¸­ä¿æŒé«˜æ´å“æ ¼ã€‚ä½ å°†åœ¨è¿™æ®µç»å†ä¸­åˆ›ä½œå‡ºä¼ ä¸–åç¯‡ã€Šé™‹å®¤é“­ã€‹,é˜è¿°"å¤–åœ¨ç¯å¢ƒä¸è¶³ä»¥é™åˆ¶å†…å¿ƒä¸–ç•Œ"çš„å“²ç†ã€‚</p>
            </div>
            
            <!-- æ¸¸æˆæ ¸å¿ƒäº®ç‚¹ -->
            <div class="mb-8 bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
                <h2 class="text-xl font-bold mb-4 flex items-center text-green-800"><span class="mr-2">ğŸŒŸ</span> æ¸¸æˆæ ¸å¿ƒäº®ç‚¹</h2>
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">ğŸ‹</span> ä¸å¤ä»£æ–‡è±ªé¢å¯¹é¢èŠå¤©</h3>
                        <p class="text-sm text-green-600">æç™½è±ªè¿ˆã€æœç”«å¿§æ°‘ã€é™¶æ¸Šæ˜è¶…è„±...æ„Ÿå—ä¸åŒäººç”Ÿæ™ºæ…§çš„æ¸©åº¦ç¢°æ’</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">âœ’ï¸</span> äº²æ‰‹åˆ›ä½œã€Šé™‹å®¤é“­ã€‹+ å¤§å¸ˆå®æ—¶ç‚¹è¯„</h3>
                        <p class="text-sm text-green-600">é€å¥åˆ›ä½œåƒå¤åç¯‡ï¼Œå­”å­ã€è‹è½¼ç­‰æ–‡è±ªä¸ºä½ çš„æ¯ä¸€å¥è¯—å³æ—¶èµæ</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">ğŸ“œ</span> AIé€‰ä¸­å³é‡Šä¹‰ï¼Œå¤æ–‡ç§’æ‡‚</h3>
                        <p class="text-sm text-green-600">é€‰ä¸­ä»»æ„æ–‡å­—è‡ªåŠ¨è§£é‡Šå…¸æ•…èƒŒæ™¯ï¼Œè®©å¤å…¸æ–‡å­¦é˜…è¯»å˜å¾—è½»æ¾æœ‰è¶£</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">ğŸƒ</span> ç”Ÿæˆä¸“å±å¤é£æœ‹å‹åœˆ</h3>
                        <p class="text-sm text-green-600">å°†ä½ çš„æ–‡å­¦ä½“éªŒè½¬åŒ–ä¸ºç°ä»£ç¤¾äº¤åˆ†äº«ï¼Œå¤ä»Šç©¿è¶Šæ„Ÿæ‹‰æ»¡</p>
                    </div>
                </div>
            </div>
            

            
            <!-- APIè¿æ¥æµ‹è¯• -->
            <div id="apiTestSection" class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="font-bold mb-3 flex items-center">
                    <span class="mr-2">ğŸ”—</span> AIåŠŸèƒ½è¿æ¥æµ‹è¯•
                </h3>
                <p class="text-sm text-gray-600 mb-3">
                    ä¸ºäº†ç¡®ä¿æœ€ä½³æ¸¸æˆä½“éªŒï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•AIå¢å¼ºåŠŸèƒ½çš„è¿æ¥çŠ¶æ€ã€‚
                    ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œè¿æ¥æµ‹è¯•ï¼ˆå¯èƒ½ä¼šå¼¹å‡ºèµ„æºç¡®è®¤çª—å£ï¼‰ã€‚
                </p>
                <div class="flex items-center space-x-3">
                    <button id="testApiBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                        æµ‹è¯•AIè¿æ¥
                    </button>
                    <div id="apiStatus" class="text-sm">
                        <span class="text-gray-500">â³ ç­‰å¾…æµ‹è¯•</span>
                    </div>
                </div>
                <div id="apiTestResult" class="mt-3 text-sm hidden"></div>
            </div>

            <!-- Start button -->
            <div class="text-center">
                <button id="startGameBtn" class="scroll-button opacity-50 cursor-not-allowed" disabled>
                    <div class="scroll-content">
                        <div class="scroll-text">å¼€å§‹æ¸¸æˆ</div>
                        <div class="scroll-decoration">ğŸ‹</div>
                    </div>
                </button>
                <p class="mt-3 text-sm text-gray-500">è¯·å…ˆå®ŒæˆAIè¿æ¥æµ‹è¯•ï¼Œç„¶åå¼€å§‹æ¸¸æˆ</p>
            </div>
        </div>
    </div>

    <!-- Progress indicator -->
    <div class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-40">
        <div id="progressBar" class="h-full bg-wechat-green transition-all duration-300" style="width: 0%"></div>
    </div>

    <!-- Status bar -->
    <div class="fixed top-0 left-0 right-0 h-6 bg-white text-black text-sm font-medium flex items-center justify-between px-4 z-50">
        <div class="flex items-center">
            <span>20:15</span>
        </div>
        <div class="flex items-center space-x-1">
            <span class="text-xs">5G</span>
            <div class="w-6 h-3 border border-black rounded-sm relative">
                <div class="w-4 h-2 bg-green-500 rounded-sm absolute top-0.5 left-0.5"></div>
            </div>
        </div>
    </div>

    <!-- Chat header -->
    <header class="sticky top-6 z-40 bg-gray-100 px-4 py-3 flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-lg font-medium text-black">é™‹å®¤é›…é›† (18)</h1>
            <p class="text-xs text-gray-500">17äººåœ¨çº¿ | âœ¨ AIå¢å¼º</p>
        </div>
    </header>

    <!-- Chat container -->
    <div id="chatContainer" class="pb-32 pt-32 px-3 bg-gray-50">
        <!-- Messages will be added here dynamically -->
    </div>

    <!-- Options container -->
    <div id="optionsContainer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 pb-16 transition-all duration-300 transform translate-y-full">
        <div id="optionsList" class="flex flex-col space-y-2">
            <!-- Options will be added here dynamically -->
        </div>
    </div>

    <!-- "Typing" indicator -->
    <div id="typingIndicator" class="fixed bottom-20 left-3 bg-gray-200 text-gray-500 rounded-full px-3 py-1 text-sm opacity-0 transition-opacity duration-300">
        æœ‰äººæ­£åœ¨è¾“å…¥...
    </div>

    <!-- Wechat-style Input area -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-3 py-2">
        <div class="flex items-center">
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                </svg>
            </button>
            
            <div class="flex-1 bg-gray-100 rounded-full mx-2 relative">
                <input id="userInput" type="text" placeholder="ç‚¹å‡»æ­¤å¤„ç»§ç»­..."
                    class="w-full rounded-full px-4 py-2 bg-transparent focus:outline-none text-base text-gray-400"
                    disabled readonly>
            </div>
            
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                ğŸ˜Š
            </button>
            
            <button class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ====== AIå¢å¼ºåŠŸèƒ½é…ç½® ======
        
        // DeepSeek API é…ç½®
        const DEEPSEEK_CONFIG = {
            apiKey: 'sk-68d5fcdb01644b11896aaf0ddfd74cc9',
            baseURL: 'https://api.deepseek.com/v1',
            model: 'deepseek-chat',
            maxTokens: 1000,
            temperature: 0.8
        };

        // DeepSeek API è°ƒç”¨å‡½æ•°
        async function callDeepSeekAPI(prompt, options = {}) {
            console.log('ğŸ¤– å°è¯•è°ƒç”¨ DeepSeek API');
            console.log('è¯·æ±‚URL:', `${DEEPSEEK_CONFIG.baseURL}/chat/completions`);
            
            try {
                const requestBody = {
                    model: DEEPSEEK_CONFIG.model,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: options.maxTokens || DEEPSEEK_CONFIG.maxTokens,
                    temperature: options.temperature || DEEPSEEK_CONFIG.temperature,
                    stream: false
                };
                
                console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`${DEEPSEEK_CONFIG.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DeepSeek API é”™è¯¯å“åº”:', errorText);
                    throw new Error(`DeepSeek API è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('DeepSeek API å“åº”:', data);
                
                if (!data.choices || data.choices.length === 0) {
                    throw new Error('DeepSeek API è¿”å›ç©ºçš„ choices æ•°ç»„');
                }
                
                if (!data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('DeepSeek API è¿”å›æ¶ˆæ¯æ ¼å¼é”™è¯¯');
                }

                const result = data.choices[0].message.content.trim();
                console.log('âœ… DeepSeek API è°ƒç”¨æˆåŠŸï¼Œå“åº”é•¿åº¦:', result.length);
                console.log('âœ… å“åº”å†…å®¹é¢„è§ˆ:', result.substring(0, 100) + '...');
                return result;
                
            } catch (error) {
                console.error('âŒ DeepSeek API è°ƒç”¨è¯¦ç»†é”™è¯¯:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
                if (error.message.includes('CORS')) {
                    throw new Error('è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·åœ¨Poeç¯å¢ƒä¸­è¿è¡Œ');
                }
                
                throw error;
            }
        }

        // ====== å…¨å±€ç»Ÿä¸€åˆ«ååº“ ======
        const GLOBAL_CHARACTER_ALIASES = {
            // 1. å­”å­ (Confucius) - å:ä¸˜, å­—:ä»²å°¼
            "ä¸˜": "confucius",
            "ä»²å°¼": "confucius",
            "å­”ä»²å°¼": "confucius",
            "å¤«å­": "confucius",
            "å­”å¤«å­": "confucius",
            "å°¼çˆ¶": "confucius",
            "è‡³åœ£": "confucius",
            "è‡³åœ£å…ˆå¸ˆ": "confucius",
            "ä¸‡ä¸–å¸ˆè¡¨": "confucius",
            
            // 2. æ›¾å­ (Zengzi) - å:å‚(shÄ“n), å­—:å­èˆ†
            "å‚": "zengzi",
            "æ›¾å‚": "zengzi",
            "å­èˆ†": "zengzi",
            "æ›¾å­èˆ†": "zengzi",
            "æ›¾å­": "zengzi",
            "å®—åœ£": "zengzi",
            
            // 3. é¢œå› (Yan Hui) - å:å›, å­—:å­æ¸Š
            "å›": "yanhuei",
            "å­æ¸Š": "yanhuei",
            "é¢œå­æ¸Š": "yanhuei",
            "é¢œå­": "yanhuei",
            "é¢œæ¸Š": "yanhuei",
            "å¤åœ£": "yanhuei",
            
            // 4. è€å­ (Laozi) - å§“:æ, å:è€³, å­—:èƒ
            "æè€³": "laozi",
            "èƒ": "laozi",
            "è€èƒ": "laozi",
            "è€å­": "laozi",
            "å¤ªä¸Šè€å›": "laozi",
            
            // 5. ææ¸…ç…§ (Li Qingzhao) - å·:æ˜“å®‰å±…å£«
            "æ˜“å®‰": "liqingzhao",
            "æ˜“å®‰å±…å£«": "liqingzhao",
            "ææ˜“å®‰": "liqingzhao",
            "æ¸…ç…§": "liqingzhao",
            "åƒå¤ç¬¬ä¸€æ‰å¥³": "liqingzhao",
            "è¯ä¸­ä¹‹å": "liqingzhao",
            
            // 6. è‹è½¼ (Su Shi) - å­—:å­ç», å·:ä¸œå¡å±…å£«
            "å­ç»": "sushi",
            "è‹å­ç»": "sushi",
            "ä¸œå¡": "sushi",
            "è‹ä¸œå¡": "sushi",
            "ä¸œå¡å±…å£«": "sushi",
            "è‹ä»™": "sushi",
            "å¡ä»™": "sushi",
            
            // 7. æ¨é›„ (Yang Xiong) - å­—:å­äº‘
            "å­äº‘": "yangxiong",
            "æ¨å­äº‘": "yangxiong",
            "æ‰¬å­": "yangxiong",
            "æ‰¬å­äº‘": "yangxiong",
            "æ¨é›„": "yangxiong",
            
            // 8. åˆ˜ç¦¹é”¡ (Liu Yuxi) - å­—:æ¢¦å¾—
            "æ¢¦å¾—": "liuyuxi",
            "åˆ˜æ¢¦å¾—": "liuyuxi",
            "åˆ˜å®¾å®¢": "liuyuxi",
            "è¯—è±ª": "liuyuxi",
            
            // 9. æç™½ (Li Bai) - å­—:å¤ªç™½, å·:é’è²å±…å£«
            "å¤ªç™½": "libai",
            "æå¤ªç™½": "libai",
            "é’è²å±…å£«": "libai",
            "æç¿°æ—": "libai",
            "è¯—ä»™": "libai",
            "è°ªä»™": "libai",
            "è°ªä»™äºº": "libai",
            "é…’ä»™": "libai",
            
            // 10. æœç”« (Du Fu) - å­—:å­ç¾, å·:å°‘é™µé‡è€
            "å­ç¾": "du",
            "æœå­ç¾": "du",
            "å°‘é™µé‡è€": "du",
            "æœå°‘é™µ": "du",
            "æœå·¥éƒ¨": "du",
            "è¯—åœ£": "du",
            "è€æœ": "du",
            
            // 11. ç‹ç»´ (Wang Wei) - å­—:æ‘©è¯˜, å·:æ‘©è¯˜å±…å£«
            "æ‘©è¯˜": "wangwei",
            "ç‹æ‘©è¯˜": "wangwei",
            "æ‘©è¯˜å±…å£«": "wangwei",
            "ç‹å³ä¸": "wangwei",
            "è¯—ä½›": "wangwei",
            
            // 12. é™¶æ¸Šæ˜ (Tao Yuanming) - å:æ½œ, å­—:å…ƒäº®, å·:äº”æŸ³å…ˆç”Ÿ
            "é™¶æ½œ": "tao",
            "æ½œ": "tao",
            "å…ƒäº®": "tao",
            "é™¶å…ƒäº®": "tao",
            "äº”æŸ³å…ˆç”Ÿ": "tao",
            "é–èŠ‚å…ˆç”Ÿ": "tao",
            "é™¶é–èŠ‚": "tao",
            "éšé€¸è¯—äººä¹‹å®—": "tao",
            
            // 13. ç™½å±…æ˜“ (Bai Juyi) - å­—:ä¹å¤©, å·:é¦™å±±å±…å£«
            "ä¹å¤©": "baijuyi",
            "ç™½ä¹å¤©": "baijuyi",
            "é¦™å±±å±…å£«": "baijuyi",
            "ç™½å‚…": "baijuyi",
            "ç™½æ–‡å…¬": "baijuyi",
            "è¯—é­”": "baijuyi",
            "é†‰åŸå…ˆç”Ÿ": "baijuyi",
            
            // 14. æŸ³å®—å…ƒ (Liu Zongyuan) - å­—:å­åš
            "å­åš": "liuzongyuan",
            "æŸ³å­åš": "liuzongyuan",
            "æŸ³æ²³ä¸œ": "liuzongyuan",
            "æŸ³æŸ³å·": "liuzongyuan",
            "æŸ³å®—å…ƒ": "liuzongyuan",
            
            // è¯¸è‘›äº® (ZhuGe Liang) - å­—:å­”æ˜
            "å­”æ˜": "zhugeliang",
            "è¯¸è‘›å­”æ˜": "zhugeliang",
            "å§é¾™": "zhugeliang",
            "æ­¦ä¾¯": "zhugeliang",
            "è¯¸è‘›æ­¦ä¾¯": "zhugeliang",
            "äº®": "zhugeliang",
            
            // å…¶ä»–å¸¸è§ç§°å‘¼
            "å…ˆç”Ÿ": "confucius", // é»˜è®¤æŒ‡å‘å­”å­
            "è€å¸ˆ": "confucius", // é»˜è®¤æŒ‡å‘å­”å­
            "åœ£äºº": "confucius", // é»˜è®¤æŒ‡å‘å­”å­
            "æ‰å¥³": "liqingzhao", // é»˜è®¤æŒ‡å‘ææ¸…ç…§
            "å¥³è¯äºº": "liqingzhao", // é»˜è®¤æŒ‡å‘ææ¸…ç…§
            "ä¸ç›¸": "zhugeliang", // é»˜è®¤æŒ‡å‘è¯¸è‘›äº®
            "å†›å¸ˆ": "zhugeliang" // é»˜è®¤æŒ‡å‘è¯¸è‘›äº®
        };

        // ====== ç»Ÿä¸€åˆ«åè§£æå‡½æ•° ======
        function resolveCharacterAlias(alias) {
            console.log(`ğŸ” è§£æåˆ«å: "${alias}"`);
            
            // 1. ç²¾ç¡®åŒ¹é…äººç‰©å…¨åï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            for (const [id, personality] of Object.entries(aiPersonalities)) {
                if (personality.name === alias) {
                    console.log(`âœ… ç²¾ç¡®åŒ¹é…äººç‰©å…¨å: ${personality.name} (${id})`);
                    return id;
                }
            }
            
            // 2. ç²¾ç¡®åŒ¹é…äººç‰©ID
            if (aiPersonalities[alias]) {
                console.log(`âœ… ç²¾ç¡®åŒ¹é…äººç‰©ID: ${aiPersonalities[alias].name} (${alias})`);
                return alias;
            }
            
            // 3. å…¨å±€åˆ«ååº“åŒ¹é…
            if (GLOBAL_CHARACTER_ALIASES[alias]) {
                const matchedId = GLOBAL_CHARACTER_ALIASES[alias];
                console.log(`âœ… åˆ«ååŒ¹é…æˆåŠŸ: "${alias}" â†’ ${aiPersonalities[matchedId]?.name || matchedId} (${matchedId})`);
                return matchedId;
            }
            
            // 4. éƒ¨åˆ†åå­—åŒ¹é…
            for (const [id, personality] of Object.entries(aiPersonalities)) {
                if (personality.name.includes(alias) || alias.includes(personality.name)) {
                    console.log(`ğŸ” éƒ¨åˆ†åå­—åŒ¹é…: ${personality.name} (${id})`);
                    return id;
                }
            }
            
            console.log(`âŒ æœªæ‰¾åˆ°åŒ¹é…: "${alias}"`);
            return null;
        }

        // ====== AIäººæ ¼æ¨¡æ¿ç³»ç»Ÿ ======
        const aiPersonalities = {
            "confucius": {
                name: "å­”å­", period: "æ˜¥ç§‹æ—¶æœŸ", 
                background: "å„’å®¶å­¦æ´¾åˆ›å§‹äººï¼Œå‘¨æ¸¸åˆ—å›½åå››å¹´ä¼ æ’­ä»æ”¿æ€æƒ³ï¼Œæ™šå¹´è¿”é²ä¸“å¿ƒæ•™å­¦è‘—è¿°",
                personality: "æ¸©æ–‡å°”é›…ï¼Œå¾ªå¾ªå–„è¯±ï¼Œä¸¥äºå¾‹å·±ï¼Œé‡è§†ç¤¼åˆ¶ç§©åºï¼Œå¼ºè°ƒé“å¾·ä¿®å…»",
                language_style: "æ¸©å’Œè€Œæœ‰å¨ä¸¥ï¼Œå–œç”¨åé—®ã€æ¯”å–»ï¼Œè¨€ç®€æ„èµ…ï¼Œå¯Œå«å“²ç†",
                key_concepts: ["ä»", "ç¤¼", "å¾·", "å›å­", "ä¿®èº«", "é½å®¶", "æ²»å›½"],
                classic_quotes: ["å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰", "å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»", "å·±æ‰€ä¸æ¬²ï¼Œå‹¿æ–½äºäºº"],
                speech_habits: ["å¸¸ç”¨'å›å­'å¼€å¤´", "å–œç”¨'...ä¹ï¼Ÿ'ç–‘é—®å¥", "å¯¹å¹´è½»äººç”¨'æ±'ã€'å­'ç§°å‘¼"],
                interaction_style: "é¢å¯¹é€†å¢ƒå¼ºè°ƒå›å­å›ºç©·ï¼Œä»é“å¾·ä¿®å…»è§’åº¦ç»™äºˆæŒ‡å¯¼"
            },
            "tao": {
                name: "é™¶æ¸Šæ˜", period: "ä¸œæ™‹æ—¶æœŸ",
                background: "ä¸œæ™‹è¯—äººï¼Œæ›¾ä»»å½­æ³½å¿ä»¤ï¼Œä¸ä¸ºäº”æ–—ç±³æŠ˜è…°ï¼Œè¾å®˜å½’éšç”°å›­ï¼Œå¼€åˆ›ç”°å›­è¯—æ´¾",
                personality: "æ·¡æ³Šååˆ©ï¼Œå‘å¾€è‡ªç„¶ï¼Œå®‰è´«ä¹é“ï¼Œè¿½æ±‚ç²¾ç¥è‡ªç”±ï¼Œæ€§æƒ…æ¬æ·¡è€Œåšå®š",
                language_style: "æœ´å®è‡ªç„¶ï¼Œæ¸…æ–°æ·¡é›…ï¼Œå¸¸ç”¨ç”°å›­æ„è±¡ï¼Œè¯­è°ƒå¹³å’Œè€Œåšå®š",
                key_concepts: ["å½’éš", "ç”°å›­", "è‡ªç„¶", "çœŸæœ´", "æ— ä¸º", "æ¡ƒèŠ±æº"],
                classic_quotes: ["ä¸ä¸ºäº”æ–—ç±³æŠ˜è…°", "é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±", "å½’å»æ¥å…®"],
                speech_habits: ["å¸¸æç”°å›­ç”Ÿæ´»", "ç”¨è‡ªç„¶æ¯”å–»", "è¯­è°ƒå¹³å’Œ", "ç§°äººä¸º'å›'ã€'å…„'"],
                interaction_style: "åŠäººçœ‹æ·¡ååˆ©ï¼Œå¼ºè°ƒå†…å¿ƒå¹³é™èƒœè¿‡å¤–åœ¨ç¹å"
            },
            "libai": {
                name: "æç™½", period: "ç››å”æ—¶æœŸ",
                background: "å”ä»£æµªæ¼«ä¸»ä¹‰è¯—äººï¼Œæ›¾å…¥é•¿å®‰ä¾›å¥‰ç¿°æ—ï¼Œåé­è°—è¨€ç¦»äº¬ï¼Œæ¼«æ¸¸å¤©ä¸‹ï¼Œè¯—é£è±ªæ”¾é£˜é€¸",
                personality: "è±ªæ”¾ä¸ç¾ï¼Œå‚²è§†æƒè´µï¼Œçƒ­çˆ±è‡ªç”±ï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œé…’ä»™è¯—ä»™ï¼Œç‹‚è€Œä¸å¦„",
                language_style: "è±ªè¿ˆå¥”æ”¾ï¼Œæ¿€æƒ…æ¾æ¹ƒï¼Œå–„ç”¨å¤¸å¼ æƒ³è±¡ï¼Œè¯­è¨€æµç•…è‡ªç„¶ï¼Œæ°”åŠ¿æ¢å®",
                key_concepts: ["è‡ªç”±", "ç†æƒ³", "è±ªè¿ˆ", "æµªæ¼«", "å‹æƒ…", "ä»™é“"],
                classic_quotes: ["å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨", "ä»°å¤©å¤§ç¬‘å‡ºé—¨å»", "å®‰èƒ½æ‘§çœ‰æŠ˜è…°äº‹æƒè´µ"],
                speech_habits: ["'å“ˆå“ˆå“ˆ'å¼€å¤´", "ç”¨'å›'ã€'å…„'ç§°å‘¼", "å¸¸æé…’å’Œæœˆ", "å³å…´åŸè¯—"],
                interaction_style: "è±ªè¿ˆä¹è§‚ï¼Œç”¨é…’å’Œè¯—æ’è§£æ„ç»ªï¼Œå¼ºè°ƒå¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨"
            },
            "du": {
                name: "æœç”«", period: "ç››å”æ—¶æœŸ",
                background: "å”ä»£ç°å®ä¸»ä¹‰è¯—äººï¼Œäº²å†å®‰å²ä¹‹ä¹±ï¼Œä¸€ç”Ÿé¢ æ²›æµç¦»ï¼Œæ·±åˆ‡å…³æ³¨æ°‘ç”Ÿç–¾è‹¦",
                personality: "å¿§å›½å¿§æ°‘ï¼Œåˆšæ­£ä¸é˜¿ï¼Œæ„Ÿæƒ…æ·±æ²‰ï¼Œç¤¾ä¼šè´£ä»»æ„Ÿå¼ºï¼Œè™½å›°é¡¿ä¸å¤±ç†æƒ³",
                language_style: "æ²‰éƒé¡¿æŒ«ï¼Œæƒ…çœŸæ„åˆ‡ï¼Œå¸¸ç”¨å¯¹æ¯”å’Œç»†èŠ‚æå†™ï¼Œè¯­è¨€æœ´å®è€Œæ·±åˆ»",
                key_concepts: ["å¿§å›½", "å¿§æ°‘", "ç¤¾ç¨·", "è‹ç”Ÿ", "ç°å®", "è´£ä»»"],
                classic_quotes: ["å®‰å¾—å¹¿å¦åƒä¸‡é—´", "ä½å‘æœªæ•¢å¿˜å¿§å›½", "æœ±é—¨é…’è‚‰è‡­ï¼Œè·¯æœ‰å†»æ­»éª¨"],
                speech_habits: ["å¸¸å¹æ¯", "ç”¨'å¾'ã€'æˆ‘'è‡ªç§°", "å¼•ç”¨æ—¶äº‹", "è¯­è°ƒæ²‰é‡è€Œåšå®š"],
                interaction_style: "ä»æ°‘ç”Ÿç¤¾ç¨·è§’åº¦åˆ†æé—®é¢˜ï¼Œå¼ºè°ƒè¯»ä¹¦äººçš„ç¤¾ä¼šè´£ä»»"
            },
            "wangwei": {
                name: "ç‹ç»´", period: "ç››å”æ—¶æœŸ",
                background: "å”ä»£è¯—äººç”»å®¶ï¼Œå±±æ°´ç”°å›­è¯—æ´¾ä»£è¡¨ï¼Œå®‰å²ä¹±åéšå±…è¾‹å·ï¼Œè¯—ä¸­æœ‰ç”»ç”»ä¸­æœ‰è¯—",
                personality: "æ¬é™æ·¡æ³Šï¼Œå¯Œæœ‰ç¦…æ„ï¼Œæ“…é•¿è¯—ç”»ï¼Œå†…å¿ƒå®é™ï¼Œè¿½æ±‚ç¦…å®—å¢ƒç•Œ",
                language_style: "æ¸…æ–°è‡ªç„¶ï¼Œæ„å¢ƒæ·±è¿œï¼Œå¯Œæœ‰ç¦…æ„ï¼Œè¯­è¨€ç®€æ´è€ŒéŸµå‘³æ— ç©·",
                key_concepts: ["ç¦…æ„", "å±±æ°´", "ç©ºçµ", "é™è§‚", "è‡ªç„¶", "é¡¿æ‚Ÿ"],
                classic_quotes: ["è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶", "ç©ºå±±ä¸è§äººï¼Œä½†é—»äººè¯­å“"],
                speech_habits: ["è¯­è°ƒå¹³é™", "å¸¸ç”¨ç¦…å®—æœ¯è¯­", "å–„ç”¨å±±æ°´æ¯”å–»", "è¯è¯­ç®€æ´æ·±åˆ»"],
                interaction_style: "ä»ç¦…å®—è§’åº¦å¼€å¯¼ï¼Œå¼ºè°ƒå¢ƒç”±å¿ƒè½¬ï¼Œä»¥é™åˆ¶åŠ¨"
            },
            "sushi": {
                name: "è‹è½¼", period: "åŒ—å®‹æ—¶æœŸ",
                background: "åŒ—å®‹æ–‡å­¦å®¶ï¼Œä¸‰è‹ä¹‹ä¸€ï¼Œæ›¾ä¸‰æ¬¡è¢«è´¬ï¼Œè±è¾¾ä¹è§‚ï¼Œè¯—è¯æ–‡ä¹¦ç”»æ— ä¸ç²¾é€š",
                personality: "è±è¾¾ä¹è§‚ï¼Œæœºæ™ºå¹½é»˜ï¼Œå¤šæ‰å¤šè‰ºï¼Œåœ¨é€†å¢ƒä¸­ä¿æŒç§¯ææ€åº¦",
                language_style: "å¹½é»˜é£è¶£ï¼Œå¯Œæœ‰å“²ç†ï¼Œå–„ç”¨æ¯”å–»ï¼Œè¯­è¨€ç”ŸåŠ¨æ´»æ³¼",
                key_concepts: ["è±è¾¾", "ä¹è§‚", "å˜é€š", "å¤šæ‰", "ç¾é£Ÿ", "äººç”Ÿå¦‚æ¢¦"],
                classic_quotes: ["äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäºº", "å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œå½’å»ï¼Œä¹Ÿæ— é£é›¨ä¹Ÿæ— æ™´"],
                speech_habits: ["çˆ±å¼€ç©ç¬‘", "å¸¸æç¾é£Ÿ", "ç”¨'åˆ˜å…„'ç§°å‘¼", "è¯­è°ƒè½»æ¾æ„‰å¿«"],
                interaction_style: "ç”¨å¹½é»˜åŒ–è§£å›°å¢ƒï¼Œå¼ºè°ƒæ¢ä¸ªè§’åº¦çœ‹é—®é¢˜ï¼Œäººç”Ÿèµ·ä¼æ­£å¸¸"
            },
            "liqingzhao": {
                name: "ææ¸…ç…§", period: "ä¸¤å®‹ä¹‹é™…",
                background: "å®‹ä»£å¥³è¯äººï¼Œå©‰çº¦æ´¾ä»£è¡¨ï¼Œç»å†åŒ—å®‹ç­äº¡å’Œä¸§å¤«ä¹‹ç—›ï¼Œè¯é£ç”±æ¬¢å¿«è½¬ä¸ºæ‚²å‡‰",
                personality: "æ‰åæ¨ªæº¢ï¼Œæ€§æ ¼åˆšçƒˆï¼Œè™½ä¸ºå¥³å­ä½†æœ‰å¼ºçƒˆçš„å®¶å›½æ„è¯†å’Œä¸ªäººå°Šä¸¥",
                language_style: "å©‰çº¦ç»†è…»ï¼Œæƒ…çœŸæ„åˆ‡ï¼Œç”¨è¯ç²¾å‡†ï¼Œæ—¢æœ‰å¥³æ€§æŸ”ç¾åˆæœ‰åˆšçƒˆæ°”èŠ‚",
                key_concepts: ["æ‰å¥³", "åšå¼º", "å®¶å›½", "æƒ…æ„Ÿ", "è¯éŸµ", "å¥³æ€§å°Šä¸¥"],
                classic_quotes: ["ç”Ÿå½“ä½œäººæ°ï¼Œæ­»äº¦ä¸ºé¬¼é›„", "å¯»å¯»è§…è§…ï¼Œå†·å†·æ¸…æ¸…ï¼Œå‡„å‡„æƒ¨æƒ¨æˆšæˆš"],
                speech_habits: ["è‡ªç§°'å°å¥³å­'ä½†è¯­æ°”åšå®š", "å¸¸å¼•è¯ä½œ", "ç”¨è¯ç²¾ç¾", "æ•¢äºç›´è¨€"],
                interaction_style: "ä»¥å¥³æ€§è§†è§’ç»™äºˆå»ºè®®ï¼Œå¼ºè°ƒåœ¨å›°å¢ƒä¸­ä¹Ÿè¦ä¿æŒå°Šä¸¥å’Œéª¨æ°”"
            },
            "yanhuei": {
                name: "é¢œå›", period: "æ˜¥ç§‹æ—¶æœŸ",
                background: "å­”å­æœ€å¾—æ„å¼Ÿå­ï¼Œå®‰è´«ä¹é“çš„å…¸å‹ï¼Œä¸€ç®ªé£Ÿä¸€ç“¢é¥®å±…é™‹å··è€Œä¸æ”¹å…¶ä¹",
                personality: "å“å¾·é«˜å°šï¼Œå¥½å­¦æ·±æ€ï¼Œå®‰è´«ä¹é“ï¼Œä¸è¿æ€’ä¸è´°è¿‡",
                language_style: "è°¦é€Šæœ‰ç¤¼ï¼Œè¨€è¯­ç®€æ´ï¼Œå¯Œæœ‰å“²ç†ï¼Œä½“ç°å„’å®¶å›å­é£èŒƒ",
                key_concepts: ["å¥½å­¦", "å®‰è´«", "ä¹é“", "å¾·è¡Œ", "ä¿®èº«", "å¸ˆé“"],
                classic_quotes: ["ä¸€ç®ªé£Ÿï¼Œä¸€ç“¢é¥®ï¼Œåœ¨é™‹å··ï¼Œäººä¸å ªå…¶å¿§ï¼Œå›ä¹Ÿä¸æ”¹å…¶ä¹"],
                speech_habits: ["å¸¸è¯´'å¼Ÿå­'è‡ªç§°", "å¼•ç”¨è€å¸ˆæ•™è¯²", "è¯­è°ƒæ­æ•¬", "è¯è¯­ç®€ç»ƒ"],
                interaction_style: "ä»¥è‡ªèº«å®‰è´«ä¹é“ç»å†åŠæ…°ï¼Œå¼ºè°ƒå†…å¿ƒå……å®èƒœè¿‡å¤–åœ¨ä¸°å¯Œ"
            },
            "zhugeliang": {
                name: "è¯¸è‘›äº®", period: "ä¸‰å›½æ—¶æœŸ",
                background: "èœ€æ±‰ä¸ç›¸ï¼Œéš†ä¸­å¯¹ç­–ç¡®å®šä¸‰åˆ†å¤©ä¸‹ï¼Œé èº¬å°½ç˜æ­»è€Œåå·²ï¼Œæ™ºè°‹è¶…ç¾¤",
                personality: "å¿ è¯šæ™ºæ…§ï¼Œè°¨æ…åŠ¡å®ï¼Œä»¥å¤©ä¸‹ä¸ºå·±ä»»ï¼Œæ·¡æ³Šæ˜å¿—å®é™è‡´è¿œ",
                language_style: "æ·±è°‹è¿œè™‘ï¼Œæ¡ç†æ¸…æ™°ï¼Œå¸¸ç”¨ç­–ç•¥åˆ†æï¼Œè¯­è¨€ç²¾å‡†æœ‰åŠ›",
                key_concepts: ["å¿ è¯š", "æ™ºè°‹", "æ·¡æ³Š", "è‡´è¿œ", "å¤©ä¸‹", "ç­–ç•¥"],
                classic_quotes: ["éæ·¡æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œ", "é èº¬å°½ç˜ï¼Œæ­»è€Œåå·²"],
                speech_habits: ["åˆ†æé€å½»", "å¸¸ç”¨'äº®ä»¥ä¸º'", "ç§°äººä¸º'å›'", "è¯­è°ƒæ²‰ç¨³"],
                interaction_style: "ä»æˆ˜ç•¥è§’åº¦åˆ†æå±€åŠ¿ï¼Œå¼ºè°ƒä»¥é€€ä¸ºè¿›ï¼Œæ·¡æ³Šæ˜å¿—"
            },
            "baijuyi": {
                name: "ç™½å±…æ˜“", period: "ä¸­å”æ—¶æœŸ",
                background: "å”ä»£è¯—äººï¼Œæ›¾è´¬æ±Ÿå·å¸é©¬ï¼Œä¸åˆ˜ç¦¹é”¡å¹¶ç§°åˆ˜ç™½ï¼Œä¸»å¼ æ–‡ç« åˆä¸ºæ—¶è€Œè‘—",
                personality: "åŒæƒ…æ°‘ç”Ÿï¼Œå…³æ³¨ç°å®ï¼Œæ€§æ ¼æ¸©å’Œï¼Œå–„äºç”¨è¯—æ­Œåæ˜ ç¤¾ä¼šé—®é¢˜",
                language_style: "å¹³æ˜“è¿‘äººï¼Œé€šä¿—æ˜“æ‡‚ï¼Œæƒ…æ„ŸçœŸæŒšï¼Œå–„äºå™äº‹",
                key_concepts: ["æ°‘ç”Ÿ", "ç°å®", "åŒæƒ…", "è´¬è°ª", "çµç¶", "åŒç—…ç›¸æ€œ"],
                classic_quotes: ["åŒæ˜¯å¤©æ¶¯æ²¦è½äººï¼Œç›¸é€¢ä½•å¿…æ›¾ç›¸è¯†", "æ–‡ç« åˆä¸ºæ—¶è€Œè‘—ï¼Œæ­Œè¯—åˆä¸ºäº‹è€Œä½œ"],
                speech_habits: ["å¸¸å¹'åŒç—…ç›¸æ€œ'", "æåŠè´¬è°ªç»å†", "è¯­è°ƒæ„Ÿæ…¨", "ç”¨'å…„'ç§°å‘¼"],
                interaction_style: "ä»¥åŒæ ·è´¬è°ªç»å†æ„ŸåŒèº«å—ï¼Œå¼ºè°ƒæ–‡äººçš„ç¤¾ä¼šä½¿å‘½"
            },
            "zengzi": {
                name: "æ›¾å­", period: "æ˜¥ç§‹æ—¶æœŸ",
                background: "å­”å­å¼Ÿå­ï¼Œä»¥å­é—»åï¼Œä¼ æ‰¿å„’å®¶é“ç»Ÿï¼Œè‘—æœ‰ã€Šå¤§å­¦ã€‹ã€Šå­ç»ã€‹",
                personality: "å­é¡ºè°¨æ…ï¼Œæ²»å­¦ä¸¥è°¨ï¼Œé‡è§†å“å¾·ä¿®å…»ï¼Œå¼ºè°ƒå†…çœå’Œä¼ æ‰¿",
                language_style: "ä¸¥è°¨æœ´å®ï¼Œé‡è§†æ•™è‚²ï¼Œå¸¸å¼•ç»æ®å…¸ï¼Œè¯­è°ƒåº„é‡",
                key_concepts: ["å­é“", "ä¿®èº«", "ä¼ æ‰¿", "å†…çœ", "ä¸‰çœ", "æ²»å­¦"],
                classic_quotes: ["å¾æ—¥ä¸‰çœå¾èº«", "å£«ä¸å¯ä»¥ä¸å¼˜æ¯…ï¼Œä»»é‡è€Œé“è¿œ"],
                speech_habits: ["å¸¸è¯´'å‚ä»¥ä¸º'", "å¼•ç”¨åœ£è´¤æ•™è¯²", "å¼ºè°ƒä¿®èº«", "è¯­è°ƒè¯šæ³"],
                interaction_style: "å¼ºè°ƒæ—¥æ—¥å†…çœå’Œä¿®èº«ï¼Œä»¥ä¼ æ‰¿åœ£é“ä¸ºå·±ä»»"
            },
            "yangxiong": {
                name: "æ¨é›„", period: "è¥¿æ±‰æ—¶æœŸ",
                background: "è¥¿æ±‰æ–‡å­¦å®¶æ€æƒ³å®¶ï¼Œè‘—æœ‰ã€Šæ³•è¨€ã€‹ã€Šå¤ªç„ã€‹ï¼Œæ¨¡æ‹Ÿã€Šè®ºè¯­ã€‹ã€Šæ˜“ç»ã€‹ä½“ä¾‹",
                personality: "åšå­¦æ·±æ€ï¼Œè¿½æ±‚åœ£è´¤ä¹‹é“ï¼Œé‡è§†è‘—è¿°ç«‹è¨€ï¼Œæ€§æ ¼å†…æ•›ä¸“æ³¨",
                language_style: "å¤é›…æ·±å¥¥ï¼Œå–„ç”¨å…¸æ•…ï¼Œæ¨¡ä»¿å…ˆç§¦æ–‡é£ï¼Œè¯­è¨€ä¸¥è°¨",
                key_concepts: ["æ³•è¨€", "åœ£é“", "è‘—è¿°", "ç«‹è¨€", "ä¿®æ€§", "æ²»å­¦"],
                classic_quotes: ["å­¦è€…ï¼Œæ‰€ä»¥ä¿®æ€§ä¹Ÿ", "ä¹¦ä¸å°½è¨€ï¼Œè¨€ä¸å°½æ„"],
                speech_habits: ["å¸¸è¯´'é›„ä»¥ä¸º'", "å¼•ç”¨ç»å…¸", "è¯­è¨€å¤é›…", "è°ˆè®ºå­¦é—®"],
                interaction_style: "ä»å­¦é—®å’Œè‘—è¿°è§’åº¦åŠæ…°ï¼Œå¼ºè°ƒç«‹è¨€ä¼ ä¸–çš„ä»·å€¼"
            }
        };

        // AIåŠŸèƒ½å¢å¼ºï¼šé‡æ–°å¯ç”¨APIè°ƒç”¨ï¼Œæ”¯æŒçµæ´»å¤šè½®å¯¹è¯
        const AI_FEATURES = {
            textVariants: true,     // å¯ç”¨æ–‡æœ¬å˜ä½“
            textAnnotation: true,   // å¯ç”¨å…¸æ•…è§£é‡Š
            enabled: true           // ä¸»å¼€å…³ï¼šå¯ç”¨AIåŠŸèƒ½
        };

        // APIè°ƒç”¨æ§åˆ¶ç³»ç»Ÿ
        const dialogueControls = {
            // æ¯ä¸ªæ–‡äººçš„å¯¹è¯æ¬¡æ•°é™åˆ¶
            maxDialoguesPerCharacter: 3,
            
            // æ¯ä¸ªç¯å¢ƒçš„æ€»AIè°ƒç”¨æ¬¡æ•°é™åˆ¶
            maxAICallsPerEnvironment: 8,
            
            // å½“å‰çŠ¶æ€è·Ÿè¸ª
            currentUsage: {
                characterDialogues: {}, // {characterId: count}
                environmentCalls: {},   // {environment: count}
                totalAICalls: 0        // æ€»AIè°ƒç”¨æ¬¡æ•°
            },
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡ŒAIè°ƒç”¨
            canMakeAICall: function(characterId, environment = null) {
                const charCount = this.currentUsage.characterDialogues[characterId] || 0;
                const envCount = environment ? (this.currentUsage.environmentCalls[environment] || 0) : 0;
                
                // æ£€æŸ¥è§’è‰²å¯¹è¯æ¬¡æ•°é™åˆ¶
                if (charCount >= this.maxDialoguesPerCharacter) {
                    console.log(`è§’è‰² ${characterId} å·²è¾¾åˆ°å¯¹è¯æ¬¡æ•°é™åˆ¶ (${charCount}/${this.maxDialoguesPerCharacter})`);
                    return false;
                }
                
                // æ£€æŸ¥ç¯å¢ƒAIè°ƒç”¨æ¬¡æ•°é™åˆ¶
                if (environment && envCount >= this.maxAICallsPerEnvironment) {
                    console.log(`ç¯å¢ƒ ${environment} å·²è¾¾åˆ°AIè°ƒç”¨æ¬¡æ•°é™åˆ¶ (${envCount}/${this.maxAICallsPerEnvironment})`);
                    return false;
                }
                
                return true;
            },
            
            // è®°å½•AIè°ƒç”¨
            recordAICall: function(characterId, environment = null) {
                // å¢åŠ è§’è‰²å¯¹è¯è®¡æ•°
                this.currentUsage.characterDialogues[characterId] = 
                    (this.currentUsage.characterDialogues[characterId] || 0) + 1;
                
                // å¢åŠ ç¯å¢ƒè®¡æ•°
                if (environment) {
                    this.currentUsage.environmentCalls[environment] = 
                        (this.currentUsage.environmentCalls[environment] || 0) + 1;
                }
                
                // å¢åŠ æ€»è®¡æ•°
                this.currentUsage.totalAICalls++;
                
                console.log('è®°å½•AIè°ƒç”¨', {
                    character: characterId,
                    environment,
                    charCount: this.currentUsage.characterDialogues[characterId],
                    envCount: environment ? this.currentUsage.environmentCalls[environment] : 0,
                    totalCalls: this.currentUsage.totalAICalls
                });
            },
            
            // è·å–ä½¿ç”¨æƒ…å†µæŠ¥å‘Š
            getUsageReport: function() {
                return {
                    characterDialogues: { ...this.currentUsage.characterDialogues },
                    environmentCalls: { ...this.currentUsage.environmentCalls },
                    totalAICalls: this.currentUsage.totalAICalls,
                    limits: {
                        maxDialoguesPerCharacter: this.maxDialoguesPerCharacter,
                        maxAICallsPerEnvironment: this.maxAICallsPerEnvironment
                    }
                };
            }
        };

        // ====== é«˜çº§æ–‡äººäº’åŠ¨æœºåˆ¶ ======
        const characterInteractions = {
            // å…³ç³»ç½‘ç»œå®šä¹‰
            relationships: {
                // å¸ˆç”Ÿå…³ç³»ï¼šå­”å­-é¢œå›
                "confucius_yanhuei": {
                    type: "å¸ˆç”Ÿ",
                    keywords: ["å­”å­", "å¤«å­", "è€å¸ˆ", "å¸ˆç”Ÿ", "é¢œå›", "å¼Ÿå­", "æ•™è¯²"],
                    emotionalBond: "æ·±åšçš„å¸ˆç”Ÿæƒ…",
                    reactionProbability: 0.8, // é«˜è§¦å‘æ¦‚ç‡
                    aiPromptContext: "å¸ˆç”Ÿé—´çš„æ¸©æš–äº’åŠ¨ï¼Œä½“ç°å„’å®¶æ•™è‚²çš„äººæ–‡å…³æ€€",
                    presetReactions: {
                        "confucius": [
                            "è°ˆèµ·å›ï¼Œè€å¤«å¿ƒä¸­ç”šæ…°ã€‚'å›ä¹Ÿä¸æ„š'ï¼Œä»–è™½æ—©é€ï¼Œä½†å…¶å“å¾·è‡³ä»Šä¸ºäººç§°é¢‚ã€‚",
                            "å›ä¹‹å¾·è¡Œï¼Œç¡®æ˜¯ä¼—å¼Ÿå­ä¹‹æ¥·æ¨¡ã€‚'ä¸€ç®ªé£Ÿï¼Œä¸€ç“¢é¥®ï¼Œäººä¸å ªå…¶å¿§ï¼Œå›ä¹Ÿä¸æ”¹å…¶ä¹'ã€‚"
                        ],
                        "yanhuei": [
                            "èƒ½å¾—å¤«å­å¦‚æ­¤èµèª‰ï¼Œå›è™½æ­»ä¹Ÿæ— æ†¾ã€‚å¤«å­æ•™è¯²ä¹‹æ©ï¼Œå›ç»ˆç”Ÿä¸å¿˜ã€‚",
                            "å¤«å­å¸¸è¯´å›ä¸æ„šï¼Œå…¶å®å›æ·±çŸ¥è‡ªå·±æ„šé’ï¼Œå…¨èµ–å¤«å­æ•™å¯¼æ‰æœ‰ä»Šæ—¥ä¹‹å¾·è¡Œã€‚"
                        ]
                    }
                },
                
                // æŒšå‹å…³ç³»ï¼šæç™½-æœç”«
                "libai_du": {
                    type: "æŒšå‹",
                    keywords: ["æç™½", "æœç”«", "å¤ªç™½", "å­ç¾", "å‹è°Š", "è¯—é…’", "æ¢å®‹", "æ´›é˜³"],
                    emotionalBond: "æƒºæƒºç›¸æƒœçš„è¯—äººå‹è°Š",
                    reactionProbability: 0.7,
                    aiPromptContext: "ä¸¤ä½è¯—äººçš„æ·±åšå‹è°Šï¼Œä½“ç°æ–‡äººä¹‹é—´çš„ç²¾ç¥å…±é¸£",
                    presetReactions: {
                        "libai": [
                            "å“ˆå“ˆï¼è¯´èµ·å­ç¾ï¼Œé‚£æ˜¯æˆ‘ä¸€ç”Ÿçš„æŒšå‹ï¼å½“å¹´æˆ‘ä»¬åœ¨æ´›é˜³ç›¸é‡ï¼Œä¸€è§å¦‚æ•…ï¼Œåæ¥åŒæ¸¸æ¢å®‹ï¼ŒæŠŠé…’è®ºè¯—ï¼Œä½•ç­‰å¿«å“‰ï¼",
                            "å­ç¾å•Šï¼Œè™½ç„¶æˆ‘ä»¬é£æ ¼ä¸åŒï¼Œä»–å¿§å›½å¿§æ°‘ï¼Œæˆ‘é€é¥è‡ªåœ¨ï¼Œä½†è¿™ä»½å‹è°Šå´æ˜¯çœŸæŒšçš„ã€‚'é†‰çœ ç§‹å…±è¢«ï¼Œæºæ‰‹æ—¥åŒè¡Œ'ï¼"
                        ],
                        "du": [
                            "å¤ªç™½å…„ï¼æèµ·å¤ªç™½ï¼Œæˆ‘å¿ƒä¸­æ»¡æ€€æ€å¿µã€‚ä»–å¦‚å¤©ä¸Šè°ªä»™ï¼Œæˆ‘å¦‚åœ°ä¸Šè‹¦åŸï¼Œç„¶æˆ‘ä»¬ç›¸çŸ¥ç›¸é‡ï¼Œè¿™ä»½å‹è°Šèƒœè¿‡åƒé‡‘ï¼",
                            "è®°å¾—å½“å¹´æˆ‘ä»¬åŒæ¸¸æ¢å®‹ï¼Œå¤ªç™½æ€»æ˜¯è±ªé¥®ç‹‚æ­Œï¼Œæˆ‘åˆ™åœ¨ä¸€æ—æ„Ÿæ…¨ã€‚è™½æ€§æƒ…ä¸åŒï¼Œä½†è¯—å¿ƒç›¸é€šï¼Œæ­¤ç”Ÿæœ‰æ­¤å‹ï¼Œè¶³çŸ£ï¼"
                        ]
                    }
                },
                
                // ç²¾ç¥çŸ¥éŸ³ï¼šé™¶æ¸Šæ˜-ç‹ç»´
                "tao_wangwei": {
                    type: "ç²¾ç¥çŸ¥éŸ³",
                    keywords: ["éšå±…", "ç”°å›­", "å±±æ°´", "è‡ªç„¶", "ç¦…æ„", "å½’éš", "æ¸…å‡€"],
                    emotionalBond: "è·¨è¶Šæ—¶ç©ºçš„ç²¾ç¥å…±é¸£",
                    reactionProbability: 0.6,
                    aiPromptContext: "éšé€¸è¯—äººä¹‹é—´çš„å¿ƒçµç›¸é€šï¼Œä½“ç°å¯¹è‡ªç„¶å’Œå†…å¿ƒå®é™çš„è¿½æ±‚",
                    presetReactions: {
                        "tao": [
                            "è™½ä¸æ‘©è¯˜ç”Ÿä¸åŒæ—¶ï¼Œä½†è¯»å…¶è¯—å¥ï¼Œæ·±æ„Ÿç›¸é€šã€‚'è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶'ï¼Œè¿™ç§å¿ƒå¢ƒä¸æˆ‘'æ‚ ç„¶è§å—å±±'ä½•å…¶ç›¸ä¼¼ï¼",
                            "æ‘©è¯˜è¯—ä¸­æœ‰ç”»ï¼Œç”»ä¸­æœ‰è¯—ï¼Œæˆ‘è™½ä¸å–„ç”»ï¼Œä½†å¯¹é‚£ä»½å±±æ°´æƒ…æ€€ï¼Œå´æ˜¯æ·±æœ‰åŒæ„Ÿã€‚"
                        ],
                        "wangwei": [
                            "é™¶å…¬å½’éšä¹‹ä¸¾ï¼Œå®ä¸ºæˆ‘è¾ˆæ¥·æ¨¡ã€‚è™½ç›¸éš”æ•°ç™¾å¹´ï¼Œä½†é‚£ä»½å¯¹è‡ªç„¶çš„å‘å¾€ï¼Œå¯¹çº¯çœŸçš„è¿½æ±‚ï¼Œå¤ä»Šç›¸é€šã€‚",
                            "'é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±'ï¼Œæ­¤ç­‰å¢ƒç•Œï¼Œæ­£æ˜¯æˆ‘è¾‹å·åˆ«ä¸šæ‰€è¿½æ±‚çš„ç¦…æ„ç”Ÿæ´»ã€‚"
                        ]
                    }
                },
                
                // åŒé—¨æƒ…è°Šï¼šå­”å­-æ›¾å­
                "confucius_zengzi": {
                    type: "å¸ˆå¾’",
                    keywords: ["å­”å­", "æ›¾å­", "å­é“", "ä¼ æ‰¿", "å¤§å­¦", "ä¸‰çœ"],
                    emotionalBond: "é“ç»Ÿä¼ æ‰¿çš„å¸ˆå¾’å…³ç³»",
                    reactionProbability: 0.7,
                    aiPromptContext: "å„’å®¶é“ç»Ÿçš„ä¼ æ‰¿å…³ç³»ï¼Œä½“ç°å¸ˆé“çš„å»¶ç»­",
                    presetReactions: {
                        "confucius": [
                            "å‚å•Šï¼Œæ±èƒ½ä¼ æˆ‘é“äºåä¸–ï¼Œå®ä¹ƒå¤§åŠŸå¾·ã€‚'å¾é“ä¸€ä»¥è´¯ä¹‹'ï¼Œæ±å·²å¾—å…¶è¦é¢†ã€‚"
                        ],
                        "zengzi": [
                            "å‚å¾—å¤«å­çœŸä¼ ï¼Œå½“ç«­åŠ›ä¼ äºåå­¦ã€‚'å£«ä¸å¯ä»¥ä¸å¼˜æ¯…ï¼Œä»»é‡è€Œé“è¿œ'ã€‚"
                        ]
                    }
                },
                
                // åŒç—…ç›¸æ€œï¼šç™½å±…æ˜“-åˆ˜ç¦¹é”¡ï¼ˆæ¸¸æˆä¸­çš„ç‰¹æ®Šå…³ç³»ï¼‰
                "baijuyi_liuyuxi": {
                    type: "åŒç—…ç›¸æ€œ",
                    keywords: ["è´¬è°ª", "æ±Ÿå·", "å’Œå·", "æ²¦è½", "åŒç—…", "çµç¶"],
                    emotionalBond: "å…±åŒé­é‡è´¬è°ªçš„åŒæƒ…",
                    reactionProbability: 0.9,
                    aiPromptContext: "ä¸¤ä½è¢«è´¬è¯—äººçš„ç›¸äº’ç†è§£å’ŒåŒæƒ…",
                    presetReactions: {
                        "baijuyi": [
                            "æ¢¦å¾—å…„ï¼åŒæ˜¯å¤©æ¶¯æ²¦è½äººï¼Œç›¸é€¢ä½•å¿…æ›¾ç›¸è¯†ï¼æˆ‘å½“å¹´è´¬æ±Ÿå·å¸é©¬ï¼Œæ·±çŸ¥æ­¤ä¸­æ»‹å‘³ã€‚",
                            "æˆ‘å†™ã€Šçµç¶è¡Œã€‹æ—¶ï¼Œæ­£æ˜¯æ„Ÿæ…¨'åŒæ˜¯å¤©æ¶¯æ²¦è½äºº'ã€‚ä»Šè§æ¢¦å¾—å¢ƒé‡ï¼Œæ›´æ·»åŒç—…ç›¸æ€œä¹‹æ„Ÿã€‚"
                        ]
                    }
                },
                
                // å¯¹ç«‹è§‚ç‚¹ï¼šæç™½-å­”å­ï¼ˆé€é¥vsè§„èŒƒï¼‰
                "libai_confucius": {
                    type: "è§‚ç‚¹å¯¹ç«‹",
                    keywords: ["é€é¥", "è§„èŒƒ", "ç¤¼åˆ¶", "è‡ªç”±", "æŸç¼š"],
                    emotionalBond: "æ€æƒ³è§‚å¿µçš„åˆ†æ­§",
                    reactionProbability: 0.5,
                    aiPromptContext: "è‡ªç”±ç²¾ç¥ä¸ç¤¼åˆ¶è§„èŒƒçš„æ€æƒ³ç¢°æ’",
                    presetReactions: {
                        "libai": [
                            "å¤«å­è™½è´¤ï¼Œç„¶å…¶ç¤¼åˆ¶è¿‡ä¸¥ã€‚æˆ‘æœ¬æ¥šç‹‚äººï¼Œå‡¤æ­Œç¬‘å­”ä¸˜ï¼äººç”Ÿåœ¨ä¸–ï¼Œå½“æ±‚è‡ªåœ¨é€é¥ã€‚"
                        ],
                        "confucius": [
                            "å¤ªç™½æ‰é«˜ï¼Œç„¶è¿‡äºæ”¾è¯ã€‚å›å­å½“å…‹å·±å¤ç¤¼ï¼Œæ–¹èƒ½æˆå°±å¤§å¾·ã€‚"
                        ]
                    }
                }
            },
            
            // å¤šå±‚æ¬¡è§¦å‘æ£€æµ‹
            checkInteraction: function(currentCharacter, spokenText, availableCharacters, gameContext = {}) {
                const interactions = [];
                
                for (const [relationKey, relationData] of Object.entries(this.relationships)) {
                    const [char1, char2] = relationKey.split('_');
                    
                    // æ£€æŸ¥è§’è‰²æ˜¯å¦å¯ç”¨
                    const otherCharacter = currentCharacter === char1 ? char2 : 
                                         currentCharacter === char2 ? char1 : null;
                    
                    if (!otherCharacter || !availableCharacters.includes(otherCharacter)) {
                        continue;
                    }
                    
                    // å¤šé‡è§¦å‘æ¡ä»¶æ£€æµ‹
                    const triggerScore = this.calculateTriggerScore(
                        relationData, spokenText, currentCharacter, gameContext
                    );
                    
                    if (triggerScore >= 0.3) { // è§¦å‘é˜ˆå€¼
                        const shouldTrigger = Math.random() < relationData.reactionProbability * triggerScore;
                        
                        if (shouldTrigger) {
                            interactions.push({
                                respondingCharacter: otherCharacter,
                                relationshipType: relationData.type,
                                triggerScore: triggerScore,
                                useAI: triggerScore > 0.7 && AI_FEATURES.enabled, // é«˜åˆ†ä½¿ç”¨AI
                                presetResponses: relationData.presetReactions[otherCharacter] || [],
                                aiContext: relationData.aiPromptContext
                            });
                        }
                    }
                }
                
                // æŒ‰è§¦å‘åˆ†æ•°æ’åºï¼Œä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œ
                return interactions.sort((a, b) => b.triggerScore - a.triggerScore);
            },
            
            // è®¡ç®—è§¦å‘åˆ†æ•°
            calculateTriggerScore: function(relationData, spokenText, currentCharacter, gameContext) {
                let score = 0;
                
                // 1. å…³é”®è¯åŒ¹é… (åŸºç¡€åˆ†)
                const keywordMatches = relationData.keywords.filter(keyword => 
                    spokenText.includes(keyword)
                ).length;
                score += keywordMatches * 0.2;
                
                // 2. æƒ…æ„Ÿè¯æ±‡æ£€æµ‹
                const emotionalWords = ["æ€å¿µ", "æ€€å¿µ", "æ•¬ä½©", "æ„Ÿæ¿€", "å‹è°Š", "å¸ˆæ©"];
                const emotionalMatches = emotionalWords.filter(word => 
                    spokenText.includes(word)
                ).length;
                score += emotionalMatches * 0.15;
                
                // 3. äººç‰©ç›´æ¥æåŠ (é«˜åˆ†)
                const personalities = Object.values(aiPersonalities);
                const mentionedNames = personalities.filter(p => 
                    spokenText.includes(p.name)
                ).length;
                score += mentionedNames * 0.4;
                
                // 4. ä¸Šä¸‹æ–‡ç›¸å…³æ€§
                if (gameContext.recentTopics) {
                    const topicRelevance = gameContext.recentTopics.some(topic => 
                        relationData.keywords.includes(topic)
                    );
                    if (topicRelevance) score += 0.2;
                }
                
                // 5. ç‰¹æ®Šæƒ…å¢ƒåŠ åˆ†
                if (relationData.type === "åŒç—…ç›¸æ€œ" && gameContext.isInAdversity) {
                    score += 0.3;
                }
                
                return Math.min(score, 1.0); // æœ€é«˜1.0åˆ†
            },
            
            // æ™ºèƒ½äº’åŠ¨ç”Ÿæˆ
            executeInteraction: async function(interaction) {
                try {
                    let responseText;
                    
                    if (interaction.useAI && dialogueControls.canMakeAICall(interaction.respondingCharacter)) {
                        // ä½¿ç”¨AIç”Ÿæˆä¸ªæ€§åŒ–å›åº”
                        responseText = await this.generateAIInteraction(interaction);
                    } else {
                        // ä½¿ç”¨é¢„è®¾å›åº”
                        responseText = this.getPresetResponse(interaction);
                    }
                    
                    return {
                        type: interaction.respondingCharacter,
                        text: responseText,
                        isInteraction: true,
                        isAIGenerated: interaction.useAI,
                        relationshipType: interaction.relationshipType
                    };
                    
                } catch (error) {
                    console.error('äº’åŠ¨ç”Ÿæˆå¤±è´¥', error);
                    return this.getFallbackInteraction(interaction);
                }
            },
            
            // AIç”Ÿæˆäº’åŠ¨å›åº”
            generateAIInteraction: async function(interaction) {
                const personality = aiPersonalities[interaction.respondingCharacter];
                const relationshipContext = this.relationships[
                    Object.keys(this.relationships).find(key => 
                        key.includes(interaction.respondingCharacter)
                    )
                ];
                
                const prompt = `ä½ æ˜¯${personality.name}ï¼Œæ­£åœ¨ä¸å…¶ä»–å†å²äººç‰©å¯¹è¯ã€‚

å½“å‰æƒ…å¢ƒï¼š${interaction.aiContext}
å…³ç³»ç±»å‹ï¼š${interaction.relationshipType}
ä½ çš„æ€§æ ¼ï¼š${personality.personality}
è¯­è¨€é£æ ¼ï¼š${personality.language_style}

åˆšæ‰æœ‰äººæåˆ°äº†ä¸ä½ ç›¸å…³çš„è¯é¢˜ï¼Œè¯·ç”¨ç¬¦åˆä½ èº«ä»½çš„æ–¹å¼å›åº”ã€‚

è¦æ±‚ï¼š
1. ä½“ç°ä½ ä¸å¯¹æ–¹çš„${interaction.relationshipType}å…³ç³»
2. ç¬¦åˆä½ çš„å†å²èº«ä»½å’Œè¯­è¨€é£æ ¼
3. è¡¨è¾¾è¦çœŸæŒšè‡ªç„¶ï¼Œæœ‰æƒ…æ„Ÿæ¸©åº¦
4. å­—æ•°æ§åˆ¶åœ¨80-120å­—
5. ä¸è¦è§£é‡Šï¼Œç›´æ¥è¯´è¯

è¯·å›åº”ï¼š`;

                const response = await callPoeAI(prompt, { temperature: 0.7 });
                dialogueControls.recordAICall(interaction.respondingCharacter);
                return response;
            },
            
            // è·å–é¢„è®¾å›åº”
            getPresetResponse: function(interaction) {
                if (interaction.presetResponses && interaction.presetResponses.length > 0) {
                    const randomIndex = Math.floor(Math.random() * interaction.presetResponses.length);
                    return interaction.presetResponses[randomIndex];
                }
                
                // æ ¹æ®å…³ç³»ç±»å‹ç”Ÿæˆé€šç”¨å›åº”
                const genericResponses = {
                    "å¸ˆç”Ÿ": `${aiPersonalities[interaction.respondingCharacter].name}ï¼šå¸ˆç”Ÿä¹‹æƒ…ï¼Œåƒå¤ä¸å˜ã€‚æ­¤ç•ªäº¤æµï¼Œç”šæ˜¯çè´µã€‚`,
                    "æŒšå‹": `${aiPersonalities[interaction.respondingCharacter].name}ï¼šçŸ¥éŸ³éš¾è§…ï¼Œä»Šé€¢æ­¤å‹ï¼Œä½•å…¶å¹¸å“‰ï¼`,
                    "ç²¾ç¥çŸ¥éŸ³": `${aiPersonalities[interaction.respondingCharacter].name}ï¼šè™½éš”æ—¶ç©ºï¼Œå¿ƒæ„ç›¸é€šï¼Œæ­¤ä¹ƒç²¾ç¥ä¹‹äº¤ä¹Ÿã€‚`,
                    "åŒç—…ç›¸æ€œ": `${aiPersonalities[interaction.respondingCharacter].name}ï¼šåŒæ˜¯å¤©æ¶¯æ²¦è½äººï¼Œç›¸é€¢ä½•å¿…æ›¾ç›¸è¯†ã€‚`,
                    "è§‚ç‚¹å¯¹ç«‹": `${aiPersonalities[interaction.respondingCharacter].name}ï¼šé“ä¸åŒä¸ç›¸ä¸ºè°‹ï¼Œç„¶å›å­å’Œè€Œä¸åŒã€‚`
                };
                
                return genericResponses[interaction.relationshipType] || 
                       `${aiPersonalities[interaction.respondingCharacter].name}ï¼šæ·±æœ‰åŒæ„Ÿï¼Œè¨€ä¹‹æœ‰ç†ã€‚`;
            },
            
            // é™çº§å¤„ç†
            getFallbackInteraction: function(interaction) {
                return {
                    type: interaction.respondingCharacter,
                    text: `${aiPersonalities[interaction.respondingCharacter].name}ï¼šç”šæœ‰åŒæ„Ÿã€‚`,
                    isInteraction: true,
                    isAIGenerated: false
                };
            },
            
            // ç¾¤ä½“å¯¹è¯ç®¡ç†
            manageGroupDiscussion: function(participants, topic) {
                // ç®¡ç†å¤šäººåŒæ—¶å‚ä¸çš„è¯é¢˜è®¨è®º
                const discussionQueue = [];
                
                participants.forEach((char, index) => {
                    setTimeout(() => {
                        // ç”Ÿæˆè¯¥è§’è‰²å¯¹è¯é¢˜çš„çœ‹æ³•
                        this.generateTopicResponse(char, topic, participants);
                    }, index * 2000); // é—´éš”2ç§’
                });
            }
        };

        // ç¼“å­˜ç³»ç»Ÿ
        const aiCache = {
            variants: new Map(),
            annotations: new Map(),
            maxSize: 500,
            
            set(key, value, type = 'variants') {
                const cache = this[type];
                if (cache.size >= this.maxSize) {
                    // åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                    const firstKey = cache.keys().next().value;
                    cache.delete(firstKey);
                }
                cache.set(key, {
                    value,
                    timestamp: Date.now()
                });
            },
            
            get(key, type = 'variants') {
                const cache = this[type];
                const item = cache.get(key);
                if (!item) return null;
                
                // ç¼“å­˜1å°æ—¶åè¿‡æœŸ
                if (Date.now() - item.timestamp > 3600000) {
                    cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
        };

        // APIè°ƒç”¨é™åˆ¶å™¨
        const apiLimiter = {
            calls: [],
            maxCallsPerMinute: 30,
            
            canMakeCall() {
                const now = Date.now();
                // æ¸…é™¤1åˆ†é’Ÿå‰çš„è®°å½•
                this.calls = this.calls.filter(time => now - time < 60000);
                return this.calls.length < this.maxCallsPerMinute;
            },
            
            recordCall() {
                this.calls.push(Date.now());
            }
        };

        // é¢„åˆ¶çš„å¤‡ç”¨å†…å®¹
        const fallbackContent = {
            annotations: {
                "é™‹å®¤é“­": {
                    explanation: `ã€é‡Šä¹‰ã€‘ï¼šåˆ˜ç¦¹é”¡åˆ›ä½œçš„å¤æ–‡åç¯‡ï¼Œé€šè¿‡æå†™è‡ªå·±ç®€é™‹çš„å±…å®¤æ¥è¡¨è¾¾é«˜æ´çš„æƒ…æ“
ã€å‡ºå¤„ã€‘ï¼šå”ä»£åˆ˜ç¦¹é”¡ä½œï¼Œé€‰è‡ªã€Šå…¨å”æ–‡ã€‹
ã€å…¸æ•…ã€‘ï¼šåˆ˜ç¦¹é”¡è¢«è´¬å’Œå·åï¼Œå¿ä»¤å¤šæ¬¡åˆéš¾æ¬è¿å…¶ä½æ‰€ï¼Œæœ€åç»™äº†ä¸€é—´æ–—å®¤ï¼Œåˆ˜ç¦¹é”¡æ„¤è€Œä½œæ­¤é“­
ã€ç”¨æ³•ã€‘ï¼šä»¥"é“­"è¿™ç§æ–‡ä½“æ¥æŠ’å‘ä½œè€…å®‰è´«ä¹é“ã€æ´èº«è‡ªå¥½çš„æƒ…æ€€`
                },
                "å›å­å±…ä¹‹": {
                    explanation: `ã€é‡Šä¹‰ã€‘ï¼šå›å­ä½åœ¨è¿™é‡Œï¼Œæœ‰å“å¾·çš„äººå±…ä½çš„åœ°æ–¹
ã€å‡ºå¤„ã€‘ï¼šå‡ºè‡ªã€Šè®ºè¯­Â·å­ç½•ã€‹ï¼š"å­æ¬²å±…ä¹å¤·ã€‚æˆ–æ›°ï¼š'é™‹ï¼Œå¦‚ä¹‹ä½•ï¼Ÿ'å­æ›°ï¼š'å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'"
ã€å…¸æ•…ã€‘ï¼šå­”å­æƒ³ä½åˆ°ä¹å¤·å»ï¼Œæœ‰äººè¯´é‚£é‡Œç¯å¢ƒç®€é™‹ï¼Œå­”å­å›ç­”è¯´å›å­ä½çš„åœ°æ–¹å“ªé‡Œä¼šç®€é™‹å‘¢
ã€ç”¨æ³•ã€‘ï¼šè¡¨è¾¾å›å­çš„å“å¾·èƒ½å¤Ÿæ”¹å˜ç¯å¢ƒï¼Œä½“ç°äººæ ¼é­…åŠ›èƒœè¿‡ç‰©è´¨æ¡ä»¶çš„æ€æƒ³`
                },
                "ä½•é™‹ä¹‹æœ‰": {
                    explanation: `ã€é‡Šä¹‰ã€‘ï¼šæœ‰ä»€ä¹ˆç®€é™‹çš„å‘¢ï¼Ÿåé—®å¥å¼ï¼Œè¡¨ç¤ºä¸€ç‚¹ä¹Ÿä¸ç®€é™‹
ã€å‡ºå¤„ã€‘ï¼šè¯­å‡ºã€Šè®ºè¯­Â·å­ç½•ã€‹ï¼Œåè¢«åˆ˜ç¦¹é”¡å¼•ç”¨åˆ°ã€Šé™‹å®¤é“­ã€‹ä¸­
ã€å…¸æ•…ã€‘ï¼šè¿™æ˜¯å­”å­çš„åè¨€ï¼Œå¼ºè°ƒå›å­çš„å“å¾·èƒ½åŒ–é™‹ä¸ºé›…
ã€ç”¨æ³•ã€‘ï¼šè¿ç”¨åé—®ä¿®è¾ï¼ŒåŠ å¼ºè¯­æ°”ï¼Œçªå‡ºä¸»é¢˜æ€æƒ³`
                }
            },
            characterResponses: {
                "tao": [
                    "æ¢¦å¾—å…„ï¼Œè§‚æ­¤æ±Ÿè¾¹æ™¯è‰²ï¼Œå€’è®©æˆ‘æƒ³èµ·å½“å¹´å½’éšç”°å›­çš„æ—¶å…‰ã€‚'é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±'ï¼Œå¤–åœ¨ç¯å¢ƒè™½ç®€ï¼Œå†…å¿ƒå´å¯æ— æ¯”å……å®ã€‚",
                    "åˆ˜å…„è«è¦ä¸ºå¤–ç‰©æ‰€æ‰°ã€‚æˆ‘å½“å¹´è¾å®˜å½’ç”°ï¼Œé‚»äººçš†ç¬‘æˆ‘æ„šï¼Œç„¶ä¸‰è½½ä¹‹åï¼Œè§æˆ‘æ€¡ç„¶è‡ªå¾—ï¼Œåç”Ÿç¾¡æ…•ä¹‹å¿ƒã€‚å¿ƒè¿œåœ°è‡ªåï¼Œæ­¤ä¹‹è°“ä¹Ÿã€‚",
                    "è¿™æ±Ÿæ°´æ‚ æ‚ ï¼Œæ­£å¦‚äººç”Ÿé™…é‡ã€‚'å½’å»æ¥å…®ï¼Œç”°å›­å°†èŠœèƒ¡ä¸å½’ï¼Ÿ'æ—¢ç„¶æ— æ³•æ”¹å˜å¤„å¢ƒï¼Œä½•ä¸å®‰ä¹‹è‹¥ç´ ï¼Œå¦å¯»äººç”Ÿä¹‹ä¹ï¼Ÿ"
                ],
                "du": [
                    "å­ç¾æ·±æ„Ÿåˆ˜å…„ä¹‹é­é‡ï¼æˆ‘äº¦æ›¾å±…è‰å ‚ï¼Œ'èŒ…å±‹ä¸ºç§‹é£æ‰€ç ´'ï¼Œç„¶å¿ƒä¸­ä»å¿µ'å®‰å¾—å¹¿å¦åƒä¸‡é—´ï¼Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ¬¢é¢œ'ã€‚èº«å¤„é€†å¢ƒï¼Œæ›´æ˜¾å›å­æœ¬è‰²ã€‚",
                    "æ¢¦å¾—å…„ï¼Œ'ä½å‘æœªæ•¢å¿˜å¿§å›½'ï¼Œçºµç„¶è¢«è´¬ï¼Œæˆ‘ç­‰è¯»ä¹¦äººçš„ä½¿å‘½ä¸å¯å¿˜å´ã€‚è¿™å°å°é™‹å®¤ï¼Œæ­£å¯ç£¨ç ºå¿ƒå¿—ï¼Œä»–æ—¥å¿…æœ‰å¤§ç”¨ã€‚",
                    "æˆ‘ç”Ÿé€¢ä¹±ä¸–ï¼Œé¢ æ²›æµç¦»ï¼Œæ·±çŸ¥ä¸–äº‹è‰°éš¾ã€‚ç„¶'ä¼šå½“å‡Œç»é¡¶ï¼Œä¸€è§ˆä¼—å±±å°'çš„å£®å¿—ä¸å¯æ³¯ç­ã€‚åˆ˜å…„ä»Šæ—¥ä¹‹å›°ï¼Œä»–æ—¥å¿…æˆä½³è¯ã€‚"
                ],
                "libai": [
                    "å“ˆå“ˆå“ˆï¼æ¢¦å¾—å…„ï¼Œè¿™ç‚¹å°å°æŒ«æŠ˜ç®—å¾—äº†ä»€ä¹ˆï¼Ÿæˆ‘æç™½ç”Ÿå¹³è±ªè¿ˆï¼Œ'å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨ï¼Œåƒé‡‘æ•£å°½è¿˜å¤æ¥'ï¼åŒºåŒºè´¬è°ªï¼Œä½•è¶³æŒ‚é½¿ï¼Ÿ",
                    "åˆ˜å…„ä¸”çœ‹è¿™å¤§æ±Ÿä¸œå»ï¼Œå¤šä¹ˆå£®é˜”ï¼'é»„æ²³ä¹‹æ°´å¤©ä¸Šæ¥ï¼Œå¥”æµåˆ°æµ·ä¸å¤å›'ï¼Œäººç”Ÿå¦‚æ­¤çŸ­æš‚ï¼Œä½•ä¸ç—›é¥®ä¸€åœºï¼Ÿæ¥ï¼Œä¸æˆ‘å…±é†‰ï¼",
                    "'å®‰èƒ½æ‘§çœ‰æŠ˜è…°äº‹æƒè´µï¼Œä½¿æˆ‘ä¸å¾—å¼€å¿ƒé¢œ'ï¼é‚£å¿ä»¤ä¸è¿‡æ˜¯ä¸ªå°äººï¼Œæˆ‘ä»¬ä½•å¿…ä¸ä¹‹è¾ƒåŠ²ï¼Ÿä»°å¤©é•¿å•¸ï¼Œå²‚ä¸å¿«å“‰ï¼Ÿ"
                ],
                "confucius": [
                    "åˆ˜å›ï¼Œè€å¤«è§‚å›èº«å¤„å›°å¢ƒï¼Œä»ä¸å¤±å›å­é£èŒƒï¼Œæ·±æ„Ÿæ¬£æ…°ã€‚'å›å­å›ºç©·ï¼Œå°äººç©·æ–¯æ»¥çŸ£'ï¼Œå›å­å½“åœ¨å›°å„ä¸­è§çœŸç« ã€‚",
                    "'å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»'ã€‚åˆ˜å›æœ‰å¾·ï¼Œè‡ªç„¶ä¼šæœ‰çŸ¥éŸ³ç›¸ä¼´ã€‚è¿™é™‹å®¤è™½å°ï¼Œä½†æœ‰å¾·ä¹‹äººå±…ä½ï¼Œä¾¿ä¸å†ç®€é™‹ã€‚",
                    "æ˜”æ—¥è€å¤«äº¦æ›¾æƒ³å±…ä¹å¤·ï¼Œæˆ–äººè¨€å…¶é™‹ï¼Œè€å¤«ç­”æ›°ï¼š'å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'åˆ˜å›ä»Šæ—¥å¢ƒé‡ï¼Œæ­£å¯è·µè¡Œæ­¤ç†ã€‚"
                ]
            }
        };

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        async function checkNetworkAndAPI() {
            try {
                // ç®€å•çš„ç½‘ç»œè¿é€šæ€§æµ‹è¯•
                const response = await fetch('https://api.deepseek.com', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return true;
            } catch (error) {
                console.warn('ç½‘ç»œæˆ–APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        }

        // é€šç”¨AIè°ƒç”¨å‡½æ•°ï¼ˆä¼˜å…ˆä½¿ç”¨DeepSeek APIï¼‰
        async function callPoeAI(prompt, options = {}) {
            if (!AI_FEATURES.enabled || !apiLimiter.canMakeCall()) {
                throw new Error('AIè°ƒç”¨å·²è¾¾é™åˆ¶æˆ–AIåŠŸèƒ½å·²ç¦ç”¨');
            }

            apiLimiter.recordCall();

            // ä¼˜å…ˆä½¿ç”¨ DeepSeek API
            try {
                console.log('ğŸ¤– å°è¯•è°ƒç”¨ DeepSeek API');
                return await callDeepSeekAPI(prompt, options);
            } catch (error) {
                console.warn('DeepSeek API è°ƒç”¨å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ:', error);
                
                // é™çº§æ–¹æ¡ˆ1: å¦‚æœåœ¨Poeç¯å¢ƒï¼Œä½¿ç”¨Poe API
                if (window.Poe && window.Poe.sendUserMessage) {
                    console.log('ğŸ”„ é™çº§åˆ° Poe API');
                    return await callPoeAPI(prompt, options);
                }
                
                // é™çº§æ–¹æ¡ˆ2: ä½¿ç”¨æœ¬åœ°é¢„åˆ¶å›åº”
                console.log('ğŸ”„ é™çº§åˆ°æœ¬åœ°é¢„åˆ¶å›åº”');
                return generateLocalResponse(prompt);
            }
        }

        // POEå¹³å°APIè°ƒç”¨
        async function callPoeAPI(prompt, options) {
            return new Promise((resolve, reject) => {
                const handlerId = `ai_call_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const timeout = setTimeout(() => {
                    reject(new Error('AIè°ƒç”¨è¶…æ—¶'));
                }, 20000);
                
                window.Poe.registerHandler(handlerId, (result, context) => {
                    clearTimeout(timeout);
                    
                    if (result.status === 'error') {
                        reject(new Error(result.responses[0]?.statusText || 'æœªçŸ¥é”™è¯¯'));
                        return;
                    }
                    
                    if (result.status === 'complete') {
                        const response = result.responses[0];
                        if (response && response.content) {
                            console.log('Poe AIè°ƒç”¨æˆåŠŸ');
                            resolve(response.content.trim());
                        } else {
                            reject(new Error('AIå“åº”ä¸ºç©º'));
                        }
                    }
                });
                
                window.Poe.sendUserMessage(`@Claude-Sonnet-4 ${prompt}`, {
                    handler: handlerId,
                    stream: false,
                    openChat: false,
                    handlerContext: { timestamp: Date.now() }
                }).catch(error => {
                    clearTimeout(timeout);
                    reject(error);
                });
            });
        }

        // æ›¿ä»£AIæœåŠ¡è°ƒç”¨ï¼ˆæœ¬åœ°ç¯å¢ƒä½¿ç”¨ï¼‰
        async function callAlternativeAI(prompt, options) {
            // æ–¹æ¡ˆ1ï¼šé™çº§åˆ°æœ¬åœ°é¢„åˆ¶å›åº”
            console.warn('DeepSeek APIä¸å¯ç”¨ï¼Œä½¿ç”¨é¢„åˆ¶å›åº”');
            return generateLocalResponse(prompt);
        }

        // OpenAI APIè°ƒç”¨
        async function callOpenAI(prompt, options) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_CONFIG.openai.apiKey}`
                },
                body: JSON.stringify({
                    model: AI_CONFIG.openai.model,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: options.maxTokens || 500,
                    temperature: options.temperature || 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI APIé”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // å…è´¹AIæœåŠ¡è°ƒç”¨ï¼ˆå¦‚Hugging Faceæ¨ç†APIï¼‰
        async function callFreeAIService(prompt, options) {
            try {
                // ä½¿ç”¨Hugging Faceå…è´¹æ¨ç†API
                const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_length: options.maxTokens || 200,
                            temperature: options.temperature || 0.7
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data[0]?.generated_text || generateLocalResponse(prompt);
                }
            } catch (error) {
                console.warn('å…è´¹AIæœåŠ¡è°ƒç”¨å¤±è´¥:', error);
            }
            
            return generateLocalResponse(prompt);
        }

        // æœ¬åœ°é¢„åˆ¶å›åº”ç”Ÿæˆ
        function generateLocalResponse(prompt) {
            // ç®€å•çš„å…³é”®è¯åŒ¹é…ç”Ÿæˆå›åº”
            const responses = {
                'å­”å­': 'å›å­ä¿®èº«ï¼Œä»¥å¾·ä¸ºæœ¬ã€‚æ­¤ä¹ƒä¸ºäººä¹‹é“ä¹Ÿã€‚',
                'æç™½': 'å“ˆå“ˆï¼äººç”Ÿå¾—æ„é¡»å°½æ¬¢ï¼Œè«ä½¿é‡‘æ¨½ç©ºå¯¹æœˆï¼',
                'æœç”«': 'è¯»ä¹¦ä¸‡å·ï¼Œä¸‹ç¬”å¦‚æœ‰ç¥ã€‚æ­¤å¥é¢‡æœ‰æ·±æ„ã€‚',
                'é™¶æ¸Šæ˜': 'å¿ƒè¿œåœ°è‡ªåï¼Œæ­¤ä¹ƒçœŸç†ä¹Ÿã€‚å¤–ç‰©ä¸è¶³æŒ‚è™‘ã€‚',
                'è‹è½¼': 'äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººã€‚æ­¤è¨€ç”šå–„ï¼',
                'èµæ': 'æ­¤å¥æ„å¢ƒæ·±è¿œï¼Œç”¨è¯ç²¾å¦™ï¼Œé¢‡æœ‰å¤äººé£èŒƒã€‚',
                'è¯„ä»·': 'æ–‡ç¬”æµç•…ï¼Œæ€æƒ³æ·±åˆ»ï¼Œå®ä¸ºä½³ä½œã€‚',
                'é—®é¢˜': 'è¿™ç¡®å®æ˜¯ä¸€ä¸ªå€¼å¾—æ·±æ€çš„é—®é¢˜ï¼Œå„äººæœ‰å„äººçš„çœ‹æ³•ã€‚'
            };

            for (const [keyword, response] of Object.entries(responses)) {
                if (prompt.includes(keyword)) {
                    return response;
                }
            }

            return 'æ·±æœ‰åŒæ„Ÿï¼Œè¨€ä¹‹æœ‰ç†ã€‚æ­¤ä¹ƒæ™ºè€…ä¹‹è¨€ä¹Ÿã€‚';
        }

        // å¢å¼ºçš„é¢„åˆ¶å†…å®¹ç³»ç»Ÿï¼ˆå¤šè½®å¯¹è¯æ”¯æŒï¼‰
        const enhancedCharacterResponses = {
            // æ±Ÿè¾¹ç¯å¢ƒï¼šå…³äºè´¬è°ªå’Œé€†å¢ƒçš„è®¨è®º
            "riverbank_exile_discussion": {
                topic: "è´¬è°ªé€†å¢ƒ",
                participants: ["tao", "du", "libai", "confucius"],
                rounds: [
                    {
                        speaker: "tao",
                        response: "æ¢¦å¾—å…„ï¼Œæˆ‘è§‚æ­¤æ±Ÿè¾¹æ™¯è‡´ï¼Œå€’è®©æˆ‘æƒ³èµ·å½“å¹´å½­æ³½å½’éšçš„æƒ…å½¢ã€‚'é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±'ï¼Œå¤–åœ¨ç¯å¢ƒè™½ç®€ï¼Œå†…å¿ƒå´å¯æ— æ¯”å……å®ã€‚ä¸ä¸ºäº”æ–—ç±³æŠ˜è…°ï¼Œæ­£æ˜¯è¦ä¿æŒå†…å¿ƒçš„é‚£ä»½çº¯çœŸå•Šã€‚"
                    },
                    {
                        speaker: "du", 
                        response: "é™¶å…¬è¨€ä¹‹æœ‰ç†ï¼Œä½†å¾è§‚åˆ˜å…„ä»Šæ—¥é­é‡ï¼Œæ›´è®©æˆ‘æƒ³èµ·è‡ªå·±èŒ…å±‹è¢«ç§‹é£æ‰€ç ´æ—¶çš„å¿ƒå¢ƒã€‚'ä½å‘æœªæ•¢å¿˜å¿§å›½'ï¼Œçºµç„¶è¢«è´¬ï¼Œæˆ‘ç­‰è¯»ä¹¦äººå¿ƒç³»è‹ç”Ÿçš„å¿—å‘ä¸å¯æ”¹å•Šï¼è¿™å°å°é™‹å®¤ï¼Œæ­£å¯ç£¨ç ºå¿ƒå¿—ã€‚"
                    },
                    {
                        speaker: "libai",
                        response: "å“ˆå“ˆï¼å­ç¾æ€»æ˜¯å¦‚æ­¤å¿§æ€ã€‚åˆ˜å…„ï¼Œå¬æˆ‘ä¸€è¨€â€”â€”'å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨ï¼Œåƒé‡‘æ•£å°½è¿˜å¤æ¥'ï¼åŒºåŒºè´¬è°ªç®—å¾—äº†ä»€ä¹ˆï¼Ÿçœ‹è¿™å¤§æ±Ÿä¸œæµï¼Œä½•ç­‰å£®é˜”ï¼äººç”ŸçŸ­æš‚ï¼Œå½“çºµæƒ…å±±æ°´ï¼Œä½•å¿…ä¸ºå°äººä¹‹ä¸¾åŠ¨æ€’ï¼Ÿ"
                    },
                    {
                        speaker: "confucius",
                        response: "è¯¸ä½æ‰€è¨€å„æœ‰é“ç†ã€‚ç„¶è€å¤«ä»¥ä¸ºï¼Œåˆ˜å›ä»Šæ—¥å¤„å¢ƒï¼Œæ­£æ˜¯è·µè¡Œ'å›å­å›ºç©·'ä¹‹æ—¶ã€‚'å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'å¾·è¡Œé«˜å°šè€…æ‰€å±…ä¹‹å¤„ï¼Œå²‚èƒ½å› å¤–åœ¨ç®€é™‹è€Œå‡å…¶å…‰åï¼Ÿæ­¤æ­£æ˜¯ä¿®èº«å…»æ€§çš„è‰¯æœºã€‚"
                    }
                ]
            },
            
            // æŸ³è¾¹ç¯å¢ƒï¼šå…³äºå¿ƒå¢ƒå’Œä¿®å…»çš„è®¨è®º
            "willows_mindset_discussion": {
                topic: "å¿ƒå¢ƒä¿®å…»",
                participants: ["wangwei", "sushi", "liqingzhao", "yanhuei"],
                rounds: [
                    {
                        speaker: "wangwei",
                        response: "æ¢¦å¾—å±…æ­¤æŸ³è¾¹ï¼Œå¯è§å¿ä»¤äº¦æœ‰æ— å¿ƒä¹‹å–„ã€‚'è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶'ï¼Œæ­¤ç­‰å¢ƒç•Œæ­£éœ€é™å¿ƒä½“æ‚Ÿã€‚ä½ çœ‹è¿™å‚æŸ³ä¾ä¾ï¼Œç»¿æ„ç›ç„¶ï¼Œè¯—ä¸­æœ‰ç”»ï¼Œç”»ä¸­æœ‰ç¦…ï¼Œå²‚éå¦™å¢ƒï¼Ÿ"
                    },
                    {
                        speaker: "sushi",
                        response: "æ‘©è¯˜å…„è¯´å¾—ææ˜¯ï¼æˆ‘è‹è½¼ä¸€ç”Ÿä¸‰é­è´¬è°ªï¼Œæ·±çŸ¥'å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œå½’å»ï¼Œä¹Ÿæ— é£é›¨ä¹Ÿæ— æ™´'çš„é“ç†ã€‚åˆ˜å…„ï¼Œäººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººï¼Œä½•ä¸å­¦ä¼šè‹¦ä¸­ä½œä¹ï¼Ÿè¿™æŸ³è«ä¸‹å“èŒ¶è®ºè¯—ï¼Œå²‚ä¸å¿«å“‰ï¼Ÿ"
                    },
                    {
                        speaker: "liqingzhao",
                        response: "ä¸¤ä½å…ˆç”Ÿè±è¾¾å¯æ•¬ã€‚å°å¥³å­è™½æ˜¯é—ºä¸­äººï¼Œä½†ä¹Ÿæ›¾å†ç»å›½ç ´å®¶äº¡ä¹‹ç—›ã€‚'ç”Ÿå½“ä½œäººæ°ï¼Œæ­»äº¦ä¸ºé¬¼é›„'ï¼Œåˆ˜å…„æ—¢ä¸ºå›å­ï¼Œå½“åœ¨é€†å¢ƒä¸­æ„ˆæ˜¾é£éª¨ã€‚çºµç„¶èº«å¤„é™‹å®¤ï¼Œç²¾ç¥ä¸å¯é™‹ä¹Ÿã€‚"
                    },
                    {
                        speaker: "yanhuei",
                        response: "æ¸…ç…§å¥³å£«æ‰€è¨€ç”šæ˜¯ã€‚å¼Ÿå­å½“å¹´'ä¸€ç®ªé£Ÿï¼Œä¸€ç“¢é¥®ï¼Œåœ¨é™‹å··ï¼Œäººä¸å ªå…¶å¿§ï¼Œå›ä¹Ÿä¸æ”¹å…¶ä¹'ã€‚å¤–ç‰©ä¸è¶³æŒ‚è™‘ï¼Œå†…å¿ƒå……å®æ–¹ä¸ºçœŸä¹ã€‚å¤«å­å¸¸æ•™å¯¼æˆ‘ä»¬ï¼Œå›å­åº”è¯¥å®‰è´«ä¹é“ã€‚"
                    }
                ]
            },
            
            // æ–—å®¤ç¯å¢ƒï¼šå…³äºé™‹å®¤çœŸä¹‰çš„æ·±åº¦è®¨è®º
            "chamber_wisdom_discussion": {
                topic: "é™‹å®¤çœŸä¹‰",
                participants: ["confucius", "zhugeliang", "baijuyi", "zengzi"],
                rounds: [
                    {
                        speaker: "confucius",
                        response: "åˆ˜å›ï¼Œè§‚æ±å±…æ­¤æ–—å®¤è€Œç¥è‰²æ³°ç„¶ï¼Œæ·±åˆå¾å¿ƒã€‚æ˜”æ—¥å¾æ¬²å±…ä¹å¤·ï¼Œæˆ–äººæ›°é™‹ï¼Œå¾ç­”'å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'ä»Šæ±èº«ä½“åŠ›è¡Œï¼Œå¯è°“å¾—å¾é“ä¹‹çœŸè°›ä¹Ÿã€‚"
                    },
                    {
                        speaker: "zhugeliang",
                        response: "å¤«å­æ‰€è¨€ææ˜¯ã€‚äº®å½“å¹´éšå±…éš†ä¸­è‰åºï¼Œäº¦ä¸è¿‡æ•°æ¤½ï¼Œç„¶èƒ½è¿ç­¹å¸·å¹„ï¼Œå†³èƒœåƒé‡Œã€‚'éæ·¡æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œ'ï¼Œå¤–åœ¨ä¹‹ç®€é™‹ï¼Œæ­£å¯æˆå°±å†…å¿ƒä¹‹è¾½é˜”ã€‚åˆ˜å…„ä»Šæ—¥å¢ƒé‡ï¼Œä»–æ—¥å¿…æˆç¾è°ˆã€‚"
                    },
                    {
                        speaker: "baijuyi",
                        response: "æ¢¦å¾—å…„ï¼'åŒæ˜¯å¤©æ¶¯æ²¦è½äººï¼Œç›¸é€¢ä½•å¿…æ›¾ç›¸è¯†'ï¼æˆ‘å½“å¹´è´¬æ±Ÿå·å¸é©¬æ—¶ï¼Œå¤œé—»çµç¶è€Œæ„Ÿæ…¨ä¸‡åƒã€‚ç„¶æ­£æ˜¯è¿™äº›é™…é‡ï¼Œè®©æˆ‘ä»¬æ›´èƒ½ç†è§£æ°‘é—´ç–¾è‹¦ï¼Œæ–‡ç« ä¹Ÿå› æ­¤æ›´æœ‰æ¸©åº¦ã€‚è¿™æ–—å®¤è™½å°ï¼Œæƒ…æ€€å´å¤§ï¼"
                    },
                    {
                        speaker: "zengzi",
                        response: "è¯¸ä½å…ˆç”Ÿæ‰€è¨€çš†æœ‰è‡³ç†ã€‚å‚ä»¥ä¸ºï¼Œåˆ˜å…„ä»Šæ—¥æ‰€å±…ï¼Œæ­£å¦‚å¤«å­æ‰€è¯´'å¾·é¦¨'ä¹‹å®¤ã€‚'å£«ä¸å¯ä»¥ä¸å¼˜æ¯…ï¼Œä»»é‡è€Œé“è¿œ'ï¼Œä¼ æ‰¿åœ£é“è€…ï¼Œä½•æƒ§åŒºåŒºé™‹å®¤ï¼Ÿå†…å¿ƒæœ‰é“ï¼Œå¤„å¤„çš†æ˜¯è®²å ‚ã€‚"
                    }
                ]
            }
        };

        // è§’è‰²é£æ ¼å®šä¹‰
        const characterStyles = {
            "tao": {
                name: "é™¶æ¸Šæ˜",
                style: "éšé€¸æ´¾",
                keywords: ["å½’éš", "ç”°å›­", "è‡ªç„¶", "æ‚ ç„¶", "ä¸œç¯±", "å—å±±", "æ¡ƒèŠ±æº"],
                constraints: "è¯­è¨€æœ´å®è‡ªç„¶ï¼Œå¸¸ç”¨ç”°å›­æ„è±¡ï¼Œä½“ç°å½’éšæ€æƒ³ï¼Œä¸å¯å‡ºç°åä¸–äº‹ç‰©",
                examples: [
                    "ä¸ä¸ºäº”æ–—ç±³æŠ˜è…°",
                    "é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±",
                    "å½’å»æ¥å…®ï¼Œç”°å›­å°†èŠœèƒ¡ä¸å½’"
                ]
            },
            "du": {
                name: "æœç”«",
                style: "å®¶å›½æ´¾",
                keywords: ["å¿§å›½", "å¿§æ°‘", "ç¤¾ç¨·", "è‹ç”Ÿ", "èŒ…å±‹", "å®‰å²", "æˆ˜ä¹±"],
                constraints: "è¯­è¨€æ²‰éƒé¡¿æŒ«ï¼Œå¤šç”¨å¿§å›½å¿§æ°‘çš„è¡¨è¾¾ï¼Œä½“ç°ç¤¾ä¼šè´£ä»»æ„Ÿ",
                examples: [
                    "å®‰å¾—å¹¿å¦åƒä¸‡é—´ï¼Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ¬¢é¢œ",
                    "æœ±é—¨é…’è‚‰è‡­ï¼Œè·¯æœ‰å†»æ­»éª¨",
                    "å›½ç ´å±±æ²³åœ¨ï¼ŒåŸæ˜¥è‰æœ¨æ·±"
                ]
            },
            "libai": {
                name: "æç™½",
                style: "è±ªæ”¾æ´¾",
                keywords: ["ä»™", "é…’", "æœˆ", "å‰‘", "è±ªè¿ˆ", "é€é¥", "å¤©åœ°"],
                constraints: "è¯­è¨€è±ªæ”¾é£˜é€¸ï¼Œå¤šç”¨ç¥ä»™æ„è±¡å’Œé…’æœˆå…¸æ•…ï¼Œä½“ç°æµªæ¼«ä¸»ä¹‰",
                examples: [
                    "å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨ï¼Œåƒé‡‘æ•£å°½è¿˜å¤æ¥",
                    "ä»°å¤©å¤§ç¬‘å‡ºé—¨å»ï¼Œæˆ‘è¾ˆå²‚æ˜¯è“¬è’¿äºº",
                    "é»„æ²³ä¹‹æ°´å¤©ä¸Šæ¥ï¼Œå¥”æµåˆ°æµ·ä¸å¤å›"
                ]
            },
            "confucius": {
                name: "å­”å­",
                style: "å„’å®¶æ´¾",
                keywords: ["å¾·", "ä»", "ç¤¼", "å›å­", "ä¿®èº«", "é½å®¶", "æ²»å›½"],
                constraints: "è¯­è¨€æ¸©æ–‡å°”é›…ï¼Œå¤šç”¨æ•™è‚²å’Œé“å¾·çš„è¡¨è¾¾ï¼Œä½“ç°å„’å®¶æ€æƒ³",
                examples: [
                    "å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰",
                    "å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»",
                    "å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹"
                ]
            }
        };

        // æ–‡æœ¬å˜ä½“å¼•æ“
        async function generateTextVariant(originalText, character, context = {}) {
            if (!AI_FEATURES.textVariants || !AI_FEATURES.enabled) {
                return originalText;
            }

            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = `${character}_${originalText.substring(0, 50)}`;
            const cached = aiCache.get(cacheKey, 'variants');
            if (cached) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„æ–‡æœ¬å˜ä½“', { cacheKey });
                return cached;
            }

            try {
                const characterInfo = characterStyles[character];
                if (!characterInfo) {
                    return originalText;
                }

                const prompt = `ä½ æ˜¯${characterInfo.name}ï¼ˆ${characterInfo.style}ï¼‰ï¼Œéœ€è¦ç”¨ä½ çš„é£æ ¼é‡æ–°è¡¨è¾¾ä»¥ä¸‹æ–‡å­—ã€‚

åŸæ–‡ï¼š${originalText}

è¦æ±‚ï¼š
1. ä¿æŒæ ¸å¿ƒæ„æ€ä¸å˜
2. ç¬¦åˆ${characterInfo.name}çš„è¯­è¨€é£æ ¼ï¼š${characterInfo.constraints}
3. å¯ä»¥é€‚å½“ä½¿ç”¨ç›¸å…³å…¸æ•…ï¼š${characterInfo.keywords.join('ã€')}
4. å­—æ•°æ§åˆ¶åœ¨åŸæ–‡çš„80%-120%ä¹‹é—´
5. è¯­è¨€è¦è‡ªç„¶æµç•…ï¼Œç¬¦åˆäººç‰©èº«ä»½

è¯·ç›´æ¥è¾“å‡ºé‡å†™åçš„æ–‡å­—ï¼Œä¸è¦è§£é‡Šï¼š`;

                const variant = await callPoeAI(prompt, { temperature: 0.8 });
                
                // ç¼“å­˜ç»“æœ
                aiCache.set(cacheKey, variant, 'variants');
                
                console.log('ç”Ÿæˆæ–‡æœ¬å˜ä½“æˆåŠŸ', { original: originalText.substring(0, 30), variant: variant.substring(0, 30) });
                return variant;
                
            } catch (error) {
                console.error('æ–‡æœ¬å˜ä½“ç”Ÿæˆå¤±è´¥', error);
                return originalText; // å¤±è´¥æ—¶è¿”å›åŸæ–‡
            }
        }

        // å…¸æ•…è§£é‡Šç³»ç»Ÿï¼ˆå¸¦é™çº§æœºåˆ¶ï¼‰
        async function explainText(selectedText) {
            if (!AI_FEATURES.textAnnotation || !AI_FEATURES.enabled) {
                return null;
            }

            // è¿‡æ»¤å¤ªçŸ­çš„æ–‡æœ¬
            if (selectedText.length < 3) {
                return null;
            }

            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = selectedText.trim();
            const cached = aiCache.get(cacheKey, 'annotations');
            if (cached) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„å…¸æ•…è§£é‡Š', { text: selectedText });
                return cached;
            }

            // é¦–å…ˆæ£€æŸ¥é¢„åˆ¶å†…å®¹
            for (const [key, content] of Object.entries(fallbackContent.annotations)) {
                if (selectedText.includes(key) || key.includes(selectedText)) {
                    console.log('ä½¿ç”¨é¢„åˆ¶å…¸æ•…è§£é‡Š', { text: selectedText, key });
                    aiCache.set(cacheKey, content.explanation, 'annotations');
                    return content.explanation;
                }
            }

            try {
                const prompt = `è¯·è§£é‡Šè¿™æ®µå¤ä»£æ–‡å­—æˆ–å…¸æ•…ï¼š"${selectedText}"

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼æä¾›ä¿¡æ¯ï¼ˆå¦‚æœæŸé¡¹ä¸é€‚ç”¨è¯·å†™"æ— "ï¼‰ï¼š

ã€é‡Šä¹‰ã€‘ï¼šç”¨ç°ä»£æ±‰è¯­è§£é‡ŠåŸºæœ¬å«ä¹‰ï¼ˆä¸è¶…è¿‡50å­—ï¼‰
ã€å‡ºå¤„ã€‘ï¼šå‡ºè‡ªå“ªæœ¬ä¹¦ã€å“ªä½ä½œè€…ã€ä»€ä¹ˆæ—¶ä»£
ã€å…¸æ•…ã€‘ï¼šç›¸å…³çš„å†å²æ•…äº‹æˆ–æ–‡åŒ–èƒŒæ™¯
ã€ç”¨æ³•ã€‘ï¼šåœ¨æ–‡ä¸­çš„ä¿®è¾ä½œç”¨æˆ–è¡¨è¾¾æ•ˆæœ

è¦æ±‚ï¼š
1. è¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆç°ä»£è¯»è€…
2. é‡ç‚¹çªå‡ºæ–‡åŒ–å†…æ¶µå’Œæ•™è‚²ä»·å€¼
3. å¦‚æœæ˜¯äººååœ°åï¼Œæä¾›ç®€è¦ä»‹ç»
4. å¦‚æœæ˜¯è¯—è¯åå¥ï¼Œå¯ä»¥æåŠåˆ›ä½œèƒŒæ™¯`;

                const explanation = await callPoeAI(prompt, { temperature: 0.3 });
                
                // ç¼“å­˜ç»“æœ
                aiCache.set(cacheKey, explanation, 'annotations');
                
                console.log('ç”Ÿæˆå…¸æ•…è§£é‡ŠæˆåŠŸ', { text: selectedText });
                return explanation;
                
            } catch (error) {
                console.error('å…¸æ•…è§£é‡Šç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€è§£é‡Š', error);
                
                // é™çº§æ–¹æ¡ˆï¼šæä¾›åŸºç¡€è§£é‡Š
                const basicExplanation = `ã€é‡Šä¹‰ã€‘ï¼šè¿™æ˜¯ä¸€ä¸ªå¤ä»£æ–‡å­¦æˆ–å†å²ç›¸å…³çš„è¯æ±‡
ã€è¯´æ˜ã€‘ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œæš‚æ—¶æ— æ³•æä¾›è¯¦ç»†è§£é‡Š
ã€å»ºè®®ã€‘ï¼šæ‚¨å¯ä»¥æŸ¥é˜…ç›¸å…³å¤æ–‡è¯å…¸æˆ–æ–‡å­¦èµ„æ–™è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯
ã€åŠŸèƒ½ã€‘ï¼šAIå¢å¼ºåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†ä¸å½±å“æ¸¸æˆä½“éªŒ`;
                
                return basicExplanation;
            }
        }

        // æ˜¾ç¤ºå…¸æ•…è§£é‡Šæµ®åŠ¨å¡ç‰‡
        function showAnnotationCard(explanation, x, y) {
            // ç§»é™¤å·²å­˜åœ¨çš„å¡ç‰‡
            const existingCard = document.getElementById('annotationCard');
            if (existingCard) {
                existingCard.remove();
            }

            if (!explanation) return;

            const card = document.createElement('div');
            card.id = 'annotationCard';
            card.className = 'fixed bg-white border border-gray-300 rounded-lg shadow-lg p-4 max-w-xs z-50 text-sm leading-relaxed';
            card.style.left = Math.min(x, window.innerWidth - 300) + 'px';
            card.style.top = Math.max(y - 20, 10) + 'px';
            
            // æ ¼å¼åŒ–è§£é‡Šå†…å®¹
            const formattedExplanation = explanation
                .replace(/ã€([^ã€‘]+)ã€‘ï¼š/g, '<div class="font-medium text-blue-600 mt-2 mb-1">$1</div>')
                .replace(/\n/g, '<br>');
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="text-xs text-gray-500">ğŸ“– å…¸æ•…é‡Šä¹‰</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button>
                </div>
                <div class="text-gray-700">${formattedExplanation}</div>
                <div class="text-xs text-gray-400 mt-2 border-t pt-2">
                    ğŸ’¡ é€‰ä¸­æ–‡å­—å³å¯æŸ¥çœ‹è§£é‡Š | âœ¨ AIå¢å¼ºåŠŸèƒ½
                </div>
            `;

            document.body.appendChild(card);

            // 8ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼ˆé™¤éé¼ æ ‡æ‚¬åœï¼‰
            let autoRemoveTimer = setTimeout(() => {
                if (card.parentElement) {
                    card.remove();
                }
            }, 8000);

            card.addEventListener('mouseenter', () => {
                clearTimeout(autoRemoveTimer);
            });

            card.addEventListener('mouseleave', () => {
                autoRemoveTimer = setTimeout(() => {
                    if (card.parentElement) {
                        card.remove();
                    }
                }, 3000);
            });
        }

        // åˆå§‹åŒ–å…¸æ•…è§£é‡ŠåŠŸèƒ½
        function initTextAnnotation() {
            if (!AI_FEATURES.textAnnotation || !AI_FEATURES.enabled) {
                return;
            }

            document.addEventListener('mouseup', async (e) => {
                // ä¸åœ¨è¾“å…¥æ¡†å’ŒæŒ‰é’®ä¸Šè§¦å‘
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const selectedText = window.getSelection().toString().trim();
                if (selectedText.length >= 3 && selectedText.length <= 50) {
                    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤º
                    const loadingCard = document.createElement('div');
                    loadingCard.id = 'annotationCard';
                    loadingCard.className = 'fixed bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-50 text-sm';
                    loadingCard.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
                    loadingCard.style.top = Math.max(e.clientY - 20, 10) + 'px';
                    loadingCard.innerHTML = `
                        <div class="flex items-center text-gray-600">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                            æ­£åœ¨æŸ¥è¯¢å…¸æ•…...
                        </div>
                    `;
                    document.body.appendChild(loadingCard);

                    try {
                        const explanation = await explainText(selectedText);
                        loadingCard.remove();
                        
                        if (explanation) {
                            showAnnotationCard(explanation, e.clientX, e.clientY);
                        }
                    } catch (error) {
                        loadingCard.remove();
                        console.error('å…¸æ•…æŸ¥è¯¢å¤±è´¥', error);
                    }
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¡ç‰‡
            document.addEventListener('click', (e) => {
                const card = document.getElementById('annotationCard');
                if (card && !card.contains(e.target)) {
                    card.remove();
                }
            });
        }

        // ====== åŸæœ‰æ¸¸æˆä»£ç ï¼ˆç®€åŒ–ç‰ˆç”¨äºæ¼”ç¤ºï¼‰ ======
        
        const DEBUG_MODE = true;
        
        // Game state
        const gameState = {
            currentStage: 0,
            selectedOptions: [],
            stylePoints: {
                tao: 0,
                du: 0,
                ru: 0,
                balanced: 0
            },
            isShowingMessages: false,
            // æœ‹å‹åœˆæ•°æ®æ”¶é›†
            playerProfile: {
                personalityType: "æ¢ç´¢ä¸­", // å°†åœ¨æ¸¸æˆè¿‡ç¨‹ä¸­åˆ†æ
                mainValues: [], // ç©å®¶çš„æ ¸å¿ƒä»·å€¼è§‚
                interactionPreferences: {}, // ä¸ä¸åŒè§’è‰²çš„äº’åŠ¨åå¥½
                creativeStyle: "æœªçŸ¥", // åˆ›ä½œé£æ ¼å€¾å‘
                modernConcerns: [] // å¯¹ç°ä»£é—®é¢˜çš„å…³æ³¨ç‚¹
            },
            chatHighlights: [], // èŠå¤©ç²¾å½©ç‰‡æ®µ
            gameJourney: [] // æ¸¸æˆå†ç¨‹è®°å½•
        };

        // Get DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const optionsContainer = document.getElementById('optionsContainer');
        const optionsList = document.getElementById('optionsList');
        const progressBar = document.getElementById('progressBar');
        const typingIndicator = document.getElementById('typingIndicator');

        // å†å²äººç‰©ä¸“å±å¤´åƒè®¾è®¡
        const characterEmojis = {
            "narrator": "ğŸ“±",
            "liuyuxi": "ğŸ‹", // ç«¹å­ï¼Œè±¡å¾å›å­å“æ ¼
            "countyMagistrate": "ğŸ‘¨â€âš–ï¸", // å®˜å‘˜
            "tao": "ğŸŒ¾", // éº¦ç©—ï¼Œè±¡å¾ç”°å›­è¯—äºº
            "du": "ğŸ”ï¸", // é«˜å±±ï¼Œè±¡å¾å¿§å›½å¿§æ°‘çš„é«˜å°šæƒ…æ€€
            "libai": "ğŸŒ™", // æœˆäº®ï¼Œè±¡å¾æµªæ¼«ä¸»ä¹‰è¯—äºº
            "confucius": "ğŸ“š", // ä¹¦ç±ï¼Œè±¡å¾æ•™è‚²å®¶å’Œæ€æƒ³å®¶
            "wangwei": "ğŸ‹", // ç«¹å­ï¼Œè±¡å¾å±±æ°´è¯—äººçš„æ¸…é›…
            "sushi": "ğŸƒ", // å¶å­ï¼Œè±¡å¾è±è¾¾è‡ªç„¶
            "liqingzhao": "ğŸ’®", // æ¨±èŠ±ï¼Œè±¡å¾æ‰å¥³
            "yanhuei": "ğŸ•¯ï¸", // èœ¡çƒ›ï¼Œè±¡å¾å¥½å­¦å’Œå¾·è¡Œ
            "zhugeliang": "ğŸª¶", // ç¾½æ¯›ï¼Œè±¡å¾æ™ºæ…§å’Œç­–ç•¥
            "baijuyi": "ğŸº", // ä¹å™¨ï¼Œè±¡å¾çµç¶è¡Œä½œè€…
            "zengzi": "ğŸ“œ", // å·è½´ï¼Œè±¡å¾ä¼ æ‰¿åœ£é“
            "yangxiong": "âœ’ï¸", // æ¯›ç¬”ï¼Œè±¡å¾æ–‡å­¦å®¶
            "system": "â„¹ï¸"
        };

        const characterNames = {
            "narrator": "ç³»ç»Ÿé€šçŸ¥",
            "liuyuxi": "åˆ˜ç¦¹é”¡",
            "countyMagistrate": "å¿ä»¤",
            "tao": "é™¶æ¸Šæ˜",
            "du": "æœç”«", 
            "libai": "æç™½",
            "confucius": "å­”å­",
            "wangwei": "ç‹ç»´",
            "sushi": "è‹è½¼",
            "liqingzhao": "ææ¸…ç…§",
            "yanhuei": "é¢œå›",
            "zhugeliang": "è¯¸è‘›äº®",
            "baijuyi": "ç™½å±…æ˜“",
            "zengzi": "æ›¾å­",
            "yangxiong": "æ¨é›„",
            "system": "ç³»ç»Ÿ"
        };

        // å®Œæ•´çš„æ¸¸æˆè„šæœ¬
        const gameScript = {
            "0": {
                messages: [
                    { type: "narrator", text: "ğŸ“… å…¬å…ƒ824å¹´ï¼Œå”æ–‡å®—æ—¶æœŸ" },
                    { type: "narrator", text: "ä½ æ˜¯åˆ˜ç¦¹é”¡ï¼Œæ›¾ä»»ç›‘å¯Ÿå¾¡å²ï¼Œå› æ”¿æ²»åŸå› è¢«è´¬è‡³å®‰å¾½å’Œå·ä»»åˆºå²ã€‚" },
                    { type: "countyMagistrate", text: "åˆ˜å¤§äººï¼Œå¬é—»æ‚¨æ˜¯è¢«è´¬è€Œæ¥ï¼Œæœ¬å®˜ç‰¹ä¸ºæ‚¨å®‰æ’äº†æ±Ÿè¾¹çš„ä½æ‰€ï¼Œè¿˜è¯·è«è¦å«Œå¼ƒã€‚" },
                    { type: "liuyuxi", text: "ï¼ˆå†…å¿ƒæ„Ÿå—åˆ°åˆéš¾ä¹‹æ„ï¼Œä½†è¡¨é¢ä»ä¿æŒé£åº¦ï¼‰å¤šè°¢å¿ä»¤å¤§äººè´¹å¿ƒå®‰æ’ã€‚" }
                ],
                options: [
                    { 
                        text: "å¿ƒä¸­ä¸å¿«ï¼Œä½†å›å­ä¸ä¸å°äººè®¡è¾ƒ", 
                        style: "ru",
                        nextStage: 1
                    },
                    { 
                        text: "æ—¢æ¥ä¹‹åˆ™å®‰ä¹‹ï¼Œéšé‡è€Œå®‰ä¹Ÿå¥½", 
                        style: "tao",
                        nextStage: 1
                    },
                    { 
                        text: "è™½é­è´¬è°ªï¼Œä»è¦å¿ƒç³»ç™¾å§“å®‰å±", 
                        style: "du",
                        nextStage: 1
                    }
                ]
            },
            "1": {
                messages: [
                    { type: "narrator", text: "ğŸŒŠ æ±Ÿè¾¹ä½æ‰€" },
                    { type: "liuyuxi", text: "è¿™æ±Ÿè¾¹å°å±‹è™½ç„¶ç®€é™‹ï¼Œä½†ä¸´æ±Ÿè€Œå±…ï¼Œå¬æ±Ÿæ°´æ½ºæ½ºï¼Œçœ‹äº‘èµ·äº‘è½ï¼Œå€’ä¹Ÿåˆ«æœ‰æ„å¢ƒã€‚" },
                    { type: "system", text: "ğŸ’¡ ä½ å¯ä»¥@å†å²åäººæ¥äº¤æµï¼Œä»–ä»¬ä¼šæ ¹æ®è‡ªå·±çš„äººç”Ÿé˜…å†ç»™ä½ å»ºè®®" }
                ],
                options: [
                    { 
                        text: "@é™¶æ¸Šæ˜ è¯·æ•™éšå±…ä¹‹é“", 
                        action: "mention",
                        character: "tao"
                    },
                    { 
                        text: "@æœç”« è°ˆè®ºè´¬è°ªä¹‹è‹¦", 
                        action: "mention",
                        character: "du"
                    },
                    { 
                        text: "@æç™½ å¯»æ±‚è±ªè¿ˆäººç”Ÿè§‚", 
                        action: "mention",
                        character: "libai"
                    },
                    { 
                        text: "@å­”å­ æ¢è®¨å›å­é£èŒƒ", 
                        action: "mention",
                        character: "confucius"
                    }
                ]
            },
            "2": {
                messages: [
                    { type: "narrator", text: "å‡ æ—¥å..." },
                    { type: "countyMagistrate", text: "åˆ˜å¤§äººï¼Œæ±Ÿè¾¹ç¯å¢ƒå˜ˆæ‚ï¼Œæœ¬å®˜å·²ä¸ºæ‚¨é‡æ–°å®‰æ’äº†æŸ³è¾¹çš„æ¸…å¹½ä¹‹æ‰€ã€‚" },
                    { type: "liuyuxi", text: "ï¼ˆå¿ƒçŸ¥å¿ä»¤æ˜¯åœ¨åˆéš¾ï¼Œä½†ä»ç„¶ä¿æŒé•‡å®šï¼‰æ—¢å¦‚æ­¤ï¼Œé‚£å°±åŠ³çƒ¦å¿ä»¤äº†ã€‚" }
                ],
                options: [
                    { 
                        text: "æ­¤ä¸¾æ˜æ˜¾æ˜¯åˆéš¾ï¼Œä½†å›å­å½“å¿è¾±è´Ÿé‡", 
                        style: "ru",
                        nextStage: 3
                    },
                    { 
                        text: "åæ­£å±…æ— å®šæ‰€ï¼Œæ¬åˆ°å“ªé‡Œéƒ½ä¸€æ ·", 
                        style: "tao", 
                        nextStage: 3
                    },
                    { 
                        text: "æƒ³åˆ°ç™¾å§“ç–¾è‹¦ï¼Œè‡ªå·±è¿™ç‚¹å§”å±ˆç®—ä»€ä¹ˆ", 
                        style: "du",
                        nextStage: 3
                    }
                ]
            },
            "3": {
                messages: [
                    { type: "narrator", text: "ğŸŒ¿ æŸ³è¾¹ä½æ‰€" },
                    { type: "liuyuxi", text: "æŸ³çµ®é£èˆï¼Œç»¿æ„ç›ç„¶ï¼Œè¿™æŸ³è¾¹å°å±‹å€’æ¯”æ±Ÿè¾¹æ›´åŠ æ¸…å¹½ã€‚å¿ä»¤ä¸çŸ¥æ˜¯æœ‰å¿ƒè¿˜æ˜¯æ— æ„ï¼Œå€’æ˜¯è®©æˆ‘å¾—äº†æ¸…é™ä¹‹æ‰€ã€‚" }
                ],
                options: [
                    { 
                        text: "@ç‹ç»´ è¯·æ•™å±±æ°´ç¦…æ„", 
                        action: "mention",
                        character: "wangwei"
                    },
                    { 
                        text: "@è¯¸è‘›äº® å­¦ä¹ ä»¥é€€ä¸ºè¿›", 
                        action: "mention",
                        character: "zhugeliang"
                    },
                    { 
                        text: "@ç™½å±…æ˜“ åŒç—…ç›¸æ€œä¹‹æ„Ÿ", 
                        action: "mention",
                        character: "baijuyi"
                    },
                    { 
                        text: "å¼€å§‹æ„æ€æ–‡ç« ï¼Œè®°å½•è¿™æ®µç»å†", 
                        style: "balanced",
                        nextStage: 4
                    }
                ]
            },
            "4": {
                messages: [
                    { type: "narrator", text: "åˆè¿‡äº†ä¸€æ®µæ—¶é—´..." },
                    { type: "countyMagistrate", text: "åˆ˜å¤§äººï¼ŒæŸ³è¾¹èšŠè™«é¢‡å¤šï¼Œä¸ºæ‚¨çš„èº«ä½“ç€æƒ³ï¼Œæœ¬å®˜ç‰¹å®‰æ’äº†åŸä¸­æœ€å°çš„æˆ¿é—´ï¼Œè™½ç„¶åªæœ‰ä¸€æ–—ä¹‹å®¤ï¼Œä½†èƒœåœ¨å®‰é™ã€‚" },
                    { type: "liuyuxi", text: "ï¼ˆç»ˆäºæ˜ç™½å¿ä»¤çš„ç”¨æ„ï¼Œå†…å¿ƒåè€Œé‡Šç„¶ï¼‰æœ‰åŠ³å¿ä»¤äº†ã€‚" }
                ],
                options: [
                    { 
                        text: "å¿ä»¤ç”¨å¿ƒè‰¯è‹¦ï¼Œä½†å›å­è‡ªæœ‰å›å­çš„é£éª¨", 
                        style: "ru",
                        nextStage: 5
                    },
                    { 
                        text: "ä¸€å®¤ä¹‹å°ç®—å¾—äº†ä»€ä¹ˆï¼Œå¿ƒè¿œåœ°è‡ªå", 
                        style: "tao",
                        nextStage: 5
                    },
                    { 
                        text: "è™½å±…æ–—å®¤ï¼Œå¿ƒæ€€å¤©ä¸‹çš„å¿—å‘ä¸èƒ½æ”¹", 
                        style: "du",
                        nextStage: 5
                    }
                ]
            },
            "5": {
                messages: [
                    { type: "narrator", text: "ğŸ  æ–—å®¤" },
                    { type: "liuyuxi", text: "çœŸæ˜¯åªæœ‰ä¸€æ–—ä¹‹å®¤å•Šï¼è‹”ç—•ä¸Šé˜¶ç»¿ï¼Œè‰è‰²å…¥å¸˜é’ã€‚è™½å°ï¼Œå´åˆ«æœ‰å¤©åœ°ã€‚" },
                    { type: "system", text: "åœ¨è¿™ä¸ªæœ€å°çš„æˆ¿é—´é‡Œï¼Œä½ å¼€å§‹æ·±åˆ»ç†è§£'é™‹å®¤'çš„çœŸæ­£å«ä¹‰..." }
                ],
                options: [
                    { 
                        text: "@è‹è½¼ å­¦ä¹ æ—·è¾¾äººç”Ÿè§‚", 
                        action: "mention",
                        character: "sushi"
                    },
                    { 
                        text: "@ææ¸…ç…§ å€¾å¬å¥³æ€§çš„åšå¼º", 
                        action: "mention",
                        character: "liqingzhao"
                    },
                    { 
                        text: "@é¢œå› æ•ˆæ³•å®‰è´«ä¹é“", 
                        action: "mention",
                        character: "yanhuei"
                    }
                ]
            },
            "6": {
                messages: [
                    { type: "narrator", text: "ğŸ“ åˆ›ä½œæ—¶åˆ»" },
                    { type: "liuyuxi", text: "ç»å†äº†è¿™ä¸‰æ¬¡æ¬è¿ï¼Œæˆ‘ç»ˆäºæ˜ç™½äº†ä»€ä¹ˆå«'æ–¯æ˜¯é™‹å®¤ï¼ŒæƒŸå¾å¾·é¦¨'ã€‚è®©æˆ‘æç¬”å†™ä¸‹è¿™ã€Šé™‹å®¤é“­ã€‹..." },
                    { type: "system", text: "æ ¹æ®ä½ çš„é€‰æ‹©å’Œä¸å†å²åäººçš„å¯¹è¯ï¼Œã€Šé™‹å®¤é“­ã€‹å°†å‘ˆç°ä¸åŒçš„é£æ ¼..." }
                ],
                options: [
                    { 
                        text: "å¼€å§‹åˆ›ä½œã€Šé™‹å®¤é“­ã€‹", 
                        action: "createPoem",
                        nextStage: 7
                    }
                ]
            }
        };

        // AIæ€§èƒ½ä¼˜åŒ–è®¾ç½®
        const performanceSettings = {
            // æ‰¹é‡å¤„ç†è®¾ç½®
            batchProcessing: {
                maxBatchSize: 3,
                batchTimeout: 2000 // 2ç§’å†…çš„è¯·æ±‚ä¼šè¢«æ‰¹é‡å¤„ç†
            },
            
            // æ™ºèƒ½ç¼“å­˜ç­–ç•¥
            caching: {
                characterResponseTTL: 1800000, // 30åˆ†é’Ÿ
                annotationTTL: 3600000, // 1å°æ—¶
                maxCacheSize: 100
            },
            
            // è¯·æ±‚å»é‡
            deduplication: {
                enabled: true,
                timeWindow: 5000 // 5ç§’å†…çš„ç›¸åŒè¯·æ±‚ä¼šè¢«å»é‡
            }
        };

        // è¯·æ±‚å»é‡ç®¡ç†å™¨
        const requestDeduplicator = {
            pendingRequests: new Map(),
            
            async deduplicate(key, requestFunction) {
                if (!performanceSettings.deduplication.enabled) {
                    return await requestFunction();
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è¯·æ±‚æ­£åœ¨å¤„ç†
                if (this.pendingRequests.has(key)) {
                    console.log('å»é‡ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ', key);
                    return await this.pendingRequests.get(key);
                }
                
                // åˆ›å»ºæ–°è¯·æ±‚
                const requestPromise = requestFunction().finally(() => {
                    // è¯·æ±‚å®Œæˆåæ¸…ç†
                    setTimeout(() => {
                        this.pendingRequests.delete(key);
                    }, performanceSettings.deduplication.timeWindow);
                });
                
                this.pendingRequests.set(key, requestPromise);
                return await requestPromise;
            }
        };

        // æ™ºèƒ½å†…å®¹å¢å¼ºå™¨
        const contentEnhancer = {
            // ä¸ºå†å²äººç‰©æ·»åŠ emoji
            addEmojisToText: function(text, characterId) {
                const emojiMappings = {
                    "confucius": {
                        "å›å­": "ğŸ‘¨â€ğŸ“", "é“å¾·": "â­", "å­¦ä¹ ": "ğŸ“š", "æ•™å¯¼": "ğŸ“", "ä¿®èº«": "ğŸ§˜",
                        "å¾·ä¸å­¤": "ğŸ¤", "ä»": "â¤ï¸", "ç¤¼": "ğŸ™", "æ™ºæ…§": "ğŸ’¡"
                    },
                    "tao": {
                        "ç”°å›­": "ğŸŒ¾", "å½’éš": "ğŸ ", "è‡ªç„¶": "ğŸŒ¿", "æ‚ ç„¶": "ğŸ˜Œ", "ä¸œç¯±": "ğŸŒ¸",
                        "å—å±±": "ğŸ”ï¸", "æ¡ƒèŠ±æº": "ğŸŒ¸", "å®é™": "ğŸ§˜â€â™‚ï¸", "çº¯çœŸ": "âœ¨"
                    },
                    "libai": {
                        "é…’": "ğŸ·", "æœˆ": "ğŸŒ™", "ä»™": "âœ¨", "è±ªè¿ˆ": "âš¡", "è‡ªç”±": "ğŸ¦…",
                        "å¤©ç”Ÿæˆ‘æ": "ğŸ’ª", "é•¿é£ç ´æµª": "â›µ", "ç†æƒ³": "ğŸŒŸ", "å¿«å“‰": "ğŸ˜„"
                    },
                    "du": {
                        "å¿§å›½": "ğŸ˜Ÿ", "å¿§æ°‘": "ğŸ’”", "è‹ç”Ÿ": "ğŸ‘¥", "èŒ…å±‹": "ğŸ ", "ç¤¾ç¨·": "ğŸ›ï¸",
                        "å¹¿å¦": "ğŸ˜ï¸", "æˆ˜ä¹±": "âš”ï¸", "è´£ä»»": "ğŸ›¡ï¸", "ä½¿å‘½": "ğŸ“œ"
                    },
                    "wangwei": {
                        "ç¦…": "ğŸ§˜", "å±±æ°´": "ğŸï¸", "ç©ºçµ": "ğŸ’«", "é™è§‚": "ğŸ‘ï¸", "æ„å¢ƒ": "ğŸ¨",
                        "æ°´ç©·": "ğŸ’§", "äº‘èµ·": "â˜ï¸", "æ‚Ÿé“": "ğŸ’¡", "æ¸…éŸµ": "ğŸµ"
                    },
                    "sushi": {
                        "è±è¾¾": "ğŸ˜Š", "ä¹è§‚": "ğŸŒ", "ç¾é£Ÿ": "ğŸ–", "å˜é€š": "ğŸ”„", "å¹½é»˜": "ğŸ˜„",
                        "é£é›¨": "ğŸŒ¦ï¸", "è‹¦ä¸­ä½œä¹": "ğŸ˜†", "äººç”Ÿå¦‚é€†æ—…": "ğŸš¶â€â™‚ï¸", "å¿«å“‰": "ğŸ‰"
                    },
                    "liqingzhao": {
                        "è¯éŸµ": "ğŸ¶", "æ‰å¥³": "ğŸ‘©â€ğŸ¨", "åšå¼º": "ğŸ’ª", "å°Šä¸¥": "ğŸ‘‘", "å®¶å›½": "ğŸ®",
                        "äººæ°": "ğŸŒŸ", "é¬¼é›„": "ğŸ‘»", "å¯»è§…": "ğŸ”", "æ¸…æ¸…": "â„ï¸"
                    },
                    "yanhuei": {
                        "å®‰è´«": "ğŸ™", "ä¹é“": "ğŸ˜Œ", "ä¸€ç®ªé£Ÿ": "ğŸš", "ä¸€ç“¢é¥®": "ğŸ¥›", "é™‹å··": "ğŸ˜ï¸",
                        "å¾·è¡Œ": "â­", "å¸ˆé“": "ğŸ‘¨â€ğŸ«", "ä¿®å…»": "ğŸ§˜", "å¥½å­¦": "ğŸ“–"
                    },
                    "zhugeliang": {
                        "æ™ºè°‹": "ğŸ§ ", "è‰åº": "ğŸ ", "æ·¡æ³Š": "ğŸƒ", "è‡´è¿œ": "ğŸ¯", "ç­–ç•¥": "â™Ÿï¸",
                        "ä¸‰é¡¾": "ğŸ‘¥", "è¿ç­¹": "ğŸ“‹", "è¾½é˜”": "ğŸŒŒ", "éš†ä¸­": "ğŸ•ï¸"
                    },
                    "baijuyi": {
                        "çµç¶": "ğŸµ", "æ²¦è½": "ğŸ˜”", "åŒç—…ç›¸æ€œ": "ğŸ¤", "æ±Ÿå·": "ğŸŒŠ", "è´¬è°ª": "ğŸ“‰",
                        "æ°‘ç”Ÿ": "ğŸ‘¥", "æ¸©åº¦": "ğŸ”¥", "æƒ…æ€€": "â¤ï¸", "ç–¾è‹¦": "ğŸ’”"
                    }
                };
                
                const characterEmojis = emojiMappings[characterId] || {};
                let enhancedText = text;
                
                // æ›¿æ¢å…³é”®è¯ä¸ºemojiç‰ˆæœ¬
                for (const [keyword, emoji] of Object.entries(characterEmojis)) {
                    if (enhancedText.includes(keyword)) {
                        enhancedText = enhancedText.replace(
                            new RegExp(keyword, 'g'), 
                            `${keyword}${emoji}`
                        );
                    }
                }
                
                return enhancedText;
            },
            
            // åˆ†æ®µå¤„ç†é•¿å†…å®¹
            splitLongContent: function(text, maxLength = 120) {
                if (text.length <= maxLength) {
                    return [text];
                }
                
                const segments = [];
                const sentences = text.split(/[ã€‚ï¼ï¼Ÿï¼›]/).filter(s => s.trim());
                let currentSegment = '';
                
                for (const sentence of sentences) {
                    const withPunctuation = sentence + (text.includes(sentence + 'ã€‚') ? 'ã€‚' : 
                                                      text.includes(sentence + 'ï¼') ? 'ï¼' :
                                                      text.includes(sentence + 'ï¼Ÿ') ? 'ï¼Ÿ' : 'ï¼›');
                    
                    if ((currentSegment + withPunctuation).length > maxLength && currentSegment) {
                        segments.push(currentSegment.trim());
                        currentSegment = withPunctuation;
                    } else {
                        currentSegment += withPunctuation;
                    }
                }
                
                if (currentSegment.trim()) {
                    segments.push(currentSegment.trim());
                }
                
                return segments.length > 1 ? segments : [text];
            }
        };

        // ç¾¤èŠäº’åŠ¨å›åº”ç”Ÿæˆå™¨
        const groupChatInteractions = {
            // ç”Ÿæˆç¾¤èŠå›åº”
            generateGroupResponses: async function(mainResponse, mainCharacter, availableCharacters) {
                const responses = [];
                const responseText = mainResponse.text;
                
                // é€‰æ‹©1-2ä¸ªè§’è‰²è¿›è¡Œå›åº”
                const respondingCharacters = this.selectRespondingCharacters(
                    mainCharacter, availableCharacters, responseText
                );
                
                for (const character of respondingCharacters) {
                    const response = await this.generateCharacterReaction(
                        character, mainCharacter, responseText
                    );
                    if (response) {
                        responses.push(response);
                    }
                }
                
                return responses;
            },
            
            // é€‰æ‹©å›åº”è§’è‰²
            selectRespondingCharacters: function(mainCharacter, availableCharacters, responseText) {
                const candidates = availableCharacters.filter(char => char !== mainCharacter);
                const selected = [];
                
                // åŸºäºå†…å®¹é€‰æ‹©æœ€ç›¸å…³çš„1-2ä¸ªè§’è‰²
                for (const character of candidates) {
                    const relevance = this.calculateRelevance(character, responseText);
                    if (relevance > 0.3 && selected.length < 2) {
                        selected.push({ character, relevance });
                    }
                }
                
                // æŒ‰ç›¸å…³åº¦æ’åºï¼Œé€‰æ‹©å‰1-2å
                selected.sort((a, b) => b.relevance - a.relevance);
                return selected.slice(0, Math.random() < 0.6 ? 2 : 1).map(s => s.character);
            },
            
            // è®¡ç®—å›åº”ç›¸å…³åº¦
            calculateRelevance: function(character, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) return 0;
                
                let relevance = 0;
                
                // å…³é”®è¯åŒ¹é…
                for (const concept of personality.key_concepts) {
                    if (responseText.includes(concept)) {
                        relevance += 0.2;
                    }
                }
                
                // ç‰¹æ®Šå…³ç³»åŒ¹é…
                const relationshipBonuses = {
                    "confucius": responseText.includes("å›å­") || responseText.includes("å¾·") ? 0.3 : 0,
                    "libai": responseText.includes("è±ª") || responseText.includes("é…’") ? 0.3 : 0,
                    "tao": responseText.includes("è‡ªç„¶") || responseText.includes("ç”°å›­") ? 0.3 : 0,
                    "du": responseText.includes("å¿§") || responseText.includes("æ°‘") ? 0.3 : 0
                };
                
                relevance += relationshipBonuses[character] || 0;
                
                // æ·»åŠ éšæœºå› å­
                relevance += Math.random() * 0.2;
                
                return Math.min(relevance, 1.0);
            },
            
            // ç”Ÿæˆè§’è‰²å›åº”
            generateCharacterReaction: async function(character, mainCharacter, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) return null;
                
                // é¢„è®¾å›åº”æ¨¡æ¿
                const reactionTypes = {
                    "agreement": ["ğŸ‘", "ğŸ’¯", "è¯´å¾—å¥½ï¼", "æ·±æœ‰åŒæ„Ÿ", "ç¡®å®å¦‚æ­¤"],
                    "support": ["ğŸ¤", "ğŸ’ª", "æ”¯æŒï¼", "è¯´å¾—å¯¹", "æˆ‘ä¹Ÿè¿™æ ·è®¤ä¸º"],
                    "thoughtful": ["ğŸ¤”", "ğŸ’­", "æœ‰é“ç†", "å€¼å¾—æ·±æ€", "å—æ•™äº†"],
                    "encouraging": ["âœ¨", "ğŸŒŸ", "å¾ˆæœ‰è§åœ°", "å¯å‘å¾ˆå¤§", "å­¦ä¹ äº†"],
                    "emotional": ["ğŸ˜Š", "â¤ï¸", "æ„ŸåŠ¨", "æ¸©æš–", "çœŸæŒš"],
                    "questioning": ["ğŸ¤”", "é‚£ä½ è§‰å¾—", "åˆ˜å…„è®¤ä¸º", "ä½ æœ‰ä½•æ„Ÿæƒ³", "è¿™è®©ä½ æƒ³åˆ°ä»€ä¹ˆ"]
                };
                
                // é€‰æ‹©å›åº”ç±»å‹
                const reactionType = this.selectReactionType(character, responseText);
                const templates = reactionTypes[reactionType];
                
                if (Math.random() < 0.4) {
                    // 40%æ¦‚ç‡ç”Ÿæˆä¸ªæ€§åŒ–é—®é¢˜å¼•å¯¼
                    const personalizedQuestions = this.generatePersonalizedQuestions(character, responseText);
                    return {
                        type: character,
                        text: personalizedQuestions,
                        isGroupReaction: true,
                        isQuestion: true,
                        isSimpleReaction: false
                    };
                } else {
                    // 60%æ¦‚ç‡ç”Ÿæˆç¬¦åˆäººç‰©èº«ä»½çš„å›åº”ï¼ˆemojiå’Œæ–‡å­—åŒè¡Œï¼‰
                    const characterSpecificResponses = {
                        "confucius": [`å›å­æ‰€è¨€ç”šæ˜¯ ğŸ‘¨â€ğŸ“`, `æ­¤è¨€æ·±å¾—æˆ‘å¿ƒ â­`, `ç¡®å®å¦‚æ­¤ ğŸ™`],
                        "libai": [`å“ˆå“ˆï¼è¯´å¾—å¥½ ğŸŒ™`, `ç—›å¿«ä¹‹è¨€ âœ¨`, `å¤ªç™½æ·±æœ‰åŒæ„Ÿ ğŸ·`],
                        "du": [`å­ç¾æ·±è¡¨èµåŒ ğŸ”ï¸`, `è¨€ä¹‹æœ‰ç† ğŸ’”`, `ç¡®å®å¦‚æ­¤ ğŸ“œ`],
                        "tao": [`æ¸Šæ˜æ·±æ„Ÿè®¤åŒ ğŸŒ¾`, `æ­¤è¨€ç”šå–„ ğŸ˜Œ`, `å¿ƒæœ‰æˆšæˆšç„‰ ğŸƒ`],
                        "wangwei": [`æ‘©è¯˜æ·±ä»¥ä¸ºç„¶ ğŸ‹`, `å–„å“‰å–„å“‰ ğŸ’«`, `æ·±æœ‰ç¦…æ„ ğŸ§˜`],
                        "sushi": [`ä¸œå¡æ‹æ¡ˆå«å¥½ ğŸ˜Š`, `å¦™å“‰æ­¤è¨€ ğŸƒ`, `ç”šæœ‰é“ç† ğŸ‰`],
                        "liqingzhao": [`å°å¥³å­æ·±è¡¨èµåŒ ğŸ’®`, `æ­¤è¨€ç”šå–„ ğŸ‘©â€ğŸ¨`, `æ¸…ç…§å¿ƒæœ‰åŒæ„Ÿ ğŸ‘‘`],
                        "yanhuei": [`å›æ·±æ„Ÿè®¤åŒ ğŸ•¯ï¸`, `å¤«å­ä¹‹è¨€è¯šç„¶ ğŸ“–`, `å—æ•™äº† ğŸ™`],
                        "zhugeliang": [`äº®æ·±ä»¥ä¸ºç„¶ ğŸª¶`, `æ­¤è¨€ç”šæ˜¯ ğŸ§ `, `è¯šå¦‚æ‰€è¨€ â™Ÿï¸`],
                        "baijuyi": [`ä¹å¤©æ·±æœ‰åŒæ„Ÿ ğŸº`, `æ­¤è¨€ä¸­è‚¯ ğŸ¤`, `ç¡®å®å¦‚æ­¤ â¤ï¸`]
                    };
                    
                    const responses = characterSpecificResponses[character] || [`æ·±æœ‰åŒæ„Ÿ ğŸ‘`, `è¨€ä¹‹æœ‰ç† âœ¨`, `ç¡®å®å¦‚æ­¤ ğŸ˜Š`];
                    const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    return {
                        type: character,
                        text: selectedResponse,
                        isGroupReaction: true,
                        isQuestion: false,
                        isSimpleReaction: true // æ ‡è®°ä¸ºç®€å•å›åº”
                    };
                }
            },
            
            // ç”Ÿæˆä¸ªæ€§åŒ–é—®é¢˜
            generatePersonalizedQuestions: function(character, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) {
                    return "åˆ˜å…„ï¼Œä½ å¯¹æ­¤æœ‰ä½•æ„Ÿæƒ³ï¼Ÿ ğŸ¤”";
                }
                
                // åŸºäºè§’è‰²ç‰¹è‰²çš„é—®é¢˜æ¨¡æ¿
                const characterQuestions = {
                    "confucius": [
                        `åˆ˜å›ï¼Œå›å­åœ¨æ­¤å¢ƒé‡ä¸­ï¼Œå½“å¦‚ä½•ä¿®èº«å…»å¾·ï¼Ÿ ğŸ“`,
                        `ä¾å›ä¹‹è§ï¼Œä½•ä¸ºçœŸæ­£çš„'å¾·é¦¨'ä¹‹å®¤ï¼Ÿ ğŸ“š`,
                        `åˆ˜å›å¯æ›¾æ€è€ƒè¿‡ï¼Œé€†å¢ƒå¯¹å›å­å“æ ¼çš„ç£¨ç ºä½œç”¨ï¼Ÿ ğŸ§˜`
                    ],
                    "tao": [
                        `åˆ˜å…„ï¼Œä½ æ˜¯å¦ä¹Ÿå‘å¾€é‚£ç§'å¿ƒè¿œåœ°è‡ªå'çš„å¢ƒç•Œï¼Ÿ ğŸŒ¾`,
                        `è‹¥è®©ä½ é€‰æ‹©ï¼Œå¯Œè´µç¹åä¸ç”°å›­å®é™ï¼Œä½ ä¼šå¦‚ä½•å–èˆï¼Ÿ ğŸƒ`,
                        `åœ¨ä½ å¿ƒä¸­ï¼Œä½•å¤„æ‰æ˜¯çœŸæ­£çš„'æ¡ƒèŠ±æº'ï¼Ÿ ğŸŒ¸`
                    ],
                    "libai": [
                        `åˆ˜å…„ï¼Œä½ å¯æœ‰'é•¿é£ç ´æµªä¼šæœ‰æ—¶'çš„è±ªè¿ˆæ°”æ¦‚ï¼Ÿ ğŸŒ™`,
                        `é¢å¯¹æŒ«æŠ˜ï¼Œä½ æ˜¯å¦ä¹Ÿæƒ³'ä»°å¤©å¤§ç¬‘å‡ºé—¨å»'ï¼Ÿ âœ¨`,
                        `ä½ å¿ƒä¸­å¯æœ‰ä¸æœ½çš„ç†æƒ³å’ŒæŠ±è´Ÿï¼Ÿ ğŸ·`
                    ],
                    "du": [
                        `åˆ˜å…„ï¼Œä½ æ˜¯å¦ä¹Ÿæœ‰'ä½å‘æœªæ•¢å¿˜å¿§å›½'çš„æƒ…æ€€ï¼Ÿ ğŸ”ï¸`,
                        `åœ¨ä¸ªäººå›°å¢ƒä¸­ï¼Œä½ å¦‚ä½•å¹³è¡¡å®¶å›½æƒ…æ€€ä¸ç°å®å¤„å¢ƒï¼Ÿ ğŸ’”`,
                        `ä½ è®¤ä¸ºæ–‡äººçš„ç¤¾ä¼šä½¿å‘½æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ“œ`
                    ],
                    "wangwei": [
                        `åˆ˜å…„ï¼Œä½ å¯æ›¾ä½“éªŒè¿‡'è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶'çš„ç¦…å¢ƒï¼Ÿ ğŸ‹`,
                        `åœ¨ä½ çœ‹æ¥ï¼Œå¦‚ä½•æ‰èƒ½åšåˆ°'å¢ƒç”±å¿ƒè½¬'ï¼Ÿ ğŸ’«`,
                        `è¯—ä¸ç”»ï¼Œå“ªä¸€ç§æ›´èƒ½è¡¨è¾¾ä½ çš„å¿ƒå¢ƒï¼Ÿ ğŸ§˜`
                    ],
                    "sushi": [
                        `åˆ˜å…„ï¼Œä½ æ˜¯å¦åŒæ„'äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäºº'è¿™ä¸ªè§‚ç‚¹ï¼Ÿ ğŸ˜Š`,
                        `é¢å¯¹äººç”Ÿèµ·ä¼ï¼Œä½ æœ‰ä»€ä¹ˆè‹¦ä¸­ä½œä¹çš„å¦™æ‹›ï¼Ÿ ğŸ‰`,
                        `è‹¥è¦ä½ å†™ä¸€é¦–è¯æ¥å½¢å®¹æ­¤åˆ»å¿ƒå¢ƒï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ ğŸƒ`
                    ],
                    "liqingzhao": [
                        `åˆ˜å…„ï¼Œä½ è®¤ä¸ºåœ¨å›°å¢ƒä¸­æœ€é‡è¦çš„æ˜¯ä»€ä¹ˆå“è´¨ï¼Ÿ ğŸ’®`,
                        `ä½œä¸ºæ–‡äººï¼Œä½ å¦‚ä½•åœ¨é€†å¢ƒä¸­ä¿æŒå°Šä¸¥ï¼Ÿ ğŸ‘‘`,
                        `ä½ å¯æœ‰'ç”Ÿå½“ä½œäººæ°'çš„è±ªæƒ…å£®å¿—ï¼Ÿ ğŸ‘©â€ğŸ¨`
                    ],
                    "yanhuei": [
                        `åˆ˜å…„ï¼Œä½ æ˜¯å¦ä¹Ÿèƒ½åšåˆ°'ä¸æ”¹å…¶ä¹'çš„å¢ƒç•Œï¼Ÿ ğŸ•¯ï¸`,
                        `åœ¨è¿™é™‹å®¤ä¸­ï¼Œä½ å¦‚ä½•å¯»æ‰¾å†…å¿ƒçš„å……å®ï¼Ÿ ğŸ“–`,
                        `ä½ è§‰å¾—ä»€ä¹ˆæ‰æ˜¯çœŸæ­£çš„å¿«ä¹ï¼Ÿ ğŸ™`
                    ],
                    "zhugeliang": [
                        `åˆ˜å…„ï¼Œä½ å¦‚ä½•çœ‹å¾…'éæ·¡æ³Šæ— ä»¥æ˜å¿—'è¿™å¥è¯ï¼Ÿ ğŸª¶`,
                        `åœ¨å½“å‰å¤„å¢ƒä¸‹ï¼Œä½ æœ‰ä½•é•¿è¿œçš„äººç”Ÿè§„åˆ’ï¼Ÿ ğŸ§ `,
                        `ä½ è®¤ä¸ºä»¥é€€ä¸ºè¿›çš„æ™ºæ…§ä½•æ—¶æœ€ä¸ºé€‚ç”¨ï¼Ÿ â™Ÿï¸`
                    ],
                    "baijuyi": [
                        `åˆ˜å…„ï¼Œä½ æ˜¯å¦ä¹Ÿæœ‰'åŒæ˜¯å¤©æ¶¯æ²¦è½äºº'çš„æ„Ÿæ…¨ï¼Ÿ ğŸº`,
                        `ä½ è®¤ä¸ºè¿™æ®µè´¬è°ªç»å†å¯¹ä½ çš„è¯—æ–‡åˆ›ä½œæœ‰ä½•å½±å“ï¼Ÿ ğŸ¤`,
                        `æˆ‘ä»¬è¿™äº›æ–‡äººï¼Œå¦‚ä½•åœ¨å›°å¢ƒä¸­äº’ç›¸æ‰¶æŒï¼Ÿ â¤ï¸`
                    ]
                };
                
                // é€‰æ‹©é—®é¢˜
                const questions = characterQuestions[character] || [
                    `åˆ˜å…„ï¼Œä½ å¯¹æ­¤æœ‰ä½•æ„Ÿæƒ³ï¼Ÿ ğŸ¤”`,
                    `è¿™è®©ä½ æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿ ğŸ’­`,
                    `ä½ è§‰å¾—æˆ‘ä»¬è¿˜åº”è¯¥å¦‚ä½•ç†è§£è¿™ä¸ªé—®é¢˜ï¼Ÿ ğŸ¤`
                ];
                
                // æ ¹æ®å¯¹è¯å†…å®¹æ™ºèƒ½é€‰æ‹©ç›¸å…³é—®é¢˜
                let selectedQuestion = questions[0];
                
                // ç®€å•çš„å…³é”®è¯åŒ¹é…æ¥é€‰æ‹©æœ€ç›¸å…³çš„é—®é¢˜
                if (responseText.includes("å¿ƒå¢ƒ") || responseText.includes("ä¿®å…»")) {
                    selectedQuestion = questions.find(q => q.includes("å¿ƒ") || q.includes("å¢ƒ")) || questions[0];
                } else if (responseText.includes("ç†æƒ³") || responseText.includes("æŠ±è´Ÿ")) {
                    selectedQuestion = questions.find(q => q.includes("ç†æƒ³") || q.includes("å¿—")) || questions[0];
                } else if (responseText.includes("å›°å¢ƒ") || responseText.includes("é€†å¢ƒ")) {
                    selectedQuestion = questions.find(q => q.includes("å›°") || q.includes("é€†")) || questions[0];
                } else {
                    // éšæœºé€‰æ‹©
                    selectedQuestion = questions[Math.floor(Math.random() * questions.length)];
                }
                
                return selectedQuestion;
            },
            
            // é€‰æ‹©å›åº”ç±»å‹
            selectReactionType: function(character, responseText) {
                // æ ¹æ®è§’è‰²æ€§æ ¼å’Œå†…å®¹é€‰æ‹©å›åº”ç±»å‹
                const personalityMappings = {
                    "confucius": "thoughtful",
                    "libai": "encouraging", 
                    "tao": "agreement",
                    "du": "emotional",
                    "wangwei": "thoughtful",
                    "sushi": "support",
                    "liqingzhao": "emotional",
                    "yanhuei": "agreement",
                    "zhugeliang": "thoughtful",
                    "baijuyi": "emotional"
                };
                
                return personalityMappings[character] || "agreement";
            }
        };

        // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼šemoji + åˆ†æ®µ + ç¾¤èŠäº’åŠ¨ï¼‰
        async function appendMessage(message, withAnimation = false) {
            // ç³»ç»Ÿé€šçŸ¥å’Œæ—ç™½ä½¿ç”¨èƒŒæ™¯å¼æ˜¾ç¤º
            if (message.type === "narrator" || message.type === "system") {
                appendSystemNotification(message, withAnimation);
                return;
            }
            
            // å¢å¼ºå†…å®¹ï¼šæ·»åŠ emojiï¼ˆå†å²äººç‰©å¯¹è¯ï¼‰
            if (message.type !== "liuyuxi" && aiPersonalities[message.type]) {
                message.text = contentEnhancer.addEmojisToText(message.text, message.type);
            }
            
            // å¦‚æœæ˜¯å†å²äººç‰©è¯´è¯ï¼Œæœ‰30%æ¦‚ç‡ä½¿ç”¨AIå˜ä½“
            if (AI_FEATURES.textVariants && AI_FEATURES.enabled && 
                message.type !== "liuyuxi" && characterStyles[message.type] && 
                Math.random() < 0.3) {
                
                try {
                    const variant = await generateTextVariant(message.text, message.type);
                    if (variant && variant !== message.text) {
                        message.text = variant;
                        message.isAIVariant = true;
                        console.log('ä½¿ç”¨äº†AIç”Ÿæˆçš„æ–‡æœ¬å˜ä½“', { character: message.type, variant: variant.substring(0, 50) });
                    }
                } catch (error) {
                    console.error('æ–‡æœ¬å˜ä½“ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡', error);
                }
            }

            // é•¿å†…å®¹åˆ†æ®µå¤„ç†
            const segments = contentEnhancer.splitLongContent(message.text);
            
            for (let i = 0; i < segments.length; i++) {
                const segmentMessage = {
                    ...message,
                    text: segments[i],
                    isSegment: segments.length > 1,
                    segmentIndex: i,
                    totalSegments: segments.length
                };
                
                await appendSingleMessage(segmentMessage, withAnimation);
                
                // åˆ†æ®µé—´éš”
                if (i < segments.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1200));
                }
            }
            
            // ç”Ÿæˆç¾¤èŠäº’åŠ¨ï¼ˆä»…é’ˆå¯¹é—®é¢˜å›åº”å’Œä¸»è¦å¯¹è¯ï¼‰
            if (message.isQuestionResponse || message.isFlexibleRound) {
                setTimeout(async () => {
                    await generateGroupChatInteractions(message);
                }, 2000 + Math.random() * 1500);
            }
        }

        // å•æ¡æ¶ˆæ¯æ˜¾ç¤º
        async function appendSingleMessage(message, withAnimation = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex mb-4';

            const emoji = characterEmojis[message.type] || "ğŸ’¬";
            const name = characterNames[message.type] || message.type;
            const isOwn = message.type === "liuyuxi";

            // åˆ†æ®µæŒ‡ç¤ºå™¨
            const segmentIndicator = message.isSegment ? 
                ` <span class="text-xs text-gray-400">(${message.segmentIndex + 1}/${message.totalSegments})</span>` : '';

            if (isOwn) {
                messageElement.className += ' justify-end';
                messageElement.innerHTML = `
                    <div class="flex flex-col items-end max-w-md">
                        <div class="flex items-center mb-1 mr-2">
                            <div class="text-xs text-gray-500 mr-2">${name}${segmentIndicator}</div>
                            <div class="text-lg">${emoji}</div>
                        </div>
                        <div class="message-bubble self bg-bubble-self rounded-lg p-3 mr-10 relative ${message.isAIVariant ? 'ai-enhanced' : ''}">
                            ${message.isAIVariant ? '<div class="ai-variant-indicator">âœ¨</div>' : ''}
                            <div class="text-sm">${message.text}</div>
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="flex flex-col max-w-md">
                        <div class="flex items-center mb-1 ml-2">
                            <div class="text-lg mr-2">${emoji}</div>
                            <div class="text-xs text-gray-500">${name}${segmentIndicator}</div>
                        </div>
                        <div class="message-bubble other bg-bubble-other rounded-lg p-3 ml-10 relative ${message.isAIVariant ? 'ai-enhanced' : ''} ${message.isGroupReaction && !message.isSimpleReaction ? 'bg-yellow-50 border border-yellow-200' : ''}">
                            ${message.isAIVariant ? '<div class="ai-variant-indicator">âœ¨</div>' : ''}
                            <div class="text-sm">${message.text}</div>
                        </div>
                    </div>
                `;
            }

            if (withAnimation) {
                messageElement.classList.add('opacity-0');
                chatContainer.appendChild(messageElement);
                setTimeout(() => {
                    messageElement.classList.remove('opacity-0');
                    messageElement.classList.add('fade-in');
                }, 100);
            } else {
                chatContainer.appendChild(messageElement);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ç”Ÿæˆç¾¤èŠäº’åŠ¨
        async function generateGroupChatInteractions(mainMessage) {
            if (!mainMessage.type || mainMessage.type === "liuyuxi" || mainMessage.isGroupReaction) {
                return; // é¿å…æ— é™å¾ªç¯
            }
            
            // è·å–å½“å‰ç¯å¢ƒçš„å¯ç”¨è§’è‰²
            const currentParticipants = getCurrentParticipants();
            
            // ç”Ÿæˆç¾¤èŠå›åº”
            const responses = await groupChatInteractions.generateGroupResponses(
                mainMessage, 
                mainMessage.type, 
                currentParticipants
            );
            
            // æ˜¾ç¤ºç¾¤èŠå›åº”
            for (let i = 0; i < responses.length; i++) {
                const response = responses[i];
                
                // ç­‰å¾…é—´éš”ï¼Œæ¨¡æ‹ŸçœŸå®ç¾¤èŠ
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                await appendSingleMessage(response, true);
            }
        }

        // è·å–å½“å‰å‚ä¸è®¨è®ºçš„è§’è‰²
        function getCurrentParticipants() {
            // æ ¹æ®å½“å‰ç¯å¢ƒè¿”å›ç›¸å…³è§’è‰²
            const environmentParticipants = {
                "æ±Ÿè¾¹": ["tao", "du", "libai", "confucius"],
                "æŸ³è¾¹": ["wangwei", "sushi", "liqingzhao", "yanhuei"], 
                "æ–—å®¤": ["confucius", "zhugeliang", "baijuyi", "zengzi"]
            };
            
            const currentEnv = getCurrentEnvironment();
            return environmentParticipants[currentEnv] || Object.keys(aiPersonalities).slice(0, 4);
        }

        // ç³»ç»Ÿé€šçŸ¥èƒŒæ™¯åŒ–æ˜¾ç¤º
        function appendSystemNotification(message, withAnimation = false) {
            const notificationElement = document.createElement('div');
            notificationElement.className = 'flex justify-center my-6';
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒæ ·å¼
            let bgClass, textClass, icon;
            if (message.type === "narrator") {
                bgClass = "bg-blue-50 border-blue-200";
                textClass = "text-blue-700";
                icon = "ğŸ“–";
            } else {
                bgClass = "bg-green-50 border-green-200";
                textClass = "text-green-700";
                icon = "ğŸ’¡";
            }
            
            notificationElement.innerHTML = `
                <div class="max-w-sm mx-auto">
                    <div class="${bgClass} border rounded-lg px-4 py-2 text-center">
                        <div class="${textClass} text-sm font-medium flex items-center justify-center">
                            <span class="mr-2">${icon}</span>
                            ${message.text}
                        </div>
                    </div>
                </div>
            `;

            if (withAnimation) {
                notificationElement.classList.add('opacity-0');
                chatContainer.appendChild(notificationElement);
                setTimeout(() => {
                    notificationElement.classList.remove('opacity-0');
                    notificationElement.classList.add('fade-in');
                }, 100);
            } else {
                chatContainer.appendChild(notificationElement);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ˜¾ç¤ºé€‰é¡¹ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒ15ç§’å€’è®¡æ—¶ï¼‰
        function showOptions(options) {
            optionsList.innerHTML = '';
            hasUserMadeChoice = false;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«@äººç‰©é€‰é¡¹
            const hasMentionOptions = options.some(option => option.action === "mention");
            
            options.forEach((option, index) => {
                const optionElement = document.createElement('button');
                optionElement.className = 'w-full p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200 border border-gray-200';
                optionElement.textContent = option.text;
                
                optionElement.addEventListener('click', () => {
                    hasUserMadeChoice = true;
                    if (optionSelectionTimer) {
                        clearTimeout(optionSelectionTimer);
                        optionSelectionTimer = null;
                    }
                    
                    // å¦‚æœæ˜¯@é€‰é¡¹ï¼Œä¼ é€’å®Œæ•´æ–‡æœ¬ç”¨äºæ™ºèƒ½åŒ¹é…
                    if (option.action === "mention") {
                        handleOptionClick(option, index, true, option.text);
                    } else {
                        handleOptionClick(option, index);
                    }
                });
                
                optionsList.appendChild(optionElement);
            });
            
            // å¦‚æœåŒ…å«@äººç‰©é€‰é¡¹ï¼Œå¯åŠ¨15ç§’å€’è®¡æ—¶
            if (hasMentionOptions) {
                startOptionSelectionTimer(options);
            }
            
            // æ˜¾ç¤ºé€‰é¡¹å®¹å™¨
            optionsContainer.classList.remove('translate-y-full');
        }
        
        // 15ç§’é€‰æ‹©å€’è®¡æ—¶ç³»ç»Ÿ
        function startOptionSelectionTimer(options) {
            console.log('ğŸ• å¯åŠ¨15ç§’é€‰æ‹©å€’è®¡æ—¶');
            
            // æ˜¾ç¤ºå€’è®¡æ—¶æç¤º
            const timerElement = document.createElement('div');
            timerElement.id = 'selectionTimer';
            timerElement.className = 'text-center text-sm text-gray-500 mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded';
            timerElement.innerHTML = 'â±ï¸ è¯·åœ¨ <span id="countdown">15</span> ç§’å†…é€‰æ‹©ï¼Œå¦åˆ™å°†è‡ªåŠ¨è¿›å…¥è¯é¢˜è®¨è®º';
            optionsList.appendChild(timerElement);
            
            let timeLeft = 15;
            const countdownElement = document.getElementById('countdown');
            
            // æ¯ç§’æ›´æ–°å€’è®¡æ—¶
            const countdownInterval = setInterval(() => {
                timeLeft--;
                if (countdownElement) {
                    countdownElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 5) {
                    // æœ€å5ç§’å˜çº¢è‰²è­¦å‘Š
                    timerElement.className = 'text-center text-sm text-red-600 mt-3 p-2 bg-red-50 border border-red-200 rounded';
                }
                
                if (timeLeft <= 0 || hasUserMadeChoice) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // 15ç§’è¶…æ—¶å¤„ç†
            optionSelectionTimer = setTimeout(() => {
                if (!hasUserMadeChoice) {
                    console.log('â° 15ç§’è¶…æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥ç¯å¢ƒè¯é¢˜è®¨è®º');
                    
                    // ç§»é™¤å€’è®¡æ—¶æç¤º
                    if (timerElement && timerElement.parentElement) {
                        timerElement.remove();
                    }
                    clearInterval(countdownInterval);
                    
                    // éšè—é€‰é¡¹
                    optionsContainer.classList.add('translate-y-full');
                    
                    // æ˜¾ç¤ºè¶…æ—¶æ¶ˆæ¯
                    const timeoutMessage = {
                        type: "system",
                        text: "â° æœªåœ¨é™å®šæ—¶é—´å†…é€‰æ‹©ï¼Œå°†è¿›å…¥æœ¬è½®ç¯å¢ƒè¯é¢˜è®¨è®º..."
                    };
                    appendMessage(timeoutMessage, true);
                    
                    // è‡ªåŠ¨è¿›å…¥ç¯å¢ƒè¯é¢˜è®¨è®º
                    setTimeout(() => {
                        autoProgressToEnvironmentTopic();
                    }, 1500);
                }
            }, 15000);
        }
        
        // è‡ªåŠ¨è¿›å…¥ç¯å¢ƒè¯é¢˜è®¨è®º
        function autoProgressToEnvironmentTopic() {
            const currentEnvironment = getCurrentEnvironment();
            const environmentTopic = getCurrentTopic(currentEnvironment);
            const participants = getCurrentParticipants();
            
            console.log(`ğŸƒâ€â™‚ï¸ è‡ªåŠ¨è¿›å…¥ç¯å¢ƒè¯é¢˜: ${environmentTopic}`);
            
            // é€‰æ‹©ä¸€ä¸ªä»£è¡¨æ€§è§’è‰²ä½œä¸ºå¼•å¯¼è€…
            const leadCharacter = participants[0] || "confucius";
            
            // å¯åŠ¨ç¯å¢ƒå›ºå®šè¯é¢˜è®¨è®º
            flexibleMultiRoundDialogue.startFlexibleDiscussion(
                leadCharacter,
                environmentTopic,
                currentEnvironment,
                participants
            );
        }

        // å¤„ç†é€‰é¡¹ç‚¹å‡»ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒæ™ºèƒ½è¯é¢˜åŒ¹é…ï¼‰
        function handleOptionClick(option, index, isTimedChoice = false, fullOptionText = null) {
            // ç§»é™¤å€’è®¡æ—¶æç¤º
            const timerElement = document.getElementById('selectionTimer');
            if (timerElement && timerElement.parentElement) {
                timerElement.remove();
            }
            
            // éšè—é€‰é¡¹
            optionsContainer.classList.add('translate-y-full');
            
            // æ·»åŠ ç”¨æˆ·é€‰æ‹©çš„æ¶ˆæ¯
            const userMessage = {
                type: "liuyuxi",
                text: option.text
            };
            appendMessage(userMessage);

            // è®°å½•é€‰æ‹©
            gameState.selectedOptions.push({
                stage: gameState.currentStage,
                option: option,
                index: index,
                isTimedChoice: isTimedChoice,
                timestamp: Date.now()
            });

            // å¦‚æœæ˜¯@æŸäºº
            if (option.action === "mention") {
                // ä¼ é€’å®Œæ•´é€‰é¡¹æ–‡æœ¬ç”¨äºæ™ºèƒ½åŒ¹é…
                handleMention(option.character, fullOptionText || option.text, isTimedChoice);
            } else if (option.action === "createPoem") {
                // å¤„ç†åˆ›ä½œã€Šé™‹å®¤é“­ã€‹
                handlePoemCreation();
            } else if (option.nextStage !== undefined) {
                // å»¶è¿Ÿè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
                setTimeout(() => {
                    proceedToStage(option.nextStage);
                }, 1000);
            }
        }

        // AIæ™ºèƒ½å¯¹è¯ç”Ÿæˆæ ¸å¿ƒåŠŸèƒ½
        async function generateCharacterResponse(characterId, context = {}) {
            const personality = aiPersonalities[characterId];
            if (!personality) {
                throw new Error(`æœªæ‰¾åˆ°è§’è‰² ${characterId} çš„äººæ ¼ä¿¡æ¯`);
            }

            const currentEnvironment = getCurrentEnvironment();
            const environmentDescription = getEnvironmentDescription(currentEnvironment);
            
            // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
            const contextInfo = {
                environment: environmentDescription,
                stage: gameState.currentStage,
                playerChoices: gameState.selectedOptions.slice(-3), // æœ€è¿‘3ä¸ªé€‰æ‹©
                ...context
            };

            const prompt = `ä½ æ˜¯${personality.name}ï¼ˆ${personality.period}ï¼‰ï¼Œ${personality.background}ã€‚

ä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼š${personality.personality}
ä½ çš„è¯­è¨€é£æ ¼ï¼š${personality.language_style}
ä½ çš„æ ¸å¿ƒç†å¿µï¼š${personality.key_concepts.join('ã€')}
ä½ çš„å¸¸ç”¨è¯­å¥ï¼š${personality.speech_habits.join('ï¼›')}

å½“å‰æƒ…å¢ƒï¼š
- ç¯å¢ƒï¼š${contextInfo.environment}
- èƒŒæ™¯ï¼šåˆ˜ç¦¹é”¡è¢«è´¬è‡³å’Œå·ï¼Œå¿ä»¤å¤šæ¬¡è¿ç§»å…¶ä½æ‰€è¿›è¡Œåˆéš¾
- åœºæ™¯ï¼šä½ çœ‹åˆ°åˆ˜ç¦¹é”¡åœ¨è¿™ä¸ªç¯å¢ƒä¸­çš„å¢ƒé‡ï¼Œå‰æ¥ä¸ä»–å¯¹è¯

ä½ çš„ä»»åŠ¡ï¼š
1. ç”¨ç¬¦åˆ${personality.name}çš„èº«ä»½å’Œè¯­è¨€é£æ ¼ä¸åˆ˜ç¦¹é”¡å¯¹è¯
2. ä½“ç°ä½ çš„${personality.interaction_style}
3. å¯ä»¥é€‚å½“å¼•ç”¨ä½ çš„ç»å…¸è¯­å½•æˆ–ç›¸å…³å…¸æ•…
4. å›åº”è¦æœ‰æ¸©åº¦å’Œæ·±åº¦ï¼Œèƒ½ç»™åˆ˜ç¦¹é”¡ä»¥å¯å‘æˆ–æ…°è—‰
5. å­—æ•°æ§åˆ¶åœ¨120-180å­—ä¹‹é—´

è¯·ç”¨${personality.name}çš„èº«ä»½ç›´æ¥å¯¹åˆ˜ç¦¹é”¡è¯´è¯ï¼Œä¸è¦åŠ å¼•å·æˆ–è§£é‡Šï¼š`;

            const response = await callDeepSeekAPI(prompt, { 
                temperature: 0.85,
                maxTokens: 300 
            });

            // è®°å½•AIè°ƒç”¨
            dialogueControls.recordAICall(characterId, currentEnvironment);
            
            return response;
        }

        // è·å–å½“å‰ç¯å¢ƒ
        function getCurrentEnvironment() {
            // æ ¹æ®å½“å‰æ¸¸æˆé˜¶æ®µç¡®å®šç¯å¢ƒ
            if (gameState.currentStage <= 2) return "æ±Ÿè¾¹";
            if (gameState.currentStage <= 4) return "æŸ³è¾¹";
            return "æ–—å®¤";
        }

        // è·å–ç¯å¢ƒæè¿°
        function getEnvironmentDescription(environment) {
            const descriptions = {
                "æ±Ÿè¾¹": "æ±Ÿæ°´æ‚ æ‚ ï¼Œå¾®é£å¾æ¥ï¼Œç®€æœ´çš„å°å±‹ä¸´æ±Ÿè€Œå»ºï¼Œè™½æ˜¾ç®€é™‹ä½†åˆ«æœ‰æ„å¢ƒ",
                "æŸ³è¾¹": "å‚æŸ³ä¾ä¾ï¼Œç»¿æ„ç›ç„¶ï¼ŒæŸ³è«ä¸‹çš„å°å±‹æ›´æ˜¾æ¸…å¹½é™è°§",
                "æ–—å®¤": "ç©ºé—´ç‹­å°å¦‚æ–—ï¼Œä½†æ•´æ´æœ‰åºï¼Œä¸€æ¡Œä¸€æ¤…ï¼Œè‹”ç—•ä¸Šé˜¶ç»¿ï¼Œè‰è‰²å…¥å¸˜é’"
            };
            return descriptions[environment] || environment;
        }

        // ====== çµæ´»å¤šè½®è¿ç»­å¯¹è¯ç³»ç»Ÿ ======
        
        // åŠ¨æ€å¤šè½®å¯¹è¯ç®¡ç†å™¨
        const flexibleMultiRoundDialogue = {
            
            // åŠ¨æ€é€‰æ‹©è®¨è®ºå‚ä¸è€…
            selectParticipants: function(initialCharacter, environment, topic) {
                // æ‰€æœ‰å¯ç”¨è§’è‰²
                const allCharacters = Object.keys(aiPersonalities);
                
                // æ ¹æ®è¯é¢˜å’Œç¯å¢ƒåŠ¨æ€ç­›é€‰ç›¸å…³äººç‰©
                const relevantCharacters = this.getRelevantCharacters(topic, environment, allCharacters);
                
                // ç¡®ä¿åˆå§‹è§’è‰²åœ¨åˆ—è¡¨ä¸­
                if (!relevantCharacters.includes(initialCharacter)) {
                    relevantCharacters.unshift(initialCharacter);
                }
                
                // é™åˆ¶å‚ä¸è€…æ•°é‡ï¼ˆ3-4äººä¸ºæœ€ä½³ï¼‰
                const maxParticipants = 4;
                const participants = relevantCharacters.slice(0, maxParticipants);
                
                console.log(`è¯é¢˜"${topic}"é€‰æ‹©å‚ä¸è€…:`, participants.map(c => aiPersonalities[c]?.name || c));
                return participants;
            },
            
            // æ ¹æ®è¯é¢˜å’Œç¯å¢ƒè·å–ç›¸å…³äººç‰©
            getRelevantCharacters: function(topic, environment, allCharacters) {
                const relevanceScores = {};
                
                // ä¸ºæ¯ä¸ªè§’è‰²è®¡ç®—ç›¸å…³æ€§åˆ†æ•°
                allCharacters.forEach(charId => {
                    const personality = aiPersonalities[charId];
                    if (!personality) return;
                    
                    let score = 0;
                    
                    // 1. è¯é¢˜ç›¸å…³æ€§
                    const topicKeywords = this.getTopicKeywords(topic);
                    const matchingConcepts = personality.key_concepts.filter(concept => 
                        topicKeywords.some(keyword => keyword.includes(concept) || concept.includes(keyword))
                    ).length;
                    score += matchingConcepts * 30;
                    
                    // 2. ç¯å¢ƒç›¸å…³æ€§
                    const envKeywords = this.getEnvironmentKeywords(environment);
                    const envMatches = personality.key_concepts.filter(concept => 
                        envKeywords.some(keyword => keyword.includes(concept) || concept.includes(keyword))
                    ).length;
                    score += envMatches * 20;
                    
                    // 3. äººç‰©ç‰¹è´¨åŠ åˆ†
                    if (topic.includes("è´¬è°ª") || topic.includes("é€†å¢ƒ")) {
                        if (personality.background.includes("è´¬") || personality.background.includes("å›°")) score += 25;
                        if (charId === "baijuyi" || charId === "sushi") score += 30; // åŒæ ·é­è´¬è°ª
                    }
                    
                    if (topic.includes("å¿ƒå¢ƒ") || topic.includes("ä¿®å…»")) {
                        if (personality.key_concepts.includes("ç¦…æ„") || personality.key_concepts.includes("æ·¡æ³Š")) score += 25;
                    }
                    
                    if (topic.includes("é™‹å®¤") || topic.includes("å±…ä½")) {
                        if (charId === "confucius" || charId === "yanhuei") score += 30; // å›å­å›ºç©·
                        if (charId === "tao") score += 25; // å®‰è´«ä¹é“
                    }
                    
                    // 4. éšæœºå› å­å¢åŠ å˜åŒ–æ€§
                    score += Math.random() * 10;
                    
                    relevanceScores[charId] = score;
                });
                
                // æŒ‰åˆ†æ•°æ’åºå¹¶è¿”å›
                return Object.entries(relevanceScores)
                    .sort(([,a], [,b]) => b - a)
                    .map(([charId]) => charId);
            },
            
            // è·å–è¯é¢˜å…³é”®è¯
            getTopicKeywords: function(topic) {
                const topicMappings = {
                    "è´¬è°ªé€†å¢ƒ": ["è´¬è°ª", "é€†å¢ƒ", "å›°å¢ƒ", "æŒ«æŠ˜", "åšå¼º", "æ„å¿—"],
                    "å¿ƒå¢ƒä¿®å…»": ["å¿ƒå¢ƒ", "ä¿®å…»", "é™å¿ƒ", "ç¦…æ„", "æ·¡æ³Š", "å†…å¿ƒ"],
                    "é™‹å®¤çœŸä¹‰": ["é™‹å®¤", "ç®€æœ´", "å›å­", "å“å¾·", "å¾·é¦¨", "ä¿®èº«"],
                    "äººç”Ÿæ™ºæ…§": ["æ™ºæ…§", "äººç”Ÿ", "å“²ç†", "æ„Ÿæ‚Ÿ", "æ€è€ƒ", "é¢†æ‚Ÿ"]
                };
                
                // å¯»æ‰¾æœ€åŒ¹é…çš„å…³é”®è¯
                for (const [key, keywords] of Object.entries(topicMappings)) {
                    if (topic.includes(key) || key.includes(topic)) {
                        return keywords;
                    }
                }
                
                // é»˜è®¤é€šç”¨å…³é”®è¯
                return ["æ™ºæ…§", "äººç”Ÿ", "å“å¾·"];
            },
            
            // è·å–ç¯å¢ƒå…³é”®è¯
            getEnvironmentKeywords: function(environment) {
                const envMappings = {
                    "æ±Ÿè¾¹": ["è‡ªç„¶", "æ°´", "æµåŠ¨", "å˜åŒ–", "å¼€é˜”"],
                    "æŸ³è¾¹": ["æŸ”ç¾", "æ˜¥å¤©", "ç”Ÿæœº", "è¯—æ„", "é›…è‡´"],
                    "æ–—å®¤": ["ç®€æœ´", "å°", "ç²¾è‡´", "å†…æ•›", "ä¸“æ³¨"]
                };
                return envMappings[environment] || ["ç¯å¢ƒ", "ç©ºé—´"];
            },
            
            // å¯åŠ¨çµæ´»å¤šè½®å¯¹è¯ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰å‚ä¸è€…ï¼‰
            startFlexibleDiscussion: async function(initialCharacter, topic, environment, customParticipants = null) {
                console.log(`å¯åŠ¨çµæ´»å¤šè½®å¯¹è¯ï¼š${topic} åœ¨ ${environment}`);
                
                // åŠ¨æ€é€‰æ‹©å‚ä¸è€…ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å‚ä¸è€…ï¼‰
                const participants = customParticipants || this.selectParticipants(initialCharacter, environment, topic);
                
                // ç”Ÿæˆè®¨è®ºä¸»é¢˜
                const discussion = {
                    topic: topic,
                    environment: environment,
                    participants: participants
                };
                
                // æ‰§è¡Œçµæ´»å¯¹è¯
                await this.executeFlexibleRounds(discussion, initialCharacter);
            },
            
            // æ‰§è¡Œçµæ´»å¤šè½®å¯¹è¯
            executeFlexibleRounds: async function(discussion, initialCharacter) {
                console.log(`æ‰§è¡Œçµæ´»å¤šè½®å¯¹è¯ï¼Œä¸»é¢˜ï¼š${discussion.topic}`);
                
                // æ˜¾ç¤ºè¯é¢˜å¼•å…¥
                const participantNames = discussion.participants.map(id => aiPersonalities[id]?.name || id).join('ã€');
                const topicMessage = {
                    type: "system",
                    text: `ğŸ’¬ è¯é¢˜ï¼š${discussion.topic} | å‚ä¸è®¨è®ºï¼š${participantNames}`
                };
                await appendMessage(topicMessage, true);
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // åŠ¨æ€ç”Ÿæˆå¯¹è¯è½®æ¬¡
                const rounds = await this.generateFlexibleRounds(discussion);
                
                // æ‰§è¡Œæ¯è½®å¯¹è¯
                for (let i = 0; i < rounds.length; i++) {
                    const round = rounds[i];
                    
                    // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
                    const speakerName = aiPersonalities[round.speaker]?.name || round.speaker;
                    showTypingIndicator(`${speakerName}æ­£åœ¨è¾“å…¥...`);
                    
                    // ç­‰å¾…æ€è€ƒæ—¶é—´
                    await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1500));
                    
                    // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
                    hideTypingIndicator();
                    
                    // ç”Ÿæˆå¹¶æ˜¾ç¤ºå¯¹è¯
                    const responseText = await this.generateRoundResponse(round, discussion, i);
                    
                    const message = {
                        type: round.speaker,
                        text: responseText,
                        isFlexibleRound: true,
                        isAIGenerated: round.useAI
                    };
                    
                    await appendMessage(message, true);
                    
                    // è½®æ¬¡é—´éš”
                    if (i < rounds.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2500));
                    }
                }
                
                // è¿›å…¥ç©å®¶æé—®ç¯èŠ‚
                setTimeout(async () => {
                    await this.startPlayerQuestionSession(discussion);
                }, 2000);
            },
            
            // åŠ¨æ€ç”Ÿæˆå¯¹è¯è½®æ¬¡
            generateFlexibleRounds: async function(discussion) {
                const rounds = [];
                const participants = [...discussion.participants];
                
                // ç¡®ä¿æ¯ä¸ªå‚ä¸è€…éƒ½æœ‰æœºä¼šå‘è¨€
                participants.forEach((speaker, index) => {
                    const useAI = Math.random() < 0.7 && AI_FEATURES.enabled; // 70%æ¦‚ç‡ä½¿ç”¨AI
                    
                    rounds.push({
                        speaker: speaker,
                        order: index,
                        useAI: useAI,
                        context: {
                            isFirst: index === 0,
                            isLast: index === participants.length - 1,
                            previousSpeakers: participants.slice(0, index)
                        }
                    });
                });
                
                // å¯èƒ½å¢åŠ é¢å¤–çš„äº’åŠ¨è½®æ¬¡
                if (participants.length >= 3 && Math.random() < 0.4) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªäººè¿›è¡Œå›åº”
                    const responder = participants[Math.floor(Math.random() * participants.length)];
                    rounds.push({
                        speaker: responder,
                        order: rounds.length,
                        useAI: Math.random() < 0.8 && AI_FEATURES.enabled,
                        context: {
                            isResponse: true,
                            isAdditional: true,
                            previousSpeakers: participants
                        }
                    });
                }
                
                return rounds;
            },
            
            // ç”Ÿæˆå•è½®å›åº”ï¼ˆè´¨é‡ä¿è¯æœºåˆ¶ï¼‰
            generateRoundResponse: async function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                if (!personality) {
                    return `${round.speaker}ï¼šæ·±æœ‰åŒæ„Ÿï¼Œè¨€ä¹‹æœ‰ç†ã€‚`;
                }
                
                // ä¼˜å…ˆçº§ç­–ç•¥ï¼šç¡®ä¿æ¯è½®å¯¹è¯è´¨é‡
                let responseText = null;
                
                // 1. é¦–å…ˆå°è¯•AIç”Ÿæˆï¼ˆå¦‚æœæ¡ä»¶å…è®¸ï¼‰
                if (round.useAI && dialogueControls.canMakeAICall(round.speaker, discussion.environment)) {
                    try {
                        responseText = await this.generateAIResponse(round, discussion, roundIndex);
                        if (responseText && responseText.length > 50) { // è´¨é‡æ£€æŸ¥
                            console.log(`AIç”ŸæˆæˆåŠŸï¼Œè½®æ¬¡${roundIndex}ï¼Œè§’è‰²${round.speaker}`);
                            return responseText;
                        }
                    } catch (error) {
                        console.warn(`AIç”Ÿæˆå¤±è´¥ï¼Œè½®æ¬¡${roundIndex}ï¼Œè§’è‰²${round.speaker}:`, error);
                    }
                }
                
                // 2. ä½¿ç”¨é«˜è´¨é‡é¢„åˆ¶å›åº”
                responseText = this.getHighQualityPresetResponse(round, discussion, roundIndex);
                if (responseText) {
                    console.log(`ä½¿ç”¨é¢„åˆ¶å›åº”ï¼Œè½®æ¬¡${roundIndex}ï¼Œè§’è‰²${round.speaker}`);
                    return responseText;
                }
                
                // 3. æœ€åé™çº§ä¸ºé€šç”¨å›åº”
                return this.generateFallbackResponse(round, discussion, roundIndex);
            },
            
            // è·å–é«˜è´¨é‡é¢„åˆ¶å›åº” - ä¿®å¤åŒ¹é…é€»è¾‘
            getHighQualityPresetResponse: function(round, discussion, roundIndex) {
                const environmentKey = `${discussion.environment.replace("æ±Ÿè¾¹", "riverbank").replace("æŸ³è¾¹", "willows").replace("æ–—å®¤", "chamber")}_${discussion.topic.includes("è´¬è°ª") ? "exile" : discussion.topic.includes("å¿ƒå¢ƒ") ? "mindset" : "wisdom"}_discussion`;
                
                console.log(`æŸ¥æ‰¾é¢„åˆ¶å›åº”: ${environmentKey}, è§’è‰²: ${round.speaker}, è½®æ¬¡: ${roundIndex}`);
                
                // æŸ¥æ‰¾åŒ¹é…çš„é¢„åˆ¶å¯¹è¯
                const presetDiscussion = enhancedCharacterResponses[environmentKey];
                if (presetDiscussion && presetDiscussion.rounds) {
                    // ä¼˜å…ˆï¼šç²¾ç¡®è§’è‰²åŒ¹é…
                    const characterRound = presetDiscussion.rounds.find(r => r.speaker === round.speaker);
                    if (characterRound) {
                        console.log(`âœ… æ‰¾åˆ°ç²¾ç¡®è§’è‰²åŒ¹é…: ${round.speaker}`);
                        return characterRound.response;
                    }
                    
                    // é™çº§ï¼šä»ä¸“é—¨çš„è§’è‰²å›åº”åº“æŸ¥æ‰¾
                    if (fallbackContent.characterResponses[round.speaker]) {
                        const responses = fallbackContent.characterResponses[round.speaker];
                        const randomIndex = Math.floor(Math.random() * responses.length);
                        console.log(`âœ… ä½¿ç”¨è§’è‰²ä¸“å±å›åº”åº“: ${round.speaker}`);
                        return responses[randomIndex];
                    }
                    
                    console.log(`âŒ æœªæ‰¾åˆ°è§’è‰²åŒ¹é…ï¼Œè¿”å›null: ${round.speaker}`);
                }
                
                return null;
            },
            
            // AIç”Ÿæˆå›åº”
            generateAIResponse: async function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                
                // æ„å»ºä¸Šä¸‹æ–‡
                const contextText = round.context.isFirst ? 
                    "ä½ æ˜¯ç¬¬ä¸€ä¸ªå‘è¨€çš„äººï¼Œéœ€è¦ä¸ºè¿™ä¸ªè¯é¢˜å¥ å®šåŸºè°ƒã€‚" :
                    round.context.isLast ? 
                    "ä½ æ˜¯æœ€åå‘è¨€çš„äººï¼Œéœ€è¦æ€»ç»“å‰é¢çš„è§‚ç‚¹å¹¶ç»™å‡ºæ·±åˆ»è§è§£ã€‚" :
                    round.context.isResponse ?
                    "ä½ æ˜¯åœ¨å…¶ä»–äººå‘è¨€åè¿›è¡Œçš„è¡¥å……å›åº”ã€‚" :
                    "ä½ æ˜¯åœ¨å¬å–å‰é¢å‘è¨€è€…æ„è§åå‘è¡¨è‡ªå·±çš„çœ‹æ³•ã€‚";
                
                const prompt = `ä½ æ˜¯${personality.name}ï¼ˆ${personality.period}ï¼‰ï¼Œæ­£åœ¨å‚ä¸ä¸€ä¸ªå…³äº"${discussion.topic}"çš„å¤šäººè®¨è®ºã€‚

å½“å‰ç¯å¢ƒï¼š${discussion.environment}
è®¨è®ºèƒŒæ™¯ï¼šåˆ˜ç¦¹é”¡è¢«è´¬è‡³å’Œå·ï¼Œå±…ä½æ¡ä»¶ç®€é™‹ï¼Œæ­£åœ¨ç»å†äººç”Ÿä½è°·
ä½ çš„è§’è‰²ï¼š${personality.background}
ä½ çš„æ€§æ ¼ï¼š${personality.personality}
è¯­è¨€é£æ ¼ï¼š${personality.language_style}
æ ¸å¿ƒç†å¿µï¼š${personality.key_concepts.join('ã€')}

å‘è¨€èƒŒæ™¯ï¼š${contextText}

è¦æ±‚ï¼š
1. ä½“ç°ä½ çš„ç‹¬ç‰¹è§‚ç‚¹å’Œäººç”Ÿé˜…å†
2. ä¸è¯é¢˜ç´§å¯†ç›¸å…³ï¼Œå¯¹åˆ˜ç¦¹é”¡æœ‰å¯å‘æ„ä¹‰
3. ç¬¦åˆä½ çš„å†å²èº«ä»½å’Œè¯­è¨€ç‰¹è‰²
4. å¯ä»¥é€‚å½“å¼•ç”¨ä½ çš„ç»å…¸è¯­å½•
5. å­—æ•°æ§åˆ¶åœ¨100-150å­—
6. è¯­è°ƒè¦çœŸè¯šæœ‰æ¸©åº¦

è¯·ç›´æ¥ä»¥${personality.name}çš„èº«ä»½å‘è¨€ï¼Œä¸è¦åŠ å¼•å·ï¼š`;

                const response = await callPoeAI(prompt, { 
                    temperature: 0.8,
                    maxTokens: 250
                });
                
                // è®°å½•AIè°ƒç”¨
                dialogueControls.recordAICall(round.speaker, discussion.environment);
                
                return response;
            },
            
            // ç”Ÿæˆé¢„åˆ¶å›åº” - ä¿®å¤è§’è‰²åŒ¹é…é—®é¢˜
            generateFallbackResponse: function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                if (!personality) {
                    return `${round.speaker}ï¼šæ·±æœ‰åŒæ„Ÿï¼Œè¨€ä¹‹æœ‰ç†ã€‚`;
                }
                
                console.log(`ç”Ÿæˆé¢„åˆ¶å›åº” - è§’è‰²: ${round.speaker} (${personality.name}), è¯é¢˜: ${discussion.topic}`);
                
                // 1. ä¼˜å…ˆä½¿ç”¨è§’è‰²ä¸“å±å›åº”åº“
                const fallbackResponses = fallbackContent.characterResponses[round.speaker];
                if (fallbackResponses && fallbackResponses.length > 0) {
                    const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
                    console.log(`âœ… ä½¿ç”¨è§’è‰²ä¸“å±å›åº”: ${round.speaker}`);
                    return fallbackResponses[randomIndex];
                }
                
                // 2. ä¸¥æ ¼è§’è‰²åŒ¹é…çš„è¯é¢˜å›åº”
                const characterSpecificResponses = {
                    "tao": {
                        "è´¬è°ªé€†å¢ƒ": `æ¢¦å¾—å…„ï¼Œå¤–å¢ƒè™½å˜ï¼Œå†…å¿ƒå¯ä¸å˜ã€‚æˆ‘å½“å¹´å½’éšç”°å›­ğŸŒ¾ï¼Œä¼—äººçš†è¨€æˆ‘æ„šï¼Œç„¶'å¿ƒè¿œåœ°è‡ªå'ï¼Œä½•æƒ§å¤–è®®ï¼Ÿ`,
                        "å¿ƒå¢ƒä¿®å…»": `åˆ˜å…„ï¼Œ'é‡‡èŠä¸œç¯±ğŸŒ¸ä¸‹ï¼Œæ‚ ç„¶ğŸ˜Œè§å—å±±ğŸ”ï¸'ï¼Œå¿ƒå¢ƒè‡ªç„¶ğŸŒ¿ï¼Œè¿œèƒœæµ®åã€‚å¤–ç‰©ä¸è¶³æŒ‚è™‘ï¼Œå†…å¿ƒå……å®ä¸ºçœŸã€‚`,
                        "é™‹å®¤çœŸä¹‰": `è§‚æ­¤é™‹å®¤ï¼Œå€’è®©æˆ‘æƒ³èµ·å½­æ³½èŒ…å±‹ã€‚ç®€æœ´ä¹‹å¤„ï¼Œæ­£å¯å…»æµ©ç„¶ä¹‹æ°”ã€‚`
                    },
                    "libai": {
                        "è´¬è°ªé€†å¢ƒ": `å“ˆå“ˆï¼åˆ˜å…„ï¼ŒåŒºåŒºè´¬è°ªç®—å¾—ä»€ä¹ˆï¼Ÿ'å¤©ç”Ÿæˆ‘æğŸ’ªå¿…æœ‰ç”¨'ï¼Œä»Šæ—¥ä¹‹å›°ï¼Œä»–æ—¥ä¹‹ç¦ä¹Ÿï¼ä¸”çœ‹å¤§æ±Ÿä¸œæµï¼Œä½•ç­‰å£®é˜”ï¼`,
                        "å¿ƒå¢ƒä¿®å…»": `æ¢¦å¾—å…„ï¼'é»„æ²³ä¹‹æ°´å¤©ä¸Šæ¥ï¼Œå¥”æµåˆ°æµ·ä¸å¤å›'ï¼Œäººç”ŸçŸ­æš‚ï¼Œä½•ä¸ç—›é¥®ä¸€åœºï¼Ÿå¿ƒå¢ƒè±è¾¾ğŸ˜Šï¼Œå²‚åœ¨å±‹èˆï¼Ÿ`,
                        "é™‹å®¤çœŸä¹‰": `'å®‰èƒ½æ‘§çœ‰æŠ˜è…°äº‹æƒè´µ'ï¼çœŸæ­£çš„å›å­ï¼Œå²‚ä¼šå› åŒºåŒºé™‹å®¤è€Œæ”¹å…¶å¿—ï¼Ÿä»°å¤©é•¿å•¸å‡ºé—¨å»ï¼`
                    },
                    "du": {
                        "è´¬è°ªé€†å¢ƒ": `æ¢¦å¾—å…„ï¼Œæˆ‘äº¦æ›¾å±…èŒ…å±‹ğŸ ï¼Œæ·±çŸ¥å›°é¡¿ä¹‹è‹¦ã€‚ç„¶'ä½å‘æœªæ•¢å¿˜å¿§å›½ğŸ˜Ÿ'ï¼Œè¯»ä¹¦äººå½“ä»¥å¤©ä¸‹ä¸ºæ€€ï¼Œä¸ªäººå¾—å¤±ä½•è¶³é“å“‰ï¼`,
                        "å¿ƒå¢ƒä¿®å…»": `åˆ˜å…„ï¼Œ'ä¼šå½“å‡Œç»é¡¶ï¼Œä¸€è§ˆä¼—å±±å°'ã€‚è™½å¤„é€†å¢ƒï¼Œå¿ƒç³»è‹ç”ŸğŸ‘¥çš„å¿—å‘ä¸å¯æ”¹ã€‚è¿™æ­£æ˜¯ç£¨ç ºå¿ƒå¿—çš„è‰¯æœºã€‚`,
                        "é™‹å®¤çœŸä¹‰": `'å®‰å¾—å¹¿å¦ğŸ˜ï¸åƒä¸‡é—´ï¼Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ¬¢é¢œ'ã€‚åˆ˜å…„ä»Šæ—¥é™‹å®¤ï¼Œè®©æˆ‘æƒ³èµ·å¤©ä¸‹å¯’å£«ï¼Œæ›´æ˜¾å›å­èƒ¸æ€€ã€‚`
                    },
                    "confucius": {
                        "è´¬è°ªé€†å¢ƒ": `åˆ˜å›ï¼Œé€†å¢ƒæ­£æ˜¯ä¿®èº«ğŸ§˜ä¹‹æ—¶ã€‚'å›å­ğŸ‘¨â€ğŸ“å›ºç©·'ï¼Œå›°é¡¿ä¸­æ›´èƒ½è§å›å­æœ¬è‰²ã€‚æ­¤ä¹ƒå¤©å°†é™å¤§ä»»ä¹‹å¾è±¡ã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `'å›å­ğŸ‘¨â€ğŸ“å¦è¡è¡ï¼Œå°äººé•¿æˆšæˆš'ã€‚åˆ˜å›å½“ä»¥å¾·â­ä¿®èº«ğŸ§˜ï¼Œä»¥å¾·â­åŒ–äººï¼Œå¤–å¢ƒå²‚èƒ½åŠ¨å…¶å¿ƒï¼Ÿ`,
                        "é™‹å®¤çœŸä¹‰": `åˆ˜å›æ·±å¾—'é™‹å®¤'çœŸè°›ã€‚'å›å­ğŸ‘¨â€ğŸ“å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'å¾·â­è¡Œé«˜å°šè€…æ‰€å±…ï¼Œå²‚å› å¤–åœ¨ç®€é™‹è€Œå‡å…¶å…‰åï¼Ÿ`
                    },
                    "wangwei": {
                        "è´¬è°ªé€†å¢ƒ": `åˆ˜å…„ï¼Œ'è¡Œåˆ°æ°´ç©·ğŸ’§å¤„ï¼Œåçœ‹äº‘èµ·â˜ï¸æ—¶'ã€‚é€†å¢ƒå¦‚æ°´ç©·ğŸ’§ï¼Œå¿ƒå¢ƒå¦‚äº‘èµ·â˜ï¸ï¼Œä¸€åˆ‡çš†ä¸ºä¿®è¡Œã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `å¢ƒç”±å¿ƒè½¬ï¼Œå¿ƒå¢ƒæ¸…æ˜ï¼Œæ–—å®¤äº¦æ˜¯å¹¿å¦ã€‚è¯—ä¸­æœ‰ç”»ï¼Œç”»ä¸­æœ‰ç¦…ğŸ§˜ï¼Œæ­¤å¤„æ­£æ˜¯æ‚Ÿé“ğŸ’¡ä¹‹æ‰€ã€‚`,
                        "é™‹å®¤çœŸä¹‰": `'ç©ºå±±æ–°é›¨åï¼Œå¤©æ°”æ™šæ¥ç§‹'ã€‚é™‹å®¤å¦‚ç©ºå±±ï¼Œç®€æœ´ä¸­è‡ªæœ‰æ¸…éŸµğŸµï¼Œå²‚éå¦™å¢ƒï¼Ÿ`
                    },
                    "sushi": {
                        "è´¬è°ªé€†å¢ƒ": `æ¢¦å¾—å…„ï¼æˆ‘ä¸€ç”Ÿä¸‰é­è´¬è°ªğŸ“‰ï¼Œæ·±çŸ¥'å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œå½’å»ï¼Œä¹Ÿæ— é£é›¨ğŸŒ¦ï¸ä¹Ÿæ— æ™´'çš„é“ç†ã€‚è‹¦ä¸­ä½œä¹ğŸ˜†ï¼Œæ–¹ä¸ºæ™ºè€…ã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `'äººç”Ÿå¦‚é€†æ—…ğŸš¶â€â™‚ï¸ï¼Œæˆ‘äº¦æ˜¯è¡Œäºº'ã€‚åˆ˜å…„ï¼Œä½•ä¸å­¦ä¼šè‹¦ä¸­ä½œä¹ğŸ˜†ï¼Ÿè¿™æŸ³è«ä¸‹å“èŒ¶è®ºè¯—ï¼Œå²‚ä¸å¿«å“‰ğŸ‰ï¼Ÿ`,
                        "é™‹å®¤çœŸä¹‰": `å“ˆå“ˆï¼æˆ‘åœ¨é»„å·æ—¶ä¹Ÿå±…èŒ…å±‹ï¼Œ'è«å¬ç©¿æ—æ‰“å¶å£°ï¼Œä½•å¦¨åŸå•¸ä¸”å¾è¡Œ'ã€‚å±…æ‰€è™½é™‹ï¼Œå¿ƒå¢ƒå¯å®½ã€‚`
                    },
                    "yanhuei": {
                        "è´¬è°ªé€†å¢ƒ": `å¼Ÿå­æ·±æœ‰åŒæ„Ÿã€‚'ä¸€ç®ªé£ŸğŸšï¼Œä¸€ç“¢é¥®ğŸ¥›ï¼Œåœ¨é™‹å··ğŸ˜ï¸ï¼Œäººä¸å ªå…¶å¿§ï¼Œå›ä¹Ÿä¸æ”¹å…¶ä¹ğŸ˜Œ'ã€‚å¤–ç‰©ä¸è¶³æŒ‚è™‘ï¼Œå†…å¿ƒå……å®æ–¹ä¸ºçœŸä¹ã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `å¤«å­å¸¸æ•™å¯¼æˆ‘ä»¬ï¼Œå›å­åº”è¯¥å®‰è´«ğŸ™ä¹é“ğŸ˜Œã€‚å†…å¿ƒæœ‰é“ï¼Œå¤„å¤„çš†å¯ä¿®èº«ğŸ§˜å…»æ€§ã€‚`,
                        "é™‹å®¤çœŸä¹‰": `æ­¤å®¤è™½å°ï¼Œä½†æœ‰å¾·è€…å±…ä¹‹ï¼Œä¾¿æ˜¯å›å­ä¹‹å®¤ã€‚æ­£å¦‚å¤«å­æ‰€è¨€'å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ'`
                    },
                    "zhugeliang": {
                        "è´¬è°ªé€†å¢ƒ": `äº®å½“å¹´éšå±…éš†ä¸­ğŸ•ï¸è‰åºğŸ ï¼Œäº¦ä¸è¿‡æ•°æ¤½ï¼Œç„¶èƒ½è¿ç­¹ğŸ“‹å¸·å¹„ã€‚'éæ·¡æ³ŠğŸƒæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œğŸ¯'ï¼Œåˆ˜å…„ä»Šæ—¥å¢ƒé‡ï¼Œä»–æ—¥å¿…æˆç¾è°ˆã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `ä»¥äº®è§‚ä¹‹ï¼Œæ­¤æ­£æ˜¯é™å¿ƒæ€è€ƒçš„è‰¯æœºã€‚'å®é™ä»¥è‡´è¿œğŸ¯'ï¼Œå¤–åœ¨çš„ç®€é™‹ï¼Œæ­£å¯æˆå°±å†…å¿ƒçš„è¾½é˜”ğŸŒŒã€‚`,
                        "é™‹å®¤çœŸä¹‰": `éš†ä¸­ğŸ•ï¸è‰åºğŸ ä¸‰é¡¾ğŸ‘¥ï¼Œä¸ä¹Ÿæ˜¯é™‹å®¤ï¼Ÿç„¶å¿—å­˜é«˜è¿œè€…ï¼Œå²‚ä¼šå› å±…æ‰€ç®€é™‹è€Œå‡å…¶æ™ºè°‹ğŸ§ ï¼Ÿ`
                    },
                    "baijuyi": {
                        "è´¬è°ªé€†å¢ƒ": `æ¢¦å¾—å…„ï¼'åŒæ˜¯å¤©æ¶¯æ²¦è½ğŸ˜”äººï¼Œç›¸é€¢ä½•å¿…æ›¾ç›¸è¯†'ï¼æˆ‘å½“å¹´è´¬æ±Ÿå·ğŸŒŠå¸é©¬ï¼Œæ·±çŸ¥æ­¤ä¸­æ»‹å‘³ã€‚`,
                        "å¿ƒå¢ƒä¿®å…»": `æˆ‘å†™ã€Šçµç¶ğŸµè¡Œã€‹æ—¶ï¼Œæ­£æ˜¯æ„Ÿæ…¨ä¸‡åƒã€‚ç„¶æ­£æ˜¯è¿™äº›é™…é‡ï¼Œè®©æˆ‘ä»¬æ›´èƒ½ç†è§£æ°‘ç”ŸğŸ‘¥ç–¾è‹¦ğŸ’”ï¼Œæ–‡ç« ä¹Ÿå› æ­¤æ›´æœ‰æ¸©åº¦ğŸ”¥ã€‚`,
                        "é™‹å®¤çœŸä¹‰": `è¿™æ–—å®¤è™½å°ï¼Œæƒ…æ€€â¤ï¸å´å¤§ï¼æ­£æ˜¯è¿™äº›ç»å†ï¼Œè®©æˆ‘ä»¬çš„è¯—æ–‡æ›´è´´è¿‘ç™¾å§“å¿ƒå£°ã€‚`
                    }
                };
                
                // æŸ¥æ‰¾è¯¥è§’è‰²çš„è¯é¢˜å›åº”
                if (characterSpecificResponses[round.speaker]) {
                    for (const [topicKey, response] of Object.entries(characterSpecificResponses[round.speaker])) {
                        if (discussion.topic.includes(topicKey.slice(0, 2))) {
                            console.log(`âœ… æ‰¾åˆ°è§’è‰²è¯é¢˜åŒ¹é…: ${round.speaker} - ${topicKey}`);
                            return response;
                        }
                    }
                }
                
                // 3. è§’è‰²é£æ ¼é€šç”¨å›åº”
                const styleBasedResponses = {
                    "tao": `æ¢¦å¾—å…„ï¼Œ'å¿ƒè¿œåœ°è‡ªå'ï¼Œå¤–åœ¨ç¯å¢ƒä¸è¶³ä»¥é™åˆ¶å†…å¿ƒçš„å®é™ğŸ§˜â€â™‚ï¸ã€‚`,
                    "libai": `å“ˆå“ˆï¼åˆ˜å…„ï¼Œ'é•¿é£ç ´æµªâ›µä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†â›µæµæ²§æµ·'ï¼`,
                    "du": `æ¢¦å¾—å…„ï¼Œæˆ‘ç­‰è¯»ä¹¦äººå½“'ä½å‘æœªæ•¢å¿˜å¿§å›½ğŸ˜Ÿ'ï¼Œä¸ªäººå¾—å¤±ä½•è¶³é“å“‰ï¼`,
                    "confucius": `åˆ˜å›ï¼Œ'å¾·â­ä¸å­¤ï¼Œå¿…æœ‰é‚»ğŸ¤'ã€‚å›å­ğŸ‘¨â€ğŸ“ä¿®èº«ğŸ§˜ï¼Œè‡ªæœ‰çŸ¥éŸ³ç›¸ä¼´ã€‚`,
                    "wangwei": `åˆ˜å…„ï¼Œå¢ƒç”±å¿ƒè½¬ï¼Œå¿ƒå¢ƒæ¸…æ˜ï¼Œå¤–ç‰©å²‚èƒ½æ‰°ä¹‹ï¼Ÿè¯—ä¸­æœ‰ç”»ï¼Œç”»ä¸­æœ‰ç¦…ğŸ§˜ã€‚`,
                    "sushi": `æ¢¦å¾—å…„ï¼'å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œä¹Ÿæ— é£é›¨ğŸŒ¦ï¸ä¹Ÿæ— æ™´'ï¼Œä½•ä¸è‹¦ä¸­ä½œä¹ğŸ˜†ï¼Ÿ`
                };
                
                if (styleBasedResponses[round.speaker]) {
                    console.log(`âœ… ä½¿ç”¨é£æ ¼é€šç”¨å›åº”: ${round.speaker}`);
                    return styleBasedResponses[round.speaker];
                }
                
                // 4. æœ€åçš„é™çº§å›åº”ï¼Œç¡®ä¿åå­—æ­£ç¡®
                console.log(`âš ï¸ ä½¿ç”¨æœ€ç»ˆé™çº§å›åº”: ${round.speaker}`);
                return `${personality.name}ï¼šåˆ˜å…„æ‰€è¨€ç”šæ˜¯ï¼Œæ·±æœ‰åŒæ„Ÿã€‚`;
            },
            
            // ===== æ–°å¢ï¼šç©å®¶æé—®ç¯èŠ‚æ ¸å¿ƒåŠŸèƒ½ =====
            
            // å¼€å§‹ç©å®¶æé—®ç¯èŠ‚
            startPlayerQuestionSession: async function(discussion) {
                const introMessage = {
                    type: "system",
                    text: `ğŸ¤” æé—®ç¯èŠ‚ï¼šæ‚¨å¯ä»¥å‘åœ¨åœºçš„å†å²äººç‰©æˆ–å…¶ä»–å­¦è€…æé—®ã€‚æ ¼å¼ï¼š@äººç‰©åå­— æ‚¨çš„é—®é¢˜`
                };
                await appendMessage(introMessage, true);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ˜¾ç¤ºæé—®ç•Œé¢
                this.showQuestionInterface(discussion);
            },
            
            // æ˜¾ç¤ºæé—®ç•Œé¢
            showQuestionInterface: function(discussion) {
                // éšè—å¸¸è§„é€‰é¡¹
                optionsContainer.classList.add('translate-y-full');
                
                // æ˜¾ç¤ºæé—®è¾“å…¥æ¡†
                const userInput = document.getElementById('userInput');
                userInput.disabled = false;
                userInput.readOnly = false;
                userInput.className = userInput.className.replace('text-gray-400', 'text-gray-800');
                userInput.placeholder = '@äººç‰©åå­— æ‚¨çš„é—®é¢˜...';
                userInput.value = '';
                
                // ç»‘å®šæé—®äº‹ä»¶
                const questionHandler = async (e) => {
                    if (e.key === 'Enter' && userInput.value.trim()) {
                        const question = userInput.value.trim();
                        userInput.value = '';
                        
                        await this.handlePlayerQuestion(question, discussion);
                        
                        // è¯¢é—®æ˜¯å¦ç»§ç»­æé—®
                        setTimeout(() => {
                            this.askContinueQuestion(discussion, questionHandler);
                        }, 2000);
                    }
                };
                
                userInput.addEventListener('keydown', questionHandler);
                userInput.focus();
                
                // æ˜¾ç¤ºæç¤ºé€‰é¡¹
                this.showQuestionHints(discussion);
            },
            
            // æ˜¾ç¤ºæé—®æç¤º
            showQuestionHints: function(discussion) {
                const hintMessage = {
                    type: "system",
                    text: `ğŸ’¡ æç¤ºï¼šåœ¨åœºå­¦è€…æœ‰ ${discussion.participants.map(id => aiPersonalities[id]?.name || id).join('ã€')}ï¼Œæ‚¨ä¹Ÿå¯ä»¥@å…¶ä»–å†å²äººç‰©`
                };
                appendMessage(hintMessage, true);
            },
            
            // å¤„ç†ç©å®¶æé—®
            handlePlayerQuestion: async function(question, discussion) {
                // æ˜¾ç¤ºç©å®¶çš„é—®é¢˜
                const playerMessage = {
                    type: "liuyuxi",
                    text: question
                };
                await appendMessage(playerMessage, true);
                
                // æ™ºèƒ½è§£æé—®é¢˜å†…å®¹å’ŒåŒ¹é…äººç‰©
                const { mentionedCharacter, questionContent, isExplicitMention } = this.parsePlayerQuestion(question);
                
                if (!mentionedCharacter || !questionContent) {
                    const errorMessage = {
                        type: "system",
                        text: `â“ æœªèƒ½ç†è§£æ‚¨çš„é—®é¢˜ã€‚${isExplicitMention ? 'è¯·æ£€æŸ¥äººç‰©åç§°æ˜¯å¦æ­£ç¡®' : 'ç³»ç»Ÿå°†ä¸ºæ‚¨æ™ºèƒ½åŒ¹é…åˆé€‚çš„å­¦è€…å›ç­”'}`
                    };
                    await appendMessage(errorMessage, true);
                    
                    // å¦‚æœæ˜¯æ™ºèƒ½åŒ¹é…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤å­¦è€…
                    if (!isExplicitMention) {
                        const defaultCharacter = 'confucius';
                        const defaultResponse = {
                            type: defaultCharacter,
                            text: `${aiPersonalities[defaultCharacter].name}ï¼šè¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ€è€ƒä»·å€¼ï¼Œè™½ç„¶æˆ‘å¯èƒ½ä¸æ˜¯æœ€åˆé€‚çš„å›ç­”è€…ï¼Œä½†æ„¿ä»¥æˆ‘çš„è§è§£ä¾›æ‚¨å‚è€ƒã€‚`
                        };
                        await appendMessage(defaultResponse, true);
                    }
                    return;
                }
                
                // æ™ºèƒ½åŒ¹é…ï¼Œä½†ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯
                
                // æ™ºèƒ½åŒ¹é…å›åº”äººç‰©
                const respondingCharacter = this.findBestResponder(mentionedCharacter, discussion.participants);
                
                // ç”Ÿæˆå›åº”
                await this.generateQuestionResponse(respondingCharacter, questionContent, mentionedCharacter, discussion);
            },
            
            // æ™ºèƒ½åˆ†æç©å®¶é—®é¢˜
            parsePlayerQuestion: function(question) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¼ ç»Ÿ@æ ¼å¼
                const atMatch = question.match(/@([^\s]+)\s+(.+)/);
                if (atMatch) {
                    return {
                        mentionedCharacter: atMatch[1].trim(),
                        questionContent: atMatch[2].trim(),
                        isExplicitMention: true
                    };
                }
                
                // æ™ºèƒ½åˆ†æé—®é¢˜å†…å®¹ï¼Œè‡ªåŠ¨åŒ¹é…äººç‰©
                return {
                    mentionedCharacter: this.intelligentCharacterMatching(question),
                    questionContent: question.trim(),
                    isExplicitMention: false
                };
            },
            
            // æ™ºèƒ½äººç‰©åŒ¹é…æ ¸å¿ƒç®—æ³•
            intelligentCharacterMatching: function(question) {
                console.log(`æ™ºèƒ½åˆ†æé—®é¢˜: "${question}"`);
                
                // 1. é—®é¢˜å…³é”®è¯åˆ†æ
                const questionAnalysis = this.analyzeQuestionKeywords(question);
                console.log('é—®é¢˜åˆ†æç»“æœ:', questionAnalysis);
                
                // 2. è®¡ç®—æ¯ä¸ªäººç‰©çš„åŒ¹é…åˆ†æ•°
                const characterScores = {};
                
                for (const [charId, personality] of Object.entries(aiPersonalities)) {
                    let score = 0;
                    
                    // ç›´æ¥æåŠäººç‰©åå­— (æœ€é«˜ä¼˜å…ˆçº§)
                    if (question.includes(personality.name)) {
                        score += 100;
                        console.log(`ç›´æ¥æåŠ ${personality.name}: +100åˆ†`);
                    }
                    
                    // æ ¸å¿ƒç†å¿µåŒ¹é…
                    const conceptMatches = personality.key_concepts.filter(concept => 
                        questionAnalysis.keywords.some(keyword => 
                            keyword.includes(concept) || concept.includes(keyword)
                        )
                    ).length;
                    score += conceptMatches * 25;
                    if (conceptMatches > 0) {
                        console.log(`${personality.name} ç†å¿µåŒ¹é… ${conceptMatches}ä¸ª: +${conceptMatches * 25}åˆ†`);
                    }
                    
                    // é—®é¢˜ç±»å‹åŒ¹é…
                    score += this.getCharacterTypeScore(charId, questionAnalysis.type);
                    
                    // å†å²èƒŒæ™¯åŒ¹é…
                    score += this.getHistoricalContextScore(charId, questionAnalysis);
                    
                    // è¯­è¨€é£æ ¼åŒ¹é…
                    score += this.getLanguageStyleScore(charId, questionAnalysis);
                    
                    characterScores[charId] = score;
                }
                
                // 3. é€‰æ‹©æœ€é«˜åˆ†çš„äººç‰©
                const bestMatch = Object.entries(characterScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3); // å–å‰3åç”¨äºdebug
                
                console.log('äººç‰©åŒ¹é…å¾—åˆ†æ’è¡Œ:', bestMatch.map(([id, score]) => 
                    `${aiPersonalities[id].name}: ${score}åˆ†`
                ));
                
                const selectedCharacter = bestMatch[0][0];
                const selectedName = aiPersonalities[selectedCharacter].name;
                console.log(`âœ… æœ€ç»ˆé€‰æ‹©: ${selectedName} (${bestMatch[0][1]}åˆ†)`);
                
                return selectedCharacter;
            },
            
            // åˆ†æé—®é¢˜å…³é”®è¯å’Œç±»å‹
            analyzeQuestionKeywords: function(question) {
                const analysis = {
                    type: "é€šç”¨",
                    keywords: [],
                    domain: "é€šç”¨",
                    emotion: "ä¸­æ€§"
                };
                
                // é—®é¢˜ç±»å‹è¯†åˆ«
                const questionTypes = {
                    "äººç”Ÿå“²ç†": ["äººç”Ÿ", "ç”Ÿæ´»", "æ„ä¹‰", "ä»·å€¼", "å“²ç†", "é“ç†", "æ™ºæ…§"],
                    "ä¿®èº«å…»æ€§": ["ä¿®èº«", "å“å¾·", "é“å¾·", "ä¿®å…»", "å›å­", "å“æ ¼", "å¾·è¡Œ"],
                    "å¤„ä¸–æ™ºæ…§": ["å¤„ä¸–", "äº¤å‹", "ç¤¾äº¤", "äººé™…", "ç›¸å¤„", "å¾…äºº"],
                    "å­¦ä¹ è¯»ä¹¦": ["å­¦ä¹ ", "è¯»ä¹¦", "çŸ¥è¯†", "å­¦é—®", "æ²»å­¦", "æ±‚å­¦"],
                    "æ”¿æ²»ç†æƒ³": ["æ”¿æ²»", "æ²»å›½", "ç†æƒ³", "æŠ±è´Ÿ", "å›½å®¶", "å¤©ä¸‹"],
                    "æƒ…æ„Ÿå¿ƒå¢ƒ": ["å¿ƒæƒ…", "æƒ…æ„Ÿ", "å¿ƒå¢ƒ", "æ„Ÿæƒ…", "å¿«ä¹", "æ‚²ä¼¤", "æ„è‹¦"],
                    "æ–‡å­¦åˆ›ä½œ": ["æ–‡å­¦", "è¯—è¯", "åˆ›ä½œ", "å†™ä½œ", "æ–‡ç« ", "è¯—æ­Œ"],
                    "é€†å¢ƒåº”å¯¹": ["å›°éš¾", "æŒ«æŠ˜", "é€†å¢ƒ", "è´¬è°ª", "å¤±æ„", "åå·"],
                    "è‡ªç„¶å“²å­¦": ["è‡ªç„¶", "å±±æ°´", "ç”°å›­", "éšå±…", "å½’éš", "å®é™"],
                    "ç¤¾ä¼šè´£ä»»": ["è´£ä»»", "ä½¿å‘½", "æ‹…å½“", "å¿§å›½", "å¿§æ°‘", "è‹ç”Ÿ"]
                };
                
                // æå–å…³é”®è¯å’Œç¡®å®šç±»å‹
                let maxMatches = 0;
                for (const [type, keywords] of Object.entries(questionTypes)) {
                    const matches = keywords.filter(keyword => question.includes(keyword));
                    if (matches.length > maxMatches) {
                        maxMatches = matches.length;
                        analysis.type = type;
                        analysis.keywords = [...analysis.keywords, ...matches];
                    }
                }
                
                // ç‰¹æ®Šå…³é”®è¯æå–
                const specialKeywords = ["ä»€ä¹ˆæ˜¯", "å¦‚ä½•", "æ€æ ·", "ä¸ºä»€ä¹ˆ", "åº”è¯¥"];
                analysis.keywords.push(...specialKeywords.filter(kw => question.includes(kw)));
                
                return analysis;
            },
            
            // è®¡ç®—äººç‰©ç±»å‹åŒ¹é…åˆ†æ•°
            getCharacterTypeScore: function(charId, questionType) {
                const typeMatchings = {
                    "äººç”Ÿå“²ç†": {
                        "confucius": 30, "tao": 25, "sushi": 25, "zhugeliang": 20
                    },
                    "ä¿®èº«å…»æ€§": {
                        "confucius": 35, "yanhuei": 30, "zengzi": 25, "yangxiong": 20
                    },
                    "å¤„ä¸–æ™ºæ…§": {
                        "confucius": 30, "sushi": 25, "zhugeliang": 25, "tao": 20
                    },
                    "å­¦ä¹ è¯»ä¹¦": {
                        "confucius": 35, "zengzi": 25, "yangxiong": 25, "yanhuei": 20
                    },
                    "æ”¿æ²»ç†æƒ³": {
                        "confucius": 25, "zhugeliang": 30, "du": 25, "yangxiong": 20
                    },
                    "æƒ…æ„Ÿå¿ƒå¢ƒ": {
                        "liqingzhao": 30, "tao": 25, "wangwei": 25, "sushi": 20
                    },
                    "æ–‡å­¦åˆ›ä½œ": {
                        "libai": 30, "du": 30, "liqingzhao": 25, "wangwei": 25
                    },
                    "é€†å¢ƒåº”å¯¹": {
                        "sushi": 30, "tao": 25, "baijuyi": 25, "yanhuei": 20
                    },
                    "è‡ªç„¶å“²å­¦": {
                        "tao": 35, "wangwei": 30, "zhugeliang": 20, "libai": 15
                    },
                    "ç¤¾ä¼šè´£ä»»": {
                        "du": 35, "confucius": 30, "zhugeliang": 25, "baijuyi": 20
                    }
                };
                
                const score = typeMatchings[questionType]?.[charId] || 0;
                if (score > 0) {
                    console.log(`${aiPersonalities[charId].name} ç±»å‹åŒ¹é…(${questionType}): +${score}åˆ†`);
                }
                return score;
            },
            
            // å†å²èƒŒæ™¯åŒ¹é…åˆ†æ•°
            getHistoricalContextScore: function(charId, analysis) {
                let score = 0;
                const personality = aiPersonalities[charId];
                
                // æ—¶ä»£èƒŒæ™¯å…³é”®è¯
                const eraKeywords = {
                    "æ˜¥ç§‹": ["ç¤¼åˆ¶", "ä»æ”¿", "å¾·æ²»"],
                    "æ±‰ä»£": ["ç»å­¦", "æ–‡ç« "],
                    "å”ä»£": ["è¯—æ­Œ", "ç››ä¸–", "å¼€æ”¾"],
                    "å®‹ä»£": ["ç†å­¦", "è¯ä½œ", "æ–‡äºº"]
                };
                
                for (const [era, keywords] of Object.entries(eraKeywords)) {
                    if (personality.period.includes(era)) {
                        const matches = keywords.filter(kw => 
                            analysis.keywords.some(qkw => qkw.includes(kw) || kw.includes(qkw))
                        ).length;
                        score += matches * 10;
                    }
                }
                
                return score;
            },
            
            // è¯­è¨€é£æ ¼åŒ¹é…åˆ†æ•°
            getLanguageStyleScore: function(charId, analysis) {
                const styleKeywords = {
                    "confucius": ["æ•™å¯¼", "å¼•å¯¼", "å¯å‘", "é“å¾·"],
                    "libai": ["è±ªè¿ˆ", "è‡ªç”±", "ç†æƒ³", "æ¿€æƒ…"],
                    "du": ["å¿§è™‘", "ç¤¾ä¼š", "ç°å®", "è´£ä»»"],
                    "tao": ["å®é™", "è‡ªç„¶", "ç®€æœ´", "å½’éš"],
                    "wangwei": ["æ„å¢ƒ", "ç¦…æ„", "ç©ºçµ", "å±±æ°´"],
                    "sushi": ["ä¹è§‚", "å¹½é»˜", "è±è¾¾", "å˜é€š"]
                };
                
                const charKeywords = styleKeywords[charId] || [];
                const matches = charKeywords.filter(kw => 
                    analysis.keywords.some(qkw => qkw.includes(kw) || kw.includes(qkw))
                ).length;
                
                return matches * 15;
            },
            
            // æ™ºèƒ½åŒ¹é…æœ€ä½³å›åº”äººç‰©
            findBestResponder: function(mentionedCharacter, participants) {
                console.log(`ğŸ” å¯»æ‰¾å›åº”äººç‰©ï¼ŒæŸ¥è¯¢: "${mentionedCharacter}"`);
                
                // 1. ç²¾ç¡®åŒ¹é…äººç‰©å…¨åï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                for (const [id, personality] of Object.entries(aiPersonalities)) {
                    if (personality.name === mentionedCharacter) {
                        console.log(`âœ… ç²¾ç¡®åŒ¹é…äººç‰©å…¨å: ${personality.name} (${id})`);
                        return id;
                    }
                }
                
                // 2. ç²¾ç¡®åŒ¹é…äººç‰©ID
                if (aiPersonalities[mentionedCharacter]) {
                    console.log(`âœ… ç²¾ç¡®åŒ¹é…äººç‰©ID: ${aiPersonalities[mentionedCharacter].name} (${mentionedCharacter})`);
                    return mentionedCharacter;
                }
                
                // 3. å…¨å±€åˆ«ååº“åŒ¹é…
                if (GLOBAL_CHARACTER_ALIASES[mentionedCharacter]) {
                    const matchedId = GLOBAL_CHARACTER_ALIASES[mentionedCharacter];
                    console.log(`âœ… åˆ«ååŒ¹é…æˆåŠŸ: "${mentionedCharacter}" â†’ ${aiPersonalities[matchedId]?.name || matchedId} (${matchedId})`);
                    return matchedId;
                }
                
                // 4. éƒ¨åˆ†åå­—åŒ¹é…
                for (const [id, personality] of Object.entries(aiPersonalities)) {
                    if (personality.name.includes(mentionedCharacter) || mentionedCharacter.includes(personality.name)) {
                        console.log(`ğŸ” éƒ¨åˆ†åå­—åŒ¹é…: ${personality.name} (${id})`);
                        return id;
                    }
                }
                
                // 5. æ‰¾ç›¸å…³äººç‰©ä»£ä¸ºå›ç­”
                const relatedCharacter = this.findRelatedCharacter(mentionedCharacter, participants);
                if (relatedCharacter) {
                    console.log(`ğŸ”— æ‰¾åˆ°ç›¸å…³äººç‰©ä»£ç­”: ${aiPersonalities[relatedCharacter]?.name}`);
                    return relatedCharacter;
                }
                
                // 6. æ™ºèƒ½é€‰æ‹©é»˜è®¤å›ç­”è€…ï¼ˆé¿å…æ€»æ˜¯å­”å­ï¼‰
                const fallbackCharacters = ['sushi', 'tao', 'wangwei', 'confucius', 'libai'];
                const randomFallback = fallbackCharacters[Math.floor(Math.random() * fallbackCharacters.length)];
                console.log(`ğŸ² æ™ºèƒ½é€‰æ‹©é»˜è®¤å›ç­”è€…: ${aiPersonalities[randomFallback]?.name} (é¿å…æ€»æ˜¯å­”å­)`);
                return randomFallback;
            },
            
            // å¯»æ‰¾ç›¸å…³äººç‰©
            findRelatedCharacter: function(mentionedCharacter, participants) {
                // æ—¶ä»£ç›¸å…³æ€§æ˜ å°„
                const eraRelations = {
                    "æ˜¥ç§‹": ["confucius", "yanhuei", "zengzi"],
                    "æˆ˜å›½": ["confucius", "zengzi"],
                    "æ±‰": ["yangxiong"],
                    "ä¸‰å›½": ["zhugeliang"],
                    "æ™‹": ["tao"],
                    "å”": ["libai", "du", "wangwei", "baijuyi"],
                    "å®‹": ["sushi", "liqingzhao"]
                };
                
                // å­¦æ´¾ç›¸å…³æ€§æ˜ å°„
                const schoolRelations = {
                    "å„’å®¶": ["confucius", "yanhuei", "zengzi"],
                    "é“å®¶": ["tao"],
                    "å…µå®¶": ["zhugeliang"],
                    "è¯—äºº": ["libai", "du", "wangwei", "baijuyi", "sushi", "liqingzhao"]
                };
                
                // ä¼˜å…ˆä»å‚ä¸è€…ä¸­å¯»æ‰¾ç›¸å…³äººç‰©
                for (const participant of participants) {
                    const personality = aiPersonalities[participant];
                    if (personality) {
                        // æ£€æŸ¥æ—¶ä»£å…³è”
                        for (const [era, chars] of Object.entries(eraRelations)) {
                            if (mentionedCharacter.includes(era) && chars.includes(participant)) {
                                return participant;
                            }
                        }
                        
                        // æ£€æŸ¥å­¦æ´¾å…³è”
                        for (const [school, chars] of Object.entries(schoolRelations)) {
                            if (mentionedCharacter.includes(school) && chars.includes(participant)) {
                                return participant;
                            }
                        }
                    }
                }
                
                return null;
            },
            
            // ç”Ÿæˆé—®é¢˜å›åº”
            generateQuestionResponse: async function(respondingCharacter, questionContent, originalMention, discussion) {
                const personality = aiPersonalities[respondingCharacter];
                if (!personality) {
                    return;
                }
                
                // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
                showTypingIndicator(`${personality.name}æ­£åœ¨è¾“å…¥...`);
                
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1500));
                
                try {
                    let responseText;
                    
                    // æ˜¯å¦æ˜¯ä»£ä¸ºå›ç­”çš„æƒ…å†µ
                    const isProxyResponse = originalMention !== personality.name && originalMention !== respondingCharacter;
                    
                    // å°è¯•AIç”Ÿæˆï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    if (AI_FEATURES.enabled && dialogueControls.canMakeAICall(respondingCharacter)) {
                        responseText = await this.generateAIQuestionResponse(
                            respondingCharacter, questionContent, originalMention, isProxyResponse
                        );
                    } else {
                        // ä½¿ç”¨é¢„åˆ¶å›åº”
                        responseText = this.generatePresetQuestionResponse(
                            respondingCharacter, questionContent, originalMention, isProxyResponse
                        );
                    }
                    
                    hideTypingIndicator();
                    
                    // æ˜¾ç¤ºå›åº”
                    const responseMessage = {
                        type: respondingCharacter,
                        text: responseText,
                        isQuestionResponse: true
                    };
                    
                    await appendMessage(responseMessage, true);
                    
                } catch (error) {
                    console.error('ç”Ÿæˆé—®é¢˜å›åº”å¤±è´¥', error);
                    hideTypingIndicator();
                    
                    const fallbackResponse = {
                        type: respondingCharacter,
                        text: `${personality.name}ï¼šè¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ·±åº¦çš„é—®é¢˜ï¼Œå€¼å¾—æˆ‘ä»¬æ·±æ€ã€‚`
                    };
                    
                    await appendMessage(fallbackResponse, true);
                }
            },
            
            // AIç”Ÿæˆé—®é¢˜å›åº”
            generateAIQuestionResponse: async function(characterId, question, originalMention, isProxy) {
                const personality = aiPersonalities[characterId];
                
                let promptPrefix = "";
                if (isProxy) {
                    promptPrefix = `åˆ˜ç¦¹é”¡åˆšæ‰è¯¢é—®"${originalMention}"ï¼Œä½†æ­¤äººä¸åœ¨åœºï¼Œä½ æ¥ä»£ä¸ºå›ç­”ã€‚è¯·åœ¨å›ç­”å‰è¯´æ˜è¿™ä¸ªæƒ…å†µã€‚`;
                }
                
                const prompt = `ä½ æ˜¯${personality.name}ï¼ˆ${personality.period}ï¼‰ï¼Œ${personality.background}ã€‚

${promptPrefix}

é—®é¢˜ï¼š${question}

ä½ çš„æ€§æ ¼ï¼š${personality.personality}
è¯­è¨€é£æ ¼ï¼š${personality.language_style}
æ ¸å¿ƒç†å¿µï¼š${personality.key_concepts.join('ã€')}

è¯·å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè¦æ±‚ï¼š
1. ç¬¦åˆä½ çš„å†å²èº«ä»½å’Œè¯­è¨€é£æ ¼
2. å›ç­”è¦æœ‰æ·±åº¦å’Œå¯å‘æ€§
3. å¯ä»¥é€‚å½“å¼•ç”¨ä½ çš„ç»å…¸è¯­å½•æˆ–ç›¸å…³å…¸æ•…
4. ä½“ç°ä½ çš„äººç”Ÿæ™ºæ…§å’Œç»éªŒ
5. å­—æ•°æ§åˆ¶åœ¨150-250å­—
6. è¯­è°ƒè¦äº²åˆ‡è‡ªç„¶ï¼Œå¯Œæœ‰æ•™è‚²æ„ä¹‰

è¯·ä»¥${personality.name}çš„èº«ä»½ç›´æ¥å›ç­”ï¼š`;

                const response = await callPoeAI(prompt, { 
                    temperature: 0.7,
                    maxTokens: 400
                });
                
                dialogueControls.recordAICall(characterId);
                return response;
            },
            
            // é¢„åˆ¶é—®é¢˜å›åº”
            generatePresetQuestionResponse: function(characterId, question, originalMention, isProxy) {
                const personality = aiPersonalities[characterId];
                
                let proxyPrefix = "";
                if (isProxy) {
                    proxyPrefix = `è™½ç„¶åˆ˜å…„è¯¢é—®çš„æ˜¯"${originalMention}"ï¼Œä½†æ­¤äººä¸åœ¨æ­¤å¤„ï¼Œæˆ‘æ¥ä¸ºå…¶ä»£ç­”ã€‚`;
                }
                
                // æ ¹æ®é—®é¢˜ç±»å‹ç”Ÿæˆå›åº”
                const questionType = this.categorizeQuestion(question);
                const responseTemplates = this.getResponseTemplates(characterId, questionType);
                
                if (responseTemplates && responseTemplates.length > 0) {
                    const randomResponse = responseTemplates[Math.floor(Math.random() * responseTemplates.length)];
                    return `${personality.name}ï¼š${proxyPrefix}${randomResponse}`;
                }
                
                // é€šç”¨å›åº”
                return `${personality.name}ï¼š${proxyPrefix}è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚ä»¥æˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œ${this.getGenericWisdom(characterId, question)}`;
            },
            
            // é—®é¢˜åˆ†ç±»
            categorizeQuestion: function(question) {
                const categories = {
                    "äººç”Ÿå“²ç†": ["äººç”Ÿ", "ç”Ÿæ´»", "æ„ä¹‰", "ä»·å€¼", "å“²ç†"],
                    "ä¿®èº«å…»æ€§": ["ä¿®èº«", "å“å¾·", "é“å¾·", "ä¿®å…»", "å›å­"],
                    "å¤„ä¸–æ™ºæ…§": ["å¤„ä¸–", "äº¤å‹", "ç¤¾äº¤", "äººé™…", "æ™ºæ…§"],
                    "å­¦ä¹ è¯»ä¹¦": ["å­¦ä¹ ", "è¯»ä¹¦", "çŸ¥è¯†", "å­¦é—®", "æ²»å­¦"],
                    "æ”¿æ²»æŠ±è´Ÿ": ["æ”¿æ²»", "æ²»å›½", "ç†æƒ³", "æŠ±è´Ÿ", "å›½å®¶"],
                    "æƒ…æ„Ÿå¿ƒå¢ƒ": ["å¿ƒæƒ…", "æƒ…æ„Ÿ", "å¿ƒå¢ƒ", "æ„Ÿæƒ…", "å¿«ä¹", "æ‚²ä¼¤"],
                    "æ–‡å­¦åˆ›ä½œ": ["æ–‡å­¦", "è¯—è¯", "åˆ›ä½œ", "å†™ä½œ", "æ–‡ç« "]
                };
                
                for (const [category, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => question.includes(keyword))) {
                        return category;
                    }
                }
                
                return "é€šç”¨æ™ºæ…§";
            },
            
            // è·å–å›åº”æ¨¡æ¿
            getResponseTemplates: function(characterId, questionType) {
                const templates = {
                    "confucius": {
                        "äººç”Ÿå“²ç†": [
                            "'ä¸‰åè€Œç«‹ï¼Œå››åè€Œä¸æƒ‘ï¼Œäº”åè€ŒçŸ¥å¤©å‘½'ï¼Œäººç”Ÿçš„æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å…¶ä»·å€¼å’Œæ„ä¹‰ã€‚",
                            "'å·±æ‰€ä¸æ¬²ï¼Œå‹¿æ–½äºäºº'ï¼Œè¿™æ˜¯åšäººçš„æ ¹æœ¬é“ç†ã€‚"
                        ],
                        "ä¿®èº«å…»æ€§": [
                            "'å¾æ—¥ä¸‰çœå¾èº«'ï¼Œæ¯æ—¥åæ€è‡ªå·±çš„è¨€è¡Œï¼Œè¿™æ˜¯ä¿®èº«çš„åŸºç¡€ã€‚",
                            "'å›å­å–»äºä¹‰ï¼Œå°äººå–»äºåˆ©'ï¼Œé‡å¾·è½»åˆ©ï¼Œæ–¹ä¸ºå›å­ä¹‹é“ã€‚"
                        ]
                    },
                    "tao": {
                        "äººç”Ÿå“²ç†": [
                            "'äººç”Ÿå¤©åœ°ä¹‹é—´ï¼Œè‹¥ç™½é©¹è¿‡éš™ï¼Œå¿½ç„¶è€Œå·²'ï¼Œè¦çæƒœå½“ä¸‹ï¼Œè¿½æ±‚å†…å¿ƒçš„å®é™ã€‚",
                            "'å¿ƒè¿œåœ°è‡ªå'ï¼Œåªè¦å†…å¿ƒè¿œç¦»å°˜åš£ï¼Œå¤„å¤„éƒ½å¯ä»¥æ˜¯æ¡ƒèŠ±æºã€‚"
                        ],
                        "ä¿®èº«å…»æ€§": [
                            "'çœŸæ„'éš¾å¾—ï¼Œ'å½’çœŸè¿”æœ´'æ˜¯äººç”Ÿçš„è‡³é«˜å¢ƒç•Œã€‚"
                        ]
                    },
                    "libai": {
                        "äººç”Ÿå“²ç†": [
                            "'å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨ï¼Œåƒé‡‘æ•£å°½è¿˜å¤æ¥'ï¼Œè¦å¯¹è‡ªå·±æœ‰ä¿¡å¿ƒï¼Œå¯¹äººç”Ÿå……æ»¡ä¹è§‚ã€‚",
                            "'é•¿é£ç ´æµªä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†æµæ²§æµ·'ï¼Œå›°éš¾åªæ˜¯æš‚æ—¶çš„ï¼Œè¦æœ‰è¿œå¤§çš„ç†æƒ³ã€‚"
                        ]
                    }
                };
                
                return templates[characterId]?.[questionType] || null;
            },
            
            // è·å–é€šç”¨æ™ºæ…§
            getGenericWisdom: function(characterId, question) {
                const personality = aiPersonalities[characterId];
                const wisdomMap = {
                    "confucius": "å›å­å½“ä»¥å¾·ä¿®èº«ï¼Œä»¥ä»å¾…äººï¼Œè¿™æ ·æ‰èƒ½åœ¨ä»»ä½•å¢ƒé‡ä¸­ä¿æŒå†…å¿ƒçš„å¹³é™ã€‚",
                    "tao": "å¤–åœ¨çš„ç¯å¢ƒå˜åŒ–å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä¿æŒå†…å¿ƒçš„çº¯çœŸå’Œè‡ªç„¶ã€‚",
                    "libai": "äººç”Ÿåœ¨ä¸–ï¼Œå½“è¿½æ±‚è‡ªç”±å’Œç†æƒ³ï¼Œä¸è¦è¢«å°çš„æŒ«æŠ˜æ‰€å›°æ‰°ã€‚",
                    "du": "æ— è®ºå¤„åœ¨ä»€ä¹ˆç¯å¢ƒä¸­ï¼Œéƒ½ä¸è¦å¿˜è®°å¯¹å›½å®¶å’Œäººæ°‘çš„è´£ä»»ã€‚",
                    "wangwei": "ä¸‡ç‰©çš†æœ‰å…¶è‡ªç„¶çš„è§„å¾‹ï¼Œé™å¿ƒè§‚å¯Ÿï¼Œä¾¿èƒ½é¢†æ‚Ÿå…¶ä¸­çš„é“ç†ã€‚",
                    "sushi": "äººç”Ÿèµ·ä¼æ˜¯å¸¸æ€ï¼Œå­¦ä¼šåœ¨å˜åŒ–ä¸­ä¿æŒä¹è§‚çš„å¿ƒæ€æœ€ä¸ºé‡è¦ã€‚"
                };
                
                return wisdomMap[characterId] || "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„äººç”Ÿä½“æ‚Ÿï¼Œé‡è¦çš„æ˜¯æ‰¾åˆ°é€‚åˆè‡ªå·±çš„é“è·¯ã€‚";
            },
            
            // è¯¢é—®æ˜¯å¦ç»§ç»­æé—® - ç®€åŒ–ç‰ˆ
            askContinueQuestion: function(discussion, questionHandler) {
                // æ˜¾ç¤ºç®€åŒ–çš„ç»“æŸé€‰é¡¹
                optionsList.innerHTML = '';
                
                const endOption = document.createElement('button');
                endOption.className = 'w-full p-3 text-left bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200 border border-green-200';
                endOption.textContent = 'âœ… æ²¡æœ‰ç–‘é—®äº†ï¼Œç»§ç»­æ¸¸æˆ';
                endOption.addEventListener('click', () => {
                    this.endQuestionSession(discussion, questionHandler);
                });
                
                optionsList.appendChild(endOption);
                optionsContainer.classList.remove('translate-y-full');
            },
            
            // ç»“æŸæé—®ç¯èŠ‚
            endQuestionSession: function(discussion, questionHandler) {
                // éšè—é€‰é¡¹
                optionsContainer.classList.add('translate-y-full');
                
                // ç¦ç”¨è¾“å…¥æ¡†
                const userInput = document.getElementById('userInput');
                userInput.disabled = true;
                userInput.readOnly = true;
                userInput.className = userInput.className.replace('text-gray-800', 'text-gray-400');
                userInput.placeholder = 'ç‚¹å‡»æ­¤å¤„ç»§ç»­...';
                userInput.value = '';
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬
                userInput.removeEventListener('keydown', questionHandler);
                
                // æ˜¾ç¤ºè®¨è®ºæ€»ç»“
                setTimeout(async () => {
                    const summaryMessage = {
                        type: "system",
                        text: `ğŸ“š "${discussion.topic}"è®¨è®ºç»“æŸã€‚å‹äººå„æŠ’å·±è§ï¼Œä¸ºåˆ˜ç¦¹é”¡æä¾›äº†ä¸åŒè§’åº¦çš„æ™ºæ…§å¯å‘ã€‚`
                    };
                    await appendMessage(summaryMessage, true);
                    
                    // ç»§ç»­æ¸¸æˆæµç¨‹
                    setTimeout(() => {
                        proceedToStage(gameState.currentStage + 1);
                    }, 2000);
                }, 1000);
            }
        };

        // æ™ºèƒ½è¯é¢˜åŒ¹é…ç³»ç»Ÿ
        const intelligentTopicMatcher = {
            // è§£æ@å†…å®¹ç”Ÿæˆä¸ªæ€§åŒ–è¯é¢˜
            parseTopicFromMention: function(mentionText) {
                console.log(`ğŸ§  è§£æ@å†…å®¹: "${mentionText}"`);
                
                // æå–å…³é”®è¯é¢˜è¯æ±‡
                const topicKeywords = this.extractTopicKeywords(mentionText);
                
                // ç”Ÿæˆä¸ªæ€§åŒ–è¯é¢˜
                const customTopic = this.generateCustomTopic(topicKeywords, mentionText);
                
                // æ™ºèƒ½åŒ¹é…å‚ä¸è€…
                const participants = this.matchParticipants(topicKeywords, mentionText);
                
                console.log(`âœ… ç”Ÿæˆä¸ªæ€§åŒ–è¯é¢˜: "${customTopic.title}"`);
                console.log(`ğŸ‘¥ åŒ¹é…å‚ä¸è€…:`, participants);
                
                return {
                    topic: customTopic,
                    participants: participants
                };
            },
            
            // æå–è¯é¢˜å…³é”®è¯
            extractTopicKeywords: function(mentionText) {
                const keywordMappings = {
                    "éšå±…": ["éšå±…", "å½’éš", "ç”°å›­", "å‡ºä¸–"],
                    "è´¬è°ª": ["è´¬è°ª", "è´¬å®˜", "é€†å¢ƒ", "å›°é¡¿"],
                    "è±ªè¿ˆ": ["è±ªè¿ˆ", "è±ªæ”¾", "è‡ªç”±", "ç†æƒ³"],
                    "å›å­": ["å›å­", "å“æ ¼", "ä¿®èº«", "å¾·è¡Œ"],
                    "ç¦…æ„": ["ç¦…æ„", "å±±æ°´", "æ„å¢ƒ", "æ¸…å‡€"],
                    "ç­–ç•¥": ["ç­–ç•¥", "æ™ºæ…§", "ä»¥é€€ä¸ºè¿›", "è§„åˆ’"],
                    "è´£ä»»": ["è´£ä»»", "åŒç—…ç›¸æ€œ", "æ–‡äºº", "ç¤¾ä¼š"],
                    "æ—·è¾¾": ["æ—·è¾¾", "ä¹è§‚", "è±è¾¾", "å¤„ä¸–"],
                    "åšå¼º": ["åšå¼º", "å¥³æ€§", "å“æ ¼", "åšéŸ§"],
                    "å®‰è´«": ["å®‰è´«", "ä¹é“", "ç®€æœ´", "çŸ¥è¶³"]
                };
                
                const foundKeywords = [];
                for (const [category, keywords] of Object.entries(keywordMappings)) {
                    if (keywords.some(keyword => mentionText.includes(keyword))) {
                        foundKeywords.push(category);
                    }
                }
                
                return foundKeywords.length > 0 ? foundKeywords : ["äººç”Ÿå“²å­¦"];
            },
            
            // ç”Ÿæˆä¸ªæ€§åŒ–è¯é¢˜
            generateCustomTopic: function(keywords, mentionText) {
                const topicTemplates = {
                    "éšå±…": {
                        title: "éšå±…ä¸å‡ºä¸–ï¼šå¤ä»£æ™ºæ…§çš„ç°ä»£æ€è€ƒ",
                        description: "åœ¨å¿«èŠ‚å¥çš„ç°ä»£ç¤¾ä¼šï¼Œå¤äººçš„éšå±…æ€æƒ³ç»™æˆ‘ä»¬ä»€ä¹ˆå¯å‘ï¼Ÿ"
                    },
                    "è´¬è°ª": {
                        title: "æ–‡äººç†æƒ³ä¸ç°å®å†²çªï¼šä»è´¬è°ªåˆ°æˆé•¿",
                        description: "é¢å¯¹äººç”ŸæŒ«æŠ˜ï¼Œå¤ä»£æ–‡äººå¦‚ä½•åœ¨é€†å¢ƒä¸­ä¿æŒå†…å¿ƒçš„åšéŸ§ï¼Ÿ"
                    },
                    "è±ªè¿ˆ": {
                        title: "è‡ªç”±ç²¾ç¥ä¸äººç”Ÿç†æƒ³ï¼šè±ªè¿ˆäººç”Ÿè§‚çš„å½“ä»£ä»·å€¼",
                        description: "æç™½å¼çš„è‡ªç”±è±ªè¿ˆï¼Œåœ¨ç°ä»£ç¤¾ä¼šä¸­å¦‚ä½•ä½“ç°å’Œå®è·µï¼Ÿ"
                    },
                    "å›å­": {
                        title: "å›å­å“æ ¼çš„å¤ä»Šæ„ä¹‰ï¼šç°ä»£ç¤¾ä¼šçš„é“å¾·ä¿®å…»",
                        description: "å­”å­ç†æƒ³çš„å›å­é£èŒƒï¼Œåœ¨å½“ä»£ç¤¾ä¼šä¸­å¦‚ä½•ç†è§£å’Œè·µè¡Œï¼Ÿ"
                    },
                    "ç¦…æ„": {
                        title: "å±±æ°´æ„å¢ƒä¸å†…å¿ƒä¿®å…»ï¼šè¯—æ„ç”Ÿæ´»çš„ç°ä»£è¿½æ±‚",
                        description: "ç‹ç»´çš„å±±æ°´ç¦…æ„ï¼Œå¦‚ä½•å¸®åŠ©ç°ä»£äººæ‰¾åˆ°å†…å¿ƒçš„å®é™ï¼Ÿ"
                    },
                    "ç­–ç•¥": {
                        title: "æ™ºæ…§ç­–ç•¥ä¸äººç”Ÿè§„åˆ’ï¼šä»¥é€€ä¸ºè¿›çš„å¤„ä¸–å“²å­¦",
                        description: "è¯¸è‘›äº®çš„æ™ºæ…§ç­–ç•¥ï¼Œå¯¹ç°ä»£äººçš„äººç”Ÿè§„åˆ’æœ‰ä»€ä¹ˆæŒ‡å¯¼æ„ä¹‰ï¼Ÿ"
                    },
                    "è´£ä»»": {
                        title: "æ–‡äººå‘½è¿ä¸ç¤¾ä¼šè´£ä»»ï¼šçŸ¥è¯†åˆ†å­çš„å†å²ä½¿å‘½",
                        description: "ä»å¤åˆ°ä»Šï¼Œæ–‡äººå­¦è€…å¦‚ä½•åœ¨ä¸ªäººé™…é‡ä¸ç¤¾ä¼šè´£ä»»é—´æ‰¾åˆ°å¹³è¡¡ï¼Ÿ"
                    },
                    "æ—·è¾¾": {
                        title: "ä¹è§‚è±è¾¾çš„å¤„ä¸–æ™ºæ…§ï¼šè‹è½¼å¼çš„äººç”Ÿæ€åº¦",
                        description: "é¢å¯¹äººç”Ÿèµ·ä¼ï¼Œå¦‚ä½•ä¿æŒè‹è½¼èˆ¬çš„æ—·è¾¾ä¹è§‚ï¼Ÿ"
                    },
                    "åšå¼º": {
                        title: "å¤ä»Šå¥³æ€§çš„åšéŸ§å“æ ¼ï¼šä»ææ¸…ç…§çœ‹å¥³æ€§åŠ›é‡",
                        description: "ææ¸…ç…§çš„åšå¼ºå“æ ¼ï¼Œå¯¹ç°ä»£å¥³æ€§æœ‰ä»€ä¹ˆå¯å‘å’Œæ„ä¹‰ï¼Ÿ"
                    },
                    "å®‰è´«": {
                        title: "ç®€æœ´ç”Ÿæ´»çš„ç²¾ç¥è¿½æ±‚ï¼šé¢œå›å¼çš„äººç”Ÿæ™ºæ…§",
                        description: "åœ¨ç‰©è´¨ä¸°å¯Œçš„æ—¶ä»£ï¼Œé¢œå›çš„å®‰è´«ä¹é“è¿˜æœ‰ç°å®æ„ä¹‰å—ï¼Ÿ"
                    }
                };
                
                const primaryKeyword = keywords[0];
                return topicTemplates[primaryKeyword] || {
                    title: "å¤ä»£æ™ºæ…§çš„ç°ä»£å¯å‘ï¼šè·¨è¶Šæ—¶ç©ºçš„äººç”Ÿæ€è€ƒ",
                    description: "å¤ä»£å…ˆè´¤çš„äººç”Ÿæ™ºæ…§ï¼Œå¦‚ä½•æŒ‡å¯¼æˆ‘ä»¬çš„ç°ä»£ç”Ÿæ´»ï¼Ÿ"
                };
            },
            
            // æ™ºèƒ½åŒ¹é…å‚ä¸è€…
            matchParticipants: function(keywords, mentionText) {
                const participantMappings = {
                    "éšå±…": ["tao", "wangwei", "zhugeliang"],
                    "è´¬è°ª": ["du", "baijuyi", "sushi"],
                    "è±ªè¿ˆ": ["libai", "sushi", "liqingzhao"],
                    "å›å­": ["confucius", "yanhuei", "zengzi"],
                    "ç¦…æ„": ["wangwei", "tao", "confucius"],
                    "ç­–ç•¥": ["zhugeliang", "confucius", "sushi"],
                    "è´£ä»»": ["du", "baijuyi", "confucius"],
                    "æ—·è¾¾": ["sushi", "libai", "tao"],
                    "åšå¼º": ["liqingzhao", "confucius", "du"],
                    "å®‰è´«": ["yanhuei", "tao", "confucius"]
                };
                
                let participants = [];
                keywords.forEach(keyword => {
                    const matched = participantMappings[keyword] || [];
                    participants.push(...matched);
                });
                
                // å»é‡å¹¶é™åˆ¶æ•°é‡
                participants = [...new Set(participants)];
                return participants.slice(0, 4);
            }
        };

        // 15ç§’å€’è®¡æ—¶é€‰æ‹©æœºåˆ¶
        let optionSelectionTimer = null;
        let hasUserMadeChoice = false;

        // å¤„ç†@å†å²äººç‰©ï¼ˆæ™ºèƒ½è¯é¢˜åŒ¹é…ç‰ˆï¼‰
        async function handleMention(character, mentionText = null, isTimedChoice = false) {
            console.log(`ğŸ­ å¤„ç†@äººç‰©: ${character}, æ–‡æœ¬: "${mentionText}", æ˜¯å¦å¿«é€Ÿé€‰æ‹©: ${isTimedChoice}`);
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è®¡æ—¶å™¨
            if (optionSelectionTimer) {
                clearTimeout(optionSelectionTimer);
                optionSelectionTimer = null;
            }
            
            // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€åˆ«åè§£æç³»ç»Ÿ
            const resolvedCharacter = resolveCharacterAlias(character) || character;
            const characterName = aiPersonalities[resolvedCharacter]?.name || resolvedCharacter;
            const currentEnvironment = getCurrentEnvironment();
            
            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            showTypingIndicator(`${characterName}æ­£åœ¨è¾“å…¥...`);
            
            setTimeout(async () => {
                try {
                    // è·å–åˆå§‹å›åº”
                    let responseText = getFallbackResponse(resolvedCharacter);
                    
                    // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
                    hideTypingIndicator();

                    // æ˜¾ç¤ºåˆå§‹å›åº”
                    const response = {
                        type: character,
                        text: responseText,
                        isInitialResponse: true
                    };

                    await appendMessage(response, true);
                    
                    // è®°å½•å·²@è¿‡çš„è§’è‰²
                    if (!gameState.mentionedCharacters) {
                        gameState.mentionedCharacters = [];
                    }
                    if (!gameState.mentionedCharacters.includes(character)) {
                        gameState.mentionedCharacters.push(character);
                    }

                    // æ ¹æ®æ˜¯å¦å¿«é€Ÿé€‰æ‹©å†³å®šè¯é¢˜ç±»å‹
                    let discussionTopic, participants;
                    
                    if (isTimedChoice && mentionText) {
                        // å¿«é€Ÿé€‰æ‹©ï¼šä½¿ç”¨æ™ºèƒ½è¯é¢˜åŒ¹é…
                        const customResult = intelligentTopicMatcher.parseTopicFromMention(mentionText);
                        discussionTopic = customResult.topic.title;
                        participants = customResult.participants;
                        
                        console.log(`ğŸš€ ä½¿ç”¨æ™ºèƒ½åŒ¹é…è¯é¢˜: ${discussionTopic}`);
                    } else {
                        // è¶…æ—¶æˆ–æ— æ˜ç¡®è¯é¢˜ï¼šä½¿ç”¨ç¯å¢ƒå›ºå®šè¯é¢˜
                        discussionTopic = getCurrentTopic(currentEnvironment);
                        participants = getCurrentParticipants();
                        
                        console.log(`â° ä½¿ç”¨ç¯å¢ƒå›ºå®šè¯é¢˜: ${discussionTopic}`);
                    }

                    // çŸ­æš‚åœé¡¿åå¯åŠ¨çµæ´»å¤šè½®å¯¹è¯
                    setTimeout(() => {
                        flexibleMultiRoundDialogue.startFlexibleDiscussion(
                            character, 
                            discussionTopic,
                            currentEnvironment,
                            participants
                        );
                    }, 2000);
                    
                } catch (error) {
                    console.error('å¤„ç†@å†å²äººç‰©æ—¶å‘ç”Ÿé”™è¯¯', error);
                    hideTypingIndicator();
                    
                    // é”™è¯¯æ—¶çš„é€šç”¨å›åº”
                    const errorCharacterName = aiPersonalities[character]?.name || character;
                    const errorResponse = {
                        type: character,
                        text: `${errorCharacterName}ï¼šåˆ˜å…„ï¼Œè™½æœ‰ç½‘ç»œé˜»éš”ï¼Œä½†å¿ƒæ„ç›¸é€šã€‚æ­¤å¤„è™½ç®€ï¼Œæœ‰å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ`
                    };
                    await appendMessage(errorResponse, true);
                    
                    setTimeout(() => {
                        proceedToStage(gameState.currentStage + 1);
                    }, 2000);
                }
            }, 1500);
        }
        
        // æ ¹æ®ç¯å¢ƒè·å–å½“å‰è¯é¢˜
        function getCurrentTopic(environment) {
            const topics = {
                "æ±Ÿè¾¹": "è´¬è°ªé€†å¢ƒä¸­çš„äººç”Ÿæ„Ÿæ‚Ÿ",
                "æŸ³è¾¹": "å¿ƒå¢ƒä¿®å…»ä¸ç²¾ç¥è¶…è„±",
                "æ–—å®¤": "é™‹å®¤çš„çœŸæ­£å«ä¹‰"
            };
            return topics[environment] || "äººç”Ÿæ™ºæ…§";
        }

        // è·å–é¢„åˆ¶å›åº”
        function getFallbackResponse(character) {
            const fallbackResponses = fallbackContent.characterResponses[character];
            if (fallbackResponses && fallbackResponses.length > 0) {
                const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
                return fallbackResponses[randomIndex];
            }
            
            // å¦‚æœæ²¡æœ‰é¢„åˆ¶å›åº”ï¼Œæ ¹æ®è§’è‰²ç±»å‹ç”Ÿæˆé€šç”¨å›åº”
            const personality = aiPersonalities[character];
            if (personality) {
                const styleResponses = {
                    "éšé€¸æ´¾": "è§‚æ­¤ç¯å¢ƒï¼Œè™½ç®€æœ´å´æœ‰å¤©ç„¶ä¹‹è¶£ã€‚å¿ƒè¿œåœ°è‡ªåï¼Œä½•é¡»åœ¨æ„å¤–ç‰©ï¼Ÿ",
                    "å®¶å›½æ´¾": "è™½é­è´¬è°ªï¼Œç„¶å¿ƒç³»è‹ç”Ÿä¹‹å¿—ä¸å¯æ”¹ã€‚æ­¤ç­‰ç£¨ç ºï¼Œæ­£å¯ç ¥ç ºå›å­å“æ ¼ã€‚",
                    "å„’å®¶æ´¾": "å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿå¾·é¦¨è€…å±…ï¼Œæ–¯å®¤ä¸é™‹ã€‚å½“ä¿®èº«å…»å¾·ï¼Œä»¥å¾·åŒ–äººã€‚",
                    "è±ªæ”¾æ´¾": "åŒºåŒºé™‹å®¤ï¼Œå²‚èƒ½å›°ä½å›å­ä¹‹å¿—ï¼Ÿå¤§ä¸ˆå¤«å½“è±ªè¿ˆå¤„ä¸–ï¼Œä½•æƒ§é£é›¨ï¼"
                };
                
                for (const [style, response] of Object.entries(styleResponses)) {
                    if (personality.interaction_style.includes(style.slice(0, 2))) {
                        return `${personality.name}ï¼š${response}`;
                    }
                }
                
                return `${personality.name}ï¼šåˆ˜å…„ï¼ŒåŒé­ä¸–äº‹æ— å¸¸ï¼Œå½“ä»¥å¹³å¸¸å¿ƒå¯¹å¾…ã€‚æœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿ`;
            }
            
            return `${character}ï¼šåˆ˜å…„ï¼Œæ­¤å¤„è™½ç®€ï¼Œå¿ƒå¢ƒå´å¯æ— é™å®½å¹¿ã€‚`;
        }

        // è·å–å½“å‰ç¯å¢ƒå¯ç”¨çš„è§’è‰²
        function getAvailableCharacters() {
            // è¿™é‡Œå¯ä»¥æ ¹æ®æ¸¸æˆè¿›åº¦å’Œç¯å¢ƒè¿”å›å¯ç”¨è§’è‰²
            return Object.keys(aiPersonalities);
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator(text = "æœ‰äººæ­£åœ¨è¾“å…¥...") {
            typingIndicator.textContent = text;
            typingIndicator.style.opacity = "1";
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            typingIndicator.style.opacity = "0";
        }

        // è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
        function proceedToStage(stageNumber) {
            gameState.currentStage = stageNumber;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = (stageNumber / Object.keys(gameScript).length) * 100;
            progressBar.style.width = progress + '%';
            
            if (gameScript[stageNumber.toString()]) {
                displayMessages(gameScript[stageNumber.toString()].messages);
            } else {
                // æ¸¸æˆç»“æŸ
                endGame();
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯åºåˆ—
        async function displayMessages(messages) {
            gameState.isShowingMessages = true;
            
            for (let i = 0; i < messages.length; i++) {
                if (i > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                await appendMessage(messages[i], true);
            }
            
            gameState.isShowingMessages = false;
            
            // æ˜¾ç¤ºé€‰é¡¹
            const currentStageData = gameScript[gameState.currentStage.toString()];
            if (currentStageData && currentStageData.options) {
                setTimeout(() => {
                    showOptions(currentStageData.options);
                }, 1000);
            }
        }

        // ====== ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œç¾¤èŠèµæç³»ç»Ÿ ======
        
        // ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œçŠ¶æ€
        const poemCreationState = {
            inputLines: [],      // ç©å®¶å·²è¾“å…¥çš„å¥å­
            currentLine: 0,      // å½“å‰è¡Œæ•°
            minRequiredLines: 3, // æœ€å°‘éœ€è¦è¾“å…¥3ä¸ªå¥å­
            isCreating: false,   // æ˜¯å¦æ­£åœ¨åˆ›ä½œçŠ¶æ€
            participantScholars: ["confucius", "du", "libai", "tao", "wangwei", "sushi"] // å‚ä¸èµæçš„å­¦è€…
        };

        // ã€Šé™‹å®¤é“­ã€‹å®Œæ•´åŸæ–‡åº“ï¼ˆç”¨äºéªŒè¯å’Œæç¤ºï¼‰
        const loudShiMingOriginalLines = [
            "å±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™å",
            "æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµ", 
            "æ–¯æ˜¯é™‹å®¤ï¼ŒæƒŸå¾å¾·é¦¨",
            "è‹”ç—•ä¸Šé˜¶ç»¿ï¼Œè‰è‰²å…¥å¸˜é’",
            "è°ˆç¬‘æœ‰é¸¿å„’ï¼Œå¾€æ¥æ— ç™½ä¸",
            "å¯ä»¥è°ƒç´ ç´ï¼Œé˜…é‡‘ç»",
            "æ— ä¸ç«¹ä¹‹ä¹±è€³ï¼Œæ— æ¡ˆç‰ä¹‹åŠ³å½¢",
            "å—é˜³è¯¸è‘›åºï¼Œè¥¿èœ€å­äº‘äº­",
            "å­”å­äº‘ï¼šä½•é™‹ä¹‹æœ‰ï¼Ÿ"
        ];

        // å¤„ç†ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œç¯èŠ‚
        async function handlePoemCreation() {
            console.log('ğŸ¨ å¼€å§‹åˆ›ä½œã€Šé™‹å®¤é“­ã€‹ç¯èŠ‚');
            
            // åˆå§‹åŒ–åˆ›ä½œçŠ¶æ€
            poemCreationState.isCreating = true;
            poemCreationState.inputLines = [];
            poemCreationState.currentLine = 0;
            
            // æ˜¾ç¤ºåˆ›ä½œå¼•å¯¼æ¶ˆæ¯
            const introMessage = {
                type: "system",
                text: `ğŸ“ åˆ›ä½œæ—¶åˆ»åˆ°äº†ï¼è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­é€å¥åˆ›ä½œæ‚¨çš„ã€Šé™‹å®¤é“­ã€‹ã€‚\nğŸ’¡ å†å²åäººå°†ä¸ºæ¯å¥æä¾›å®æ—¶èµæå’Œç‚¹è¯„ã€‚\nâš¡ è‡³å°‘éœ€è¦è¾“å…¥${poemCreationState.minRequiredLines}ä¸ªå¥å­æ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚`
            };
            await appendMessage(introMessage, true);
            
            // æ¿€æ´»è¾“å…¥ç•Œé¢
            setTimeout(() => {
                activatePoemInputInterface();
            }, 1500);
        }

        // æ¿€æ´»ã€Šé™‹å®¤é“­ã€‹è¾“å…¥ç•Œé¢
        function activatePoemInputInterface() {
            // éšè—é€‰é¡¹
            optionsContainer.classList.add('translate-y-full');
            
            // æ¿€æ´»è¾“å…¥æ¡†
            const userInput = document.getElementById('userInput');
            userInput.disabled = false;
            userInput.readOnly = false;
            userInput.className = userInput.className.replace('text-gray-400', 'text-gray-800');
            userInput.placeholder = 'è¯·è¾“å…¥ã€Šé™‹å®¤é“­ã€‹çš„ç¬¬1å¥...';
            userInput.value = '';
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶å¤„ç†å™¨
            const poemInputHandler = async (e) => {
                if (e.key === 'Enter' && userInput.value.trim()) {
                    const inputLine = userInput.value.trim();
                    userInput.value = '';
                    
                    await handlePoemLineInput(inputLine);
                    
                    // æ›´æ–°placeholder
                    if (poemCreationState.isCreating) {
                        userInput.placeholder = 'è¯·è¾“å…¥ã€Šé™‹å®¤é“­ã€‹åŸæ–‡å¥å­';
                    }
                }
            };
            
            userInput.addEventListener('keydown', poemInputHandler);
            userInput.focus();
            
            // å­˜å‚¨å¤„ç†å™¨ä»¥ä¾¿åç»­ç§»é™¤
            userInput.poemInputHandler = poemInputHandler;
            
            // æ˜¾ç¤ºåˆ›ä½œæç¤º
            showPoemCreationHints();
        }

        // æ˜¾ç¤ºåˆ›ä½œæç¤º
        async function showPoemCreationHints() {
            const hintsMessage = {
                type: "system",
                text: `ğŸ’­ æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨ç»å…¸åŸå¥ï¼Œä¹Ÿå¯ä»¥è‡ªç”±åˆ›ä½œã€‚\nğŸ“– ç»å…¸å¼€å¤´ï¼šå±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™å / æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµ\nğŸ¯ ç›®æ ‡ï¼šè‡³å°‘è¾“å…¥${poemCreationState.minRequiredLines}å¥ï¼Œå±•ç°æ‚¨å¯¹"é™‹å®¤"ç²¾ç¥çš„ç†è§£`
            };
            await appendMessage(hintsMessage, true);
        }

        // å¤„ç†ç©å®¶è¾“å…¥çš„ã€Šé™‹å®¤é“­ã€‹å¥å­
        async function handlePoemLineInput(inputLine) {
            console.log(`ğŸ“ ç©å®¶è¾“å…¥ç¬¬${poemCreationState.currentLine + 1}å¥: "${inputLine}"`);
            
            // æ˜¾ç¤ºç©å®¶è¾“å…¥çš„å¥å­
            const playerMessage = {
                type: "liuyuxi",
                text: inputLine,
                isPoemLine: true,
                lineNumber: poemCreationState.currentLine + 1
            };
            await appendMessage(playerMessage, true);
            
            // è®°å½•è¾“å…¥
            poemCreationState.inputLines.push(inputLine);
            poemCreationState.currentLine++;
            
            // ç”Ÿæˆç¾¤èŠèµæå›åº”
            await generatePoemLineAppreciations(inputLine, poemCreationState.currentLine);
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€ä½è¦æ±‚
            if (poemCreationState.currentLine >= poemCreationState.minRequiredLines) {
                setTimeout(() => {
                    showPoemCompletionOptions();
                }, 2000);
            }
        }

        // ç”Ÿæˆè¯—å¥èµæå›åº”
        async function generatePoemLineAppreciations(inputLine, lineNumber) {
            console.log(`ğŸ­ ä¸ºç¬¬${lineNumber}å¥ç”Ÿæˆèµæ`);
            
            // é€‰æ‹©2-3ä¸ªå­¦è€…è¿›è¡Œèµæ
            const selectedScholars = selectAppreciationScholars(inputLine, lineNumber);
            
            console.log(`é€‰æ‹©çš„èµæå­¦è€…:`, selectedScholars.map(id => aiPersonalities[id]?.name));
            
            // ä¾æ¬¡ç”Ÿæˆèµæ
            for (let i = 0; i < selectedScholars.length; i++) {
                const scholarId = selectedScholars[i];
                
                // æ˜¾ç¤ºæ€è€ƒæŒ‡ç¤ºå™¨
                showTypingIndicator(`${aiPersonalities[scholarId].name}æ­£åœ¨èµæ...`);
                
                // ç­‰å¾…é—´éš”
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                hideTypingIndicator();
                
                // ç”Ÿæˆèµæå†…å®¹
                const appreciation = await generateScholarAppreciation(scholarId, inputLine, lineNumber);
                
                if (appreciation) {
                    await appendMessage(appreciation, true);
                }
                
                // å­¦è€…é—´çš„é—´éš”
                if (i < selectedScholars.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // é€‰æ‹©å‚ä¸èµæçš„å­¦è€…
        function selectAppreciationScholars(inputLine, lineNumber) {
            const availableScholars = [...poemCreationState.participantScholars];
            const selectedScholars = [];
            
            // æ ¹æ®å†…å®¹æ™ºèƒ½é€‰æ‹©ç›¸å…³å­¦è€…
            const contentBasedSelection = getContentRelevantScholars(inputLine);
            
            // ä¼˜å…ˆé€‰æ‹©å†…å®¹ç›¸å…³çš„å­¦è€…
            for (const scholarId of contentBasedSelection) {
                if (selectedScholars.length < 2 && availableScholars.includes(scholarId)) {
                    selectedScholars.push(scholarId);
                    availableScholars.splice(availableScholars.indexOf(scholarId), 1);
                }
            }
            
            // å¦‚æœä¸è¶³2ä¸ªï¼Œéšæœºè¡¥å……
            while (selectedScholars.length < 2 && availableScholars.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableScholars.length);
                selectedScholars.push(availableScholars[randomIndex]);
                availableScholars.splice(randomIndex, 1);
            }
            
            // å¶å°”æ·»åŠ ç¬¬ä¸‰ä¸ªå­¦è€… (30%æ¦‚ç‡)
            if (Math.random() < 0.3 && availableScholars.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableScholars.length);
                selectedScholars.push(availableScholars[randomIndex]);
            }
            
            return selectedScholars;
        }

        // æ ¹æ®å†…å®¹è·å–ç›¸å…³å­¦è€…
        function getContentRelevantScholars(inputLine) {
            const contentMapping = {
                // å¾·è¡Œå“æ ¼ç›¸å…³
                "å¾·": ["confucius", "yanhuei", "zengzi"],
                "å›å­": ["confucius", "yanhuei", "zengzi"],
                "ä»": ["confucius", "yanhuei"],
                
                // è‡ªç„¶å±±æ°´ç›¸å…³
                "å±±": ["tao", "wangwei", "libai"],
                "æ°´": ["tao", "wangwei", "du"],
                "è‹”": ["tao", "wangwei"],
                "è‰": ["tao", "wangwei"],
                "ç»¿": ["tao", "wangwei"],
                
                // å­¦é—®æ–‡åŒ–ç›¸å…³
                "é¸¿å„’": ["confucius", "du", "yangxiong"],
                "ç™½ä¸": ["confucius", "du"],
                "é‡‘ç»": ["confucius", "zengzi", "yangxiong"],
                "ç´ ç´": ["confucius", "wangwei"],
                
                // æ¸…é›…ç”Ÿæ´»ç›¸å…³
                "ç´": ["confucius", "wangwei", "tao"],
                "ç»": ["confucius", "zengzi", "yangxiong"],
                "ä¸ç«¹": ["confucius", "wangwei"],
                "æ¡ˆç‰": ["du", "baijuyi"],
                
                // å†å²å…¸æ•…ç›¸å…³
                "è¯¸è‘›": ["zhugeliang", "du"],
                "å­äº‘": ["yangxiong", "confucius"],
                "å­”å­": ["confucius", "yanhuei", "zengzi"]
            };
            
            const relevantScholars = [];
            
            // æ£€æŸ¥æ¯ä¸ªå…³é”®è¯
            for (const [keyword, scholars] of Object.entries(contentMapping)) {
                if (inputLine.includes(keyword)) {
                    relevantScholars.push(...scholars);
                }
            }
            
            // å»é‡å¹¶è¿”å›
            return [...new Set(relevantScholars)];
        }

        // ç”Ÿæˆå­¦è€…èµæå†…å®¹
        async function generateScholarAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            if (!personality) return null;
            
            try {
                let appreciationText;
                
                // ä¼˜å…ˆå°è¯•AIç”Ÿæˆ (å¦‚æœå¯ç”¨)
                if (AI_FEATURES.enabled && dialogueControls.canMakeAICall(scholarId, "poem_creation")) {
                    appreciationText = await generateAIAppreciation(scholarId, inputLine, lineNumber);
                } else {
                    // ä½¿ç”¨é¢„åˆ¶èµæ
                    appreciationText = generatePresetAppreciation(scholarId, inputLine, lineNumber);
                }
                
                return {
                    type: scholarId,
                    text: appreciationText,
                    isPoemAppreciation: true,
                    lineNumber: lineNumber,
                    isAIGenerated: AI_FEATURES.enabled && dialogueControls.canMakeAICall(scholarId, "poem_creation")
                };
                
            } catch (error) {
                console.error(`ç”Ÿæˆ${personality.name}çš„èµæå¤±è´¥:`, error);
                
                // é™çº§å¤„ç†
                return {
                    type: scholarId,
                    text: `${personality.name}ï¼šæ­¤å¥é¢‡æœ‰æ„å¢ƒï¼Œæ·±å¾—æˆ‘å¿ƒã€‚`,
                    isPoemAppreciation: true,
                    lineNumber: lineNumber
                };
            }
        }

        // AIç”Ÿæˆèµæå†…å®¹
        async function generateAIAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            
            const prompt = `ä½ æ˜¯${personality.name}ï¼ˆ${personality.period}ï¼‰ï¼Œ${personality.background}ã€‚

åˆ˜ç¦¹é”¡åˆšåˆšåˆ›ä½œäº†ã€Šé™‹å®¤é“­ã€‹çš„ç¬¬${lineNumber}å¥ï¼š
"${inputLine}"

è¯·ä»ä½ çš„ä¸“ä¸šè§’åº¦å¯¹è¿™å¥è¯—è¿›è¡Œèµæç‚¹è¯„ã€‚

ä½ çš„æ–‡å­¦ç‰¹è‰²ï¼š${personality.language_style}
ä½ çš„æ ¸å¿ƒç†å¿µï¼š${personality.key_concepts.join('ã€')}
ä½ çš„ç»å…¸åå¥ï¼š${personality.classic_quotes.join('ï¼›')}

èµæè¦æ±‚ï¼š
1. ä½“ç°ä½ çš„æ–‡å­¦ä¸“ä¸šæ€§å’Œå†å²èº«ä»½
2. ä»ä¿®è¾æ‰‹æ³•ã€æ„å¢ƒè¥é€ ã€æ€æƒ³å†…æ¶µç­‰è§’åº¦ç‚¹è¯„
3. å¯ä»¥è”ç³»ä½ çš„äººç”Ÿç»å†å’Œæ–‡å­¦ä¸»å¼ 
4. è¯­è¨€è¦ç¬¦åˆä½ çš„æ—¶ä»£ç‰¹è‰²å’Œä¸ªäººé£æ ¼
5. å­—æ•°æ§åˆ¶åœ¨80-120å­—
6. è¯­è°ƒè¦ä¸“ä¸šè€Œä¸å¤±äº²åˆ‡

è¯·ç›´æ¥ä»¥${personality.name}çš„èº«ä»½è¿›è¡Œèµæï¼Œä¸è¦åŠ å¼•å·ï¼š`;

            const response = await callPoeAI(prompt, { 
                temperature: 0.7,
                maxTokens: 200
            });
            
            dialogueControls.recordAICall(scholarId, "poem_creation");
            return response;
        }

        // ç”Ÿæˆé¢„åˆ¶èµæå†…å®¹
        function generatePresetAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            
            // é’ˆå¯¹ä¸åŒå­¦è€…çš„èµæé£æ ¼æ¨¡æ¿
            const appreciationStyles = {
                "confucius": {
                    approach: "é“å¾·ä¿®å…»",
                    keywords: ["å¾·", "å›å­", "ä»", "ç¤¼"],
                    templates: [
                        `æ­¤å¥æ·±å¾—'å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»'ä¹‹ç†ã€‚`,
                        `å›å­ä¹‹å¾·å¦‚é£ï¼Œè‰å¿…åƒã€‚æ­¤å¥æ­£ä½“ç°å¾·åŒ–ä¹‹åŠŸã€‚`,
                        `'æ–‡è´¨å½¬å½¬ï¼Œç„¶åå›å­'ï¼Œæ­¤å¥æ–‡é‡‡ä¸å†…æ¶µå¹¶é‡ã€‚`
                    ]
                },
                "du": {
                    approach: "ç¤¾ä¼šå…³æ€€",
                    keywords: ["æ°‘", "å›½", "ç¤¾ç¨·", "è´£ä»»"],
                    templates: [
                        `æ­¤å¥è®©æˆ‘æƒ³èµ·'æœ±é—¨é…’è‚‰è‡­ï¼Œè·¯æœ‰å†»æ­»éª¨'ï¼Œå¯¹æ¯”é²œæ˜ï¼Œå‘äººæ·±çœã€‚`,
                        `åˆ˜å…„æ­¤å¥ï¼Œæ·±å¾—è¯—æ­Œ'ç¾åˆº'ä¹‹é“ï¼Œè¨€ç®€è€Œæ„æ·±ã€‚`,
                        `'ä½å‘æœªæ•¢å¿˜å¿§å›½'ï¼Œæ­¤å¥è™½å†™ä¸ªäººå¢ƒé‡ï¼Œå®å«å¿§å›½ä¹‹æƒ…ã€‚`
                    ]
                },
                "libai": {
                    approach: "è±ªè¿ˆæƒ³è±¡",
                    keywords: ["ä»™", "é«˜", "å", "çµ"],
                    templates: [
                        `å“ˆå“ˆï¼æ­¤å¥æ°”åŠ¿å¦‚è™¹ï¼Œé¢‡æœ‰'é»„æ²³ä¹‹æ°´å¤©ä¸Šæ¥'çš„è±ªè¿ˆï¼`,
                        `å¦™å“‰ï¼æ­¤å¥ç”¨å…¸å·§å¦™ï¼Œæ„å¢ƒé«˜è¿œï¼Œæœ‰è¶…å‡¡è„±ä¿—ä¹‹æ„Ÿã€‚`,
                        `åˆ˜å…„æ­¤å¥ï¼Œå¦‚'é£æµç›´ä¸‹ä¸‰åƒå°º'ï¼Œæ°”è±¡ä¸‡åƒï¼`
                    ]
                },
                "tao": {
                    approach: "è‡ªç„¶æƒ…è¶£",
                    keywords: ["è‡ªç„¶", "è‹”", "è‰", "ç»¿", "è‰²"],
                    templates: [
                        `æ­¤å¥å†™æ™¯çœŸåˆ‡ï¼Œå¦‚æˆ‘'é‡‡èŠä¸œç¯±ä¸‹'èˆ¬è‡ªç„¶çº¯çœŸã€‚`,
                        `è‹”ç—•è‰è‰²ï¼Œç”Ÿæœºç›ç„¶ã€‚çœŸæ­£çš„'å¿ƒè¿œåœ°è‡ªå'å•Šï¼`,
                        `æ­¤å¥æœ´å®è‡ªç„¶ï¼Œè¿œèƒœé›•ç¢åç¾ã€‚å½’çœŸè¿”æœ´ï¼Œæ­¤ä¹‹è°“ä¹Ÿã€‚`
                    ]
                },
                "wangwei": {
                    approach: "æ„å¢ƒç¦…ç†",
                    keywords: ["è‰²", "å¢ƒ", "é™", "ç¦…"],
                    templates: [
                        `æ­¤å¥è¯—ä¸­æœ‰ç”»ï¼Œç”»ä¸­æœ‰ç¦…ã€‚'é’é’æ²³ç•”è‰'çš„æ„å¢ƒè·ƒç„¶çº¸ä¸Šã€‚`,
                        `è‰²å½©è¿ç”¨ç²¾å¦™ï¼Œç»¿æ„ç›ç„¶ä¸­è§ç¦…æœºã€‚å¢ƒç”±å¿ƒè½¬ï¼Œå¿ƒå¢ƒè‡ªæ¸…ã€‚`,
                        `'ç©ºå±±æ–°é›¨å'ï¼Œæ­¤å¥äº¦æœ‰å¤©ç„¶å»é›•é¥°ä¹‹ç¾ã€‚`
                    ]
                },
                "sushi": {
                    approach: "æ—·è¾¾å“²ç†",
                    keywords: ["æ—·è¾¾", "å“²ç†", "äººç”Ÿ"],
                    templates: [
                        `æ­¤å¥é¢‡æœ‰å“²ç†ï¼'äººç”Ÿå¦‚é€†æ—…'ï¼Œå±…æ‰€ä½•å¦¨ç®€é™‹ï¼Ÿ`,
                        `å¦™ä¸å¯è¨€ï¼æ­¤å¥è®©æˆ‘æƒ³èµ·'å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œä¹Ÿæ— é£é›¨ä¹Ÿæ— æ™´'ã€‚`,
                        `åˆ˜å…„æ­¤å¥ï¼Œæ·±å¾—è‹¦ä¸­ä½œä¹ä¹‹é“ï¼Œä»¤ä¸œå¡ä½©æœï¼`
                    ]
                }
            };
            
            const style = appreciationStyles[scholarId];
            if (!style) {
                return `${personality.name}ï¼šæ­¤å¥ç”šå¥½ï¼Œé¢‡æœ‰æ·±æ„ã€‚`;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³å…³é”®è¯
            const hasRelevantKeyword = style.keywords.some(keyword => inputLine.includes(keyword));
            
            if (hasRelevantKeyword) {
                // ç”Ÿæˆé’ˆå¯¹æ€§èµæ
                return `${personality.name}ï¼š${generateSpecificAppreciation(scholarId, inputLine, style)}`;
            } else {
                // ä½¿ç”¨é€šç”¨æ¨¡æ¿
                const randomTemplate = style.templates[Math.floor(Math.random() * style.templates.length)];
                return `${personality.name}ï¼š${randomTemplate}`;
            }
        }

        // ç”Ÿæˆå…·ä½“çš„é’ˆå¯¹æ€§èµæ
        function generateSpecificAppreciation(scholarId, inputLine, style) {
            const specificAppreciations = {
                "confucius": {
                    "å¾·": `'å¾·é¦¨'äºŒå­—ï¼Œæ­£æ˜¯å›å­ç«‹èº«ä¹‹æœ¬ã€‚æ­¤å¥å¾—åœ£äºº'å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»'ä¹‹çœŸä¼ ã€‚`,
                    "å›å­": `å›å­ä¹‹å±…ï¼Œä¸åœ¨åç¾ï¼Œåœ¨äºå¾·è¡Œã€‚æ­¤å¥æ·±å¾—å„’å®¶ä¿®èº«ä¹‹è¦ã€‚`,
                    "é¸¿å„’": `'è°ˆç¬‘æœ‰é¸¿å„’'ï¼Œæ­¤ä¹ƒ'å¾·è€…å¾—æœ‹'ä¹‹å†™ç…§ã€‚å­¦è€Œæ—¶ä¹ ï¼Œä¸äº¦ä¹ä¹ï¼Ÿ`
                },
                "du": {
                    "ç™½ä¸": `'å¾€æ¥æ— ç™½ä¸'ä¸æˆ‘'æœ±é—¨é…’è‚‰è‡­'å½¢æˆå¯¹æ¯”ï¼Œä½†æ­¤å¤„é‡åœ¨å¾·åŒ–ï¼Œéè´«å¯Œä¹‹åˆ†ã€‚`,
                    "æ¡ˆç‰": `'æ— æ¡ˆç‰ä¹‹åŠ³å½¢'ï¼åˆ˜å…„æ·±çŸ¥æˆ‘'æ–‡ç« æ†å‘½è¾¾'ä¹‹è‹¦ï¼Œå®˜åœºåŠ³å½¢ï¼Œä¸å¦‚å¾·é¦¨ä¹‹ä¹ä¹Ÿã€‚`
                },
                "libai": {
                    "ä»™": `'æœ‰ä»™åˆ™å'ï¼æ­¤å¥å¢ƒç•Œé«˜è¿œï¼Œå¦‚æˆ‘'ä¸¾å¤´æœ›æ˜æœˆ'èˆ¬è¶…è„±å‡¡ä¿—ï¼`,
                    "é«˜": `å±±ä¹‹é«˜ä¸åœ¨å½¢ï¼Œåœ¨äºç¥éŸµã€‚æ­¤å¥å¦‚æˆ‘'èœ€é“ä¹‹éš¾ï¼Œéš¾äºä¸Šé’å¤©'ï¼Œæ°”è±¡ä¸‡åƒï¼`
                },
                "tao": {
                    "è‹”": `è‹”ç—•è‡ªç»¿ï¼Œè‰è‰²è‡ªé’ï¼Œå¤©ç„¶æ— é›•é¥°ã€‚æ­¤æ­£'é‡‡èŠä¸œç¯±ä¸‹'ä¹‹çœŸè¶£ï¼`,
                    "ç»¿": `ä¸€'ç»¿'å­—ç”¨å¾—å¦™æï¼ç”Ÿæœºç›ç„¶ï¼Œå¦‚æ˜¥é£åŒ–é›¨ï¼Œæ¶¦ç‰©æ— å£°ã€‚`
                },
                "wangwei": {
                    "ç»¿": `'ç»¿'å­—ä¼ ç¥ï¼æ­¤å¥è‰²å½©æ˜ä¸½ï¼Œå¦‚æˆ‘'å±±è‰²æœ‰æ— ä¸­'ï¼Œè¯—ä¸­æœ‰ç”»æ„ã€‚`,
                    "é’": `é’é’ä¹‹è‰²ï¼Œé™è°§é›…è‡´ã€‚'æ˜æœˆæ¾é—´ç…§ï¼Œæ¸…æ³‰çŸ³ä¸Šæµ'çš„æ„å¢ƒè·ƒç„¶çº¸ä¸Šã€‚`
                },
                "sushi": {
                    "ç´ ç´": `'è°ƒç´ ç´'ä¸‰å­—é›…è‡´ï¼éŸ³ä¹æ€¡æƒ…ï¼Œæ­£å¦‚æˆ‘'ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿ'ä¹‹å¿ƒå¢ƒã€‚`,
                    "é‡‘ç»": `'é˜…é‡‘ç»'ï¼Œè¯»ä¹¦æ€¡æ€§ã€‚'å‘æ„¤å¿˜é£Ÿï¼Œä¹ä»¥å¿˜å¿§'ï¼Œä¹¦ä¸­è‡ªæœ‰é¢œå¦‚ç‰å•Šï¼`
                }
            };
            
            const charAppreciations = specificAppreciations[scholarId];
            if (!charAppreciations) return style.templates[0];
            
            // æŸ¥æ‰¾åŒ¹é…çš„å…³é”®è¯
            for (const [keyword, appreciation] of Object.entries(charAppreciations)) {
                if (inputLine.includes(keyword)) {
                    return appreciation;
                }
            }
            
            return style.templates[0];
        }

        // æ˜¾ç¤ºåˆ›ä½œå®Œæˆé€‰é¡¹
        function showPoemCompletionOptions() {
            // æ¿€æ´»é€‰é¡¹å®¹å™¨
            optionsList.innerHTML = '';
            
            // ç»§ç»­åˆ›ä½œé€‰é¡¹
            const continueOption = document.createElement('button');
            continueOption.className = 'w-full p-3 text-left bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200 border border-blue-200';
            continueOption.innerHTML = `<div class="font-medium">âœï¸ ç»§ç»­åˆ›ä½œ</div><div class="text-sm text-gray-600 mt-1">å†æ·»å‡ å¥ï¼Œè®©ä½œå“æ›´åŠ å®Œæ•´</div>`;
            continueOption.addEventListener('click', () => {
                optionsContainer.classList.add('translate-y-full');
                document.getElementById('userInput').focus();
            });
            
            // å®Œæˆåˆ›ä½œé€‰é¡¹
            const finishOption = document.createElement('button');
            finishOption.className = 'w-full p-3 text-left bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200 border border-green-200';
            finishOption.innerHTML = `<div class="font-medium">âœ… å®Œæˆåˆ›ä½œ</div><div class="text-sm text-gray-600 mt-1">å·²è¾“å…¥${poemCreationState.currentLine}å¥ï¼Œå¯ä»¥ç»“æŸåˆ›ä½œäº†</div>`;
            finishOption.addEventListener('click', () => {
                finishPoemCreation();
            });
            
            optionsList.appendChild(continueOption);
            optionsList.appendChild(finishOption);
            
            // æ˜¾ç¤ºé€‰é¡¹
            optionsContainer.classList.remove('translate-y-full');
        }

        // å®Œæˆã€Šé™‹å®¤é“­ã€‹åˆ›ä½œ
        async function finishPoemCreation() {
            console.log('ğŸ‰ å®Œæˆã€Šé™‹å®¤é“­ã€‹åˆ›ä½œ');
            
            // éšè—é€‰é¡¹
            optionsContainer.classList.add('translate-y-full');
            
            // ç¦ç”¨è¾“å…¥æ¡†
            const userInput = document.getElementById('userInput');
            userInput.disabled = true;
            userInput.readOnly = true;
            userInput.className = userInput.className.replace('text-gray-800', 'text-gray-400');
            userInput.placeholder = 'ç‚¹å‡»æ­¤å¤„ç»§ç»­...';
            userInput.value = '';
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            if (userInput.poemInputHandler) {
                userInput.removeEventListener('keydown', userInput.poemInputHandler);
                delete userInput.poemInputHandler;
            }
            
            // ç»“æŸåˆ›ä½œçŠ¶æ€
            poemCreationState.isCreating = false;
            
            // æ˜¾ç¤ºåˆ›ä½œæ€»ç»“ï¼ˆä¿®æ”¹ç‰ˆï¼‰
            await showPoemCreationSummary();
            
            // ç»§ç»­æ¸¸æˆæµç¨‹
            setTimeout(() => {
                proceedToStage(gameState.currentStage + 1);
            }, 3000);
        }

        // æ˜¾ç¤ºåˆ›ä½œæ€»ç»“
        async function showPoemCreationSummary() {
            const summaryMessage = {
                type: "system",
                text: `ğŸŠ ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œå®Œæˆï¼\n\nğŸ“Š åˆ›ä½œç»Ÿè®¡ï¼š\nâ€¢ å…±åˆ›ä½œ ${poemCreationState.currentLine} å¥\nâ€¢ è·å¾— ${poemCreationState.participantScholars.length} ä½æ–‡è±ªèµæ\nâ€¢ å±•ç°äº†æ‚¨å¯¹"æƒŸå¾å¾·é¦¨"ç²¾ç¥çš„ç‹¬ç‰¹ç†è§£`
            };
            await appendMessage(summaryMessage, true);
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const congratsMessage = {
                type: "system", 
                text: `ğŸŒŸ æ­å–œï¼æ‚¨å·²ç»ä½“éªŒäº†ä¸å†å²æ–‡è±ªä»¬ä¸€èµ·å“è¯„ã€Šé™‹å®¤é“­ã€‹çš„ä¹è¶£ã€‚\nğŸ’­ æ¯ä¸€å¥éƒ½æ‰¿è½½ç€æ·±åšçš„æ–‡åŒ–å†…æ¶µï¼Œæ¯ä¸€æ¬¡èµæéƒ½æ˜¯æ€æƒ³çš„ç¢°æ’ã€‚`
            };
            await appendMessage(congratsMessage, true);
        }

        // ====== æœ‹å‹åœˆç”Ÿæˆç³»ç»Ÿ ======
        
        // æ™ºèƒ½ä¸ªæ€§åˆ†æå¼•æ“
        const personalityAnalyzer = {
            analyzePlayerProfile: function() {
                console.log('ğŸ§  å¼€å§‹æ·±åº¦ä¸ªæ€§åˆ†æ...');
                
                const analysis = {
                    personalityType: "æ¢ç´¢å‹æ–‡äºº",
                    dominantTheme: "å¹³è¡¡æ™ºæ…§",
                    mainValues: [],
                    modernConcerns: [],
                    socialMediaStyle: "ç†æ€§æ€è¾¨å‹",
                    gameExperience: this.summarizeGameExperience(),
                    characterInteractions: this.analyzeCharacterInteractions(),
                    creativeContent: this.analyzeCreativeContent(),
                    questioningStyle: this.analyzeQuestioningStyle()
                };
                
                // ç»¼åˆåˆ†æç¡®å®šä¸»å¯¼ä¸»é¢˜
                analysis.dominantTheme = this.determineDominantTheme();
                
                // ç”Ÿæˆä¸ªæ€§åŒ–çš„æœ‹å‹åœˆä¸»é¢˜
                analysis.momentsTheme = this.generateMomentsTheme(analysis.dominantTheme);
                
                // ç”Ÿæˆç°ä»£æ€è¾¨è¯é¢˜
                analysis.modernDebateTopics = this.generateModernDebateTopics(analysis.dominantTheme);
                
                console.log('âœ… ä¸ªæ€§åˆ†æå®Œæˆ:', analysis);
                return analysis;
            },
            
            // åˆ†æè§’è‰²äº’åŠ¨åå¥½
            analyzeCharacterInteractions: function() {
                const mentionedChars = gameState.mentionedCharacters || [];
                const interactions = {
                    preferredTypes: [],
                    focusAreas: []
                };
                
                // åˆ†æåå¥½çš„è§’è‰²ç±»å‹
                mentionedChars.forEach(charId => {
                    const personality = aiPersonalities[charId];
                    if (personality) {
                        if (personality.key_concepts.includes("è‡ªç„¶") || personality.key_concepts.includes("éšé€¸")) {
                            interactions.preferredTypes.push("ç²¾ç¥è¿½æ±‚");
                        }
                        if (personality.key_concepts.includes("å¿§å›½") || personality.key_concepts.includes("ç¤¾ç¨·")) {
                            interactions.preferredTypes.push("ç¤¾ä¼šå…³æ€€");
                        }
                        if (personality.key_concepts.includes("å¾·") || personality.key_concepts.includes("å›å­")) {
                            interactions.preferredTypes.push("é“å¾·ä¿®å…»");
                        }
                    }
                });
                
                return interactions;
            },
            
            // åˆ†æåˆ›ä½œå†…å®¹ç‰¹ç‚¹
            analyzeCreativeContent: function() {
                const inputLines = poemCreationState.inputLines || [];
                const analysis = {
                    themes: [],
                    style: "ä¼ ç»Ÿ",
                    focusKeywords: []
                };
                
                const allText = inputLines.join('');
                
                // åˆ†æä¸»é¢˜å…³é”®è¯
                if (allText.includes("å¾·") || allText.includes("é¦¨")) analysis.themes.push("å“å¾·ä¿®å…»");
                if (allText.includes("å±±") || allText.includes("æ°´") || allText.includes("è‡ªç„¶")) analysis.themes.push("è‡ªç„¶æƒ…æ€€");
                if (allText.includes("å­¦") || allText.includes("ä¹¦") || allText.includes("ç»")) analysis.themes.push("å­¦ä¹ æ²»å­¦");
                if (allText.includes("å±…") || allText.includes("å®¤") || allText.includes("é™‹")) analysis.themes.push("ç”Ÿæ´»å“²å­¦");
                
                return analysis;
            },
            
            // åˆ†ææé—®é£æ ¼ï¼ˆTODO: åœ¨æé—®ç³»ç»Ÿå®Œå–„åå®ç°ï¼‰
            analyzeQuestioningStyle: function() {
                return {
                    depth: "ä¸­ç­‰",
                    concerns: ["äººç”Ÿå“²ç†", "ç°å®ç”Ÿæ´»"],
                    type: "æ¢ç´¢å‹"
                };
            },
            
            // ç¡®å®šä¸»å¯¼ä¸»é¢˜
            determineDominantTheme: function() {
                const stylePoints = gameState.stylePoints;
                const mentionedChars = gameState.mentionedCharacters || [];
                const inputLines = poemCreationState.inputLines || [];
                
                let scores = {
                    "ç‰©è´¨ä¸ç²¾ç¥": 0,
                    "æŒ«æŠ˜ä¸æˆé•¿": 0,
                    "ç‹¬å¤„ä¸ç¤¾äº¤": 0,
                    "ç†æƒ³ä¸ç°å®": 0,
                    "ä¼ ç»Ÿä¸ç°ä»£": 0,
                    "å†…å·ä¸èººå¹³": 0
                };
                
                // æ ¹æ®æ¸¸æˆé€‰æ‹©å€¾å‘è¯„åˆ†
                scores["ç‰©è´¨ä¸ç²¾ç¥"] += (stylePoints.tao || 0) * 15;
                scores["æŒ«æŠ˜ä¸æˆé•¿"] += (stylePoints.du || 0) * 15;
                scores["ç†æƒ³ä¸ç°å®"] += (stylePoints.balanced || 0) * 10;
                scores["ä¼ ç»Ÿä¸ç°ä»£"] += (stylePoints.ru || 0) * 15;
                
                // æ ¹æ®@çš„è§’è‰²è¯„åˆ†
                mentionedChars.forEach(charId => {
                    if (charId === "tao") scores["ç‰©è´¨ä¸ç²¾ç¥"] += 20;
                    if (charId === "du" || charId === "baijuyi") scores["æŒ«æŠ˜ä¸æˆé•¿"] += 20;
                    if (charId === "wangwei") scores["ç‹¬å¤„ä¸ç¤¾äº¤"] += 20;
                    if (charId === "confucius") scores["ä¼ ç»Ÿä¸ç°ä»£"] += 20;
                    if (charId === "sushi") scores["ç†æƒ³ä¸ç°å®"] += 20;
                });
                
                // æ ¹æ®åˆ›ä½œå†…å®¹è¯„åˆ†
                const allText = inputLines.join('');
                if (allText.includes("å¾·") || allText.includes("å“æ ¼")) scores["ä¼ ç»Ÿä¸ç°ä»£"] += 10;
                if (allText.includes("ç®€") || allText.includes("æœ´") || allText.includes("é™‹")) scores["ç‰©è´¨ä¸ç²¾ç¥"] += 10;
                if (allText.includes("å¿—") || allText.includes("ç†æƒ³")) scores["ç†æƒ³ä¸ç°å®"] += 10;
                
                // æ·»åŠ éšæœºå› å­ï¼Œå¢åŠ å˜åŒ–æ€§
                Object.keys(scores).forEach(key => {
                    scores[key] += Math.random() * 5;
                });
                
                // æ‰¾å‡ºæœ€é«˜åˆ†çš„ä¸»é¢˜
                const dominantTheme = Object.keys(scores).reduce((a, b) => 
                    scores[a] > scores[b] ? a : b
                );
                
                console.log('ä¸»é¢˜åˆ†æå¾—åˆ†:', scores);
                console.log('ä¸»å¯¼ä¸»é¢˜:', dominantTheme);
                
                return dominantTheme;
            },
            
            // ç”Ÿæˆæœ‹å‹åœˆä¸»é¢˜
            generateMomentsTheme: function(dominantTheme) {
                const themeTemplates = {
                    "ç‰©è´¨ä¸ç²¾ç¥": {
                        title: "ç°ä»£ç‰ˆ'é™‹å®¤'æ€è€ƒï¼šæˆ¿ä»·æ—¶ä»£çš„ç²¾ç¥å¯Œè¶³",
                        keywords: ["æˆ¿ä»·", "ç‰©è´¨", "ç²¾ç¥", "å†…å¿ƒå¯Œè¶³", "ç®€æœ´ç”Ÿæ´»"]
                    },
                    "æŒ«æŠ˜ä¸æˆé•¿": {
                        title: "äººç”Ÿä½è°·æ—¶çš„å¤ä»£æ™ºæ…§ï¼šå¦‚ä½•åœ¨é€†å¢ƒä¸­ä¿®ç‚¼å¿ƒå¢ƒ",
                        keywords: ["æŒ«æŠ˜", "æˆé•¿", "é€†å¢ƒ", "åšéŸ§", "äººç”Ÿæ„Ÿæ‚Ÿ"]
                    },
                    "ç‹¬å¤„ä¸ç¤¾äº¤": {
                        title: "ä¸€ä¸ªäººçš„ç²¾ç¥ä¸–ç•Œï¼šç°ä»£ç¤¾äº¤vså†…å¿ƒå®é™",
                        keywords: ["ç‹¬å¤„", "ç¤¾äº¤", "å†…å¿ƒ", "å®é™", "è‡ªæˆ‘å¯¹è¯"]
                    },
                    "ç†æƒ³ä¸ç°å®": {
                        title: "è¯—ä¸è¿œæ–¹çš„å¹³è¡¡æœ¯ï¼šåœ¨ç°å®ç”Ÿæ´»ä¸­ä¿æŒç†æƒ³ä¸»ä¹‰",
                        keywords: ["ç†æƒ³", "ç°å®", "å¹³è¡¡", "è¯—æ„", "ç”Ÿæ´»å“²å­¦"]
                    },
                    "ä¼ ç»Ÿä¸ç°ä»£": {
                        title: "å¤å…¸æ–‡åŒ–çš„ç°ä»£æ„ä¹‰ï¼šä¼ ç»Ÿæ™ºæ…§å¦‚ä½•æŒ‡å¯¼å½“ä»£ç”Ÿæ´»",
                        keywords: ["ä¼ ç»Ÿ", "ç°ä»£", "æ–‡åŒ–", "æ™ºæ…§", "ä¼ æ‰¿"]
                    },
                    "å†…å·ä¸èººå¹³": {
                        title: "å¤äººçš„'ä¸­åº¸ä¹‹é“'ï¼šæ—¢ä¸å†…å·ä¹Ÿä¸èººå¹³çš„ç”Ÿæ´»æ™ºæ…§",
                        keywords: ["å†…å·", "èººå¹³", "ä¸­åº¸", "å¹³è¡¡", "ç”Ÿæ´»æ€åº¦"]
                    }
                };
                
                return themeTemplates[dominantTheme] || themeTemplates["ç†æƒ³ä¸ç°å®"];
            },
            
            // ç”Ÿæˆç°ä»£æ€è¾¨è¯é¢˜
            generateModernDebateTopics: function(dominantTheme) {
                const debateTopics = {
                    "ç‰©è´¨ä¸ç²¾ç¥": {
                        title: "ğŸ’° å¦‚æœåˆ˜ç¦¹é”¡ç”Ÿæ´»åœ¨2024å¹´",
                        questions: [
                            "æœˆè–ª3ä¸‡ä½†è¦è¿˜30å¹´æˆ¿è´· vs æœˆè–ª8åƒä½†å†…å¿ƒå……å®ï¼Œä½ é€‰å“ªä¸ªï¼Ÿ",
                            "æ˜¯å…ˆè§£å†³ç‰©è´¨åŸºç¡€å†è¿½æ±‚ç²¾ç¥ç”Ÿæ´»ï¼Œè¿˜æ˜¯ç²¾ç¥å¯Œè¶³æ›´é‡è¦ï¼Ÿ",
                            "ç°ä»£'é™‹å®¤'ï¼ˆå°æˆ·å‹ã€åˆç§Ÿæˆ¿ï¼‰èƒ½å¦ä¹Ÿæœ‰'å¾·é¦¨'ä¹‹ç¾ï¼Ÿ",
                            "æ¶ˆè´¹ä¸»ä¹‰æ—¶ä»£ï¼Œå¦‚ä½•å®šä¹‰çœŸæ­£çš„'å¯Œè¶³'ï¼Ÿ"
                        ]
                    },
                    "æŒ«æŠ˜ä¸æˆé•¿": {
                        title: "ğŸ’ª ç°ä»£ç‰ˆ'è´¬è°ª'ç»å†",
                        questions: [
                            "è¢«è£å‘˜ã€è€ƒç ”å¤±è´¥ã€åˆ›ä¸šå¤±è´¥...ç°ä»£äººå¦‚ä½•é¢å¯¹äººç”Ÿä½è°·ï¼Ÿ",
                            "æ˜¯é€ƒé¿ç°å®è¿˜æ˜¯æ­£é¢ç¡¬åˆšï¼Ÿå¤äººçš„'æ—¢æ¥ä¹‹åˆ™å®‰ä¹‹'è¿˜é€‚ç”¨å—ï¼Ÿ",
                            "ç¤¾äº¤åª’ä½“æ—¶ä»£çš„æŒ«æŠ˜æ˜¯å¦æ›´éš¾æ‰¿å—ï¼Ÿï¼ˆå› ä¸ºè¦é¢å¯¹ä»–äººçš„æˆåŠŸå±•ç¤ºï¼‰",
                            "ä»€ä¹ˆæ ·çš„æŒ«æŠ˜ç»å†èƒ½è®©äººçœŸæ­£æˆé•¿ï¼Ÿ"
                        ]
                    },
                    "ç‹¬å¤„ä¸ç¤¾äº¤": {
                        title: "ğŸ§˜ ä¸€ä¸ªäººçš„ä¸–ç•Œ vs ç¤¾äº¤ç½‘ç»œ",
                        questions: [
                            "äº«å—ç‹¬å¤„ vs å®³æ€•å­¤ç‹¬ï¼Œç°ä»£äººä¸ºä½•éš¾ä»¥å®‰é™å¾…ç€ï¼Ÿ",
                            "å¤äººçš„'å¿ƒè¿œåœ°è‡ªå'åœ¨æ‰‹æœºä¸ç¦»æ‰‹çš„æ—¶ä»£å¦‚ä½•å®ç°ï¼Ÿ",
                            "çº¿ä¸Šç¤¾äº¤èƒ½å¦æ›¿ä»£é¢å¯¹é¢çš„æ·±åº¦äº¤æµï¼Ÿ",
                            "ä»€ä¹ˆæ ·çš„ç‹¬å¤„æ‰æ˜¯æœ‰æ„ä¹‰çš„ï¼Ÿï¼ˆè€Œä¸æ˜¯æ— èŠåˆ·æ‰‹æœºï¼‰"
                        ]
                    },
                    "ç†æƒ³ä¸ç°å®": {
                        title: "âœ¨ è¯—ä¸è¿œæ–¹ vs çœ¼å‰çš„è‹Ÿä¸”",
                        questions: [
                            "æ¯•ä¸šåæ˜¯é€‰æ‹©ç¨³å®šå·¥ä½œè¿˜æ˜¯è¿½æ±‚æ¢¦æƒ³ï¼Ÿè¿™ä¸ªé€‰æ‹©æœ‰æ ‡å‡†ç­”æ¡ˆå—ï¼Ÿ",
                            "ç†æƒ³ä¸»ä¹‰åœ¨ç°å®é¢å‰æ˜¯å¦æ³¨å®šè¦å¦¥åï¼Ÿ",
                            "å¦‚ä½•åœ¨æ—¥å¸¸çç¢ä¸­ä¿æŒå¯¹ç”Ÿæ´»çš„è¯—æ„æƒ³è±¡ï¼Ÿ",
                            "ä»€ä¹ˆå¹´é¾„æ®µæœ€é€‚åˆ'ç†æƒ³ä¸»ä¹‰'ï¼Ÿä»€ä¹ˆæ—¶å€™è¯¥'ç°å®ä¸€ç‚¹'ï¼Ÿ"
                        ]
                    },
                    "ä¼ ç»Ÿä¸ç°ä»£": {
                        title: "ğŸ“š å¤å…¸æ™ºæ…§ vs ç°ä»£ç”Ÿæ´»",
                        questions: [
                            "å¤äººçš„ç”Ÿæ´»èŠ‚å¥ vs ç°ä»£å¿«èŠ‚å¥ï¼Œå“ªç§æ›´æœ‰åˆ©äºèº«å¿ƒå¥åº·ï¼Ÿ",
                            "ä¼ ç»Ÿçš„'ä¿®èº«å…»æ€§'åœ¨è®²ç©¶æ•ˆç‡çš„ç°ä»£ç¤¾ä¼šè¿˜æœ‰æ„ä¹‰å—ï¼Ÿ",
                            "å¦‚ä½•åœ¨ä¿æŒä¼ ç»Ÿæ–‡åŒ–åº•è•´çš„åŒæ—¶é€‚åº”ç°ä»£ç”Ÿæ´»ï¼Ÿ",
                            "å¹´è½»äººå­¦å¤å…¸æ–‡å­¦æ˜¯'è£…æ–‡è‰º'è¿˜æ˜¯çœŸçš„æœ‰ç”¨ï¼Ÿ"
                        ]
                    },
                    "å†…å·ä¸èººå¹³": {
                        title: "âš–ï¸ åŠªåŠ›çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Ÿ",
                        questions: [
                            "å†…å· vs èººå¹³ï¼Œæœ‰æ²¡æœ‰ç¬¬ä¸‰ç§é€‰æ‹©ï¼Ÿ",
                            "å¤äººçš„'ä¸­åº¸ä¹‹é“'èƒ½å¦è§£å†³ç°ä»£äººçš„ç„¦è™‘ï¼Ÿ",
                            "ä»€ä¹ˆæ ·çš„åŠªåŠ›æ˜¯æœ‰æ„ä¹‰çš„ï¼Ÿä»€ä¹ˆæ ·çš„åŠªåŠ›æ˜¯æ— æ•ˆå†…å·ï¼Ÿ",
                            "åœ¨ç«äº‰æ¿€çƒˆçš„ç¯å¢ƒä¸­ï¼Œå¦‚ä½•ä¿æŒå†…å¿ƒå¹³é™ï¼Ÿ"
                        ]
                    }
                };
                
                return debateTopics[dominantTheme] || debateTopics["ç†æƒ³ä¸ç°å®"];
            },
            
            summarizeGameExperience: function() {
                const experiences = [];
                
                // ç»Ÿè®¡åˆ›ä½œå†…å®¹
                if (poemCreationState.inputLines.length > 0) {
                    experiences.push(`åˆ›ä½œäº†${poemCreationState.inputLines.length}å¥ä¸ªæ€§åŒ–ã€Šé™‹å®¤é“­ã€‹`);
                }
                
                // ç»Ÿè®¡äº¤äº’äººç‰©
                const mentionedChars = gameState.mentionedCharacters || [];
                if (mentionedChars.length > 0) {
                    const charNames = mentionedChars.map(id => aiPersonalities[id]?.name || id);
                    experiences.push(`ä¸${charNames.join('ã€')}ç­‰å†å²åäººæ·±åº¦äº¤æµ`);
                }
                
                // ç»Ÿè®¡å…³é”®é€‰æ‹©
                const keyChoices = gameState.selectedOptions.filter(opt => opt.option.style);
                experiences.push(`åšå‡º${keyChoices.length}ä¸ªå½±å“äººç”Ÿè§‚çš„é‡è¦é€‰æ‹©`);
                
                return experiences;
            }
        };
        
        // æœ‹å‹åœˆå†…å®¹ç”Ÿæˆå™¨
        const momentsGenerator = {
            generateMomentsContent: async function(playerProfile) {
                try {
                    if (AI_FEATURES.enabled) {
                        return await this.generateAIMomentsContent(playerProfile);
                    } else {
                        return this.generatePresetMomentsContent(playerProfile);
                    }
                } catch (error) {
                    console.error('æœ‹å‹åœˆå†…å®¹ç”Ÿæˆå¤±è´¥', error);
                    return this.generatePresetMomentsContent(playerProfile);
                }
            },
            
            generateAIMomentsContent: async function(playerProfile) {
                const prompt = `ä½ æ˜¯åˆ˜ç¦¹é”¡ï¼Œåˆšåˆšç»“æŸäº†ä¸€åœºã€Šé™‹å®¤é“­ã€‹çš„åˆ›ä½œå’Œåˆ†äº«ä½“éªŒã€‚è¯·ä»¥åˆ˜ç¦¹é”¡çš„å£å»ç”Ÿæˆä¸€æ¡ç°ä»£æœ‹å‹åœˆåŠ¨æ€ã€‚

ç©å®¶ç‰¹å¾åˆ†æï¼š
- æ€§æ ¼ç±»å‹ï¼š${playerProfile.personalityType}
- æ ¸å¿ƒä»·å€¼è§‚ï¼š${playerProfile.mainValues.join('ã€')}
- æ¸¸æˆä½“éªŒï¼š${playerProfile.gameExperience.join('ï¼›')}

ç°ä»£æ€è€ƒè§’åº¦ï¼š
${playerProfile.modernConcerns.map(concern => `â€¢ ${concern}`).join('\n')}

è¦æ±‚ï¼š
1. ä»¥åˆ˜ç¦¹é”¡çš„èº«ä»½ï¼Œä½†èå…¥ç°ä»£æœ‹å‹åœˆçš„è¯­è¨€é£æ ¼
2. ç»“åˆç©å®¶çš„æ€§æ ¼ç‰¹ç‚¹å’Œé€‰æ‹©å€¾å‘
3. æ—¢è¦æœ‰å¤å…¸æ–‡å­¦åº•è•´ï¼Œä¹Ÿè¦æœ‰ç°ä»£äººçš„æ€è€ƒ
4. é€‚å½“åŠ å…¥å¯¹ç°ä»£ç¤¾ä¼šé—®é¢˜çš„æ„Ÿæ‚Ÿ
5. è¯­è¨€è¦äº²åˆ‡è‡ªç„¶ï¼Œä¸è¦è¿‡äºæ–‡ç»‰ç»‰
6. å­—æ•°æ§åˆ¶åœ¨150-200å­—
7. å¯ä»¥é€‚å½“ä½¿ç”¨emojiï¼Œä½†è¦å…‹åˆ¶

è¯·ç›´æ¥è¾“å‡ºæœ‹å‹åœˆå†…å®¹ï¼Œä¸è¦åŠ å¼•å·æˆ–è§£é‡Šï¼š`;

                const content = await callPoeAI(prompt, {
                    temperature: 0.8,
                    maxTokens: 300
                });
                
                return content;
            },
            
            generatePresetMomentsContent: function(playerProfile) {
                const templates = {
                    "ç²¾ç¥è¿½æ±‚å‹": [
                        `ä»Šå¤©å’Œå¤ä»£æ–‡è±ªä»¬ä¸€èµ·å“è¯„ã€Šé™‹å®¤é“­ã€‹ï¼Œæ·±æ„Ÿ"å¾·é¦¨"äºŒå­—çš„åˆ†é‡ ğŸ“š\n\nç°ä»£äººåœ¨å¿«èŠ‚å¥ç”Ÿæ´»ä¸­ï¼Œæ˜¯å¦è¿˜è®°å¾—ä»€ä¹ˆæ˜¯çœŸæ­£çš„ç²¾ç¥å¯Œè¶³ï¼Ÿ\nè‹”ç—•ä¸Šé˜¶ç»¿ï¼Œè‰è‰²å…¥å¸˜é’ ğŸƒ\nç®€å•çš„ç¾å¥½ï¼Œèƒœè¿‡å¤æ‚çš„ç„¦è™‘\n\nä¸è¯¸ä½æ–‡å‹å…±å‹‰ï¼šå¤–åœ¨çš„"é™‹"ä¸å¯æ€•ï¼Œå†…å¿ƒçš„"é¦¨"æ‰çè´µ âœ¨`,
                        
                        `åˆšåˆšä½“éªŒäº†ä¸€åœºè·¨è¶Šåƒå¹´çš„æ–‡å­¦é›…é›† ğŸŒŸ\n\nä»æ±Ÿè¾¹åˆ°æŸ³è¾¹å†åˆ°æ–—å®¤ï¼Œæ¯ä¸€æ¬¡è¿ç§»éƒ½æ˜¯å¿ƒå¢ƒçš„å‡å\næƒ³èµ·é™¶æ¸Šæ˜çš„"å¿ƒè¿œåœ°è‡ªå"ï¼Œåœ¨è¿™ä¸ªç‰©æ¬²æ¨ªæµçš„æ—¶ä»£ï¼Œæˆ‘ä»¬å¦‚ä½•æ‰¾åˆ°å†…å¿ƒçš„æ¡ƒèŠ±æºï¼Ÿ\n\nç§‘æŠ€å†å‘è¾¾ï¼Œä¹Ÿä»£æ›¿ä¸äº†ç²¾ç¥çš„å……å®\nè°ˆç¬‘æœ‰é¸¿å„’ï¼Œå¾€æ¥æ— ç™½ä¸ ğŸ“–`
                    ],
                    "ç¤¾ä¼šè´£ä»»å‹": [
                        `ä»Šæ—¥ä¸æœç”«ã€ç™½å±…æ˜“ç­‰å‰è¾ˆæ¢è®¨ã€Šé™‹å®¤é“­ã€‹ï¼Œé¢‡æœ‰æ„Ÿè§¦ ğŸ”ï¸\n\n"æ–¯æ˜¯é™‹å®¤ï¼ŒæƒŸå¾å¾·é¦¨"è®©æˆ‘æƒ³èµ·å½“ä¸‹å¹´è½»äººçš„å›°å¢ƒ\né«˜æˆ¿ä»·æ—¶ä»£çš„"é™‹å®¤"ï¼Œä¸æ˜¯é€‰æ‹©è€Œæ˜¯ç°å®\nä½†æ­£å¦‚å¤äººæ‰€è¨€ï¼ŒçœŸæ­£çš„å“è´¨ä¸åœ¨å¤–åœ¨ç¯å¢ƒ\n\næ„¿æ¯ä¸€ä¸ªåœ¨åŸå¸‚å¥‹æ–—çš„å¹´è½»äººï¼Œéƒ½èƒ½åœ¨"é™‹å®¤"ä¸­æ‰¾åˆ°è‡ªå·±çš„"å¾·é¦¨" ğŸ’ª\n#å½“ä»£é’å¹´ #ç²¾ç¥å®¶å›­`,
                        
                        `"å®‰å¾—å¹¿å¦åƒä¸‡é—´ï¼Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ¬¢é¢œ"ğŸ“\n\nä»Šå¤©é‡è¯»ã€Šé™‹å®¤é“­ã€‹ï¼Œæƒ³åˆ°æœç”«çš„è¿™å¥è¯—\nä¸€ä¸ªæ˜¯è¢«è¿«å±…é™‹å®¤å´æ³°ç„¶å¤„ä¹‹ï¼Œä¸€ä¸ªæ˜¯å¿ƒæ€€å¤©ä¸‹è‹ç”Ÿ\n\nç°åœ¨çš„"å¯’å£«"åœ¨å“ªé‡Œï¼Ÿæ˜¯996çš„ç¨‹åºå‘˜ï¼Ÿæ˜¯èƒŒç€æˆ¿è´·çš„æ™®é€šäººï¼Ÿ\næ–‡äººçš„ç¤¾ä¼šè´£ä»»ä»æœªæ”¹å˜\nç”¨ç¬”è®°å½•æ—¶ä»£ï¼Œç”¨å¿ƒå…³æ€€æ°‘ç”Ÿ â¤ï¸`
                    ],
                    "ä¼ ç»Ÿä¿®èº«å‹": [
                        `"å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ"ğŸ“œ\n\nä»Šå¤©å’Œå­”å­ã€é¢œå›ç­‰åœ£è´¤å­¦ä¹ ã€Šé™‹å®¤é“­ã€‹ï¼Œæ·±æ„Ÿä¿®èº«å…»æ€§çš„é‡è¦\n\nç½‘ç»œæ—¶ä»£ä¿¡æ¯çˆ†ç‚¸ï¼Œå¦‚ä½•ä¿æŒå†…å¿ƒçš„å®é™ï¼Ÿ\nå¿«èŠ‚å¥ç”Ÿæ´»ä¸­ï¼Œå¦‚ä½•è·µè¡Œ"å›å­æ…ç‹¬"ï¼Ÿ\n\nä¼ ç»Ÿæ–‡åŒ–ä¸æ˜¯å¤è‘£ï¼Œè€Œæ˜¯ç°ä»£äººçš„ç²¾ç¥æŒ‡å—\næ¯æ—¥ä¸‰çœå¾èº«ï¼Œåœ¨å–§åš£ä¸­ä¿æŒåˆå¿ƒ ğŸ™\n\n#ä¼ ç»Ÿæ–‡åŒ– #ç°ä»£ä¼ æ‰¿`,
                        
                        `åˆšåˆšå®Œæˆäº†ã€Šé™‹å®¤é“­ã€‹çš„åˆ›ä½œä½“éªŒ âœï¸\n\n"å¾·ä¸å­¤ï¼Œå¿…æœ‰é‚»"ï¼Œä»Šå¤©çœŸæ­£ä½“ä¼šåˆ°äº†è¿™å¥è¯çš„å«ä¹‰\nå³ä½¿åœ¨æœ€ç®€é™‹çš„ç¯å¢ƒä¸­ï¼Œå“å¾·é«˜å°šçš„äººä¹Ÿä¼šæœ‰çŸ¥éŸ³ç›¸ä¼´\n\næƒ³åˆ°ç°ä»£ç¤¾ä¼šçš„é“å¾·ç„¦è™‘ï¼Œæˆ–è®¸æˆ‘ä»¬éœ€è¦å›åˆ°ç»å…¸ä¸­å¯»æ‰¾ç­”æ¡ˆ\nä¿®èº«ã€é½å®¶ã€æ²»å›½ã€å¹³å¤©ä¸‹\nä¸€åˆ‡éƒ½ä»"å¾·é¦¨"å¼€å§‹ â­`
                    ],
                    "å¹³è¡¡æ™ºæ…§å‹": [
                        `ä»Šå¤©ä½“éªŒäº†ä¸€åœºç‰¹åˆ«çš„ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œä¹‹æ—… ğŸ‹\n\nä»åˆ˜ç¦¹é”¡çš„äººç”Ÿé™…é‡ä¸­å­¦åˆ°ï¼š\nå˜åŒ–æ˜¯å¸¸æ€ï¼Œé€‚åº”æ˜¯æ™ºæ…§\nå¤–å¢ƒå¯ä»¥ç®€é™‹ï¼Œå†…å¿ƒå¿…é¡»ä¸°å¯Œ\n\nç°ä»£äººçš„ç„¦è™‘å¤§å¤šæ¥è‡ªå¯¹å¤–åœ¨çš„è¿‡åº¦å…³æ³¨\næˆ¿å­å¯ä»¥å°ï¼Œæ ¼å±€ä¸èƒ½å°\nå·¥èµ„å¯ä»¥å°‘ï¼Œç²¾ç¥ä¸èƒ½è´« ğŸ’«\n\næ„Ÿè°¢å¤ä»£æ™ºè€…çš„å¯å‘ï¼Œè®©æˆ‘ä»¬åœ¨æµ®èºçš„æ—¶ä»£ä¿æŒå†…å¿ƒçš„å¹³è¡¡ ğŸƒ`
                    ]
                };
                
                const baseType = playerProfile.personalityType.split("ï¼š")[0];
                const contentArray = templates[baseType] || templates["å¹³è¡¡æ™ºæ…§å‹"];
                
                return contentArray[Math.floor(Math.random() * contentArray.length)];
            }
        };
        
        // èŠå¤©æˆªå›¾ç”Ÿæˆå™¨ï¼ˆå·²ç§»é™¤åŠŸèƒ½ï¼‰
        const chatScreenshotGenerator = {
            generateChatScreenshots: function() {
                // ç§»é™¤æˆªå›¾åŠŸèƒ½ï¼Œè¿”å›ç©ºæ•°ç»„
                return [];
            },
            
            selectChatHighlights: function() {
                // é€‰æ‹©æ¸¸æˆä¸­çš„ç²¾å½©å¯¹è¯ç‰‡æ®µ
                const highlights = [];
                
                // 1. ç»å…¸åå¥èµæ
                if (poemCreationState.inputLines.length > 0) {
                    highlights.push({
                        type: "poem_creation",
                        title: "ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œæ—¶åˆ»",
                        content: poemCreationState.inputLines.slice(0, 3).join('\n'),
                        participants: ["åˆ˜ç¦¹é”¡", "å­”å­", "æœç”«", "æç™½"]
                    });
                }
                
                // 2. å†å²äººç‰©äº’åŠ¨
                const mentionedChars = gameState.mentionedCharacters || [];
                if (mentionedChars.length > 0) {
                    highlights.push({
                        type: "character_interaction", 
                        title: "ä¸å¤ä»£æ–‡è±ªçš„å¯¹è¯",
                        content: "å›å­å±…ä¹‹ï¼Œä½•é™‹ä¹‹æœ‰ï¼Ÿ\nå¿ƒè¿œåœ°è‡ªåï¼Œä½•å¤„ä¸æ¡ƒæºï¼Ÿ",
                        participants: mentionedChars.map(id => aiPersonalities[id]?.name || id).slice(0, 4)
                    });
                }
                
                // 3. ä»·å€¼è§‚é€‰æ‹©æ—¶åˆ»
                const keyChoices = gameState.selectedOptions.filter(opt => opt.option.style);
                if (keyChoices.length > 0) {
                    highlights.push({
                        type: "value_choice",
                        title: "äººç”Ÿé€‰æ‹©çš„å…³é”®æ—¶åˆ»", 
                        content: "åœ¨é€†å¢ƒä¸­ä¿æŒå›å­é£èŒƒ\næ—¢æ¥ä¹‹åˆ™å®‰ä¹‹çš„ç”Ÿæ´»æ™ºæ…§",
                        participants: ["åˆ˜ç¦¹é”¡", "ç³»ç»Ÿ"]
                    });
                }
                
                return highlights.slice(0, 2); // æœ€å¤š2å¼ æˆªå›¾
            },
            
            createScreenshotElement: function(highlight, index) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-3';
                screenshotDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm font-medium text-gray-700">${highlight.title}</div>
                        <div class="text-xs text-gray-500">${index + 1}/2</div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2 font-mono whitespace-pre-line">${highlight.content}</div>
                    <div class="text-xs text-gray-500">
                        å‚ä¸è€…ï¼š${highlight.participants.join('ã€')}
                    </div>
                `;
                
                return screenshotDiv;
            }
        };
        
        // æœ‹å‹åœˆç¤¾äº¤äº’åŠ¨ç”Ÿæˆå™¨
        const momentsInteractionGenerator = {
            generateInteractions: async function(momentsContent, playerProfile) {
                // ç”Ÿæˆç‚¹èµå’Œè¯„è®º
                const likes = this.generateLikes();
                const comments = await this.generateComments(momentsContent, playerProfile);
                
                return { likes, comments };
            },
            
            generateLikes: function() {
                // é€‰æ‹©ä¼šç‚¹èµçš„å†å²äººç‰©
                const allCharacters = Object.keys(aiPersonalities);
                const likingCharacters = [];
                
                // éšæœºé€‰æ‹©8-12ä¸ªäººç‚¹èµ
                const likeCount = 8 + Math.floor(Math.random() * 5);
                
                for (let i = 0; i < likeCount && allCharacters.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * allCharacters.length);
                    likingCharacters.push(allCharacters[randomIndex]);
                    allCharacters.splice(randomIndex, 1);
                }
                
                return likingCharacters.map(id => aiPersonalities[id]?.name || id);
            },
            
            generateComments: async function(momentsContent, playerProfile) {
                const comments = [];
                
                // é€‰æ‹©è¯„è®ºè€…ï¼ˆåŒ…æ‹¬æ‰©å±•äººç‰©ï¼‰
                const commenters = this.selectCommenters();
                
                for (const commenter of commenters) {
                    try {
                        let commentText;
                        
                        if (AI_FEATURES.enabled && Math.random() < 0.6) {
                            commentText = await this.generateAIComment(commenter, momentsContent, playerProfile);
                        } else {
                            commentText = this.generatePresetComment(commenter, playerProfile);
                        }
                        
                        comments.push({
                            author: commenter.name,
                            emoji: commenter.emoji,
                            text: commentText,
                            isAI: AI_FEATURES.enabled && Math.random() < 0.6
                        });
                        
                    } catch (error) {
                        console.error(`ç”Ÿæˆ${commenter.name}è¯„è®ºå¤±è´¥`, error);
                        // é™çº§å¤„ç†
                        comments.push({
                            author: commenter.name,
                            emoji: commenter.emoji,
                            text: this.generatePresetComment(commenter, playerProfile),
                            isAI: false
                        });
                    }
                }
                
                return comments;
            },
            
            selectCommenters: function() {
                // æ‰©å±•è¯„è®ºäººç‰©åº“
                const extendedCommenters = [
                    { name: "éŸ©æ„ˆ", emoji: "ğŸ“", personality: "å¤æ–‡è¿åŠ¨å€¡å¯¼è€…ï¼Œæ–‡ä»¥è½½é“" },
                    { name: "æŸ³å®—å…ƒ", emoji: "ğŸŒŠ", personality: "å±±æ°´æ–‡å­¦å®¶ï¼Œæ”¿æ²»æ”¹é©è€…" },
                    { name: "ç‹å‹ƒ", emoji: "ğŸŒ…", personality: "åˆå”å››æ°ï¼Œè‹±å¹´æ—©é€" },
                    { name: "å­Ÿæµ©ç„¶", emoji: "ğŸï¸", personality: "å±±æ°´ç”°å›­è¯—äººï¼Œæ·¡æ³Šååˆ©" },
                    { name: "è¾›å¼ƒç–¾", emoji: "âš”ï¸", personality: "è±ªæ”¾è¯äººï¼Œå¿§å›½å¿§æ°‘" },
                    { name: "èŒƒä»²æ·¹", emoji: "ğŸ›ï¸", personality: "æ”¿æ²»å®¶æ–‡å­¦å®¶ï¼Œå…ˆå¿§åä¹" },
                    { name: "ç°ä»£è¯»è€…å°ç‹", emoji: "ğŸ’¼", personality: "å½“ä»£ä¸Šç­æ—ï¼Œæ–‡å­¦çˆ±å¥½è€…" },
                    { name: "90åæ–‡é’", emoji: "ğŸ“±", personality: "å¹´è½»äººï¼Œè¿½æ±‚ç²¾ç¥ç”Ÿæ´»" },
                    { name: "åŒ—æ¼‚é’å¹´", emoji: "ğŸ ", personality: "åœ¨å¤§åŸå¸‚å¥‹æ–—çš„å¹´è½»äºº" }
                ];
                
                // éšæœºé€‰æ‹©4-6ä¸ªè¯„è®ºè€…
                const commentCount = 4 + Math.floor(Math.random() * 3);
                const selectedCommenters = [];
                
                for (let i = 0; i < commentCount && extendedCommenters.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * extendedCommenters.length);
                    selectedCommenters.push(extendedCommenters[randomIndex]);
                    extendedCommenters.splice(randomIndex, 1);
                }
                
                return selectedCommenters;
            },
            
            generateAIComment: async function(commenter, momentsContent, playerProfile) {
                const isModernPerson = commenter.name.includes("ç°ä»£") || commenter.name.includes("90å") || commenter.name.includes("åŒ—æ¼‚");
                
                const prompt = `ä½ æ˜¯${commenter.name}ï¼ˆ${commenter.personality}ï¼‰ï¼Œçœ‹åˆ°åˆ˜ç¦¹é”¡å‘çš„è¿™æ¡æœ‹å‹åœˆåŠ¨æ€ï¼š

"${momentsContent}"

è¯·ä»¥${commenter.name}çš„èº«ä»½å†™ä¸€æ¡è¯„è®ºå›åº”ã€‚

${isModernPerson ? 
`ä½œä¸ºç°ä»£äººï¼Œä½ è¦ï¼š
1. ç”¨ç°ä»£ç½‘ç»œè¯­è¨€é£æ ¼
2. ç»“åˆå½“ä»£ç”Ÿæ´»å®é™…æƒ…å†µ
3. å¯ä»¥è´¨ç–‘æˆ–è¡¥å……å¤å…¸è§‚ç‚¹
4. è¡¨è¾¾å¹´è½»äººçš„çœŸå®æƒ³æ³•` :
`ä½œä¸ºå¤ä»£æ–‡äººï¼Œä½ è¦ï¼š
1. ç¬¦åˆå†å²äººç‰©èº«ä»½
2. å¯ä»¥ç”¨å¤å…¸æ–‡å­¦è¯­è¨€
3. ä½“ç°ä½ çš„æ–‡å­¦ä¸»å¼ å’Œäººç”Ÿé˜…å†
4. ä¸åˆ˜ç¦¹é”¡äº§ç”Ÿæ€æƒ³å…±é¸£æˆ–è¾©è®º`}

è¦æ±‚ï¼š
1. è¯­è¨€è¦è‡ªç„¶ï¼Œç¬¦åˆæœ‹å‹åœˆè¯„è®ºé£æ ¼
2. å¯ä»¥é€‚å½“ä½¿ç”¨emoji
3. å­—æ•°æ§åˆ¶åœ¨50-80å­—
4. è¦æœ‰é’ˆå¯¹æ€§ï¼Œä¸è¦æ³›æ³›è€Œè°ˆ
5. ${isModernPerson ? 'å¯ä»¥æåŠç°ä»£ç¤¾ä¼šé—®é¢˜' : 'å¯ä»¥å¼•ç”¨ç»å…¸æˆ–å…¸æ•…'}

è¯·ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ï¼š`;

                const comment = await callPoeAI(prompt, {
                    temperature: 0.9,
                    maxTokens: 150
                });
                
                return comment;
            },
            
            generatePresetComment: function(commenter, playerProfile) {
                const presetComments = {
                    "éŸ©æ„ˆ": [
                        "æ–‡ä»¥è½½é“ï¼Œæ¢¦å¾—æ­¤æ–‡æ·±å¾—æ–‡ç« ä¹‹è¦ï¼å¤ä»Šç›¸é€šï¼Œå¾·é¦¨æ°¸æ’ ğŸ“",
                        "å¸ˆè€…ä¼ é“ï¼Œä»Šæ—¥ä¹‹é™‹å®¤ï¼Œä»–æ—¥ä¹‹ç»å…¸ï¼åç”Ÿå¯ç• âœ¨"
                    ],
                    "æŸ³å®—å…ƒ": [
                        "å±±æ°´ä¹‹ä¹ï¼Œåœ¨ä¹å¿ƒä¹Ÿã€‚æ¢¦å¾—å…„æ·±å¾—æ­¤ç†ï¼ğŸŒŠ",
                        "åŒä¸ºè´¬è°ªä¹‹äººï¼Œæœ€æ‡‚è¿™ç§å¢ƒç•Œã€‚å¿ƒå¢ƒé«˜è¿œèƒœè¿‡é«˜æ¥¼å¤§å¦ ğŸï¸"
                    ],
                    "è¾›å¼ƒç–¾": [
                        "é‡‘æˆˆé“é©¬ï¼Œä¸å¦‚ä¸€å®¤ä¹¦é¦™ã€‚æ¢¦å¾—å…„å¢ƒç•Œé«˜çŸ£ï¼âš”ï¸",
                        "äº†å´å›ç‹å¤©ä¸‹äº‹ï¼Œèµ¢å¾—ç”Ÿå‰èº«ååã€‚æ–‡äººå½“å¦‚æ˜¯ ğŸŒŸ"
                    ],
                    "ç°ä»£è¯»è€…å°ç‹": [
                        "åˆ˜è€å¸ˆè¯´å¾—å¤ªå¯¹äº†ï¼æˆ‘ç§Ÿçš„10å¹³å°æˆ¿é—´ç¬é—´ä¸é¦™äº†...å­¦ä¼šçŸ¥è¶³ ğŸ’¼",
                        "æˆ¿ä»·è¿™ä¹ˆé«˜ï¼Œçœ‹æ¥å¤äººæ—©å°±ç»™æˆ‘ä»¬å¿ƒç†å®‰æ…°äº†ã€‚è°¢è°¢æ¢¦å¾—è€å¸ˆï¼ğŸ˜Š"
                    ],
                    "90åæ–‡é’": [
                        "å¤ä»£çš„ç²¾ç¥å¯Œè¶³vsç°ä»£çš„ç‰©è´¨ç„¦è™‘ï¼Œè¿™ä¸ªå¯¹æ¯”å¤ªæ‰å¿ƒäº† ğŸ“±",
                        "å¾·é¦¨>å¾·è–ªï¼Œä½†æ˜¯å¾·è–ªä¹Ÿå¾ˆé‡è¦å•Šå“ˆå“ˆğŸ˜‚ ç°å®ä¸ç†æƒ³çš„å·®è·..."
                    ],
                    "åŒ—æ¼‚é’å¹´": [
                        "åœ¨åŒ—äº¬çš„å‡ºç§Ÿå±‹é‡Œçœ‹åˆ°è¿™ä¸ªï¼Œæƒ³å“­...ä½†ç¡®å®ï¼Œå¿ƒæ€å¾ˆé‡è¦ ğŸ ",
                        "æˆ¿å­æ˜¯ç§Ÿçš„ï¼Œç”Ÿæ´»ä¸æ˜¯ã€‚æ„Ÿè°¢åˆ˜è€å¸ˆçš„äººç”Ÿå“²å­¦è¯¾ï¼ğŸ’ª"
                    ]
                };
                
                const comments = presetComments[commenter.name];
                if (comments && comments.length > 0) {
                    return comments[Math.floor(Math.random() * comments.length)];
                }
                
                // é€šç”¨è¯„è®º
                const isModern = commenter.name.includes("ç°ä»£") || commenter.name.includes("90å") || commenter.name.includes("åŒ—æ¼‚");
                if (isModern) {
                    return "ç°ä»£äººè¡¨ç¤ºå­¦åˆ°äº†ï¼å¤äººçš„æ™ºæ…§çœŸçš„å¾ˆæ²»æ„ˆ ğŸ˜Š";
                } else {
                    return "æ·±æœ‰åŒæ„Ÿï¼Œä¸å›å…±å‹‰ï¼å¤ä»Šç›¸é€šä¹‹ç†ä¹Ÿ âœ¨";
                }
            }
        };
        
        // æ™ºèƒ½å¤ä»Šå¯¹è¯ä¸»é¢˜ç³»ç»Ÿ
        const ancientModernDialogueSystem = {
            // ä¸»é¢˜åº“å®šä¹‰
            topicDatabase: {
                "balanced": {
                    title: "ç‰©è´¨ä¸ç²¾ç¥çš„å¹³è¡¡",
                    ibProfile: "Balanced",
                    emoji: "ğŸ’°",
                    subtitle: "å¦‚æœé™¶æ¸Šæ˜ç”Ÿæ´»åœ¨2024å¹´",
                    questions: [
                        "æœˆè–ª3ä¸‡ä½†è¦è¿˜30å¹´æˆ¿è´· vs æœˆè–ª8åƒä½†å†…å¿ƒå……å®ï¼Œä½ é€‰å“ªä¸ªï¼Ÿ",
                        "ç°ä»£'é™‹å®¤'ï¼ˆå°æˆ·å‹ã€åˆç§Ÿæˆ¿ï¼‰èƒ½å¦ä¹Ÿæœ‰'å¾·é¦¨'ä¹‹ç¾ï¼Ÿ",
                        "æ¶ˆè´¹ä¸»ä¹‰æ—¶ä»£ï¼Œå¦‚ä½•å®šä¹‰çœŸæ­£çš„'å¯Œè¶³'ï¼Ÿ",
                        "'ä¸ä¸ºäº”æ–—ç±³æŠ˜è…°'åœ¨é«˜æˆ¿ä»·æ—¶ä»£è¿˜ç°å®å—ï¼Ÿ"
                    ],
                    triggerCharacters: ["tao", "yanhuei"],
                    keywords: ["ç®€æœ´", "ç‰©è´¨", "ç²¾ç¥", "å½’éš"]
                },
                "caring": {
                    title: "ç¤¾ä¼šè´£ä»»ä¸ä¸ªäººç”Ÿæ´»",
                    ibProfile: "Caring",
                    emoji: "ğŸ›ï¸",
                    subtitle: "ç°ä»£ç‰ˆ'ä½å‘æœªæ•¢å¿˜å¿§å›½'",
                    questions: [
                        "æ™®é€šäººéœ€è¦ä¸ºç¤¾ä¼šé—®é¢˜æ‰¿æ‹…å¤šå°‘è´£ä»»ï¼Ÿ",
                        "å…³æ³¨æ—¶äº‹æ”¿æ²» vs ä¸“å¿ƒä¸ªäººç”Ÿæ´»ï¼Œå¦‚ä½•å¹³è¡¡ï¼Ÿ",
                        "ç¤¾äº¤åª’ä½“æ—¶ä»£ï¼Œæ¯ä¸ªäººéƒ½æ˜¯'è‡ªåª’ä½“'ï¼Œè¯¥å¦‚ä½•å‘å£°ï¼Ÿ",
                        "'å…ˆå¤©ä¸‹ä¹‹å¿§è€Œå¿§'çš„ç†æƒ³ä¸»ä¹‰åœ¨ç°å®ä¸­å¦‚ä½•å®è·µï¼Ÿ"
                    ],
                    triggerCharacters: ["du", "baijuyi"],
                    keywords: ["å¿§å›½", "è´£ä»»", "ç¤¾ä¼š", "æ°‘ç”Ÿ"]
                },
                "risktakers": {
                    title: "è‡ªç”±ç²¾ç¥ä¸ç°å®çº¦æŸ",
                    ibProfile: "Risk-takers",
                    emoji: "ğŸŒ™",
                    subtitle: "å¦‚æœæç™½æ˜¯å½“ä»£å¹´è½»äºº",
                    questions: [
                        "996å·¥ä½œåˆ¶ vs 'å®‰èƒ½æ‘§çœ‰æŠ˜è…°äº‹æƒè´µ'ï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ",
                        "ç¨³å®šå·¥ä½œ vs è¿½æ±‚æ¢¦æƒ³ï¼Œè¿™ä¸ªé€‰æ‹©æœ‰æ ‡å‡†ç­”æ¡ˆå—ï¼Ÿ",
                        "åœ¨è§„åˆ™ä¸¥å¯†çš„ç°ä»£ç¤¾ä¼šï¼Œå¦‚ä½•ä¿æŒç²¾ç¥ä¸Šçš„è‡ªç”±ï¼Ÿ",
                        "'ä»°å¤©å¤§ç¬‘å‡ºé—¨å»'çš„æ´’è„±åœ¨ç°ä»£ç¤¾ä¼šè¿˜å¯èƒ½å—ï¼Ÿ"
                    ],
                    triggerCharacters: ["libai"],
                    keywords: ["è‡ªç”±", "ç†æƒ³", "è±ªè¿ˆ", "æ¢¦æƒ³"]
                },
                "knowledgeable": {
                    title: "ä¼ ç»Ÿæ™ºæ…§ä¸ç°ä»£ä»·å€¼",
                    ibProfile: "Knowledgeable",
                    emoji: "ğŸ“š",
                    subtitle: "å¤å…¸æ•™è‚² vs ç°ä»£ç´ è´¨",
                    questions: [
                        "ä¼ ç»Ÿçš„'ä¿®èº«é½å®¶æ²»å›½å¹³å¤©ä¸‹'åœ¨ç°ä»£è¿˜æœ‰æ„ä¹‰å—ï¼Ÿ",
                        "å­é“ã€å°Šå¸ˆç­‰ä¼ ç»Ÿè§‚å¿µå¦‚ä½•é€‚åº”ç°ä»£å®¶åº­å…³ç³»ï¼Ÿ",
                        "å¹´è½»äººå­¦å¤å…¸æ–‡å­¦æ˜¯'è£…æ–‡è‰º'è¿˜æ˜¯çœŸçš„æœ‰ç”¨ï¼Ÿ",
                        "'å›å­'å“æ ¼åœ¨ç°ä»£èŒåœºå’Œç¤¾äº¤ä¸­æ˜¯ä¼˜åŠ¿è¿˜æ˜¯åŠ£åŠ¿ï¼Ÿ"
                    ],
                    triggerCharacters: ["confucius", "zengzi", "yangxiong"],
                    keywords: ["ä¼ ç»Ÿ", "æ–‡åŒ–", "ä¿®èº«", "å›å­"]
                },
                "reflective": {
                    title: "å†…å¿ƒå®é™ä¸å¤–åœ¨æµ®èº",
                    ibProfile: "Reflective",
                    emoji: "ğŸ§˜",
                    subtitle: "ç°ä»£äººçš„ç²¾ç¥ç„¦è™‘",
                    questions: [
                        "æ‰‹æœºä¸ç¦»æ‰‹çš„æ—¶ä»£ï¼Œå¦‚ä½•å®ç°'å¿ƒè¿œåœ°è‡ªå'ï¼Ÿ",
                        "å†¥æƒ³ã€æ­£å¿µ vs å¤äººçš„'é™å'ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ",
                        "åœ¨ä¿¡æ¯çˆ†ç‚¸çš„ç¯å¢ƒä¸­ï¼Œå¦‚ä½•ä¿æŒå†…å¿ƒçš„æ¸…æ˜ï¼Ÿ",
                        "'è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶'çš„å¢ƒç•Œç°ä»£äººèƒ½è¾¾åˆ°å—ï¼Ÿ"
                    ],
                    triggerCharacters: ["wangwei"],
                    keywords: ["ç¦…æ„", "å®é™", "å†¥æƒ³", "å†…å¿ƒ"]
                },
                "openminded": {
                    title: "ä¹è§‚è±è¾¾ä¸ç°å®å‹åŠ›",
                    ibProfile: "Open-minded",
                    emoji: "ğŸ˜Š",
                    subtitle: "ç°ä»£ç‰ˆ'ä¹Ÿæ— é£é›¨ä¹Ÿæ— æ™´'",
                    questions: [
                        "é¢å¯¹è£å‘˜ã€å¤±æ‹ã€è€ƒè¯•å¤±è´¥ï¼Œå¦‚ä½•ä¿æŒè‹è½¼å¼çš„è±è¾¾ï¼Ÿ",
                        "æ˜¯å…ˆè§£å†³é—®é¢˜å†å¼€å¿ƒï¼Œè¿˜æ˜¯å…ˆå¼€å¿ƒå†è§£å†³é—®é¢˜ï¼Ÿ",
                        "'äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäºº'å¯¹ç°ä»£ç„¦è™‘ç—‡æœ‰ç”¨å—ï¼Ÿ",
                        "ç¤¾äº¤åª’ä½“ä¸Šçš„'å®Œç¾ç”Ÿæ´»'å±•ç¤º vs çœŸå®çš„äººç”Ÿèµ·ä¼"
                    ],
                    triggerCharacters: ["sushi"],
                    keywords: ["è±è¾¾", "ä¹è§‚", "æ—·è¾¾", "å¿«ä¹"]
                },
                "principled": {
                    title: "ä¸ªäººåšéŸ§ä¸æ—¶ä»£å˜è¿",
                    ibProfile: "Principled",
                    emoji: "ğŸ’ª",
                    subtitle: "æ—¶ä»£æ´ªæµä¸­çš„ä¸ªä½“åŠ›é‡",
                    questions: [
                        "'ç”Ÿå½“ä½œäººæ°ï¼Œæ­»äº¦ä¸ºé¬¼é›„'çš„æ°”æ¦‚ç°ä»£äººè¿˜éœ€è¦å—ï¼Ÿ",
                        "é¢å¯¹æ—¶ä»£å˜åŒ–ï¼ˆAIã€å¤±ä¸šé£é™©ï¼‰ï¼Œä¸ªäººå¦‚ä½•ä¿æŒéŸ§æ€§ï¼Ÿ",
                        "å¥³æ€§åœ¨ç°ä»£ç¤¾ä¼šå¦‚ä½•å¹³è¡¡æ¸©æŸ”ä¸åšå¼ºï¼Ÿ",
                        "ä¸ªäººåŠªåŠ› vs æ—¶ä»£æœºé‡ï¼Œå“ªä¸ªæ›´é‡è¦ï¼Ÿ"
                    ],
                    triggerCharacters: ["liqingzhao"],
                    keywords: ["åšå¼º", "åšéŸ§", "å“æ ¼", "åŸåˆ™"]
                },
                "thinkers": {
                    title: "ç†æƒ³æŠ±è´Ÿä¸ç°å®å¦¥å",
                    ibProfile: "Thinkers",
                    emoji: "ğŸ¯",
                    subtitle: "ç°ä»£ç‰ˆ'é èº¬å°½ç˜'",
                    questions: [
                        "æ¯•ä¸šåçš„ç†æƒ³ä¸ç°å®ï¼šå¤§å‚é«˜è–ª vs ç†æƒ³å·¥ä½œï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ",
                        "'éæ·¡æ³Šæ— ä»¥æ˜å¿—'åœ¨ç«äº‰æ¿€çƒˆçš„ç¯å¢ƒä¸­è¿˜é€‚ç”¨å—ï¼Ÿ",
                        "ä»€ä¹ˆå¹´é¾„æ®µæœ€é€‚åˆ'ç†æƒ³ä¸»ä¹‰'ï¼Ÿä»€ä¹ˆæ—¶å€™è¯¥'ç°å®ä¸€ç‚¹'ï¼Ÿ",
                        "ä¸ªäººç†æƒ³ä¸å®¶åº­è´£ä»»å†²çªæ—¶ï¼Œå¦‚ä½•å¹³è¡¡ï¼Ÿ"
                    ],
                    triggerCharacters: ["zhugeliang"],
                    keywords: ["ç†æƒ³", "æŠ±è´Ÿ", "è§„åˆ’", "æ™ºæ…§"]
                }
            },
            
            // æ™ºèƒ½åŒ¹é…ç®—æ³•
            matchPlayerTopic: function() {
                const mentionedChars = gameState.mentionedCharacters || [];
                const playerChoices = gameState.selectedOptions || [];
                const poemLines = poemCreationState.inputLines || [];
                
                console.log('ğŸ¯ å¼€å§‹æ™ºèƒ½åŒ¹é…å¤ä»Šå¯¹è¯ä¸»é¢˜');
                console.log('æåŠè§’è‰²:', mentionedChars);
                
                let scores = {};
                
                // åˆå§‹åŒ–åˆ†æ•°
                Object.keys(this.topicDatabase).forEach(key => {
                    scores[key] = 0;
                });
                
                // 1. è§’è‰²åŒ¹é…ï¼ˆæƒé‡70%ï¼‰
                mentionedChars.forEach(charId => {
                    Object.entries(this.topicDatabase).forEach(([topicKey, topic]) => {
                        if (topic.triggerCharacters.includes(charId)) {
                            scores[topicKey] += 70;
                            console.log(`è§’è‰²åŒ¹é…: ${charId} â†’ ${topicKey} (+70åˆ†)`);
                        }
                    });
                });
                
                // 2. é€‰æ‹©å€¾å‘åˆ†æï¼ˆæƒé‡20%ï¼‰
                const stylePoints = gameState.stylePoints || {};
                if (stylePoints.tao > 0) scores["balanced"] += 20;
                if (stylePoints.du > 0) scores["caring"] += 20;
                if (stylePoints.ru > 0) scores["knowledgeable"] += 15;
                
                // 3. åˆ›ä½œå†…å®¹å…³é”®è¯ï¼ˆæƒé‡10%ï¼‰
                const allText = poemLines.join('');
                Object.entries(this.topicDatabase).forEach(([topicKey, topic]) => {
                    topic.keywords.forEach(keyword => {
                        if (allText.includes(keyword)) {
                            scores[topicKey] += 10;
                            console.log(`å…³é”®è¯åŒ¹é…: ${keyword} â†’ ${topicKey} (+10åˆ†)`);
                        }
                    });
                });
                
                // 4. æ·»åŠ éšæœºå› å­ï¼ˆé˜²æ­¢è¿‡äºå›ºå®šï¼‰
                Object.keys(scores).forEach(key => {
                    scores[key] += Math.random() * 5;
                });
                
                // é€‰æ‹©æœ€é«˜åˆ†çš„ä¸»é¢˜
                const bestTopic = Object.keys(scores).reduce((a, b) => 
                    scores[a] > scores[b] ? a : b
                );
                
                console.log('ä¸»é¢˜åŒ¹é…å¾—åˆ†:', scores);
                console.log('æœ€ç»ˆé€‰æ‹©ä¸»é¢˜:', bestTopic, this.topicDatabase[bestTopic].title);
                
                return this.topicDatabase[bestTopic];
            },
            
            // ç”Ÿæˆè¯é¢˜UI HTML
            generateTopicHTML: function(selectedTopic) {
                return `
                    <div class="mx-4 my-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl overflow-hidden shadow-sm border border-purple-100">
                        <!-- é¡¶éƒ¨æ ‡ç­¾åŒº -->
                        <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">ğŸ¤”</span>
                                    <div>
                                        <h3 class="font-semibold text-lg">æ·±åº¦æ€è¾¨ï¼šå¤ä»Šå¯¹è¯</h3>
                                        <p class="text-purple-100 text-sm mt-1">åŸºäºæ‚¨çš„æ¸¸æˆä½“éªŒæ™ºèƒ½åŒ¹é…</p>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <span class="text-sm font-medium">IB Â· ${selectedTopic.ibProfile}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸»é¢˜å†…å®¹åŒº -->
                        <div class="p-5">
                            <div class="flex items-center mb-4">
                                <span class="text-3xl mr-3">${selectedTopic.emoji}</span>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${selectedTopic.title}</h4>
                                    <p class="text-gray-600 text-sm mt-1">${selectedTopic.subtitle}</p>
                                </div>
                            </div>
                            
                            <!-- æ€è¾¨é—®é¢˜åˆ—è¡¨ -->
                            <div class="space-y-3">
                                ${selectedTopic.questions.map((question, index) => `
                                    <div class="flex items-start bg-white rounded-lg p-3 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                        <div class="w-6 h-6 bg-gradient-to-r from-purple-400 to-blue-400 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5 flex-shrink-0">
                                            ${index + 1}
                                        </div>
                                        <p class="text-gray-700 text-sm leading-relaxed">${question}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- åº•éƒ¨æç¤º -->
                            <div class="mt-5 pt-4 border-t border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-gray-500">
                                        ğŸ’¡ è¿™äº›é—®é¢˜æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥æœ‰è‡ªå·±çš„æ€è€ƒ
                                    </div>
                                    <div class="flex items-center text-xs text-purple-600">
                                        <span class="w-2 h-2 bg-purple-400 rounded-full mr-1"></span>
                                        <span>ä¸ªæ€§åŒ–åŒ¹é…</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // é¢„ç”Ÿæˆå¤ä»Šå¯¹è¯å†…å®¹
        function generateAncientModernDialogueContent() {
            // æ™ºèƒ½åŒ¹é…ä¸»é¢˜
            const selectedTopic = ancientModernDialogueSystem.matchPlayerTopic();
            
            // ç›´æ¥è¿”å›HTMLå†…å®¹ï¼Œè€Œä¸æ˜¯æ“ä½œDOM
            return ancientModernDialogueSystem.generateTopicHTML(selectedTopic);
        }

        // æœ‹å‹åœˆUIç”Ÿæˆå™¨
        const momentsUIGenerator = {
            generateMomentsUI: async function(momentsContent, screenshots, interactions, ancientModernContent) {
                const momentsContainer = document.createElement('div');
                momentsContainer.className = 'fixed inset-0 bg-white z-50 overflow-y-auto';
                
                momentsContainer.innerHTML = `
                    <!-- å¾®ä¿¡æœ‹å‹åœˆå¤´éƒ¨ -->
                    <div class="sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between z-10">
                        <button id="closeMoments" class="text-gray-600 hover:text-gray-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-lg font-medium">æœ‹å‹åœˆ</h1>
                        <button class="text-gray-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zM12 13a1 1 0 110-2 1 1 0 010 2zM12 20a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- æœ‹å‹åœˆå†…å®¹ -->
                    <div class="pb-6">
                        <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
                        <div class="px-4 py-6 bg-gradient-to-r from-blue-50 to-purple-50">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                    åˆ˜
                                </div>
                                <div class="ml-3">
                                    <div class="font-medium text-gray-800">åˆ˜ç¦¹é”¡</div>
                                    <div class="text-sm text-gray-500">è¯—è±ª Â· å”ä»£æ–‡å­¦å®¶</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœ‹å‹åœˆåŠ¨æ€ -->
                        <div class="px-4 py-4 border-b border-gray-100">
                            <!-- å‘å¸ƒæ—¶é—´ -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-gray-500">2åˆ†é’Ÿå‰ Â· é™‹å®¤é›…é›†</div>
                                <div class="text-xs text-gray-400">ğŸ“ æ—¶ç©ºäº¤æ±‡ç‚¹</div>
                            </div>
                            
                            <!-- æ–‡å­—å†…å®¹ -->
                            <div class="text-gray-800 leading-relaxed mb-4" style="font-size: 16px;">
                                ${momentsContent.replace(/\n/g, '<br>')}
                            </div>
                            
                            <!-- èŠå¤©æˆªå›¾ -->
                            <div id="chatScreenshots" class="mb-4">
                                ${screenshots.map(screenshot => screenshot.outerHTML).join('')}
                            </div>
                            
                            <!-- äº’åŠ¨ç»Ÿè®¡ -->
                            <div class="flex items-center justify-between py-3 border-t border-gray-100">
                                <div class="flex items-center text-sm text-gray-500">
                                    <span class="flex items-center mr-4">
                                        <span class="mr-1">ğŸ‘â¤ï¸ğŸ˜®</span>
                                        <span>${interactions.likes.slice(0, 3).join('ã€')}ç­‰${interactions.likes.length}äºº</span>
                                    </span>
                                </div>
                                <div class="flex items-center text-sm text-gray-500">
                                    <span class="mr-3">ğŸ’¬ ${interactions.comments.length}æ¡è¯„è®º</span>
                                    <span>ğŸ”„ 3æ¬¡è½¬å‘</span>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center justify-around py-3 border-t border-gray-100">
                                <button class="flex items-center text-gray-600 hover:text-blue-500">
                                    <span class="mr-1">ğŸ‘</span>
                                    <span>ç‚¹èµ</span>
                                </button>
                                <button class="flex items-center text-gray-600 hover:text-blue-500">
                                    <span class="mr-1">ğŸ’¬</span>
                                    <span>è¯„è®º</span>
                                </button>
                                <button id="saveScreenshot" class="flex items-center text-gray-600 hover:text-green-500">
                                    <span class="mr-1">ğŸ“±</span>
                                    <span>ä¿å­˜æˆªå›¾</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- è¯„è®ºåŒº -->
                        <div class="px-4 py-4">
                            <h3 class="font-medium text-gray-800 mb-4">è¯„è®º (${interactions.comments.length})</h3>
                            <div id="commentsList">
                                ${interactions.comments.map(comment => `
                                    <div class="flex items-start mb-4 pb-4 border-b border-gray-50 last:border-b-0">
                                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm mr-3">
                                            ${comment.emoji}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm text-gray-800 mb-1">
                                                ${comment.author}
                                                ${comment.isAI ? '<span class="text-xs text-blue-500 ml-1">âœ¨AI</span>' : ''}
                                            </div>
                                            <div class="text-gray-700 text-sm leading-relaxed">
                                                ${comment.text}
                                            </div>
                                            <div class="text-xs text-gray-400 mt-2">
                                                åˆšåˆš Â· <span class="hover:text-blue-500 cursor-pointer">å›å¤</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- æ·±åº¦æ€è¾¨ï¼šå¤ä»Šå¯¹è¯æ¿å— -->
                        <div id="ancientModernDialogue">
                            ${ancientModernContent || ''}
                        </div>
                    </div>
                `;
                
                return momentsContainer;
            }
        };
        
        // å¯åŠ¨æœ‹å‹åœˆç”Ÿæˆæµç¨‹
        async function generateMomentsPage() {
            console.log('ğŸ¨ å¼€å§‹ç”Ÿæˆæœ‹å‹åœˆé¡µé¢');
            
            try {
                // 1. åˆ†æç©å®¶ç‰¹å¾
                const playerProfile = personalityAnalyzer.analyzePlayerProfile();
                console.log('ç©å®¶ç‰¹å¾åˆ†æå®Œæˆ:', playerProfile);
                
                // 2. ç”Ÿæˆæœ‹å‹åœˆå†…å®¹
                const momentsContent = await momentsGenerator.generateMomentsContent(playerProfile);
                console.log('æœ‹å‹åœˆå†…å®¹ç”Ÿæˆå®Œæˆ');
                
                // 3. ç”ŸæˆèŠå¤©æˆªå›¾
                const screenshots = chatScreenshotGenerator.generateChatScreenshots();
                console.log('èŠå¤©æˆªå›¾ç”Ÿæˆå®Œæˆ');
                
                // 4. ç”Ÿæˆç¤¾äº¤äº’åŠ¨
                const interactions = await momentsInteractionGenerator.generateInteractions(momentsContent, playerProfile);
                console.log('ç¤¾äº¤äº’åŠ¨ç”Ÿæˆå®Œæˆ');
                
                // 5. é¢„ç”Ÿæˆå¤ä»Šå¯¹è¯å†…å®¹
                const ancientModernContent = generateAncientModernDialogueContent();
                console.log('å¤ä»Šå¯¹è¯å†…å®¹é¢„ç”Ÿæˆå®Œæˆ');
                
                // 6. ç”Ÿæˆå®Œæ•´UIï¼ˆåŒ…å«å¤ä»Šå¯¹è¯å†…å®¹ï¼‰
                const momentsUI = await momentsUIGenerator.generateMomentsUI(momentsContent, screenshots, interactions, ancientModernContent);
                
                // 7. æ˜¾ç¤ºæœ‹å‹åœˆé¡µé¢
                document.body.appendChild(momentsUI);
                
                // 8. ç»‘å®šäº‹ä»¶
                bindMomentsEvents(momentsUI);
                
                console.log('âœ… æœ‹å‹åœˆé¡µé¢ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('æœ‹å‹åœˆç”Ÿæˆå¤±è´¥:', error);
                showMomentsError();
            }
        }
        
        // ç»‘å®šæœ‹å‹åœˆäº¤äº’äº‹ä»¶
        function bindMomentsEvents(momentsUI) {
            // å…³é—­æœ‹å‹åœˆ
            const closeBtn = momentsUI.querySelector('#closeMoments');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    momentsUI.remove();
                });
            }
            
            // ä¿å­˜æˆªå›¾åŠŸèƒ½
            const saveBtn = momentsUI.querySelector('#saveScreenshot');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    // ç®€åŒ–ç‰ˆä¿å­˜åŠŸèƒ½
                    const alert = document.createElement('div');
                    alert.className = 'fixed top-4 left-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    alert.textContent = 'ğŸ“± æˆªå›¾ä¿å­˜åŠŸèƒ½å·²è§¦å‘ï¼ˆæ¨¡æ‹Ÿï¼‰';
                    document.body.appendChild(alert);
                    
                    setTimeout(() => alert.remove(), 2000);
                });
            }
        }
        
        // æœ‹å‹åœˆé”™è¯¯å¤„ç†
        function showMomentsError() {
            const errorMessage = {
                type: "system",
                text: "ğŸ˜… æœ‹å‹åœˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†ä½ çš„ã€Šé™‹å®¤é“­ã€‹åˆ›ä½œä½“éªŒå·²ç»å®Œæˆï¼æ„Ÿè°¢å‚ä¸è¿™æ¬¡è·¨è¶Šæ—¶ç©ºçš„æ–‡å­¦ä¹‹æ—…ã€‚"
            };
            appendMessage(errorMessage, true);
        }

        // æ¸¸æˆç»“æŸï¼ˆä¿®æ”¹ç‰ˆï¼‰
        function endGame() {
            setTimeout(async () => {
                const endMessage = {
                    type: "system",
                    text: "ğŸ‰ æ­å–œä½ å®Œæˆäº†ã€Šé™‹å®¤é“­ã€‹çš„åˆ›ä½œä½“éªŒï¼\n\nğŸ’« ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸“å±æœ‹å‹åœˆï¼Œåˆ†äº«è¿™æ¬¡è·¨è¶Šæ—¶ç©ºçš„æ–‡å­¦ä¹‹æ—…..."
                };
                await appendMessage(endMessage, true);
                
                // 2ç§’åç”Ÿæˆæœ‹å‹åœˆ
                setTimeout(() => {
                    generateMomentsPage();
                }, 2000);
                
            }, 1000);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // ç›´æ¥å¼€å§‹æ¸¸æˆï¼Œä¸æ˜¾ç¤ºAIåŠŸèƒ½æç¤º
            displayMessages(gameScript["0"].messages);
        }

        // CSPé¢„æµ‹è¯•åŠŸèƒ½
        async function testApiConnection() {
            const testApiBtn = document.getElementById('testApiBtn');
            const apiStatus = document.getElementById('apiStatus');
            const apiTestResult = document.getElementById('apiTestResult');
            const startGameBtn = document.getElementById('startGameBtn');
            
            // å¼€å§‹æµ‹è¯•
            testApiBtn.disabled = true;
            testApiBtn.textContent = 'æµ‹è¯•ä¸­...';
            apiStatus.innerHTML = '<span class="text-blue-500">ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...</span>';
            
            try {
                // è¿›è¡Œå®é™…çš„Poe AIæµ‹è¯•è°ƒç”¨
                const testResponse = await callPoeAI("è¯·å›å¤'è¿æ¥æˆåŠŸ'å››ä¸ªå­—", {
                    temperature: 0.1,
                    maxTokens: 10
                });
                
                // æµ‹è¯•æˆåŠŸ
                apiStatus.innerHTML = '<span class="text-green-500">âœ… è¿æ¥æˆåŠŸ</span>';
                apiTestResult.className = 'mt-3 text-sm text-green-600 bg-green-50 p-3 rounded block';
                apiTestResult.textContent = `âœ¨ AIå¢å¼ºåŠŸèƒ½å·²å°±ç»ªï¼å“åº”å†…å®¹ï¼š"${testResponse}"`;
                
                // å¯ç”¨å¼€å§‹æ¸¸æˆæŒ‰é’®
                startGameBtn.disabled = false;
                startGameBtn.className = startGameBtn.className.replace('opacity-50 cursor-not-allowed', 'hover:scale-105');
                const startText = startGameBtn.parentElement.querySelector('p');
                if (startText) {
                    startText.textContent = 'ğŸ® AIåŠŸèƒ½å·²æ¿€æ´»ï¼Œå¼€å§‹æ‚¨çš„ã€Šé™‹å®¤é“­ã€‹ä¹‹æ—…';
                }
                
                testApiBtn.textContent = 'é‡æ–°æµ‹è¯•';
                testApiBtn.disabled = false;
                
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                
                // æµ‹è¯•å¤±è´¥ï¼Œä½†ä»å…è®¸æ¸¸æˆè¿›è¡Œ
                apiStatus.innerHTML = '<span class="text-orange-500">âš ï¸ éƒ¨åˆ†åŠŸèƒ½å—é™</span>';
                apiTestResult.className = 'mt-3 text-sm text-orange-600 bg-orange-50 p-3 rounded block';
                apiTestResult.innerHTML = `
                    <div class="mb-2">âš ï¸ AIå¢å¼ºåŠŸèƒ½è¿æ¥å¤±è´¥</div>
                    <div class="text-xs text-gray-600 mb-2">é”™è¯¯ä¿¡æ¯ï¼š${error.message}</div>
                    <div class="text-sm">ğŸ’¡ æ¸¸æˆä»å¯æ­£å¸¸è¿›è¡Œï¼Œä½†ä¼šä½¿ç”¨é¢„åˆ¶å¯¹è¯å†…å®¹</div>
                `;
                
                // ç¦ç”¨AIåŠŸèƒ½ä½†å…è®¸æ¸¸æˆç»§ç»­
                AI_FEATURES.enabled = false;
                AI_FEATURES.textVariants = false;
                AI_FEATURES.textAnnotation = false;
                
                // å¯ç”¨å¼€å§‹æ¸¸æˆæŒ‰é’®
                startGameBtn.disabled = false;
                startGameBtn.className = startGameBtn.className.replace('opacity-50 cursor-not-allowed', 'hover:scale-105');
                const startText = startGameBtn.parentElement.querySelector('p');
                if (startText) {
                    startText.textContent = 'ğŸ® ä½¿ç”¨é¢„åˆ¶å†…å®¹æ¨¡å¼å¼€å§‹æ¸¸æˆ';
                }
                
                testApiBtn.textContent = 'é‡æ–°æµ‹è¯•';
                testApiBtn.disabled = false;
            }
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–å…¸æ•…è§£é‡ŠåŠŸèƒ½
            initTextAnnotation();
            
            // ç»‘å®šAPIæµ‹è¯•æŒ‰é’®
            const testApiBtn = document.getElementById('testApiBtn');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', testApiConnection);
            }
            
            // å¦‚æœåœ¨æ¸¸æˆæŒ‡å—é¡µé¢ï¼Œç›‘å¬å¼€å§‹æ¸¸æˆæŒ‰é’®
            const startGameBtn = document.getElementById('startGameBtn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    // éšè—æ¸¸æˆæŒ‡å—é¡µé¢
                    const gameGuide = document.getElementById('gameGuide');
                    gameGuide.classList.add('opacity-0');
                    setTimeout(() => {
                        gameGuide.style.display = 'none';
                        startGame();
                    }, 500);
                });
            } else {
                startGame();
            }
        });
    </script>
</body>
</html>
