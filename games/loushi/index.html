<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陋室雅集 (AI增强版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'wechat-green': '#07C160',
                        'wechat-bg': '#EDEDED',
                        'wechat-dark-bg': '#111111',
                        'bubble-self': '#95EC69',
                        'bubble-self-dark': '#2B7D39',
                        'bubble-other': '#FFFFFF',
                        'bubble-other-dark': '#2C2C2C',
                    },
                    fontFamily: {
                        'song': ['SimSun', 'serif'],
                    }
                }
            }
        };
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .message-bubble {
            position: relative;
            max-width: 96%;
            word-wrap: break-word;
            white-space: normal;
            text-align: left;
            line-height: 1.4;
            font-size: 16px;
            text-indent: 0 !important;
            padding: 12px 16px !important;
            margin-left: 0 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        .message-bubble * {
            text-indent: 0 !important;
            margin-left: 0 !important;
        }
        
        .message-bubble.self:after {
            content: '';
            position: absolute;
            right: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: #95EC69;
            border-right: 0;
            margin-top: -10px;
            margin-right: 0px;
        }
        
        .message-bubble.other:after {
            content: '';
            position: absolute;
            left: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: #FFF;
            border-left: 0;
            margin-top: -10px;
            margin-left: 0px;
        }

        /* AI增强功能样式 */
        .ai-variant-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* 竹林雅致风格样式 */
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        
        /* 古典卷轴样式的按钮 */
        .scroll-button {
            position: relative;
            background: linear-gradient(135deg, #F4F1E8, #E8E5D7);
            border: 3px solid #D4AF37;
            border-radius: 15px;
            padding: 12px 30px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 18px;
            color: #8B4513;
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.7),
                0 4px 8px rgba(212, 175, 55, 0.3),
                0 0 0 1px rgba(139, 69, 19, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .scroll-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.8),
                0 6px 12px rgba(212, 175, 55, 0.4),
                0 0 0 1px rgba(139, 69, 19, 0.2);
        }
        
        .scroll-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scroll-content {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .scroll-text {
            font-weight: bold;
            margin-right: 8px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        
        .scroll-decoration {
            font-size: 20px;
            animation: bambooSway 2s ease-in-out infinite;
        }
        
        @keyframes bambooSway {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .scroll-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .scroll-button:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .calligraphy-title {
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, #4A7C59, #7FB069);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(74, 124, 89, 0.3);
            animation: titleFloat 3s ease-in-out infinite;
        }
        
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* 竹林背景 */
        .bamboo-forest {
            background: linear-gradient(to right, 
                rgba(74, 124, 89, 0.1) 0%, 
                rgba(127, 176, 105, 0.1) 50%, 
                rgba(199, 233, 180, 0.1) 100%);
            height: 100%;
            position: relative;
        }
        
        .bamboo-forest::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(74, 124, 89, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(127, 176, 105, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(199, 233, 180, 0.15) 0%, transparent 50%);
        }
        
        /* 飘落竹叶动画 - 扩大两倍尺寸，覆盖整个界面 */
        .falling-leaves {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .falling-leaves::before,
        .falling-leaves::after {
            content: '🍃';
            position: absolute;
            font-size: 32px; /* 从16px增加到32px，放大两倍 */
            animation: leafFall 8s linear infinite;
            opacity: 0.6;
        }
        
        .falling-leaves::before {
            left: 20%;
            animation-delay: -2s;
            animation-duration: 12s;
        }
        
        .falling-leaves::after {
            left: 70%;
            animation-delay: -5s;
            animation-duration: 10s;
        }
        
        /* 增加更多竹叶元素覆盖整个界面 */
        .falling-leaves::after {
            content: '🍃';
            left: 10%;
        }
        
        .falling-leaves::before {
            content: '🍃🍃';
            left: 50%;
        }
        
        /* 添加额外的竹叶伪元素通过JS创建 */
        .falling-leaves.enhanced::before {
            content: '🍃';
            left: 5%;
            animation-delay: -1s;
            animation-duration: 10s;
        }
        
        .falling-leaves.enhanced::after {
            content: '🍃';
            left: 85%;
            animation-delay: -6s;
            animation-duration: 14s;
        }
        
        @keyframes leafFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* 琢玉印章样式 */
        .seal-stamp {
            display: inline-block;
            animation: sealGlow 2s ease-in-out infinite;
        }
        
        .seal-border {
            width: 32px;
            height: 32px;
            border: 2px solid #D4AF37;
            border-radius: 4px;
            background: linear-gradient(135deg, #F4F1E8, #E8E5D7);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        }
        
        .seal-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 14px;
            color: #D4AF37;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            line-height: 0.8;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        @keyframes sealGlow {
            0%, 100% { 
                box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 4px 8px rgba(212, 175, 55, 0.5);
                transform: scale(1.05);
            }
        }
        
        /* 毛笔字效果增强 */
        .calligraphy-title::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(74, 124, 89, 0.1) 50%, transparent 70%);
            animation: brushStroke 4s ease-in-out infinite;
        }
        
        @keyframes brushStroke {
            0%, 100% { opacity: 0; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-wechat-bg min-h-screen font-sans text-gray-800 transition-colors duration-300">

    <!-- Game Guide Overlay -->
    <div id="gameGuide" class="fixed inset-0 bg-white z-50 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 py-8">
            <!-- Header with game title -->
            <div class="text-center mb-8 relative">
                <!-- 竹林背景 -->
                <div class="absolute inset-0 -z-10 opacity-10">
                    <div class="bamboo-forest"></div>
                </div>
                
                <!-- 飘落竹叶动画 -->
                <div class="falling-leaves"></div>
                
                <!-- 毛笔字标题 -->
                <h1 class="text-4xl font-bold mb-3 text-green-800 calligraphy-title">陋室雅集</h1>
                
                <!-- 制作署名和印章 -->
                <div class="mt-6 flex items-center justify-center space-x-4">
                    <div class="text-sm text-gray-500">游戏制作者：Hannah </div>
                    <div class="seal-stamp">
                        <div class="seal-border">
                            <div class="seal-text">
                                <span>琢</span>
                                <span>玉</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Game introduction -->
            <div class="mb-8 bg-gray-50 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">📜</span> 历史背景</h2>
                <p class="mb-3">公元824年,唐朝文宗时期。你将扮演刘禹锡,曾任监察御史的你因政治原因触怒权贵,被贬至安徽和州任刺史。</p>
                <p class="mb-3">初到和州,县令见你是被贬官员,暗中欲刁难于你,多次搬迁你的住所,想借此打击你的锐气...</p>
                <p>然而,真正的君子能够在逆境中保持高洁品格。你将在这段经历中创作出传世名篇《陋室铭》,阐述"外在环境不足以限制内心世界"的哲理。</p>
            </div>
            
            <!-- 游戏核心亮点 -->
            <div class="mb-8 bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
                <h2 class="text-xl font-bold mb-4 flex items-center text-green-800"><span class="mr-2">🌟</span> 游戏核心亮点</h2>
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">🎋</span> 与古代文豪面对面聊天</h3>
                        <p class="text-sm text-green-600">李白豪迈、杜甫忧民、陶渊明超脱...感受不同人生智慧的温度碰撞</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">✒️</span> 亲手创作《陋室铭》+ 大师实时点评</h3>
                        <p class="text-sm text-green-600">逐句创作千古名篇，孔子、苏轼等文豪为你的每一句诗即时赏析</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">📜</span> AI选中即释义，古文秒懂</h3>
                        <p class="text-sm text-green-600">选中任意文字自动解释典故背景，让古典文学阅读变得轻松有趣</p>
                    </div>
                    <div class="bg-gradient-to-r from-white to-green-50 p-4 rounded-lg border border-green-100 shadow-sm">
                        <h3 class="font-bold mb-2 flex items-center text-green-700"><span class="mr-2">🍃</span> 生成专属古风朋友圈</h3>
                        <p class="text-sm text-green-600">将你的文学体验转化为现代社交分享，古今穿越感拉满</p>
                    </div>
                </div>
            </div>
            

            
            <!-- API连接测试 -->
            <div id="apiTestSection" class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="font-bold mb-3 flex items-center">
                    <span class="mr-2">🔗</span> AI功能连接测试
                </h3>
                <p class="text-sm text-gray-600 mb-3">
                    为了确保最佳游戏体验，我们需要测试AI增强功能的连接状态。
                    点击下方按钮进行连接测试（可能会弹出资源确认窗口）。
                </p>
                <div class="flex items-center space-x-3">
                    <button id="testApiBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                        测试AI连接
                    </button>
                    <div id="apiStatus" class="text-sm">
                        <span class="text-gray-500">⏳ 等待测试</span>
                    </div>
                </div>
                <div id="apiTestResult" class="mt-3 text-sm hidden"></div>
            </div>

            <!-- Start button -->
            <div class="text-center">
                <button id="startGameBtn" class="scroll-button opacity-50 cursor-not-allowed" disabled>
                    <div class="scroll-content">
                        <div class="scroll-text">开始游戏</div>
                        <div class="scroll-decoration">🎋</div>
                    </div>
                </button>
                <p class="mt-3 text-sm text-gray-500">请先完成AI连接测试，然后开始游戏</p>
            </div>
        </div>
    </div>

    <!-- Progress indicator -->
    <div class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-40">
        <div id="progressBar" class="h-full bg-wechat-green transition-all duration-300" style="width: 0%"></div>
    </div>

    <!-- Status bar -->
    <div class="fixed top-0 left-0 right-0 h-6 bg-white text-black text-sm font-medium flex items-center justify-between px-4 z-50">
        <div class="flex items-center">
            <span>20:15</span>
        </div>
        <div class="flex items-center space-x-1">
            <span class="text-xs">5G</span>
            <div class="w-6 h-3 border border-black rounded-sm relative">
                <div class="w-4 h-2 bg-green-500 rounded-sm absolute top-0.5 left-0.5"></div>
            </div>
        </div>
    </div>

    <!-- Chat header -->
    <header class="sticky top-6 z-40 bg-gray-100 px-4 py-3 flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-lg font-medium text-black">陋室雅集 (18)</h1>
            <p class="text-xs text-gray-500">17人在线 | ✨ AI增强</p>
        </div>
    </header>

    <!-- Chat container -->
    <div id="chatContainer" class="pb-32 pt-32 px-3 bg-gray-50">
        <!-- Messages will be added here dynamically -->
    </div>

    <!-- Options container -->
    <div id="optionsContainer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 pb-16 transition-all duration-300 transform translate-y-full">
        <div id="optionsList" class="flex flex-col space-y-2">
            <!-- Options will be added here dynamically -->
        </div>
    </div>

    <!-- "Typing" indicator -->
    <div id="typingIndicator" class="fixed bottom-20 left-3 bg-gray-200 text-gray-500 rounded-full px-3 py-1 text-sm opacity-0 transition-opacity duration-300">
        有人正在输入...
    </div>

    <!-- Wechat-style Input area -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-3 py-2">
        <div class="flex items-center">
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                </svg>
            </button>
            
            <div class="flex-1 bg-gray-100 rounded-full mx-2 relative">
                <input id="userInput" type="text" placeholder="点击此处继续..."
                    class="w-full rounded-full px-4 py-2 bg-transparent focus:outline-none text-base text-gray-400"
                    disabled readonly>
            </div>
            
            <button class="w-8 h-8 mr-2 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                😊
            </button>
            
            <button class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ====== AI增强功能配置 ======
        
        // DeepSeek API 配置
        const DEEPSEEK_CONFIG = {
            apiKey: 'sk-68d5fcdb01644b11896aaf0ddfd74cc9',
            baseURL: 'https://api.deepseek.com/v1',
            model: 'deepseek-chat',
            maxTokens: 1000,
            temperature: 0.8
        };

        // DeepSeek API 调用函数
        async function callDeepSeekAPI(prompt, options = {}) {
            console.log('🤖 尝试调用 DeepSeek API');
            console.log('请求URL:', `${DEEPSEEK_CONFIG.baseURL}/chat/completions`);
            
            try {
                const requestBody = {
                    model: DEEPSEEK_CONFIG.model,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: options.maxTokens || DEEPSEEK_CONFIG.maxTokens,
                    temperature: options.temperature || DEEPSEEK_CONFIG.temperature,
                    stream: false
                };
                
                console.log('请求体:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`${DEEPSEEK_CONFIG.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DeepSeek API 错误响应:', errorText);
                    throw new Error(`DeepSeek API 请求失败 (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('DeepSeek API 响应:', data);
                
                if (!data.choices || data.choices.length === 0) {
                    throw new Error('DeepSeek API 返回空的 choices 数组');
                }
                
                if (!data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('DeepSeek API 返回消息格式错误');
                }

                const result = data.choices[0].message.content.trim();
                console.log('✅ DeepSeek API 调用成功，响应长度:', result.length);
                console.log('✅ 响应内容预览:', result.substring(0, 100) + '...');
                return result;
                
            } catch (error) {
                console.error('❌ DeepSeek API 调用详细错误:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // 检查是否是网络错误
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('网络连接失败，请检查网络设置');
                }
                
                // 检查是否是CORS错误
                if (error.message.includes('CORS')) {
                    throw new Error('跨域请求被阻止，请在Poe环境中运行');
                }
                
                throw error;
            }
        }

        // ====== 全局统一别名库 ======
        const GLOBAL_CHARACTER_ALIASES = {
            // 1. 孔子 (Confucius) - 名:丘, 字:仲尼
            "丘": "confucius",
            "仲尼": "confucius",
            "孔仲尼": "confucius",
            "夫子": "confucius",
            "孔夫子": "confucius",
            "尼父": "confucius",
            "至圣": "confucius",
            "至圣先师": "confucius",
            "万世师表": "confucius",
            
            // 2. 曾子 (Zengzi) - 名:参(shēn), 字:子舆
            "参": "zengzi",
            "曾参": "zengzi",
            "子舆": "zengzi",
            "曾子舆": "zengzi",
            "曾子": "zengzi",
            "宗圣": "zengzi",
            
            // 3. 颜回 (Yan Hui) - 名:回, 字:子渊
            "回": "yanhuei",
            "子渊": "yanhuei",
            "颜子渊": "yanhuei",
            "颜子": "yanhuei",
            "颜渊": "yanhuei",
            "复圣": "yanhuei",
            
            // 4. 老子 (Laozi) - 姓:李, 名:耳, 字:聃
            "李耳": "laozi",
            "聃": "laozi",
            "老聃": "laozi",
            "老子": "laozi",
            "太上老君": "laozi",
            
            // 5. 李清照 (Li Qingzhao) - 号:易安居士
            "易安": "liqingzhao",
            "易安居士": "liqingzhao",
            "李易安": "liqingzhao",
            "清照": "liqingzhao",
            "千古第一才女": "liqingzhao",
            "词中之后": "liqingzhao",
            
            // 6. 苏轼 (Su Shi) - 字:子瞻, 号:东坡居士
            "子瞻": "sushi",
            "苏子瞻": "sushi",
            "东坡": "sushi",
            "苏东坡": "sushi",
            "东坡居士": "sushi",
            "苏仙": "sushi",
            "坡仙": "sushi",
            
            // 7. 杨雄 (Yang Xiong) - 字:子云
            "子云": "yangxiong",
            "杨子云": "yangxiong",
            "扬子": "yangxiong",
            "扬子云": "yangxiong",
            "杨雄": "yangxiong",
            
            // 8. 刘禹锡 (Liu Yuxi) - 字:梦得
            "梦得": "liuyuxi",
            "刘梦得": "liuyuxi",
            "刘宾客": "liuyuxi",
            "诗豪": "liuyuxi",
            
            // 9. 李白 (Li Bai) - 字:太白, 号:青莲居士
            "太白": "libai",
            "李太白": "libai",
            "青莲居士": "libai",
            "李翰林": "libai",
            "诗仙": "libai",
            "谪仙": "libai",
            "谪仙人": "libai",
            "酒仙": "libai",
            
            // 10. 杜甫 (Du Fu) - 字:子美, 号:少陵野老
            "子美": "du",
            "杜子美": "du",
            "少陵野老": "du",
            "杜少陵": "du",
            "杜工部": "du",
            "诗圣": "du",
            "老杜": "du",
            
            // 11. 王维 (Wang Wei) - 字:摩诘, 号:摩诘居士
            "摩诘": "wangwei",
            "王摩诘": "wangwei",
            "摩诘居士": "wangwei",
            "王右丞": "wangwei",
            "诗佛": "wangwei",
            
            // 12. 陶渊明 (Tao Yuanming) - 名:潜, 字:元亮, 号:五柳先生
            "陶潜": "tao",
            "潜": "tao",
            "元亮": "tao",
            "陶元亮": "tao",
            "五柳先生": "tao",
            "靖节先生": "tao",
            "陶靖节": "tao",
            "隐逸诗人之宗": "tao",
            
            // 13. 白居易 (Bai Juyi) - 字:乐天, 号:香山居士
            "乐天": "baijuyi",
            "白乐天": "baijuyi",
            "香山居士": "baijuyi",
            "白傅": "baijuyi",
            "白文公": "baijuyi",
            "诗魔": "baijuyi",
            "醉吟先生": "baijuyi",
            
            // 14. 柳宗元 (Liu Zongyuan) - 字:子厚
            "子厚": "liuzongyuan",
            "柳子厚": "liuzongyuan",
            "柳河东": "liuzongyuan",
            "柳柳州": "liuzongyuan",
            "柳宗元": "liuzongyuan",
            
            // 诸葛亮 (ZhuGe Liang) - 字:孔明
            "孔明": "zhugeliang",
            "诸葛孔明": "zhugeliang",
            "卧龙": "zhugeliang",
            "武侯": "zhugeliang",
            "诸葛武侯": "zhugeliang",
            "亮": "zhugeliang",
            
            // 其他常见称呼
            "先生": "confucius", // 默认指向孔子
            "老师": "confucius", // 默认指向孔子
            "圣人": "confucius", // 默认指向孔子
            "才女": "liqingzhao", // 默认指向李清照
            "女词人": "liqingzhao", // 默认指向李清照
            "丞相": "zhugeliang", // 默认指向诸葛亮
            "军师": "zhugeliang" // 默认指向诸葛亮
        };

        // ====== 统一别名解析函数 ======
        function resolveCharacterAlias(alias) {
            console.log(`🔍 解析别名: "${alias}"`);
            
            // 1. 精确匹配人物全名（最高优先级）
            for (const [id, personality] of Object.entries(aiPersonalities)) {
                if (personality.name === alias) {
                    console.log(`✅ 精确匹配人物全名: ${personality.name} (${id})`);
                    return id;
                }
            }
            
            // 2. 精确匹配人物ID
            if (aiPersonalities[alias]) {
                console.log(`✅ 精确匹配人物ID: ${aiPersonalities[alias].name} (${alias})`);
                return alias;
            }
            
            // 3. 全局别名库匹配
            if (GLOBAL_CHARACTER_ALIASES[alias]) {
                const matchedId = GLOBAL_CHARACTER_ALIASES[alias];
                console.log(`✅ 别名匹配成功: "${alias}" → ${aiPersonalities[matchedId]?.name || matchedId} (${matchedId})`);
                return matchedId;
            }
            
            // 4. 部分名字匹配
            for (const [id, personality] of Object.entries(aiPersonalities)) {
                if (personality.name.includes(alias) || alias.includes(personality.name)) {
                    console.log(`🔍 部分名字匹配: ${personality.name} (${id})`);
                    return id;
                }
            }
            
            console.log(`❌ 未找到匹配: "${alias}"`);
            return null;
        }

        // ====== AI人格模板系统 ======
        const aiPersonalities = {
            "confucius": {
                name: "孔子", period: "春秋时期", 
                background: "儒家学派创始人，周游列国十四年传播仁政思想，晚年返鲁专心教学著述",
                personality: "温文尔雅，循循善诱，严于律己，重视礼制秩序，强调道德修养",
                language_style: "温和而有威严，喜用反问、比喻，言简意赅，富含哲理",
                key_concepts: ["仁", "礼", "德", "君子", "修身", "齐家", "治国"],
                classic_quotes: ["君子居之，何陋之有", "德不孤，必有邻", "己所不欲，勿施于人"],
                speech_habits: ["常用'君子'开头", "喜用'...乎？'疑问句", "对年轻人用'汝'、'子'称呼"],
                interaction_style: "面对逆境强调君子固穷，从道德修养角度给予指导"
            },
            "tao": {
                name: "陶渊明", period: "东晋时期",
                background: "东晋诗人，曾任彭泽县令，不为五斗米折腰，辞官归隐田园，开创田园诗派",
                personality: "淡泊名利，向往自然，安贫乐道，追求精神自由，性情恬淡而坚定",
                language_style: "朴实自然，清新淡雅，常用田园意象，语调平和而坚定",
                key_concepts: ["归隐", "田园", "自然", "真朴", "无为", "桃花源"],
                classic_quotes: ["不为五斗米折腰", "采菊东篱下，悠然见南山", "归去来兮"],
                speech_habits: ["常提田园生活", "用自然比喻", "语调平和", "称人为'君'、'兄'"],
                interaction_style: "劝人看淡名利，强调内心平静胜过外在繁华"
            },
            "libai": {
                name: "李白", period: "盛唐时期",
                background: "唐代浪漫主义诗人，曾入长安供奉翰林，后遭谗言离京，漫游天下，诗风豪放飘逸",
                personality: "豪放不羁，傲视权贵，热爱自由，情感丰富，酒仙诗仙，狂而不妄",
                language_style: "豪迈奔放，激情澎湃，善用夸张想象，语言流畅自然，气势恢宏",
                key_concepts: ["自由", "理想", "豪迈", "浪漫", "友情", "仙道"],
                classic_quotes: ["天生我材必有用", "仰天大笑出门去", "安能摧眉折腰事权贵"],
                speech_habits: ["'哈哈哈'开头", "用'君'、'兄'称呼", "常提酒和月", "即兴吟诗"],
                interaction_style: "豪迈乐观，用酒和诗排解愁绪，强调天生我材必有用"
            },
            "du": {
                name: "杜甫", period: "盛唐时期",
                background: "唐代现实主义诗人，亲历安史之乱，一生颠沛流离，深切关注民生疾苦",
                personality: "忧国忧民，刚正不阿，感情深沉，社会责任感强，虽困顿不失理想",
                language_style: "沉郁顿挫，情真意切，常用对比和细节描写，语言朴实而深刻",
                key_concepts: ["忧国", "忧民", "社稷", "苍生", "现实", "责任"],
                classic_quotes: ["安得广厦千万间", "位卑未敢忘忧国", "朱门酒肉臭，路有冻死骨"],
                speech_habits: ["常叹息", "用'吾'、'我'自称", "引用时事", "语调沉重而坚定"],
                interaction_style: "从民生社稷角度分析问题，强调读书人的社会责任"
            },
            "wangwei": {
                name: "王维", period: "盛唐时期",
                background: "唐代诗人画家，山水田园诗派代表，安史乱后隐居辋川，诗中有画画中有诗",
                personality: "恬静淡泊，富有禅意，擅长诗画，内心宁静，追求禅宗境界",
                language_style: "清新自然，意境深远，富有禅意，语言简洁而韵味无穷",
                key_concepts: ["禅意", "山水", "空灵", "静观", "自然", "顿悟"],
                classic_quotes: ["行到水穷处，坐看云起时", "空山不见人，但闻人语响"],
                speech_habits: ["语调平静", "常用禅宗术语", "善用山水比喻", "话语简洁深刻"],
                interaction_style: "从禅宗角度开导，强调境由心转，以静制动"
            },
            "sushi": {
                name: "苏轼", period: "北宋时期",
                background: "北宋文学家，三苏之一，曾三次被贬，豁达乐观，诗词文书画无不精通",
                personality: "豁达乐观，机智幽默，多才多艺，在逆境中保持积极态度",
                language_style: "幽默风趣，富有哲理，善用比喻，语言生动活泼",
                key_concepts: ["豁达", "乐观", "变通", "多才", "美食", "人生如梦"],
                classic_quotes: ["人生如逆旅，我亦是行人", "回首向来萧瑟处，归去，也无风雨也无晴"],
                speech_habits: ["爱开玩笑", "常提美食", "用'刘兄'称呼", "语调轻松愉快"],
                interaction_style: "用幽默化解困境，强调换个角度看问题，人生起伏正常"
            },
            "liqingzhao": {
                name: "李清照", period: "两宋之际",
                background: "宋代女词人，婉约派代表，经历北宋灭亡和丧夫之痛，词风由欢快转为悲凉",
                personality: "才华横溢，性格刚烈，虽为女子但有强烈的家国意识和个人尊严",
                language_style: "婉约细腻，情真意切，用词精准，既有女性柔美又有刚烈气节",
                key_concepts: ["才女", "坚强", "家国", "情感", "词韵", "女性尊严"],
                classic_quotes: ["生当作人杰，死亦为鬼雄", "寻寻觅觅，冷冷清清，凄凄惨惨戚戚"],
                speech_habits: ["自称'小女子'但语气坚定", "常引词作", "用词精美", "敢于直言"],
                interaction_style: "以女性视角给予建议，强调在困境中也要保持尊严和骨气"
            },
            "yanhuei": {
                name: "颜回", period: "春秋时期",
                background: "孔子最得意弟子，安贫乐道的典型，一箪食一瓢饮居陋巷而不改其乐",
                personality: "品德高尚，好学深思，安贫乐道，不迁怒不贰过",
                language_style: "谦逊有礼，言语简洁，富有哲理，体现儒家君子风范",
                key_concepts: ["好学", "安贫", "乐道", "德行", "修身", "师道"],
                classic_quotes: ["一箪食，一瓢饮，在陋巷，人不堪其忧，回也不改其乐"],
                speech_habits: ["常说'弟子'自称", "引用老师教诲", "语调恭敬", "话语简练"],
                interaction_style: "以自身安贫乐道经历劝慰，强调内心充实胜过外在丰富"
            },
            "zhugeliang": {
                name: "诸葛亮", period: "三国时期",
                background: "蜀汉丞相，隆中对策确定三分天下，鞠躬尽瘁死而后已，智谋超群",
                personality: "忠诚智慧，谨慎务实，以天下为己任，淡泊明志宁静致远",
                language_style: "深谋远虑，条理清晰，常用策略分析，语言精准有力",
                key_concepts: ["忠诚", "智谋", "淡泊", "致远", "天下", "策略"],
                classic_quotes: ["非淡泊无以明志，非宁静无以致远", "鞠躬尽瘁，死而后已"],
                speech_habits: ["分析透彻", "常用'亮以为'", "称人为'君'", "语调沉稳"],
                interaction_style: "从战略角度分析局势，强调以退为进，淡泊明志"
            },
            "baijuyi": {
                name: "白居易", period: "中唐时期",
                background: "唐代诗人，曾贬江州司马，与刘禹锡并称刘白，主张文章合为时而著",
                personality: "同情民生，关注现实，性格温和，善于用诗歌反映社会问题",
                language_style: "平易近人，通俗易懂，情感真挚，善于叙事",
                key_concepts: ["民生", "现实", "同情", "贬谪", "琵琶", "同病相怜"],
                classic_quotes: ["同是天涯沦落人，相逢何必曾相识", "文章合为时而著，歌诗合为事而作"],
                speech_habits: ["常叹'同病相怜'", "提及贬谪经历", "语调感慨", "用'兄'称呼"],
                interaction_style: "以同样贬谪经历感同身受，强调文人的社会使命"
            },
            "zengzi": {
                name: "曾子", period: "春秋时期",
                background: "孔子弟子，以孝闻名，传承儒家道统，著有《大学》《孝经》",
                personality: "孝顺谨慎，治学严谨，重视品德修养，强调内省和传承",
                language_style: "严谨朴实，重视教育，常引经据典，语调庄重",
                key_concepts: ["孝道", "修身", "传承", "内省", "三省", "治学"],
                classic_quotes: ["吾日三省吾身", "士不可以不弘毅，任重而道远"],
                speech_habits: ["常说'参以为'", "引用圣贤教诲", "强调修身", "语调诚恳"],
                interaction_style: "强调日日内省和修身，以传承圣道为己任"
            },
            "yangxiong": {
                name: "杨雄", period: "西汉时期",
                background: "西汉文学家思想家，著有《法言》《太玄》，模拟《论语》《易经》体例",
                personality: "博学深思，追求圣贤之道，重视著述立言，性格内敛专注",
                language_style: "古雅深奥，善用典故，模仿先秦文风，语言严谨",
                key_concepts: ["法言", "圣道", "著述", "立言", "修性", "治学"],
                classic_quotes: ["学者，所以修性也", "书不尽言，言不尽意"],
                speech_habits: ["常说'雄以为'", "引用经典", "语言古雅", "谈论学问"],
                interaction_style: "从学问和著述角度劝慰，强调立言传世的价值"
            }
        };

        // AI功能增强：重新启用API调用，支持灵活多轮对话
        const AI_FEATURES = {
            textVariants: true,     // 启用文本变体
            textAnnotation: true,   // 启用典故解释
            enabled: true           // 主开关：启用AI功能
        };

        // API调用控制系统
        const dialogueControls = {
            // 每个文人的对话次数限制
            maxDialoguesPerCharacter: 3,
            
            // 每个环境的总AI调用次数限制
            maxAICallsPerEnvironment: 8,
            
            // 当前状态跟踪
            currentUsage: {
                characterDialogues: {}, // {characterId: count}
                environmentCalls: {},   // {environment: count}
                totalAICalls: 0        // 总AI调用次数
            },
            
            // 检查是否可以进行AI调用
            canMakeAICall: function(characterId, environment = null) {
                const charCount = this.currentUsage.characterDialogues[characterId] || 0;
                const envCount = environment ? (this.currentUsage.environmentCalls[environment] || 0) : 0;
                
                // 检查角色对话次数限制
                if (charCount >= this.maxDialoguesPerCharacter) {
                    console.log(`角色 ${characterId} 已达到对话次数限制 (${charCount}/${this.maxDialoguesPerCharacter})`);
                    return false;
                }
                
                // 检查环境AI调用次数限制
                if (environment && envCount >= this.maxAICallsPerEnvironment) {
                    console.log(`环境 ${environment} 已达到AI调用次数限制 (${envCount}/${this.maxAICallsPerEnvironment})`);
                    return false;
                }
                
                return true;
            },
            
            // 记录AI调用
            recordAICall: function(characterId, environment = null) {
                // 增加角色对话计数
                this.currentUsage.characterDialogues[characterId] = 
                    (this.currentUsage.characterDialogues[characterId] || 0) + 1;
                
                // 增加环境计数
                if (environment) {
                    this.currentUsage.environmentCalls[environment] = 
                        (this.currentUsage.environmentCalls[environment] || 0) + 1;
                }
                
                // 增加总计数
                this.currentUsage.totalAICalls++;
                
                console.log('记录AI调用', {
                    character: characterId,
                    environment,
                    charCount: this.currentUsage.characterDialogues[characterId],
                    envCount: environment ? this.currentUsage.environmentCalls[environment] : 0,
                    totalCalls: this.currentUsage.totalAICalls
                });
            },
            
            // 获取使用情况报告
            getUsageReport: function() {
                return {
                    characterDialogues: { ...this.currentUsage.characterDialogues },
                    environmentCalls: { ...this.currentUsage.environmentCalls },
                    totalAICalls: this.currentUsage.totalAICalls,
                    limits: {
                        maxDialoguesPerCharacter: this.maxDialoguesPerCharacter,
                        maxAICallsPerEnvironment: this.maxAICallsPerEnvironment
                    }
                };
            }
        };

        // ====== 高级文人互动机制 ======
        const characterInteractions = {
            // 关系网络定义
            relationships: {
                // 师生关系：孔子-颜回
                "confucius_yanhuei": {
                    type: "师生",
                    keywords: ["孔子", "夫子", "老师", "师生", "颜回", "弟子", "教诲"],
                    emotionalBond: "深厚的师生情",
                    reactionProbability: 0.8, // 高触发概率
                    aiPromptContext: "师生间的温暖互动，体现儒家教育的人文关怀",
                    presetReactions: {
                        "confucius": [
                            "谈起回，老夫心中甚慰。'回也不愚'，他虽早逝，但其品德至今为人称颂。",
                            "回之德行，确是众弟子之楷模。'一箪食，一瓢饮，人不堪其忧，回也不改其乐'。"
                        ],
                        "yanhuei": [
                            "能得夫子如此赞誉，回虽死也无憾。夫子教诲之恩，回终生不忘。",
                            "夫子常说回不愚，其实回深知自己愚钝，全赖夫子教导才有今日之德行。"
                        ]
                    }
                },
                
                // 挚友关系：李白-杜甫
                "libai_du": {
                    type: "挚友",
                    keywords: ["李白", "杜甫", "太白", "子美", "友谊", "诗酒", "梁宋", "洛阳"],
                    emotionalBond: "惺惺相惜的诗人友谊",
                    reactionProbability: 0.7,
                    aiPromptContext: "两位诗人的深厚友谊，体现文人之间的精神共鸣",
                    presetReactions: {
                        "libai": [
                            "哈哈！说起子美，那是我一生的挚友！当年我们在洛阳相遇，一见如故，后来同游梁宋，把酒论诗，何等快哉！",
                            "子美啊，虽然我们风格不同，他忧国忧民，我逍遥自在，但这份友谊却是真挚的。'醉眠秋共被，携手日同行'！"
                        ],
                        "du": [
                            "太白兄！提起太白，我心中满怀思念。他如天上谪仙，我如地上苦吟，然我们相知相重，这份友谊胜过千金！",
                            "记得当年我们同游梁宋，太白总是豪饮狂歌，我则在一旁感慨。虽性情不同，但诗心相通，此生有此友，足矣！"
                        ]
                    }
                },
                
                // 精神知音：陶渊明-王维
                "tao_wangwei": {
                    type: "精神知音",
                    keywords: ["隐居", "田园", "山水", "自然", "禅意", "归隐", "清净"],
                    emotionalBond: "跨越时空的精神共鸣",
                    reactionProbability: 0.6,
                    aiPromptContext: "隐逸诗人之间的心灵相通，体现对自然和内心宁静的追求",
                    presetReactions: {
                        "tao": [
                            "虽与摩诘生不同时，但读其诗句，深感相通。'行到水穷处，坐看云起时'，这种心境与我'悠然见南山'何其相似！",
                            "摩诘诗中有画，画中有诗，我虽不善画，但对那份山水情怀，却是深有同感。"
                        ],
                        "wangwei": [
                            "陶公归隐之举，实为我辈楷模。虽相隔数百年，但那份对自然的向往，对纯真的追求，古今相通。",
                            "'采菊东篱下，悠然见南山'，此等境界，正是我辋川别业所追求的禅意生活。"
                        ]
                    }
                },
                
                // 同门情谊：孔子-曾子
                "confucius_zengzi": {
                    type: "师徒",
                    keywords: ["孔子", "曾子", "孝道", "传承", "大学", "三省"],
                    emotionalBond: "道统传承的师徒关系",
                    reactionProbability: 0.7,
                    aiPromptContext: "儒家道统的传承关系，体现师道的延续",
                    presetReactions: {
                        "confucius": [
                            "参啊，汝能传我道于后世，实乃大功德。'吾道一以贯之'，汝已得其要领。"
                        ],
                        "zengzi": [
                            "参得夫子真传，当竭力传于后学。'士不可以不弘毅，任重而道远'。"
                        ]
                    }
                },
                
                // 同病相怜：白居易-刘禹锡（游戏中的特殊关系）
                "baijuyi_liuyuxi": {
                    type: "同病相怜",
                    keywords: ["贬谪", "江州", "和州", "沦落", "同病", "琵琶"],
                    emotionalBond: "共同遭遇贬谪的同情",
                    reactionProbability: 0.9,
                    aiPromptContext: "两位被贬诗人的相互理解和同情",
                    presetReactions: {
                        "baijuyi": [
                            "梦得兄！同是天涯沦落人，相逢何必曾相识！我当年贬江州司马，深知此中滋味。",
                            "我写《琵琶行》时，正是感慨'同是天涯沦落人'。今见梦得境遇，更添同病相怜之感。"
                        ]
                    }
                },
                
                // 对立观点：李白-孔子（逍遥vs规范）
                "libai_confucius": {
                    type: "观点对立",
                    keywords: ["逍遥", "规范", "礼制", "自由", "束缚"],
                    emotionalBond: "思想观念的分歧",
                    reactionProbability: 0.5,
                    aiPromptContext: "自由精神与礼制规范的思想碰撞",
                    presetReactions: {
                        "libai": [
                            "夫子虽贤，然其礼制过严。我本楚狂人，凤歌笑孔丘！人生在世，当求自在逍遥。"
                        ],
                        "confucius": [
                            "太白才高，然过于放诞。君子当克己复礼，方能成就大德。"
                        ]
                    }
                }
            },
            
            // 多层次触发检测
            checkInteraction: function(currentCharacter, spokenText, availableCharacters, gameContext = {}) {
                const interactions = [];
                
                for (const [relationKey, relationData] of Object.entries(this.relationships)) {
                    const [char1, char2] = relationKey.split('_');
                    
                    // 检查角色是否可用
                    const otherCharacter = currentCharacter === char1 ? char2 : 
                                         currentCharacter === char2 ? char1 : null;
                    
                    if (!otherCharacter || !availableCharacters.includes(otherCharacter)) {
                        continue;
                    }
                    
                    // 多重触发条件检测
                    const triggerScore = this.calculateTriggerScore(
                        relationData, spokenText, currentCharacter, gameContext
                    );
                    
                    if (triggerScore >= 0.3) { // 触发阈值
                        const shouldTrigger = Math.random() < relationData.reactionProbability * triggerScore;
                        
                        if (shouldTrigger) {
                            interactions.push({
                                respondingCharacter: otherCharacter,
                                relationshipType: relationData.type,
                                triggerScore: triggerScore,
                                useAI: triggerScore > 0.7 && AI_FEATURES.enabled, // 高分使用AI
                                presetResponses: relationData.presetReactions[otherCharacter] || [],
                                aiContext: relationData.aiPromptContext
                            });
                        }
                    }
                }
                
                // 按触发分数排序，优先级高的先执行
                return interactions.sort((a, b) => b.triggerScore - a.triggerScore);
            },
            
            // 计算触发分数
            calculateTriggerScore: function(relationData, spokenText, currentCharacter, gameContext) {
                let score = 0;
                
                // 1. 关键词匹配 (基础分)
                const keywordMatches = relationData.keywords.filter(keyword => 
                    spokenText.includes(keyword)
                ).length;
                score += keywordMatches * 0.2;
                
                // 2. 情感词汇检测
                const emotionalWords = ["思念", "怀念", "敬佩", "感激", "友谊", "师恩"];
                const emotionalMatches = emotionalWords.filter(word => 
                    spokenText.includes(word)
                ).length;
                score += emotionalMatches * 0.15;
                
                // 3. 人物直接提及 (高分)
                const personalities = Object.values(aiPersonalities);
                const mentionedNames = personalities.filter(p => 
                    spokenText.includes(p.name)
                ).length;
                score += mentionedNames * 0.4;
                
                // 4. 上下文相关性
                if (gameContext.recentTopics) {
                    const topicRelevance = gameContext.recentTopics.some(topic => 
                        relationData.keywords.includes(topic)
                    );
                    if (topicRelevance) score += 0.2;
                }
                
                // 5. 特殊情境加分
                if (relationData.type === "同病相怜" && gameContext.isInAdversity) {
                    score += 0.3;
                }
                
                return Math.min(score, 1.0); // 最高1.0分
            },
            
            // 智能互动生成
            executeInteraction: async function(interaction) {
                try {
                    let responseText;
                    
                    if (interaction.useAI && dialogueControls.canMakeAICall(interaction.respondingCharacter)) {
                        // 使用AI生成个性化回应
                        responseText = await this.generateAIInteraction(interaction);
                    } else {
                        // 使用预设回应
                        responseText = this.getPresetResponse(interaction);
                    }
                    
                    return {
                        type: interaction.respondingCharacter,
                        text: responseText,
                        isInteraction: true,
                        isAIGenerated: interaction.useAI,
                        relationshipType: interaction.relationshipType
                    };
                    
                } catch (error) {
                    console.error('互动生成失败', error);
                    return this.getFallbackInteraction(interaction);
                }
            },
            
            // AI生成互动回应
            generateAIInteraction: async function(interaction) {
                const personality = aiPersonalities[interaction.respondingCharacter];
                const relationshipContext = this.relationships[
                    Object.keys(this.relationships).find(key => 
                        key.includes(interaction.respondingCharacter)
                    )
                ];
                
                const prompt = `你是${personality.name}，正在与其他历史人物对话。

当前情境：${interaction.aiContext}
关系类型：${interaction.relationshipType}
你的性格：${personality.personality}
语言风格：${personality.language_style}

刚才有人提到了与你相关的话题，请用符合你身份的方式回应。

要求：
1. 体现你与对方的${interaction.relationshipType}关系
2. 符合你的历史身份和语言风格
3. 表达要真挚自然，有情感温度
4. 字数控制在80-120字
5. 不要解释，直接说话

请回应：`;

                const response = await callPoeAI(prompt, { temperature: 0.7 });
                dialogueControls.recordAICall(interaction.respondingCharacter);
                return response;
            },
            
            // 获取预设回应
            getPresetResponse: function(interaction) {
                if (interaction.presetResponses && interaction.presetResponses.length > 0) {
                    const randomIndex = Math.floor(Math.random() * interaction.presetResponses.length);
                    return interaction.presetResponses[randomIndex];
                }
                
                // 根据关系类型生成通用回应
                const genericResponses = {
                    "师生": `${aiPersonalities[interaction.respondingCharacter].name}：师生之情，千古不变。此番交流，甚是珍贵。`,
                    "挚友": `${aiPersonalities[interaction.respondingCharacter].name}：知音难觅，今逢此友，何其幸哉！`,
                    "精神知音": `${aiPersonalities[interaction.respondingCharacter].name}：虽隔时空，心意相通，此乃精神之交也。`,
                    "同病相怜": `${aiPersonalities[interaction.respondingCharacter].name}：同是天涯沦落人，相逢何必曾相识。`,
                    "观点对立": `${aiPersonalities[interaction.respondingCharacter].name}：道不同不相为谋，然君子和而不同。`
                };
                
                return genericResponses[interaction.relationshipType] || 
                       `${aiPersonalities[interaction.respondingCharacter].name}：深有同感，言之有理。`;
            },
            
            // 降级处理
            getFallbackInteraction: function(interaction) {
                return {
                    type: interaction.respondingCharacter,
                    text: `${aiPersonalities[interaction.respondingCharacter].name}：甚有同感。`,
                    isInteraction: true,
                    isAIGenerated: false
                };
            },
            
            // 群体对话管理
            manageGroupDiscussion: function(participants, topic) {
                // 管理多人同时参与的话题讨论
                const discussionQueue = [];
                
                participants.forEach((char, index) => {
                    setTimeout(() => {
                        // 生成该角色对话题的看法
                        this.generateTopicResponse(char, topic, participants);
                    }, index * 2000); // 间隔2秒
                });
            }
        };

        // 缓存系统
        const aiCache = {
            variants: new Map(),
            annotations: new Map(),
            maxSize: 500,
            
            set(key, value, type = 'variants') {
                const cache = this[type];
                if (cache.size >= this.maxSize) {
                    // 删除最旧的缓存项
                    const firstKey = cache.keys().next().value;
                    cache.delete(firstKey);
                }
                cache.set(key, {
                    value,
                    timestamp: Date.now()
                });
            },
            
            get(key, type = 'variants') {
                const cache = this[type];
                const item = cache.get(key);
                if (!item) return null;
                
                // 缓存1小时后过期
                if (Date.now() - item.timestamp > 3600000) {
                    cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
        };

        // API调用限制器
        const apiLimiter = {
            calls: [],
            maxCallsPerMinute: 30,
            
            canMakeCall() {
                const now = Date.now();
                // 清除1分钟前的记录
                this.calls = this.calls.filter(time => now - time < 60000);
                return this.calls.length < this.maxCallsPerMinute;
            },
            
            recordCall() {
                this.calls.push(Date.now());
            }
        };

        // 预制的备用内容
        const fallbackContent = {
            annotations: {
                "陋室铭": {
                    explanation: `【释义】：刘禹锡创作的古文名篇，通过描写自己简陋的居室来表达高洁的情操
【出处】：唐代刘禹锡作，选自《全唐文》
【典故】：刘禹锡被贬和州后，县令多次刁难搬迁其住所，最后给了一间斗室，刘禹锡愤而作此铭
【用法】：以"铭"这种文体来抒发作者安贫乐道、洁身自好的情怀`
                },
                "君子居之": {
                    explanation: `【释义】：君子住在这里，有品德的人居住的地方
【出处】：出自《论语·子罕》："子欲居九夷。或曰：'陋，如之何？'子曰：'君子居之，何陋之有？'"
【典故】：孔子想住到九夷去，有人说那里环境简陋，孔子回答说君子住的地方哪里会简陋呢
【用法】：表达君子的品德能够改变环境，体现人格魅力胜过物质条件的思想`
                },
                "何陋之有": {
                    explanation: `【释义】：有什么简陋的呢？反问句式，表示一点也不简陋
【出处】：语出《论语·子罕》，后被刘禹锡引用到《陋室铭》中
【典故】：这是孔子的名言，强调君子的品德能化陋为雅
【用法】：运用反问修辞，加强语气，突出主题思想`
                }
            },
            characterResponses: {
                "tao": [
                    "梦得兄，观此江边景色，倒让我想起当年归隐田园的时光。'采菊东篱下，悠然见南山'，外在环境虽简，内心却可无比充实。",
                    "刘兄莫要为外物所扰。我当年辞官归田，邻人皆笑我愚，然三载之后，见我怡然自得，反生羡慕之心。心远地自偏，此之谓也。",
                    "这江水悠悠，正如人生际遇。'归去来兮，田园将芜胡不归？'既然无法改变处境，何不安之若素，另寻人生之乐？"
                ],
                "du": [
                    "子美深感刘兄之遭遇！我亦曾居草堂，'茅屋为秋风所破'，然心中仍念'安得广厦千万间，大庇天下寒士俱欢颜'。身处逆境，更显君子本色。",
                    "梦得兄，'位卑未敢忘忧国'，纵然被贬，我等读书人的使命不可忘却。这小小陋室，正可磨砺心志，他日必有大用。",
                    "我生逢乱世，颠沛流离，深知世事艰难。然'会当凌绝顶，一览众山小'的壮志不可泯灭。刘兄今日之困，他日必成佳话。"
                ],
                "libai": [
                    "哈哈哈！梦得兄，这点小小挫折算得了什么？我李白生平豪迈，'天生我材必有用，千金散尽还复来'！区区贬谪，何足挂齿？",
                    "刘兄且看这大江东去，多么壮阔！'黄河之水天上来，奔流到海不复回'，人生如此短暂，何不痛饮一场？来，与我共醉！",
                    "'安能摧眉折腰事权贵，使我不得开心颜'！那县令不过是个小人，我们何必与之较劲？仰天长啸，岂不快哉？"
                ],
                "confucius": [
                    "刘君，老夫观君身处困境，仍不失君子风范，深感欣慰。'君子固穷，小人穷斯滥矣'，君子当在困厄中见真章。",
                    "'德不孤，必有邻'。刘君有德，自然会有知音相伴。这陋室虽小，但有德之人居住，便不再简陋。",
                    "昔日老夫亦曾想居九夷，或人言其陋，老夫答曰：'君子居之，何陋之有？'刘君今日境遇，正可践行此理。"
                ]
            }
        };

        // 网络状态检测
        async function checkNetworkAndAPI() {
            try {
                // 简单的网络连通性测试
                const response = await fetch('https://api.deepseek.com', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return true;
            } catch (error) {
                console.warn('网络或API连接测试失败:', error);
                return false;
            }
        }

        // 通用AI调用函数（优先使用DeepSeek API）
        async function callPoeAI(prompt, options = {}) {
            if (!AI_FEATURES.enabled || !apiLimiter.canMakeCall()) {
                throw new Error('AI调用已达限制或AI功能已禁用');
            }

            apiLimiter.recordCall();

            // 优先使用 DeepSeek API
            try {
                console.log('🤖 尝试调用 DeepSeek API');
                return await callDeepSeekAPI(prompt, options);
            } catch (error) {
                console.warn('DeepSeek API 调用失败，尝试降级方案:', error);
                
                // 降级方案1: 如果在Poe环境，使用Poe API
                if (window.Poe && window.Poe.sendUserMessage) {
                    console.log('🔄 降级到 Poe API');
                    return await callPoeAPI(prompt, options);
                }
                
                // 降级方案2: 使用本地预制回应
                console.log('🔄 降级到本地预制回应');
                return generateLocalResponse(prompt);
            }
        }

        // POE平台API调用
        async function callPoeAPI(prompt, options) {
            return new Promise((resolve, reject) => {
                const handlerId = `ai_call_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const timeout = setTimeout(() => {
                    reject(new Error('AI调用超时'));
                }, 20000);
                
                window.Poe.registerHandler(handlerId, (result, context) => {
                    clearTimeout(timeout);
                    
                    if (result.status === 'error') {
                        reject(new Error(result.responses[0]?.statusText || '未知错误'));
                        return;
                    }
                    
                    if (result.status === 'complete') {
                        const response = result.responses[0];
                        if (response && response.content) {
                            console.log('Poe AI调用成功');
                            resolve(response.content.trim());
                        } else {
                            reject(new Error('AI响应为空'));
                        }
                    }
                });
                
                window.Poe.sendUserMessage(`@Claude-Sonnet-4 ${prompt}`, {
                    handler: handlerId,
                    stream: false,
                    openChat: false,
                    handlerContext: { timestamp: Date.now() }
                }).catch(error => {
                    clearTimeout(timeout);
                    reject(error);
                });
            });
        }

        // 替代AI服务调用（本地环境使用）
        async function callAlternativeAI(prompt, options) {
            // 方案1：降级到本地预制回应
            console.warn('DeepSeek API不可用，使用预制回应');
            return generateLocalResponse(prompt);
        }

        // OpenAI API调用
        async function callOpenAI(prompt, options) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_CONFIG.openai.apiKey}`
                },
                body: JSON.stringify({
                    model: AI_CONFIG.openai.model,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: options.maxTokens || 500,
                    temperature: options.temperature || 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API错误: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // 免费AI服务调用（如Hugging Face推理API）
        async function callFreeAIService(prompt, options) {
            try {
                // 使用Hugging Face免费推理API
                const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_length: options.maxTokens || 200,
                            temperature: options.temperature || 0.7
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data[0]?.generated_text || generateLocalResponse(prompt);
                }
            } catch (error) {
                console.warn('免费AI服务调用失败:', error);
            }
            
            return generateLocalResponse(prompt);
        }

        // 本地预制回应生成
        function generateLocalResponse(prompt) {
            // 简单的关键词匹配生成回应
            const responses = {
                '孔子': '君子修身，以德为本。此乃为人之道也。',
                '李白': '哈哈！人生得意须尽欢，莫使金樽空对月！',
                '杜甫': '读书万卷，下笔如有神。此句颇有深意。',
                '陶渊明': '心远地自偏，此乃真理也。外物不足挂虑。',
                '苏轼': '人生如逆旅，我亦是行人。此言甚善！',
                '赏析': '此句意境深远，用词精妙，颇有古人风范。',
                '评价': '文笔流畅，思想深刻，实为佳作。',
                '问题': '这确实是一个值得深思的问题，各人有各人的看法。'
            };

            for (const [keyword, response] of Object.entries(responses)) {
                if (prompt.includes(keyword)) {
                    return response;
                }
            }

            return '深有同感，言之有理。此乃智者之言也。';
        }

        // 增强的预制内容系统（多轮对话支持）
        const enhancedCharacterResponses = {
            // 江边环境：关于贬谪和逆境的讨论
            "riverbank_exile_discussion": {
                topic: "贬谪逆境",
                participants: ["tao", "du", "libai", "confucius"],
                rounds: [
                    {
                        speaker: "tao",
                        response: "梦得兄，我观此江边景致，倒让我想起当年彭泽归隐的情形。'采菊东篱下，悠然见南山'，外在环境虽简，内心却可无比充实。不为五斗米折腰，正是要保持内心的那份纯真啊。"
                    },
                    {
                        speaker: "du", 
                        response: "陶公言之有理，但吾观刘兄今日遭遇，更让我想起自己茅屋被秋风所破时的心境。'位卑未敢忘忧国'，纵然被贬，我等读书人心系苍生的志向不可改啊！这小小陋室，正可磨砺心志。"
                    },
                    {
                        speaker: "libai",
                        response: "哈哈！子美总是如此忧思。刘兄，听我一言——'天生我材必有用，千金散尽还复来'！区区贬谪算得了什么？看这大江东流，何等壮阔！人生短暂，当纵情山水，何必为小人之举动怒？"
                    },
                    {
                        speaker: "confucius",
                        response: "诸位所言各有道理。然老夫以为，刘君今日处境，正是践行'君子固穷'之时。'君子居之，何陋之有？'德行高尚者所居之处，岂能因外在简陋而减其光华？此正是修身养性的良机。"
                    }
                ]
            },
            
            // 柳边环境：关于心境和修养的讨论
            "willows_mindset_discussion": {
                topic: "心境修养",
                participants: ["wangwei", "sushi", "liqingzhao", "yanhuei"],
                rounds: [
                    {
                        speaker: "wangwei",
                        response: "梦得居此柳边，可见县令亦有无心之善。'行到水穷处，坐看云起时'，此等境界正需静心体悟。你看这垂柳依依，绿意盎然，诗中有画，画中有禅，岂非妙境？"
                    },
                    {
                        speaker: "sushi",
                        response: "摩诘兄说得极是！我苏轼一生三遭贬谪，深知'回首向来萧瑟处，归去，也无风雨也无晴'的道理。刘兄，人生如逆旅，我亦是行人，何不学会苦中作乐？这柳荫下品茶论诗，岂不快哉？"
                    },
                    {
                        speaker: "liqingzhao",
                        response: "两位先生豁达可敬。小女子虽是闺中人，但也曾历经国破家亡之痛。'生当作人杰，死亦为鬼雄'，刘兄既为君子，当在逆境中愈显风骨。纵然身处陋室，精神不可陋也。"
                    },
                    {
                        speaker: "yanhuei",
                        response: "清照女士所言甚是。弟子当年'一箪食，一瓢饮，在陋巷，人不堪其忧，回也不改其乐'。外物不足挂虑，内心充实方为真乐。夫子常教导我们，君子应该安贫乐道。"
                    }
                ]
            },
            
            // 斗室环境：关于陋室真义的深度讨论
            "chamber_wisdom_discussion": {
                topic: "陋室真义",
                participants: ["confucius", "zhugeliang", "baijuyi", "zengzi"],
                rounds: [
                    {
                        speaker: "confucius",
                        response: "刘君，观汝居此斗室而神色泰然，深合吾心。昔日吾欲居九夷，或人曰陋，吾答'君子居之，何陋之有？'今汝身体力行，可谓得吾道之真谛也。"
                    },
                    {
                        speaker: "zhugeliang",
                        response: "夫子所言极是。亮当年隐居隆中草庐，亦不过数椽，然能运筹帷幄，决胜千里。'非淡泊无以明志，非宁静无以致远'，外在之简陋，正可成就内心之辽阔。刘兄今日境遇，他日必成美谈。"
                    },
                    {
                        speaker: "baijuyi",
                        response: "梦得兄！'同是天涯沦落人，相逢何必曾相识'！我当年贬江州司马时，夜闻琵琶而感慨万千。然正是这些际遇，让我们更能理解民间疾苦，文章也因此更有温度。这斗室虽小，情怀却大！"
                    },
                    {
                        speaker: "zengzi",
                        response: "诸位先生所言皆有至理。参以为，刘兄今日所居，正如夫子所说'德馨'之室。'士不可以不弘毅，任重而道远'，传承圣道者，何惧区区陋室？内心有道，处处皆是讲堂。"
                    }
                ]
            }
        };

        // 角色风格定义
        const characterStyles = {
            "tao": {
                name: "陶渊明",
                style: "隐逸派",
                keywords: ["归隐", "田园", "自然", "悠然", "东篱", "南山", "桃花源"],
                constraints: "语言朴实自然，常用田园意象，体现归隐思想，不可出现后世事物",
                examples: [
                    "不为五斗米折腰",
                    "采菊东篱下，悠然见南山",
                    "归去来兮，田园将芜胡不归"
                ]
            },
            "du": {
                name: "杜甫",
                style: "家国派",
                keywords: ["忧国", "忧民", "社稷", "苍生", "茅屋", "安史", "战乱"],
                constraints: "语言沉郁顿挫，多用忧国忧民的表达，体现社会责任感",
                examples: [
                    "安得广厦千万间，大庇天下寒士俱欢颜",
                    "朱门酒肉臭，路有冻死骨",
                    "国破山河在，城春草木深"
                ]
            },
            "libai": {
                name: "李白",
                style: "豪放派",
                keywords: ["仙", "酒", "月", "剑", "豪迈", "逍遥", "天地"],
                constraints: "语言豪放飘逸，多用神仙意象和酒月典故，体现浪漫主义",
                examples: [
                    "天生我材必有用，千金散尽还复来",
                    "仰天大笑出门去，我辈岂是蓬蒿人",
                    "黄河之水天上来，奔流到海不复回"
                ]
            },
            "confucius": {
                name: "孔子",
                style: "儒家派",
                keywords: ["德", "仁", "礼", "君子", "修身", "齐家", "治国"],
                constraints: "语言温文尔雅，多用教育和道德的表达，体现儒家思想",
                examples: [
                    "君子居之，何陋之有",
                    "德不孤，必有邻",
                    "学而时习之，不亦说乎"
                ]
            }
        };

        // 文本变体引擎
        async function generateTextVariant(originalText, character, context = {}) {
            if (!AI_FEATURES.textVariants || !AI_FEATURES.enabled) {
                return originalText;
            }

            // 检查缓存
            const cacheKey = `${character}_${originalText.substring(0, 50)}`;
            const cached = aiCache.get(cacheKey, 'variants');
            if (cached) {
                console.log('使用缓存的文本变体', { cacheKey });
                return cached;
            }

            try {
                const characterInfo = characterStyles[character];
                if (!characterInfo) {
                    return originalText;
                }

                const prompt = `你是${characterInfo.name}（${characterInfo.style}），需要用你的风格重新表达以下文字。

原文：${originalText}

要求：
1. 保持核心意思不变
2. 符合${characterInfo.name}的语言风格：${characterInfo.constraints}
3. 可以适当使用相关典故：${characterInfo.keywords.join('、')}
4. 字数控制在原文的80%-120%之间
5. 语言要自然流畅，符合人物身份

请直接输出重写后的文字，不要解释：`;

                const variant = await callPoeAI(prompt, { temperature: 0.8 });
                
                // 缓存结果
                aiCache.set(cacheKey, variant, 'variants');
                
                console.log('生成文本变体成功', { original: originalText.substring(0, 30), variant: variant.substring(0, 30) });
                return variant;
                
            } catch (error) {
                console.error('文本变体生成失败', error);
                return originalText; // 失败时返回原文
            }
        }

        // 典故解释系统（带降级机制）
        async function explainText(selectedText) {
            if (!AI_FEATURES.textAnnotation || !AI_FEATURES.enabled) {
                return null;
            }

            // 过滤太短的文本
            if (selectedText.length < 3) {
                return null;
            }

            // 检查缓存
            const cacheKey = selectedText.trim();
            const cached = aiCache.get(cacheKey, 'annotations');
            if (cached) {
                console.log('使用缓存的典故解释', { text: selectedText });
                return cached;
            }

            // 首先检查预制内容
            for (const [key, content] of Object.entries(fallbackContent.annotations)) {
                if (selectedText.includes(key) || key.includes(selectedText)) {
                    console.log('使用预制典故解释', { text: selectedText, key });
                    aiCache.set(cacheKey, content.explanation, 'annotations');
                    return content.explanation;
                }
            }

            try {
                const prompt = `请解释这段古代文字或典故："${selectedText}"

请按以下格式提供信息（如果某项不适用请写"无"）：

【释义】：用现代汉语解释基本含义（不超过50字）
【出处】：出自哪本书、哪位作者、什么时代
【典故】：相关的历史故事或文化背景
【用法】：在文中的修辞作用或表达效果

要求：
1. 语言通俗易懂，适合现代读者
2. 重点突出文化内涵和教育价值
3. 如果是人名地名，提供简要介绍
4. 如果是诗词名句，可以提及创作背景`;

                const explanation = await callPoeAI(prompt, { temperature: 0.3 });
                
                // 缓存结果
                aiCache.set(cacheKey, explanation, 'annotations');
                
                console.log('生成典故解释成功', { text: selectedText });
                return explanation;
                
            } catch (error) {
                console.error('典故解释生成失败，使用基础解释', error);
                
                // 降级方案：提供基础解释
                const basicExplanation = `【释义】：这是一个古代文学或历史相关的词汇
【说明】：由于网络问题，暂时无法提供详细解释
【建议】：您可以查阅相关古文词典或文学资料获取更详细的信息
【功能】：AI增强功能暂时不可用，但不影响游戏体验`;
                
                return basicExplanation;
            }
        }

        // 显示典故解释浮动卡片
        function showAnnotationCard(explanation, x, y) {
            // 移除已存在的卡片
            const existingCard = document.getElementById('annotationCard');
            if (existingCard) {
                existingCard.remove();
            }

            if (!explanation) return;

            const card = document.createElement('div');
            card.id = 'annotationCard';
            card.className = 'fixed bg-white border border-gray-300 rounded-lg shadow-lg p-4 max-w-xs z-50 text-sm leading-relaxed';
            card.style.left = Math.min(x, window.innerWidth - 300) + 'px';
            card.style.top = Math.max(y - 20, 10) + 'px';
            
            // 格式化解释内容
            const formattedExplanation = explanation
                .replace(/【([^】]+)】：/g, '<div class="font-medium text-blue-600 mt-2 mb-1">$1</div>')
                .replace(/\n/g, '<br>');
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="text-xs text-gray-500">📖 典故释义</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button>
                </div>
                <div class="text-gray-700">${formattedExplanation}</div>
                <div class="text-xs text-gray-400 mt-2 border-t pt-2">
                    💡 选中文字即可查看解释 | ✨ AI增强功能
                </div>
            `;

            document.body.appendChild(card);

            // 8秒后自动消失（除非鼠标悬停）
            let autoRemoveTimer = setTimeout(() => {
                if (card.parentElement) {
                    card.remove();
                }
            }, 8000);

            card.addEventListener('mouseenter', () => {
                clearTimeout(autoRemoveTimer);
            });

            card.addEventListener('mouseleave', () => {
                autoRemoveTimer = setTimeout(() => {
                    if (card.parentElement) {
                        card.remove();
                    }
                }, 3000);
            });
        }

        // 初始化典故解释功能
        function initTextAnnotation() {
            if (!AI_FEATURES.textAnnotation || !AI_FEATURES.enabled) {
                return;
            }

            document.addEventListener('mouseup', async (e) => {
                // 不在输入框和按钮上触发
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const selectedText = window.getSelection().toString().trim();
                if (selectedText.length >= 3 && selectedText.length <= 50) {
                    // 显示加载指示
                    const loadingCard = document.createElement('div');
                    loadingCard.id = 'annotationCard';
                    loadingCard.className = 'fixed bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-50 text-sm';
                    loadingCard.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
                    loadingCard.style.top = Math.max(e.clientY - 20, 10) + 'px';
                    loadingCard.innerHTML = `
                        <div class="flex items-center text-gray-600">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                            正在查询典故...
                        </div>
                    `;
                    document.body.appendChild(loadingCard);

                    try {
                        const explanation = await explainText(selectedText);
                        loadingCard.remove();
                        
                        if (explanation) {
                            showAnnotationCard(explanation, e.clientX, e.clientY);
                        }
                    } catch (error) {
                        loadingCard.remove();
                        console.error('典故查询失败', error);
                    }
                }
            });

            // 点击其他地方关闭卡片
            document.addEventListener('click', (e) => {
                const card = document.getElementById('annotationCard');
                if (card && !card.contains(e.target)) {
                    card.remove();
                }
            });
        }

        // ====== 原有游戏代码（简化版用于演示） ======
        
        const DEBUG_MODE = true;
        
        // Game state
        const gameState = {
            currentStage: 0,
            selectedOptions: [],
            stylePoints: {
                tao: 0,
                du: 0,
                ru: 0,
                balanced: 0
            },
            isShowingMessages: false,
            // 朋友圈数据收集
            playerProfile: {
                personalityType: "探索中", // 将在游戏过程中分析
                mainValues: [], // 玩家的核心价值观
                interactionPreferences: {}, // 与不同角色的互动偏好
                creativeStyle: "未知", // 创作风格倾向
                modernConcerns: [] // 对现代问题的关注点
            },
            chatHighlights: [], // 聊天精彩片段
            gameJourney: [] // 游戏历程记录
        };

        // Get DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const optionsContainer = document.getElementById('optionsContainer');
        const optionsList = document.getElementById('optionsList');
        const progressBar = document.getElementById('progressBar');
        const typingIndicator = document.getElementById('typingIndicator');

        // 历史人物专属头像设计
        const characterEmojis = {
            "narrator": "📱",
            "liuyuxi": "🎋", // 竹子，象征君子品格
            "countyMagistrate": "👨‍⚖️", // 官员
            "tao": "🌾", // 麦穗，象征田园诗人
            "du": "🏔️", // 高山，象征忧国忧民的高尚情怀
            "libai": "🌙", // 月亮，象征浪漫主义诗人
            "confucius": "📚", // 书籍，象征教育家和思想家
            "wangwei": "🎋", // 竹子，象征山水诗人的清雅
            "sushi": "🍃", // 叶子，象征豁达自然
            "liqingzhao": "💮", // 樱花，象征才女
            "yanhuei": "🕯️", // 蜡烛，象征好学和德行
            "zhugeliang": "🪶", // 羽毛，象征智慧和策略
            "baijuyi": "🎺", // 乐器，象征琵琶行作者
            "zengzi": "📜", // 卷轴，象征传承圣道
            "yangxiong": "✒️", // 毛笔，象征文学家
            "system": "ℹ️"
        };

        const characterNames = {
            "narrator": "系统通知",
            "liuyuxi": "刘禹锡",
            "countyMagistrate": "县令",
            "tao": "陶渊明",
            "du": "杜甫", 
            "libai": "李白",
            "confucius": "孔子",
            "wangwei": "王维",
            "sushi": "苏轼",
            "liqingzhao": "李清照",
            "yanhuei": "颜回",
            "zhugeliang": "诸葛亮",
            "baijuyi": "白居易",
            "zengzi": "曾子",
            "yangxiong": "杨雄",
            "system": "系统"
        };

        // 完整的游戏脚本
        const gameScript = {
            "0": {
                messages: [
                    { type: "narrator", text: "📅 公元824年，唐文宗时期" },
                    { type: "narrator", text: "你是刘禹锡，曾任监察御史，因政治原因被贬至安徽和州任刺史。" },
                    { type: "countyMagistrate", text: "刘大人，听闻您是被贬而来，本官特为您安排了江边的住所，还请莫要嫌弃。" },
                    { type: "liuyuxi", text: "（内心感受到刁难之意，但表面仍保持风度）多谢县令大人费心安排。" }
                ],
                options: [
                    { 
                        text: "心中不快，但君子不与小人计较", 
                        style: "ru",
                        nextStage: 1
                    },
                    { 
                        text: "既来之则安之，随遇而安也好", 
                        style: "tao",
                        nextStage: 1
                    },
                    { 
                        text: "虽遭贬谪，仍要心系百姓安危", 
                        style: "du",
                        nextStage: 1
                    }
                ]
            },
            "1": {
                messages: [
                    { type: "narrator", text: "🌊 江边住所" },
                    { type: "liuyuxi", text: "这江边小屋虽然简陋，但临江而居，听江水潺潺，看云起云落，倒也别有意境。" },
                    { type: "system", text: "💡 你可以@历史名人来交流，他们会根据自己的人生阅历给你建议" }
                ],
                options: [
                    { 
                        text: "@陶渊明 请教隐居之道", 
                        action: "mention",
                        character: "tao"
                    },
                    { 
                        text: "@杜甫 谈论贬谪之苦", 
                        action: "mention",
                        character: "du"
                    },
                    { 
                        text: "@李白 寻求豪迈人生观", 
                        action: "mention",
                        character: "libai"
                    },
                    { 
                        text: "@孔子 探讨君子风范", 
                        action: "mention",
                        character: "confucius"
                    }
                ]
            },
            "2": {
                messages: [
                    { type: "narrator", text: "几日后..." },
                    { type: "countyMagistrate", text: "刘大人，江边环境嘈杂，本官已为您重新安排了柳边的清幽之所。" },
                    { type: "liuyuxi", text: "（心知县令是在刁难，但仍然保持镇定）既如此，那就劳烦县令了。" }
                ],
                options: [
                    { 
                        text: "此举明显是刁难，但君子当忍辱负重", 
                        style: "ru",
                        nextStage: 3
                    },
                    { 
                        text: "反正居无定所，搬到哪里都一样", 
                        style: "tao", 
                        nextStage: 3
                    },
                    { 
                        text: "想到百姓疾苦，自己这点委屈算什么", 
                        style: "du",
                        nextStage: 3
                    }
                ]
            },
            "3": {
                messages: [
                    { type: "narrator", text: "🌿 柳边住所" },
                    { type: "liuyuxi", text: "柳絮飞舞，绿意盎然，这柳边小屋倒比江边更加清幽。县令不知是有心还是无意，倒是让我得了清静之所。" }
                ],
                options: [
                    { 
                        text: "@王维 请教山水禅意", 
                        action: "mention",
                        character: "wangwei"
                    },
                    { 
                        text: "@诸葛亮 学习以退为进", 
                        action: "mention",
                        character: "zhugeliang"
                    },
                    { 
                        text: "@白居易 同病相怜之感", 
                        action: "mention",
                        character: "baijuyi"
                    },
                    { 
                        text: "开始构思文章，记录这段经历", 
                        style: "balanced",
                        nextStage: 4
                    }
                ]
            },
            "4": {
                messages: [
                    { type: "narrator", text: "又过了一段时间..." },
                    { type: "countyMagistrate", text: "刘大人，柳边蚊虫颇多，为您的身体着想，本官特安排了城中最小的房间，虽然只有一斗之室，但胜在安静。" },
                    { type: "liuyuxi", text: "（终于明白县令的用意，内心反而释然）有劳县令了。" }
                ],
                options: [
                    { 
                        text: "县令用心良苦，但君子自有君子的风骨", 
                        style: "ru",
                        nextStage: 5
                    },
                    { 
                        text: "一室之小算得了什么，心远地自偏", 
                        style: "tao",
                        nextStage: 5
                    },
                    { 
                        text: "虽居斗室，心怀天下的志向不能改", 
                        style: "du",
                        nextStage: 5
                    }
                ]
            },
            "5": {
                messages: [
                    { type: "narrator", text: "🏠 斗室" },
                    { type: "liuyuxi", text: "真是只有一斗之室啊！苔痕上阶绿，草色入帘青。虽小，却别有天地。" },
                    { type: "system", text: "在这个最小的房间里，你开始深刻理解'陋室'的真正含义..." }
                ],
                options: [
                    { 
                        text: "@苏轼 学习旷达人生观", 
                        action: "mention",
                        character: "sushi"
                    },
                    { 
                        text: "@李清照 倾听女性的坚强", 
                        action: "mention",
                        character: "liqingzhao"
                    },
                    { 
                        text: "@颜回 效法安贫乐道", 
                        action: "mention",
                        character: "yanhuei"
                    }
                ]
            },
            "6": {
                messages: [
                    { type: "narrator", text: "📝 创作时刻" },
                    { type: "liuyuxi", text: "经历了这三次搬迁，我终于明白了什么叫'斯是陋室，惟吾德馨'。让我提笔写下这《陋室铭》..." },
                    { type: "system", text: "根据你的选择和与历史名人的对话，《陋室铭》将呈现不同的风格..." }
                ],
                options: [
                    { 
                        text: "开始创作《陋室铭》", 
                        action: "createPoem",
                        nextStage: 7
                    }
                ]
            }
        };

        // AI性能优化设置
        const performanceSettings = {
            // 批量处理设置
            batchProcessing: {
                maxBatchSize: 3,
                batchTimeout: 2000 // 2秒内的请求会被批量处理
            },
            
            // 智能缓存策略
            caching: {
                characterResponseTTL: 1800000, // 30分钟
                annotationTTL: 3600000, // 1小时
                maxCacheSize: 100
            },
            
            // 请求去重
            deduplication: {
                enabled: true,
                timeWindow: 5000 // 5秒内的相同请求会被去重
            }
        };

        // 请求去重管理器
        const requestDeduplicator = {
            pendingRequests: new Map(),
            
            async deduplicate(key, requestFunction) {
                if (!performanceSettings.deduplication.enabled) {
                    return await requestFunction();
                }
                
                // 检查是否有相同的请求正在处理
                if (this.pendingRequests.has(key)) {
                    console.log('去重：等待现有请求完成', key);
                    return await this.pendingRequests.get(key);
                }
                
                // 创建新请求
                const requestPromise = requestFunction().finally(() => {
                    // 请求完成后清理
                    setTimeout(() => {
                        this.pendingRequests.delete(key);
                    }, performanceSettings.deduplication.timeWindow);
                });
                
                this.pendingRequests.set(key, requestPromise);
                return await requestPromise;
            }
        };

        // 智能内容增强器
        const contentEnhancer = {
            // 为历史人物添加emoji
            addEmojisToText: function(text, characterId) {
                const emojiMappings = {
                    "confucius": {
                        "君子": "👨‍🎓", "道德": "⭐", "学习": "📚", "教导": "🎓", "修身": "🧘",
                        "德不孤": "🤝", "仁": "❤️", "礼": "🙏", "智慧": "💡"
                    },
                    "tao": {
                        "田园": "🌾", "归隐": "🏠", "自然": "🌿", "悠然": "😌", "东篱": "🌸",
                        "南山": "🏔️", "桃花源": "🌸", "宁静": "🧘‍♂️", "纯真": "✨"
                    },
                    "libai": {
                        "酒": "🍷", "月": "🌙", "仙": "✨", "豪迈": "⚡", "自由": "🦅",
                        "天生我材": "💪", "长风破浪": "⛵", "理想": "🌟", "快哉": "😄"
                    },
                    "du": {
                        "忧国": "😟", "忧民": "💔", "苍生": "👥", "茅屋": "🏠", "社稷": "🏛️",
                        "广厦": "🏘️", "战乱": "⚔️", "责任": "🛡️", "使命": "📜"
                    },
                    "wangwei": {
                        "禅": "🧘", "山水": "🏞️", "空灵": "💫", "静观": "👁️", "意境": "🎨",
                        "水穷": "💧", "云起": "☁️", "悟道": "💡", "清韵": "🎵"
                    },
                    "sushi": {
                        "豁达": "😊", "乐观": "🌞", "美食": "🍖", "变通": "🔄", "幽默": "😄",
                        "风雨": "🌦️", "苦中作乐": "😆", "人生如逆旅": "🚶‍♂️", "快哉": "🎉"
                    },
                    "liqingzhao": {
                        "词韵": "🎶", "才女": "👩‍🎨", "坚强": "💪", "尊严": "👑", "家国": "🏮",
                        "人杰": "🌟", "鬼雄": "👻", "寻觅": "🔍", "清清": "❄️"
                    },
                    "yanhuei": {
                        "安贫": "🙏", "乐道": "😌", "一箪食": "🍚", "一瓢饮": "🥛", "陋巷": "🏘️",
                        "德行": "⭐", "师道": "👨‍🏫", "修养": "🧘", "好学": "📖"
                    },
                    "zhugeliang": {
                        "智谋": "🧠", "草庐": "🏠", "淡泊": "🍃", "致远": "🎯", "策略": "♟️",
                        "三顾": "👥", "运筹": "📋", "辽阔": "🌌", "隆中": "🏕️"
                    },
                    "baijuyi": {
                        "琵琶": "🎵", "沦落": "😔", "同病相怜": "🤝", "江州": "🌊", "贬谪": "📉",
                        "民生": "👥", "温度": "🔥", "情怀": "❤️", "疾苦": "💔"
                    }
                };
                
                const characterEmojis = emojiMappings[characterId] || {};
                let enhancedText = text;
                
                // 替换关键词为emoji版本
                for (const [keyword, emoji] of Object.entries(characterEmojis)) {
                    if (enhancedText.includes(keyword)) {
                        enhancedText = enhancedText.replace(
                            new RegExp(keyword, 'g'), 
                            `${keyword}${emoji}`
                        );
                    }
                }
                
                return enhancedText;
            },
            
            // 分段处理长内容
            splitLongContent: function(text, maxLength = 120) {
                if (text.length <= maxLength) {
                    return [text];
                }
                
                const segments = [];
                const sentences = text.split(/[。！？；]/).filter(s => s.trim());
                let currentSegment = '';
                
                for (const sentence of sentences) {
                    const withPunctuation = sentence + (text.includes(sentence + '。') ? '。' : 
                                                      text.includes(sentence + '！') ? '！' :
                                                      text.includes(sentence + '？') ? '？' : '；');
                    
                    if ((currentSegment + withPunctuation).length > maxLength && currentSegment) {
                        segments.push(currentSegment.trim());
                        currentSegment = withPunctuation;
                    } else {
                        currentSegment += withPunctuation;
                    }
                }
                
                if (currentSegment.trim()) {
                    segments.push(currentSegment.trim());
                }
                
                return segments.length > 1 ? segments : [text];
            }
        };

        // 群聊互动回应生成器
        const groupChatInteractions = {
            // 生成群聊回应
            generateGroupResponses: async function(mainResponse, mainCharacter, availableCharacters) {
                const responses = [];
                const responseText = mainResponse.text;
                
                // 选择1-2个角色进行回应
                const respondingCharacters = this.selectRespondingCharacters(
                    mainCharacter, availableCharacters, responseText
                );
                
                for (const character of respondingCharacters) {
                    const response = await this.generateCharacterReaction(
                        character, mainCharacter, responseText
                    );
                    if (response) {
                        responses.push(response);
                    }
                }
                
                return responses;
            },
            
            // 选择回应角色
            selectRespondingCharacters: function(mainCharacter, availableCharacters, responseText) {
                const candidates = availableCharacters.filter(char => char !== mainCharacter);
                const selected = [];
                
                // 基于内容选择最相关的1-2个角色
                for (const character of candidates) {
                    const relevance = this.calculateRelevance(character, responseText);
                    if (relevance > 0.3 && selected.length < 2) {
                        selected.push({ character, relevance });
                    }
                }
                
                // 按相关度排序，选择前1-2名
                selected.sort((a, b) => b.relevance - a.relevance);
                return selected.slice(0, Math.random() < 0.6 ? 2 : 1).map(s => s.character);
            },
            
            // 计算回应相关度
            calculateRelevance: function(character, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) return 0;
                
                let relevance = 0;
                
                // 关键词匹配
                for (const concept of personality.key_concepts) {
                    if (responseText.includes(concept)) {
                        relevance += 0.2;
                    }
                }
                
                // 特殊关系匹配
                const relationshipBonuses = {
                    "confucius": responseText.includes("君子") || responseText.includes("德") ? 0.3 : 0,
                    "libai": responseText.includes("豪") || responseText.includes("酒") ? 0.3 : 0,
                    "tao": responseText.includes("自然") || responseText.includes("田园") ? 0.3 : 0,
                    "du": responseText.includes("忧") || responseText.includes("民") ? 0.3 : 0
                };
                
                relevance += relationshipBonuses[character] || 0;
                
                // 添加随机因子
                relevance += Math.random() * 0.2;
                
                return Math.min(relevance, 1.0);
            },
            
            // 生成角色回应
            generateCharacterReaction: async function(character, mainCharacter, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) return null;
                
                // 预设回应模板
                const reactionTypes = {
                    "agreement": ["👏", "💯", "说得好！", "深有同感", "确实如此"],
                    "support": ["🤝", "💪", "支持！", "说得对", "我也这样认为"],
                    "thoughtful": ["🤔", "💭", "有道理", "值得深思", "受教了"],
                    "encouraging": ["✨", "🌟", "很有见地", "启发很大", "学习了"],
                    "emotional": ["😊", "❤️", "感动", "温暖", "真挚"],
                    "questioning": ["🤔", "那你觉得", "刘兄认为", "你有何感想", "这让你想到什么"]
                };
                
                // 选择回应类型
                const reactionType = this.selectReactionType(character, responseText);
                const templates = reactionTypes[reactionType];
                
                if (Math.random() < 0.4) {
                    // 40%概率生成个性化问题引导
                    const personalizedQuestions = this.generatePersonalizedQuestions(character, responseText);
                    return {
                        type: character,
                        text: personalizedQuestions,
                        isGroupReaction: true,
                        isQuestion: true,
                        isSimpleReaction: false
                    };
                } else {
                    // 60%概率生成符合人物身份的回应（emoji和文字同行）
                    const characterSpecificResponses = {
                        "confucius": [`君子所言甚是 👨‍🎓`, `此言深得我心 ⭐`, `确实如此 🙏`],
                        "libai": [`哈哈！说得好 🌙`, `痛快之言 ✨`, `太白深有同感 🍷`],
                        "du": [`子美深表赞同 🏔️`, `言之有理 💔`, `确实如此 📜`],
                        "tao": [`渊明深感认同 🌾`, `此言甚善 😌`, `心有戚戚焉 🍃`],
                        "wangwei": [`摩诘深以为然 🎋`, `善哉善哉 💫`, `深有禅意 🧘`],
                        "sushi": [`东坡拍案叫好 😊`, `妙哉此言 🍃`, `甚有道理 🎉`],
                        "liqingzhao": [`小女子深表赞同 💮`, `此言甚善 👩‍🎨`, `清照心有同感 👑`],
                        "yanhuei": [`回深感认同 🕯️`, `夫子之言诚然 📖`, `受教了 🙏`],
                        "zhugeliang": [`亮深以为然 🪶`, `此言甚是 🧠`, `诚如所言 ♟️`],
                        "baijuyi": [`乐天深有同感 🎺`, `此言中肯 🤝`, `确实如此 ❤️`]
                    };
                    
                    const responses = characterSpecificResponses[character] || [`深有同感 👍`, `言之有理 ✨`, `确实如此 😊`];
                    const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    return {
                        type: character,
                        text: selectedResponse,
                        isGroupReaction: true,
                        isQuestion: false,
                        isSimpleReaction: true // 标记为简单回应
                    };
                }
            },
            
            // 生成个性化问题
            generatePersonalizedQuestions: function(character, responseText) {
                const personality = aiPersonalities[character];
                if (!personality) {
                    return "刘兄，你对此有何感想？ 🤔";
                }
                
                // 基于角色特色的问题模板
                const characterQuestions = {
                    "confucius": [
                        `刘君，君子在此境遇中，当如何修身养德？ 🎓`,
                        `依君之见，何为真正的'德馨'之室？ 📚`,
                        `刘君可曾思考过，逆境对君子品格的磨砺作用？ 🧘`
                    ],
                    "tao": [
                        `刘兄，你是否也向往那种'心远地自偏'的境界？ 🌾`,
                        `若让你选择，富贵繁华与田园宁静，你会如何取舍？ 🍃`,
                        `在你心中，何处才是真正的'桃花源'？ 🌸`
                    ],
                    "libai": [
                        `刘兄，你可有'长风破浪会有时'的豪迈气概？ 🌙`,
                        `面对挫折，你是否也想'仰天大笑出门去'？ ✨`,
                        `你心中可有不朽的理想和抱负？ 🍷`
                    ],
                    "du": [
                        `刘兄，你是否也有'位卑未敢忘忧国'的情怀？ 🏔️`,
                        `在个人困境中，你如何平衡家国情怀与现实处境？ 💔`,
                        `你认为文人的社会使命是什么？ 📜`
                    ],
                    "wangwei": [
                        `刘兄，你可曾体验过'行到水穷处，坐看云起时'的禅境？ 🎋`,
                        `在你看来，如何才能做到'境由心转'？ 💫`,
                        `诗与画，哪一种更能表达你的心境？ 🧘`
                    ],
                    "sushi": [
                        `刘兄，你是否同意'人生如逆旅，我亦是行人'这个观点？ 😊`,
                        `面对人生起伏，你有什么苦中作乐的妙招？ 🎉`,
                        `若要你写一首词来形容此刻心境，会是什么样的？ 🍃`
                    ],
                    "liqingzhao": [
                        `刘兄，你认为在困境中最重要的是什么品质？ 💮`,
                        `作为文人，你如何在逆境中保持尊严？ 👑`,
                        `你可有'生当作人杰'的豪情壮志？ 👩‍🎨`
                    ],
                    "yanhuei": [
                        `刘兄，你是否也能做到'不改其乐'的境界？ 🕯️`,
                        `在这陋室中，你如何寻找内心的充实？ 📖`,
                        `你觉得什么才是真正的快乐？ 🙏`
                    ],
                    "zhugeliang": [
                        `刘兄，你如何看待'非淡泊无以明志'这句话？ 🪶`,
                        `在当前处境下，你有何长远的人生规划？ 🧠`,
                        `你认为以退为进的智慧何时最为适用？ ♟️`
                    ],
                    "baijuyi": [
                        `刘兄，你是否也有'同是天涯沦落人'的感慨？ 🎺`,
                        `你认为这段贬谪经历对你的诗文创作有何影响？ 🤝`,
                        `我们这些文人，如何在困境中互相扶持？ ❤️`
                    ]
                };
                
                // 选择问题
                const questions = characterQuestions[character] || [
                    `刘兄，你对此有何感想？ 🤔`,
                    `这让你想到了什么？ 💭`,
                    `你觉得我们还应该如何理解这个问题？ 🤝`
                ];
                
                // 根据对话内容智能选择相关问题
                let selectedQuestion = questions[0];
                
                // 简单的关键词匹配来选择最相关的问题
                if (responseText.includes("心境") || responseText.includes("修养")) {
                    selectedQuestion = questions.find(q => q.includes("心") || q.includes("境")) || questions[0];
                } else if (responseText.includes("理想") || responseText.includes("抱负")) {
                    selectedQuestion = questions.find(q => q.includes("理想") || q.includes("志")) || questions[0];
                } else if (responseText.includes("困境") || responseText.includes("逆境")) {
                    selectedQuestion = questions.find(q => q.includes("困") || q.includes("逆")) || questions[0];
                } else {
                    // 随机选择
                    selectedQuestion = questions[Math.floor(Math.random() * questions.length)];
                }
                
                return selectedQuestion;
            },
            
            // 选择回应类型
            selectReactionType: function(character, responseText) {
                // 根据角色性格和内容选择回应类型
                const personalityMappings = {
                    "confucius": "thoughtful",
                    "libai": "encouraging", 
                    "tao": "agreement",
                    "du": "emotional",
                    "wangwei": "thoughtful",
                    "sushi": "support",
                    "liqingzhao": "emotional",
                    "yanhuei": "agreement",
                    "zhugeliang": "thoughtful",
                    "baijuyi": "emotional"
                };
                
                return personalityMappings[character] || "agreement";
            }
        };

        // 消息显示函数（增强版：emoji + 分段 + 群聊互动）
        async function appendMessage(message, withAnimation = false) {
            // 系统通知和旁白使用背景式显示
            if (message.type === "narrator" || message.type === "system") {
                appendSystemNotification(message, withAnimation);
                return;
            }
            
            // 增强内容：添加emoji（历史人物对话）
            if (message.type !== "liuyuxi" && aiPersonalities[message.type]) {
                message.text = contentEnhancer.addEmojisToText(message.text, message.type);
            }
            
            // 如果是历史人物说话，有30%概率使用AI变体
            if (AI_FEATURES.textVariants && AI_FEATURES.enabled && 
                message.type !== "liuyuxi" && characterStyles[message.type] && 
                Math.random() < 0.3) {
                
                try {
                    const variant = await generateTextVariant(message.text, message.type);
                    if (variant && variant !== message.text) {
                        message.text = variant;
                        message.isAIVariant = true;
                        console.log('使用了AI生成的文本变体', { character: message.type, variant: variant.substring(0, 50) });
                    }
                } catch (error) {
                    console.error('文本变体生成失败，使用原文', error);
                }
            }

            // 长内容分段处理
            const segments = contentEnhancer.splitLongContent(message.text);
            
            for (let i = 0; i < segments.length; i++) {
                const segmentMessage = {
                    ...message,
                    text: segments[i],
                    isSegment: segments.length > 1,
                    segmentIndex: i,
                    totalSegments: segments.length
                };
                
                await appendSingleMessage(segmentMessage, withAnimation);
                
                // 分段间隔
                if (i < segments.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1200));
                }
            }
            
            // 生成群聊互动（仅针对问题回应和主要对话）
            if (message.isQuestionResponse || message.isFlexibleRound) {
                setTimeout(async () => {
                    await generateGroupChatInteractions(message);
                }, 2000 + Math.random() * 1500);
            }
        }

        // 单条消息显示
        async function appendSingleMessage(message, withAnimation = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex mb-4';

            const emoji = characterEmojis[message.type] || "💬";
            const name = characterNames[message.type] || message.type;
            const isOwn = message.type === "liuyuxi";

            // 分段指示器
            const segmentIndicator = message.isSegment ? 
                ` <span class="text-xs text-gray-400">(${message.segmentIndex + 1}/${message.totalSegments})</span>` : '';

            if (isOwn) {
                messageElement.className += ' justify-end';
                messageElement.innerHTML = `
                    <div class="flex flex-col items-end max-w-md">
                        <div class="flex items-center mb-1 mr-2">
                            <div class="text-xs text-gray-500 mr-2">${name}${segmentIndicator}</div>
                            <div class="text-lg">${emoji}</div>
                        </div>
                        <div class="message-bubble self bg-bubble-self rounded-lg p-3 mr-10 relative ${message.isAIVariant ? 'ai-enhanced' : ''}">
                            ${message.isAIVariant ? '<div class="ai-variant-indicator">✨</div>' : ''}
                            <div class="text-sm">${message.text}</div>
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="flex flex-col max-w-md">
                        <div class="flex items-center mb-1 ml-2">
                            <div class="text-lg mr-2">${emoji}</div>
                            <div class="text-xs text-gray-500">${name}${segmentIndicator}</div>
                        </div>
                        <div class="message-bubble other bg-bubble-other rounded-lg p-3 ml-10 relative ${message.isAIVariant ? 'ai-enhanced' : ''} ${message.isGroupReaction && !message.isSimpleReaction ? 'bg-yellow-50 border border-yellow-200' : ''}">
                            ${message.isAIVariant ? '<div class="ai-variant-indicator">✨</div>' : ''}
                            <div class="text-sm">${message.text}</div>
                        </div>
                    </div>
                `;
            }

            if (withAnimation) {
                messageElement.classList.add('opacity-0');
                chatContainer.appendChild(messageElement);
                setTimeout(() => {
                    messageElement.classList.remove('opacity-0');
                    messageElement.classList.add('fade-in');
                }, 100);
            } else {
                chatContainer.appendChild(messageElement);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 生成群聊互动
        async function generateGroupChatInteractions(mainMessage) {
            if (!mainMessage.type || mainMessage.type === "liuyuxi" || mainMessage.isGroupReaction) {
                return; // 避免无限循环
            }
            
            // 获取当前环境的可用角色
            const currentParticipants = getCurrentParticipants();
            
            // 生成群聊回应
            const responses = await groupChatInteractions.generateGroupResponses(
                mainMessage, 
                mainMessage.type, 
                currentParticipants
            );
            
            // 显示群聊回应
            for (let i = 0; i < responses.length; i++) {
                const response = responses[i];
                
                // 等待间隔，模拟真实群聊
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                await appendSingleMessage(response, true);
            }
        }

        // 获取当前参与讨论的角色
        function getCurrentParticipants() {
            // 根据当前环境返回相关角色
            const environmentParticipants = {
                "江边": ["tao", "du", "libai", "confucius"],
                "柳边": ["wangwei", "sushi", "liqingzhao", "yanhuei"], 
                "斗室": ["confucius", "zhugeliang", "baijuyi", "zengzi"]
            };
            
            const currentEnv = getCurrentEnvironment();
            return environmentParticipants[currentEnv] || Object.keys(aiPersonalities).slice(0, 4);
        }

        // 系统通知背景化显示
        function appendSystemNotification(message, withAnimation = false) {
            const notificationElement = document.createElement('div');
            notificationElement.className = 'flex justify-center my-6';
            
            // 根据消息类型设置不同样式
            let bgClass, textClass, icon;
            if (message.type === "narrator") {
                bgClass = "bg-blue-50 border-blue-200";
                textClass = "text-blue-700";
                icon = "📖";
            } else {
                bgClass = "bg-green-50 border-green-200";
                textClass = "text-green-700";
                icon = "💡";
            }
            
            notificationElement.innerHTML = `
                <div class="max-w-sm mx-auto">
                    <div class="${bgClass} border rounded-lg px-4 py-2 text-center">
                        <div class="${textClass} text-sm font-medium flex items-center justify-center">
                            <span class="mr-2">${icon}</span>
                            ${message.text}
                        </div>
                    </div>
                </div>
            `;

            if (withAnimation) {
                notificationElement.classList.add('opacity-0');
                chatContainer.appendChild(notificationElement);
                setTimeout(() => {
                    notificationElement.classList.remove('opacity-0');
                    notificationElement.classList.add('fade-in');
                }, 100);
            } else {
                chatContainer.appendChild(notificationElement);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 显示选项（增强版：支持15秒倒计时）
        function showOptions(options) {
            optionsList.innerHTML = '';
            hasUserMadeChoice = false;
            
            // 检查是否包含@人物选项
            const hasMentionOptions = options.some(option => option.action === "mention");
            
            options.forEach((option, index) => {
                const optionElement = document.createElement('button');
                optionElement.className = 'w-full p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200 border border-gray-200';
                optionElement.textContent = option.text;
                
                optionElement.addEventListener('click', () => {
                    hasUserMadeChoice = true;
                    if (optionSelectionTimer) {
                        clearTimeout(optionSelectionTimer);
                        optionSelectionTimer = null;
                    }
                    
                    // 如果是@选项，传递完整文本用于智能匹配
                    if (option.action === "mention") {
                        handleOptionClick(option, index, true, option.text);
                    } else {
                        handleOptionClick(option, index);
                    }
                });
                
                optionsList.appendChild(optionElement);
            });
            
            // 如果包含@人物选项，启动15秒倒计时
            if (hasMentionOptions) {
                startOptionSelectionTimer(options);
            }
            
            // 显示选项容器
            optionsContainer.classList.remove('translate-y-full');
        }
        
        // 15秒选择倒计时系统
        function startOptionSelectionTimer(options) {
            console.log('🕐 启动15秒选择倒计时');
            
            // 显示倒计时提示
            const timerElement = document.createElement('div');
            timerElement.id = 'selectionTimer';
            timerElement.className = 'text-center text-sm text-gray-500 mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded';
            timerElement.innerHTML = '⏱️ 请在 <span id="countdown">15</span> 秒内选择，否则将自动进入话题讨论';
            optionsList.appendChild(timerElement);
            
            let timeLeft = 15;
            const countdownElement = document.getElementById('countdown');
            
            // 每秒更新倒计时
            const countdownInterval = setInterval(() => {
                timeLeft--;
                if (countdownElement) {
                    countdownElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 5) {
                    // 最后5秒变红色警告
                    timerElement.className = 'text-center text-sm text-red-600 mt-3 p-2 bg-red-50 border border-red-200 rounded';
                }
                
                if (timeLeft <= 0 || hasUserMadeChoice) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // 15秒超时处理
            optionSelectionTimer = setTimeout(() => {
                if (!hasUserMadeChoice) {
                    console.log('⏰ 15秒超时，自动进入环境话题讨论');
                    
                    // 移除倒计时提示
                    if (timerElement && timerElement.parentElement) {
                        timerElement.remove();
                    }
                    clearInterval(countdownInterval);
                    
                    // 隐藏选项
                    optionsContainer.classList.add('translate-y-full');
                    
                    // 显示超时消息
                    const timeoutMessage = {
                        type: "system",
                        text: "⏰ 未在限定时间内选择，将进入本轮环境话题讨论..."
                    };
                    appendMessage(timeoutMessage, true);
                    
                    // 自动进入环境话题讨论
                    setTimeout(() => {
                        autoProgressToEnvironmentTopic();
                    }, 1500);
                }
            }, 15000);
        }
        
        // 自动进入环境话题讨论
        function autoProgressToEnvironmentTopic() {
            const currentEnvironment = getCurrentEnvironment();
            const environmentTopic = getCurrentTopic(currentEnvironment);
            const participants = getCurrentParticipants();
            
            console.log(`🏃‍♂️ 自动进入环境话题: ${environmentTopic}`);
            
            // 选择一个代表性角色作为引导者
            const leadCharacter = participants[0] || "confucius";
            
            // 启动环境固定话题讨论
            flexibleMultiRoundDialogue.startFlexibleDiscussion(
                leadCharacter,
                environmentTopic,
                currentEnvironment,
                participants
            );
        }

        // 处理选项点击（增强版：支持智能话题匹配）
        function handleOptionClick(option, index, isTimedChoice = false, fullOptionText = null) {
            // 移除倒计时提示
            const timerElement = document.getElementById('selectionTimer');
            if (timerElement && timerElement.parentElement) {
                timerElement.remove();
            }
            
            // 隐藏选项
            optionsContainer.classList.add('translate-y-full');
            
            // 添加用户选择的消息
            const userMessage = {
                type: "liuyuxi",
                text: option.text
            };
            appendMessage(userMessage);

            // 记录选择
            gameState.selectedOptions.push({
                stage: gameState.currentStage,
                option: option,
                index: index,
                isTimedChoice: isTimedChoice,
                timestamp: Date.now()
            });

            // 如果是@某人
            if (option.action === "mention") {
                // 传递完整选项文本用于智能匹配
                handleMention(option.character, fullOptionText || option.text, isTimedChoice);
            } else if (option.action === "createPoem") {
                // 处理创作《陋室铭》
                handlePoemCreation();
            } else if (option.nextStage !== undefined) {
                // 延迟进入下一阶段
                setTimeout(() => {
                    proceedToStage(option.nextStage);
                }, 1000);
            }
        }

        // AI智能对话生成核心功能
        async function generateCharacterResponse(characterId, context = {}) {
            const personality = aiPersonalities[characterId];
            if (!personality) {
                throw new Error(`未找到角色 ${characterId} 的人格信息`);
            }

            const currentEnvironment = getCurrentEnvironment();
            const environmentDescription = getEnvironmentDescription(currentEnvironment);
            
            // 构建上下文信息
            const contextInfo = {
                environment: environmentDescription,
                stage: gameState.currentStage,
                playerChoices: gameState.selectedOptions.slice(-3), // 最近3个选择
                ...context
            };

            const prompt = `你是${personality.name}（${personality.period}），${personality.background}。

你的性格特点：${personality.personality}
你的语言风格：${personality.language_style}
你的核心理念：${personality.key_concepts.join('、')}
你的常用语句：${personality.speech_habits.join('；')}

当前情境：
- 环境：${contextInfo.environment}
- 背景：刘禹锡被贬至和州，县令多次迁移其住所进行刁难
- 场景：你看到刘禹锡在这个环境中的境遇，前来与他对话

你的任务：
1. 用符合${personality.name}的身份和语言风格与刘禹锡对话
2. 体现你的${personality.interaction_style}
3. 可以适当引用你的经典语录或相关典故
4. 回应要有温度和深度，能给刘禹锡以启发或慰藉
5. 字数控制在120-180字之间

请用${personality.name}的身份直接对刘禹锡说话，不要加引号或解释：`;

            const response = await callDeepSeekAPI(prompt, { 
                temperature: 0.85,
                maxTokens: 300 
            });

            // 记录AI调用
            dialogueControls.recordAICall(characterId, currentEnvironment);
            
            return response;
        }

        // 获取当前环境
        function getCurrentEnvironment() {
            // 根据当前游戏阶段确定环境
            if (gameState.currentStage <= 2) return "江边";
            if (gameState.currentStage <= 4) return "柳边";
            return "斗室";
        }

        // 获取环境描述
        function getEnvironmentDescription(environment) {
            const descriptions = {
                "江边": "江水悠悠，微风徐来，简朴的小屋临江而建，虽显简陋但别有意境",
                "柳边": "垂柳依依，绿意盎然，柳荫下的小屋更显清幽静谧",
                "斗室": "空间狭小如斗，但整洁有序，一桌一椅，苔痕上阶绿，草色入帘青"
            };
            return descriptions[environment] || environment;
        }

        // ====== 灵活多轮连续对话系统 ======
        
        // 动态多轮对话管理器
        const flexibleMultiRoundDialogue = {
            
            // 动态选择讨论参与者
            selectParticipants: function(initialCharacter, environment, topic) {
                // 所有可用角色
                const allCharacters = Object.keys(aiPersonalities);
                
                // 根据话题和环境动态筛选相关人物
                const relevantCharacters = this.getRelevantCharacters(topic, environment, allCharacters);
                
                // 确保初始角色在列表中
                if (!relevantCharacters.includes(initialCharacter)) {
                    relevantCharacters.unshift(initialCharacter);
                }
                
                // 限制参与者数量（3-4人为最佳）
                const maxParticipants = 4;
                const participants = relevantCharacters.slice(0, maxParticipants);
                
                console.log(`话题"${topic}"选择参与者:`, participants.map(c => aiPersonalities[c]?.name || c));
                return participants;
            },
            
            // 根据话题和环境获取相关人物
            getRelevantCharacters: function(topic, environment, allCharacters) {
                const relevanceScores = {};
                
                // 为每个角色计算相关性分数
                allCharacters.forEach(charId => {
                    const personality = aiPersonalities[charId];
                    if (!personality) return;
                    
                    let score = 0;
                    
                    // 1. 话题相关性
                    const topicKeywords = this.getTopicKeywords(topic);
                    const matchingConcepts = personality.key_concepts.filter(concept => 
                        topicKeywords.some(keyword => keyword.includes(concept) || concept.includes(keyword))
                    ).length;
                    score += matchingConcepts * 30;
                    
                    // 2. 环境相关性
                    const envKeywords = this.getEnvironmentKeywords(environment);
                    const envMatches = personality.key_concepts.filter(concept => 
                        envKeywords.some(keyword => keyword.includes(concept) || concept.includes(keyword))
                    ).length;
                    score += envMatches * 20;
                    
                    // 3. 人物特质加分
                    if (topic.includes("贬谪") || topic.includes("逆境")) {
                        if (personality.background.includes("贬") || personality.background.includes("困")) score += 25;
                        if (charId === "baijuyi" || charId === "sushi") score += 30; // 同样遭贬谪
                    }
                    
                    if (topic.includes("心境") || topic.includes("修养")) {
                        if (personality.key_concepts.includes("禅意") || personality.key_concepts.includes("淡泊")) score += 25;
                    }
                    
                    if (topic.includes("陋室") || topic.includes("居住")) {
                        if (charId === "confucius" || charId === "yanhuei") score += 30; // 君子固穷
                        if (charId === "tao") score += 25; // 安贫乐道
                    }
                    
                    // 4. 随机因子增加变化性
                    score += Math.random() * 10;
                    
                    relevanceScores[charId] = score;
                });
                
                // 按分数排序并返回
                return Object.entries(relevanceScores)
                    .sort(([,a], [,b]) => b - a)
                    .map(([charId]) => charId);
            },
            
            // 获取话题关键词
            getTopicKeywords: function(topic) {
                const topicMappings = {
                    "贬谪逆境": ["贬谪", "逆境", "困境", "挫折", "坚强", "意志"],
                    "心境修养": ["心境", "修养", "静心", "禅意", "淡泊", "内心"],
                    "陋室真义": ["陋室", "简朴", "君子", "品德", "德馨", "修身"],
                    "人生智慧": ["智慧", "人生", "哲理", "感悟", "思考", "领悟"]
                };
                
                // 寻找最匹配的关键词
                for (const [key, keywords] of Object.entries(topicMappings)) {
                    if (topic.includes(key) || key.includes(topic)) {
                        return keywords;
                    }
                }
                
                // 默认通用关键词
                return ["智慧", "人生", "品德"];
            },
            
            // 获取环境关键词
            getEnvironmentKeywords: function(environment) {
                const envMappings = {
                    "江边": ["自然", "水", "流动", "变化", "开阔"],
                    "柳边": ["柔美", "春天", "生机", "诗意", "雅致"],
                    "斗室": ["简朴", "小", "精致", "内敛", "专注"]
                };
                return envMappings[environment] || ["环境", "空间"];
            },
            
            // 启动灵活多轮对话（增强版：支持自定义参与者）
            startFlexibleDiscussion: async function(initialCharacter, topic, environment, customParticipants = null) {
                console.log(`启动灵活多轮对话：${topic} 在 ${environment}`);
                
                // 动态选择参与者（优先使用自定义参与者）
                const participants = customParticipants || this.selectParticipants(initialCharacter, environment, topic);
                
                // 生成讨论主题
                const discussion = {
                    topic: topic,
                    environment: environment,
                    participants: participants
                };
                
                // 执行灵活对话
                await this.executeFlexibleRounds(discussion, initialCharacter);
            },
            
            // 执行灵活多轮对话
            executeFlexibleRounds: async function(discussion, initialCharacter) {
                console.log(`执行灵活多轮对话，主题：${discussion.topic}`);
                
                // 显示话题引入
                const participantNames = discussion.participants.map(id => aiPersonalities[id]?.name || id).join('、');
                const topicMessage = {
                    type: "system",
                    text: `💬 话题：${discussion.topic} | 参与讨论：${participantNames}`
                };
                await appendMessage(topicMessage, true);
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 动态生成对话轮次
                const rounds = await this.generateFlexibleRounds(discussion);
                
                // 执行每轮对话
                for (let i = 0; i < rounds.length; i++) {
                    const round = rounds[i];
                    
                    // 显示打字指示器
                    const speakerName = aiPersonalities[round.speaker]?.name || round.speaker;
                    showTypingIndicator(`${speakerName}正在输入...`);
                    
                    // 等待思考时间
                    await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1500));
                    
                    // 隐藏打字指示器
                    hideTypingIndicator();
                    
                    // 生成并显示对话
                    const responseText = await this.generateRoundResponse(round, discussion, i);
                    
                    const message = {
                        type: round.speaker,
                        text: responseText,
                        isFlexibleRound: true,
                        isAIGenerated: round.useAI
                    };
                    
                    await appendMessage(message, true);
                    
                    // 轮次间隔
                    if (i < rounds.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2500));
                    }
                }
                
                // 进入玩家提问环节
                setTimeout(async () => {
                    await this.startPlayerQuestionSession(discussion);
                }, 2000);
            },
            
            // 动态生成对话轮次
            generateFlexibleRounds: async function(discussion) {
                const rounds = [];
                const participants = [...discussion.participants];
                
                // 确保每个参与者都有机会发言
                participants.forEach((speaker, index) => {
                    const useAI = Math.random() < 0.7 && AI_FEATURES.enabled; // 70%概率使用AI
                    
                    rounds.push({
                        speaker: speaker,
                        order: index,
                        useAI: useAI,
                        context: {
                            isFirst: index === 0,
                            isLast: index === participants.length - 1,
                            previousSpeakers: participants.slice(0, index)
                        }
                    });
                });
                
                // 可能增加额外的互动轮次
                if (participants.length >= 3 && Math.random() < 0.4) {
                    // 随机选择一个人进行回应
                    const responder = participants[Math.floor(Math.random() * participants.length)];
                    rounds.push({
                        speaker: responder,
                        order: rounds.length,
                        useAI: Math.random() < 0.8 && AI_FEATURES.enabled,
                        context: {
                            isResponse: true,
                            isAdditional: true,
                            previousSpeakers: participants
                        }
                    });
                }
                
                return rounds;
            },
            
            // 生成单轮回应（质量保证机制）
            generateRoundResponse: async function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                if (!personality) {
                    return `${round.speaker}：深有同感，言之有理。`;
                }
                
                // 优先级策略：确保每轮对话质量
                let responseText = null;
                
                // 1. 首先尝试AI生成（如果条件允许）
                if (round.useAI && dialogueControls.canMakeAICall(round.speaker, discussion.environment)) {
                    try {
                        responseText = await this.generateAIResponse(round, discussion, roundIndex);
                        if (responseText && responseText.length > 50) { // 质量检查
                            console.log(`AI生成成功，轮次${roundIndex}，角色${round.speaker}`);
                            return responseText;
                        }
                    } catch (error) {
                        console.warn(`AI生成失败，轮次${roundIndex}，角色${round.speaker}:`, error);
                    }
                }
                
                // 2. 使用高质量预制回应
                responseText = this.getHighQualityPresetResponse(round, discussion, roundIndex);
                if (responseText) {
                    console.log(`使用预制回应，轮次${roundIndex}，角色${round.speaker}`);
                    return responseText;
                }
                
                // 3. 最后降级为通用回应
                return this.generateFallbackResponse(round, discussion, roundIndex);
            },
            
            // 获取高质量预制回应 - 修复匹配逻辑
            getHighQualityPresetResponse: function(round, discussion, roundIndex) {
                const environmentKey = `${discussion.environment.replace("江边", "riverbank").replace("柳边", "willows").replace("斗室", "chamber")}_${discussion.topic.includes("贬谪") ? "exile" : discussion.topic.includes("心境") ? "mindset" : "wisdom"}_discussion`;
                
                console.log(`查找预制回应: ${environmentKey}, 角色: ${round.speaker}, 轮次: ${roundIndex}`);
                
                // 查找匹配的预制对话
                const presetDiscussion = enhancedCharacterResponses[environmentKey];
                if (presetDiscussion && presetDiscussion.rounds) {
                    // 优先：精确角色匹配
                    const characterRound = presetDiscussion.rounds.find(r => r.speaker === round.speaker);
                    if (characterRound) {
                        console.log(`✅ 找到精确角色匹配: ${round.speaker}`);
                        return characterRound.response;
                    }
                    
                    // 降级：从专门的角色回应库查找
                    if (fallbackContent.characterResponses[round.speaker]) {
                        const responses = fallbackContent.characterResponses[round.speaker];
                        const randomIndex = Math.floor(Math.random() * responses.length);
                        console.log(`✅ 使用角色专属回应库: ${round.speaker}`);
                        return responses[randomIndex];
                    }
                    
                    console.log(`❌ 未找到角色匹配，返回null: ${round.speaker}`);
                }
                
                return null;
            },
            
            // AI生成回应
            generateAIResponse: async function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                
                // 构建上下文
                const contextText = round.context.isFirst ? 
                    "你是第一个发言的人，需要为这个话题奠定基调。" :
                    round.context.isLast ? 
                    "你是最后发言的人，需要总结前面的观点并给出深刻见解。" :
                    round.context.isResponse ?
                    "你是在其他人发言后进行的补充回应。" :
                    "你是在听取前面发言者意见后发表自己的看法。";
                
                const prompt = `你是${personality.name}（${personality.period}），正在参与一个关于"${discussion.topic}"的多人讨论。

当前环境：${discussion.environment}
讨论背景：刘禹锡被贬至和州，居住条件简陋，正在经历人生低谷
你的角色：${personality.background}
你的性格：${personality.personality}
语言风格：${personality.language_style}
核心理念：${personality.key_concepts.join('、')}

发言背景：${contextText}

要求：
1. 体现你的独特观点和人生阅历
2. 与话题紧密相关，对刘禹锡有启发意义
3. 符合你的历史身份和语言特色
4. 可以适当引用你的经典语录
5. 字数控制在100-150字
6. 语调要真诚有温度

请直接以${personality.name}的身份发言，不要加引号：`;

                const response = await callPoeAI(prompt, { 
                    temperature: 0.8,
                    maxTokens: 250
                });
                
                // 记录AI调用
                dialogueControls.recordAICall(round.speaker, discussion.environment);
                
                return response;
            },
            
            // 生成预制回应 - 修复角色匹配问题
            generateFallbackResponse: function(round, discussion, roundIndex) {
                const personality = aiPersonalities[round.speaker];
                if (!personality) {
                    return `${round.speaker}：深有同感，言之有理。`;
                }
                
                console.log(`生成预制回应 - 角色: ${round.speaker} (${personality.name}), 话题: ${discussion.topic}`);
                
                // 1. 优先使用角色专属回应库
                const fallbackResponses = fallbackContent.characterResponses[round.speaker];
                if (fallbackResponses && fallbackResponses.length > 0) {
                    const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
                    console.log(`✅ 使用角色专属回应: ${round.speaker}`);
                    return fallbackResponses[randomIndex];
                }
                
                // 2. 严格角色匹配的话题回应
                const characterSpecificResponses = {
                    "tao": {
                        "贬谪逆境": `梦得兄，外境虽变，内心可不变。我当年归隐田园🌾，众人皆言我愚，然'心远地自偏'，何惧外议？`,
                        "心境修养": `刘兄，'采菊东篱🌸下，悠然😌见南山🏔️'，心境自然🌿，远胜浮华。外物不足挂虑，内心充实为真。`,
                        "陋室真义": `观此陋室，倒让我想起彭泽茅屋。简朴之处，正可养浩然之气。`
                    },
                    "libai": {
                        "贬谪逆境": `哈哈！刘兄，区区贬谪算得什么？'天生我材💪必有用'，今日之困，他日之福也！且看大江东流，何等壮阔！`,
                        "心境修养": `梦得兄！'黄河之水天上来，奔流到海不复回'，人生短暂，何不痛饮一场？心境豁达😊，岂在屋舍？`,
                        "陋室真义": `'安能摧眉折腰事权贵'！真正的君子，岂会因区区陋室而改其志？仰天长啸出门去！`
                    },
                    "du": {
                        "贬谪逆境": `梦得兄，我亦曾居茅屋🏠，深知困顿之苦。然'位卑未敢忘忧国😟'，读书人当以天下为怀，个人得失何足道哉！`,
                        "心境修养": `刘兄，'会当凌绝顶，一览众山小'。虽处逆境，心系苍生👥的志向不可改。这正是磨砺心志的良机。`,
                        "陋室真义": `'安得广厦🏘️千万间，大庇天下寒士俱欢颜'。刘兄今日陋室，让我想起天下寒士，更显君子胸怀。`
                    },
                    "confucius": {
                        "贬谪逆境": `刘君，逆境正是修身🧘之时。'君子👨‍🎓固穷'，困顿中更能见君子本色。此乃天将降大任之征象。`,
                        "心境修养": `'君子👨‍🎓坦荡荡，小人长戚戚'。刘君当以德⭐修身🧘，以德⭐化人，外境岂能动其心？`,
                        "陋室真义": `刘君深得'陋室'真谛。'君子👨‍🎓居之，何陋之有？'德⭐行高尚者所居，岂因外在简陋而减其光华？`
                    },
                    "wangwei": {
                        "贬谪逆境": `刘兄，'行到水穷💧处，坐看云起☁️时'。逆境如水穷💧，心境如云起☁️，一切皆为修行。`,
                        "心境修养": `境由心转，心境清明，斗室亦是广厦。诗中有画，画中有禅🧘，此处正是悟道💡之所。`,
                        "陋室真义": `'空山新雨后，天气晚来秋'。陋室如空山，简朴中自有清韵🎵，岂非妙境？`
                    },
                    "sushi": {
                        "贬谪逆境": `梦得兄！我一生三遭贬谪📉，深知'回首向来萧瑟处，归去，也无风雨🌦️也无晴'的道理。苦中作乐😆，方为智者。`,
                        "心境修养": `'人生如逆旅🚶‍♂️，我亦是行人'。刘兄，何不学会苦中作乐😆？这柳荫下品茶论诗，岂不快哉🎉？`,
                        "陋室真义": `哈哈！我在黄州时也居茅屋，'莫听穿林打叶声，何妨吟啸且徐行'。居所虽陋，心境可宽。`
                    },
                    "yanhuei": {
                        "贬谪逆境": `弟子深有同感。'一箪食🍚，一瓢饮🥛，在陋巷🏘️，人不堪其忧，回也不改其乐😌'。外物不足挂虑，内心充实方为真乐。`,
                        "心境修养": `夫子常教导我们，君子应该安贫🙏乐道😌。内心有道，处处皆可修身🧘养性。`,
                        "陋室真义": `此室虽小，但有德者居之，便是君子之室。正如夫子所言'君子居之，何陋之有？'`
                    },
                    "zhugeliang": {
                        "贬谪逆境": `亮当年隐居隆中🏕️草庐🏠，亦不过数椽，然能运筹📋帷幄。'非淡泊🍃无以明志，非宁静无以致远🎯'，刘兄今日境遇，他日必成美谈。`,
                        "心境修养": `以亮观之，此正是静心思考的良机。'宁静以致远🎯'，外在的简陋，正可成就内心的辽阔🌌。`,
                        "陋室真义": `隆中🏕️草庐🏠三顾👥，不也是陋室？然志存高远者，岂会因居所简陋而减其智谋🧠？`
                    },
                    "baijuyi": {
                        "贬谪逆境": `梦得兄！'同是天涯沦落😔人，相逢何必曾相识'！我当年贬江州🌊司马，深知此中滋味。`,
                        "心境修养": `我写《琵琶🎵行》时，正是感慨万千。然正是这些际遇，让我们更能理解民生👥疾苦💔，文章也因此更有温度🔥。`,
                        "陋室真义": `这斗室虽小，情怀❤️却大！正是这些经历，让我们的诗文更贴近百姓心声。`
                    }
                };
                
                // 查找该角色的话题回应
                if (characterSpecificResponses[round.speaker]) {
                    for (const [topicKey, response] of Object.entries(characterSpecificResponses[round.speaker])) {
                        if (discussion.topic.includes(topicKey.slice(0, 2))) {
                            console.log(`✅ 找到角色话题匹配: ${round.speaker} - ${topicKey}`);
                            return response;
                        }
                    }
                }
                
                // 3. 角色风格通用回应
                const styleBasedResponses = {
                    "tao": `梦得兄，'心远地自偏'，外在环境不足以限制内心的宁静🧘‍♂️。`,
                    "libai": `哈哈！刘兄，'长风破浪⛵会有时，直挂云帆⛵济沧海'！`,
                    "du": `梦得兄，我等读书人当'位卑未敢忘忧国😟'，个人得失何足道哉！`,
                    "confucius": `刘君，'德⭐不孤，必有邻🤝'。君子👨‍🎓修身🧘，自有知音相伴。`,
                    "wangwei": `刘兄，境由心转，心境清明，外物岂能扰之？诗中有画，画中有禅🧘。`,
                    "sushi": `梦得兄！'回首向来萧瑟处，也无风雨🌦️也无晴'，何不苦中作乐😆？`
                };
                
                if (styleBasedResponses[round.speaker]) {
                    console.log(`✅ 使用风格通用回应: ${round.speaker}`);
                    return styleBasedResponses[round.speaker];
                }
                
                // 4. 最后的降级回应，确保名字正确
                console.log(`⚠️ 使用最终降级回应: ${round.speaker}`);
                return `${personality.name}：刘兄所言甚是，深有同感。`;
            },
            
            // ===== 新增：玩家提问环节核心功能 =====
            
            // 开始玩家提问环节
            startPlayerQuestionSession: async function(discussion) {
                const introMessage = {
                    type: "system",
                    text: `🤔 提问环节：您可以向在场的历史人物或其他学者提问。格式：@人物名字 您的问题`
                };
                await appendMessage(introMessage, true);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 显示提问界面
                this.showQuestionInterface(discussion);
            },
            
            // 显示提问界面
            showQuestionInterface: function(discussion) {
                // 隐藏常规选项
                optionsContainer.classList.add('translate-y-full');
                
                // 显示提问输入框
                const userInput = document.getElementById('userInput');
                userInput.disabled = false;
                userInput.readOnly = false;
                userInput.className = userInput.className.replace('text-gray-400', 'text-gray-800');
                userInput.placeholder = '@人物名字 您的问题...';
                userInput.value = '';
                
                // 绑定提问事件
                const questionHandler = async (e) => {
                    if (e.key === 'Enter' && userInput.value.trim()) {
                        const question = userInput.value.trim();
                        userInput.value = '';
                        
                        await this.handlePlayerQuestion(question, discussion);
                        
                        // 询问是否继续提问
                        setTimeout(() => {
                            this.askContinueQuestion(discussion, questionHandler);
                        }, 2000);
                    }
                };
                
                userInput.addEventListener('keydown', questionHandler);
                userInput.focus();
                
                // 显示提示选项
                this.showQuestionHints(discussion);
            },
            
            // 显示提问提示
            showQuestionHints: function(discussion) {
                const hintMessage = {
                    type: "system",
                    text: `💡 提示：在场学者有 ${discussion.participants.map(id => aiPersonalities[id]?.name || id).join('、')}，您也可以@其他历史人物`
                };
                appendMessage(hintMessage, true);
            },
            
            // 处理玩家提问
            handlePlayerQuestion: async function(question, discussion) {
                // 显示玩家的问题
                const playerMessage = {
                    type: "liuyuxi",
                    text: question
                };
                await appendMessage(playerMessage, true);
                
                // 智能解析问题内容和匹配人物
                const { mentionedCharacter, questionContent, isExplicitMention } = this.parsePlayerQuestion(question);
                
                if (!mentionedCharacter || !questionContent) {
                    const errorMessage = {
                        type: "system",
                        text: `❓ 未能理解您的问题。${isExplicitMention ? '请检查人物名称是否正确' : '系统将为您智能匹配合适的学者回答'}`
                    };
                    await appendMessage(errorMessage, true);
                    
                    // 如果是智能匹配失败，尝试使用默认学者
                    if (!isExplicitMention) {
                        const defaultCharacter = 'confucius';
                        const defaultResponse = {
                            type: defaultCharacter,
                            text: `${aiPersonalities[defaultCharacter].name}：这个问题很有思考价值，虽然我可能不是最合适的回答者，但愿以我的见解供您参考。`
                        };
                        await appendMessage(defaultResponse, true);
                    }
                    return;
                }
                
                // 智能匹配，但不显示提示信息
                
                // 智能匹配回应人物
                const respondingCharacter = this.findBestResponder(mentionedCharacter, discussion.participants);
                
                // 生成回应
                await this.generateQuestionResponse(respondingCharacter, questionContent, mentionedCharacter, discussion);
            },
            
            // 智能分析玩家问题
            parsePlayerQuestion: function(question) {
                // 检查是否是传统@格式
                const atMatch = question.match(/@([^\s]+)\s+(.+)/);
                if (atMatch) {
                    return {
                        mentionedCharacter: atMatch[1].trim(),
                        questionContent: atMatch[2].trim(),
                        isExplicitMention: true
                    };
                }
                
                // 智能分析问题内容，自动匹配人物
                return {
                    mentionedCharacter: this.intelligentCharacterMatching(question),
                    questionContent: question.trim(),
                    isExplicitMention: false
                };
            },
            
            // 智能人物匹配核心算法
            intelligentCharacterMatching: function(question) {
                console.log(`智能分析问题: "${question}"`);
                
                // 1. 问题关键词分析
                const questionAnalysis = this.analyzeQuestionKeywords(question);
                console.log('问题分析结果:', questionAnalysis);
                
                // 2. 计算每个人物的匹配分数
                const characterScores = {};
                
                for (const [charId, personality] of Object.entries(aiPersonalities)) {
                    let score = 0;
                    
                    // 直接提及人物名字 (最高优先级)
                    if (question.includes(personality.name)) {
                        score += 100;
                        console.log(`直接提及 ${personality.name}: +100分`);
                    }
                    
                    // 核心理念匹配
                    const conceptMatches = personality.key_concepts.filter(concept => 
                        questionAnalysis.keywords.some(keyword => 
                            keyword.includes(concept) || concept.includes(keyword)
                        )
                    ).length;
                    score += conceptMatches * 25;
                    if (conceptMatches > 0) {
                        console.log(`${personality.name} 理念匹配 ${conceptMatches}个: +${conceptMatches * 25}分`);
                    }
                    
                    // 问题类型匹配
                    score += this.getCharacterTypeScore(charId, questionAnalysis.type);
                    
                    // 历史背景匹配
                    score += this.getHistoricalContextScore(charId, questionAnalysis);
                    
                    // 语言风格匹配
                    score += this.getLanguageStyleScore(charId, questionAnalysis);
                    
                    characterScores[charId] = score;
                }
                
                // 3. 选择最高分的人物
                const bestMatch = Object.entries(characterScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3); // 取前3名用于debug
                
                console.log('人物匹配得分排行:', bestMatch.map(([id, score]) => 
                    `${aiPersonalities[id].name}: ${score}分`
                ));
                
                const selectedCharacter = bestMatch[0][0];
                const selectedName = aiPersonalities[selectedCharacter].name;
                console.log(`✅ 最终选择: ${selectedName} (${bestMatch[0][1]}分)`);
                
                return selectedCharacter;
            },
            
            // 分析问题关键词和类型
            analyzeQuestionKeywords: function(question) {
                const analysis = {
                    type: "通用",
                    keywords: [],
                    domain: "通用",
                    emotion: "中性"
                };
                
                // 问题类型识别
                const questionTypes = {
                    "人生哲理": ["人生", "生活", "意义", "价值", "哲理", "道理", "智慧"],
                    "修身养性": ["修身", "品德", "道德", "修养", "君子", "品格", "德行"],
                    "处世智慧": ["处世", "交友", "社交", "人际", "相处", "待人"],
                    "学习读书": ["学习", "读书", "知识", "学问", "治学", "求学"],
                    "政治理想": ["政治", "治国", "理想", "抱负", "国家", "天下"],
                    "情感心境": ["心情", "情感", "心境", "感情", "快乐", "悲伤", "愁苦"],
                    "文学创作": ["文学", "诗词", "创作", "写作", "文章", "诗歌"],
                    "逆境应对": ["困难", "挫折", "逆境", "贬谪", "失意", "坎坷"],
                    "自然哲学": ["自然", "山水", "田园", "隐居", "归隐", "宁静"],
                    "社会责任": ["责任", "使命", "担当", "忧国", "忧民", "苍生"]
                };
                
                // 提取关键词和确定类型
                let maxMatches = 0;
                for (const [type, keywords] of Object.entries(questionTypes)) {
                    const matches = keywords.filter(keyword => question.includes(keyword));
                    if (matches.length > maxMatches) {
                        maxMatches = matches.length;
                        analysis.type = type;
                        analysis.keywords = [...analysis.keywords, ...matches];
                    }
                }
                
                // 特殊关键词提取
                const specialKeywords = ["什么是", "如何", "怎样", "为什么", "应该"];
                analysis.keywords.push(...specialKeywords.filter(kw => question.includes(kw)));
                
                return analysis;
            },
            
            // 计算人物类型匹配分数
            getCharacterTypeScore: function(charId, questionType) {
                const typeMatchings = {
                    "人生哲理": {
                        "confucius": 30, "tao": 25, "sushi": 25, "zhugeliang": 20
                    },
                    "修身养性": {
                        "confucius": 35, "yanhuei": 30, "zengzi": 25, "yangxiong": 20
                    },
                    "处世智慧": {
                        "confucius": 30, "sushi": 25, "zhugeliang": 25, "tao": 20
                    },
                    "学习读书": {
                        "confucius": 35, "zengzi": 25, "yangxiong": 25, "yanhuei": 20
                    },
                    "政治理想": {
                        "confucius": 25, "zhugeliang": 30, "du": 25, "yangxiong": 20
                    },
                    "情感心境": {
                        "liqingzhao": 30, "tao": 25, "wangwei": 25, "sushi": 20
                    },
                    "文学创作": {
                        "libai": 30, "du": 30, "liqingzhao": 25, "wangwei": 25
                    },
                    "逆境应对": {
                        "sushi": 30, "tao": 25, "baijuyi": 25, "yanhuei": 20
                    },
                    "自然哲学": {
                        "tao": 35, "wangwei": 30, "zhugeliang": 20, "libai": 15
                    },
                    "社会责任": {
                        "du": 35, "confucius": 30, "zhugeliang": 25, "baijuyi": 20
                    }
                };
                
                const score = typeMatchings[questionType]?.[charId] || 0;
                if (score > 0) {
                    console.log(`${aiPersonalities[charId].name} 类型匹配(${questionType}): +${score}分`);
                }
                return score;
            },
            
            // 历史背景匹配分数
            getHistoricalContextScore: function(charId, analysis) {
                let score = 0;
                const personality = aiPersonalities[charId];
                
                // 时代背景关键词
                const eraKeywords = {
                    "春秋": ["礼制", "仁政", "德治"],
                    "汉代": ["经学", "文章"],
                    "唐代": ["诗歌", "盛世", "开放"],
                    "宋代": ["理学", "词作", "文人"]
                };
                
                for (const [era, keywords] of Object.entries(eraKeywords)) {
                    if (personality.period.includes(era)) {
                        const matches = keywords.filter(kw => 
                            analysis.keywords.some(qkw => qkw.includes(kw) || kw.includes(qkw))
                        ).length;
                        score += matches * 10;
                    }
                }
                
                return score;
            },
            
            // 语言风格匹配分数
            getLanguageStyleScore: function(charId, analysis) {
                const styleKeywords = {
                    "confucius": ["教导", "引导", "启发", "道德"],
                    "libai": ["豪迈", "自由", "理想", "激情"],
                    "du": ["忧虑", "社会", "现实", "责任"],
                    "tao": ["宁静", "自然", "简朴", "归隐"],
                    "wangwei": ["意境", "禅意", "空灵", "山水"],
                    "sushi": ["乐观", "幽默", "豁达", "变通"]
                };
                
                const charKeywords = styleKeywords[charId] || [];
                const matches = charKeywords.filter(kw => 
                    analysis.keywords.some(qkw => qkw.includes(kw) || kw.includes(qkw))
                ).length;
                
                return matches * 15;
            },
            
            // 智能匹配最佳回应人物
            findBestResponder: function(mentionedCharacter, participants) {
                console.log(`🔍 寻找回应人物，查询: "${mentionedCharacter}"`);
                
                // 1. 精确匹配人物全名（最高优先级）
                for (const [id, personality] of Object.entries(aiPersonalities)) {
                    if (personality.name === mentionedCharacter) {
                        console.log(`✅ 精确匹配人物全名: ${personality.name} (${id})`);
                        return id;
                    }
                }
                
                // 2. 精确匹配人物ID
                if (aiPersonalities[mentionedCharacter]) {
                    console.log(`✅ 精确匹配人物ID: ${aiPersonalities[mentionedCharacter].name} (${mentionedCharacter})`);
                    return mentionedCharacter;
                }
                
                // 3. 全局别名库匹配
                if (GLOBAL_CHARACTER_ALIASES[mentionedCharacter]) {
                    const matchedId = GLOBAL_CHARACTER_ALIASES[mentionedCharacter];
                    console.log(`✅ 别名匹配成功: "${mentionedCharacter}" → ${aiPersonalities[matchedId]?.name || matchedId} (${matchedId})`);
                    return matchedId;
                }
                
                // 4. 部分名字匹配
                for (const [id, personality] of Object.entries(aiPersonalities)) {
                    if (personality.name.includes(mentionedCharacter) || mentionedCharacter.includes(personality.name)) {
                        console.log(`🔍 部分名字匹配: ${personality.name} (${id})`);
                        return id;
                    }
                }
                
                // 5. 找相关人物代为回答
                const relatedCharacter = this.findRelatedCharacter(mentionedCharacter, participants);
                if (relatedCharacter) {
                    console.log(`🔗 找到相关人物代答: ${aiPersonalities[relatedCharacter]?.name}`);
                    return relatedCharacter;
                }
                
                // 6. 智能选择默认回答者（避免总是孔子）
                const fallbackCharacters = ['sushi', 'tao', 'wangwei', 'confucius', 'libai'];
                const randomFallback = fallbackCharacters[Math.floor(Math.random() * fallbackCharacters.length)];
                console.log(`🎲 智能选择默认回答者: ${aiPersonalities[randomFallback]?.name} (避免总是孔子)`);
                return randomFallback;
            },
            
            // 寻找相关人物
            findRelatedCharacter: function(mentionedCharacter, participants) {
                // 时代相关性映射
                const eraRelations = {
                    "春秋": ["confucius", "yanhuei", "zengzi"],
                    "战国": ["confucius", "zengzi"],
                    "汉": ["yangxiong"],
                    "三国": ["zhugeliang"],
                    "晋": ["tao"],
                    "唐": ["libai", "du", "wangwei", "baijuyi"],
                    "宋": ["sushi", "liqingzhao"]
                };
                
                // 学派相关性映射
                const schoolRelations = {
                    "儒家": ["confucius", "yanhuei", "zengzi"],
                    "道家": ["tao"],
                    "兵家": ["zhugeliang"],
                    "诗人": ["libai", "du", "wangwei", "baijuyi", "sushi", "liqingzhao"]
                };
                
                // 优先从参与者中寻找相关人物
                for (const participant of participants) {
                    const personality = aiPersonalities[participant];
                    if (personality) {
                        // 检查时代关联
                        for (const [era, chars] of Object.entries(eraRelations)) {
                            if (mentionedCharacter.includes(era) && chars.includes(participant)) {
                                return participant;
                            }
                        }
                        
                        // 检查学派关联
                        for (const [school, chars] of Object.entries(schoolRelations)) {
                            if (mentionedCharacter.includes(school) && chars.includes(participant)) {
                                return participant;
                            }
                        }
                    }
                }
                
                return null;
            },
            
            // 生成问题回应
            generateQuestionResponse: async function(respondingCharacter, questionContent, originalMention, discussion) {
                const personality = aiPersonalities[respondingCharacter];
                if (!personality) {
                    return;
                }
                
                // 显示打字指示器
                showTypingIndicator(`${personality.name}正在输入...`);
                
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1500));
                
                try {
                    let responseText;
                    
                    // 是否是代为回答的情况
                    const isProxyResponse = originalMention !== personality.name && originalMention !== respondingCharacter;
                    
                    // 尝试AI生成（如果可用）
                    if (AI_FEATURES.enabled && dialogueControls.canMakeAICall(respondingCharacter)) {
                        responseText = await this.generateAIQuestionResponse(
                            respondingCharacter, questionContent, originalMention, isProxyResponse
                        );
                    } else {
                        // 使用预制回应
                        responseText = this.generatePresetQuestionResponse(
                            respondingCharacter, questionContent, originalMention, isProxyResponse
                        );
                    }
                    
                    hideTypingIndicator();
                    
                    // 显示回应
                    const responseMessage = {
                        type: respondingCharacter,
                        text: responseText,
                        isQuestionResponse: true
                    };
                    
                    await appendMessage(responseMessage, true);
                    
                } catch (error) {
                    console.error('生成问题回应失败', error);
                    hideTypingIndicator();
                    
                    const fallbackResponse = {
                        type: respondingCharacter,
                        text: `${personality.name}：这是一个很有深度的问题，值得我们深思。`
                    };
                    
                    await appendMessage(fallbackResponse, true);
                }
            },
            
            // AI生成问题回应
            generateAIQuestionResponse: async function(characterId, question, originalMention, isProxy) {
                const personality = aiPersonalities[characterId];
                
                let promptPrefix = "";
                if (isProxy) {
                    promptPrefix = `刘禹锡刚才询问"${originalMention}"，但此人不在场，你来代为回答。请在回答前说明这个情况。`;
                }
                
                const prompt = `你是${personality.name}（${personality.period}），${personality.background}。

${promptPrefix}

问题：${question}

你的性格：${personality.personality}
语言风格：${personality.language_style}
核心理念：${personality.key_concepts.join('、')}

请回答这个问题，要求：
1. 符合你的历史身份和语言风格
2. 回答要有深度和启发性
3. 可以适当引用你的经典语录或相关典故
4. 体现你的人生智慧和经验
5. 字数控制在150-250字
6. 语调要亲切自然，富有教育意义

请以${personality.name}的身份直接回答：`;

                const response = await callPoeAI(prompt, { 
                    temperature: 0.7,
                    maxTokens: 400
                });
                
                dialogueControls.recordAICall(characterId);
                return response;
            },
            
            // 预制问题回应
            generatePresetQuestionResponse: function(characterId, question, originalMention, isProxy) {
                const personality = aiPersonalities[characterId];
                
                let proxyPrefix = "";
                if (isProxy) {
                    proxyPrefix = `虽然刘兄询问的是"${originalMention}"，但此人不在此处，我来为其代答。`;
                }
                
                // 根据问题类型生成回应
                const questionType = this.categorizeQuestion(question);
                const responseTemplates = this.getResponseTemplates(characterId, questionType);
                
                if (responseTemplates && responseTemplates.length > 0) {
                    const randomResponse = responseTemplates[Math.floor(Math.random() * responseTemplates.length)];
                    return `${personality.name}：${proxyPrefix}${randomResponse}`;
                }
                
                // 通用回应
                return `${personality.name}：${proxyPrefix}这是一个很好的问题。以我的经验来看，${this.getGenericWisdom(characterId, question)}`;
            },
            
            // 问题分类
            categorizeQuestion: function(question) {
                const categories = {
                    "人生哲理": ["人生", "生活", "意义", "价值", "哲理"],
                    "修身养性": ["修身", "品德", "道德", "修养", "君子"],
                    "处世智慧": ["处世", "交友", "社交", "人际", "智慧"],
                    "学习读书": ["学习", "读书", "知识", "学问", "治学"],
                    "政治抱负": ["政治", "治国", "理想", "抱负", "国家"],
                    "情感心境": ["心情", "情感", "心境", "感情", "快乐", "悲伤"],
                    "文学创作": ["文学", "诗词", "创作", "写作", "文章"]
                };
                
                for (const [category, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => question.includes(keyword))) {
                        return category;
                    }
                }
                
                return "通用智慧";
            },
            
            // 获取回应模板
            getResponseTemplates: function(characterId, questionType) {
                const templates = {
                    "confucius": {
                        "人生哲理": [
                            "'三十而立，四十而不惑，五十而知天命'，人生的每个阶段都有其价值和意义。",
                            "'己所不欲，勿施于人'，这是做人的根本道理。"
                        ],
                        "修身养性": [
                            "'吾日三省吾身'，每日反思自己的言行，这是修身的基础。",
                            "'君子喻于义，小人喻于利'，重德轻利，方为君子之道。"
                        ]
                    },
                    "tao": {
                        "人生哲理": [
                            "'人生天地之间，若白驹过隙，忽然而已'，要珍惜当下，追求内心的宁静。",
                            "'心远地自偏'，只要内心远离尘嚣，处处都可以是桃花源。"
                        ],
                        "修身养性": [
                            "'真意'难得，'归真返朴'是人生的至高境界。"
                        ]
                    },
                    "libai": {
                        "人生哲理": [
                            "'天生我材必有用，千金散尽还复来'，要对自己有信心，对人生充满乐观。",
                            "'长风破浪会有时，直挂云帆济沧海'，困难只是暂时的，要有远大的理想。"
                        ]
                    }
                };
                
                return templates[characterId]?.[questionType] || null;
            },
            
            // 获取通用智慧
            getGenericWisdom: function(characterId, question) {
                const personality = aiPersonalities[characterId];
                const wisdomMap = {
                    "confucius": "君子当以德修身，以仁待人，这样才能在任何境遇中保持内心的平静。",
                    "tao": "外在的环境变化并不重要，重要的是保持内心的纯真和自然。",
                    "libai": "人生在世，当追求自由和理想，不要被小的挫折所困扰。",
                    "du": "无论处在什么环境中，都不要忘记对国家和人民的责任。",
                    "wangwei": "万物皆有其自然的规律，静心观察，便能领悟其中的道理。",
                    "sushi": "人生起伏是常态，学会在变化中保持乐观的心态最为重要。"
                };
                
                return wisdomMap[characterId] || "每个人都有自己的人生体悟，重要的是找到适合自己的道路。";
            },
            
            // 询问是否继续提问 - 简化版
            askContinueQuestion: function(discussion, questionHandler) {
                // 显示简化的结束选项
                optionsList.innerHTML = '';
                
                const endOption = document.createElement('button');
                endOption.className = 'w-full p-3 text-left bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200 border border-green-200';
                endOption.textContent = '✅ 没有疑问了，继续游戏';
                endOption.addEventListener('click', () => {
                    this.endQuestionSession(discussion, questionHandler);
                });
                
                optionsList.appendChild(endOption);
                optionsContainer.classList.remove('translate-y-full');
            },
            
            // 结束提问环节
            endQuestionSession: function(discussion, questionHandler) {
                // 隐藏选项
                optionsContainer.classList.add('translate-y-full');
                
                // 禁用输入框
                const userInput = document.getElementById('userInput');
                userInput.disabled = true;
                userInput.readOnly = true;
                userInput.className = userInput.className.replace('text-gray-800', 'text-gray-400');
                userInput.placeholder = '点击此处继续...';
                userInput.value = '';
                
                // 移除事件监听
                userInput.removeEventListener('keydown', questionHandler);
                
                // 显示讨论总结
                setTimeout(async () => {
                    const summaryMessage = {
                        type: "system",
                        text: `📚 "${discussion.topic}"讨论结束。友人各抒己见，为刘禹锡提供了不同角度的智慧启发。`
                    };
                    await appendMessage(summaryMessage, true);
                    
                    // 继续游戏流程
                    setTimeout(() => {
                        proceedToStage(gameState.currentStage + 1);
                    }, 2000);
                }, 1000);
            }
        };

        // 智能话题匹配系统
        const intelligentTopicMatcher = {
            // 解析@内容生成个性化话题
            parseTopicFromMention: function(mentionText) {
                console.log(`🧠 解析@内容: "${mentionText}"`);
                
                // 提取关键话题词汇
                const topicKeywords = this.extractTopicKeywords(mentionText);
                
                // 生成个性化话题
                const customTopic = this.generateCustomTopic(topicKeywords, mentionText);
                
                // 智能匹配参与者
                const participants = this.matchParticipants(topicKeywords, mentionText);
                
                console.log(`✅ 生成个性化话题: "${customTopic.title}"`);
                console.log(`👥 匹配参与者:`, participants);
                
                return {
                    topic: customTopic,
                    participants: participants
                };
            },
            
            // 提取话题关键词
            extractTopicKeywords: function(mentionText) {
                const keywordMappings = {
                    "隐居": ["隐居", "归隐", "田园", "出世"],
                    "贬谪": ["贬谪", "贬官", "逆境", "困顿"],
                    "豪迈": ["豪迈", "豪放", "自由", "理想"],
                    "君子": ["君子", "品格", "修身", "德行"],
                    "禅意": ["禅意", "山水", "意境", "清净"],
                    "策略": ["策略", "智慧", "以退为进", "规划"],
                    "责任": ["责任", "同病相怜", "文人", "社会"],
                    "旷达": ["旷达", "乐观", "豁达", "处世"],
                    "坚强": ["坚强", "女性", "品格", "坚韧"],
                    "安贫": ["安贫", "乐道", "简朴", "知足"]
                };
                
                const foundKeywords = [];
                for (const [category, keywords] of Object.entries(keywordMappings)) {
                    if (keywords.some(keyword => mentionText.includes(keyword))) {
                        foundKeywords.push(category);
                    }
                }
                
                return foundKeywords.length > 0 ? foundKeywords : ["人生哲学"];
            },
            
            // 生成个性化话题
            generateCustomTopic: function(keywords, mentionText) {
                const topicTemplates = {
                    "隐居": {
                        title: "隐居与出世：古代智慧的现代思考",
                        description: "在快节奏的现代社会，古人的隐居思想给我们什么启发？"
                    },
                    "贬谪": {
                        title: "文人理想与现实冲突：从贬谪到成长",
                        description: "面对人生挫折，古代文人如何在逆境中保持内心的坚韧？"
                    },
                    "豪迈": {
                        title: "自由精神与人生理想：豪迈人生观的当代价值",
                        description: "李白式的自由豪迈，在现代社会中如何体现和实践？"
                    },
                    "君子": {
                        title: "君子品格的古今意义：现代社会的道德修养",
                        description: "孔子理想的君子风范，在当代社会中如何理解和践行？"
                    },
                    "禅意": {
                        title: "山水意境与内心修养：诗意生活的现代追求",
                        description: "王维的山水禅意，如何帮助现代人找到内心的宁静？"
                    },
                    "策略": {
                        title: "智慧策略与人生规划：以退为进的处世哲学",
                        description: "诸葛亮的智慧策略，对现代人的人生规划有什么指导意义？"
                    },
                    "责任": {
                        title: "文人命运与社会责任：知识分子的历史使命",
                        description: "从古到今，文人学者如何在个人际遇与社会责任间找到平衡？"
                    },
                    "旷达": {
                        title: "乐观豁达的处世智慧：苏轼式的人生态度",
                        description: "面对人生起伏，如何保持苏轼般的旷达乐观？"
                    },
                    "坚强": {
                        title: "古今女性的坚韧品格：从李清照看女性力量",
                        description: "李清照的坚强品格，对现代女性有什么启发和意义？"
                    },
                    "安贫": {
                        title: "简朴生活的精神追求：颜回式的人生智慧",
                        description: "在物质丰富的时代，颜回的安贫乐道还有现实意义吗？"
                    }
                };
                
                const primaryKeyword = keywords[0];
                return topicTemplates[primaryKeyword] || {
                    title: "古代智慧的现代启发：跨越时空的人生思考",
                    description: "古代先贤的人生智慧，如何指导我们的现代生活？"
                };
            },
            
            // 智能匹配参与者
            matchParticipants: function(keywords, mentionText) {
                const participantMappings = {
                    "隐居": ["tao", "wangwei", "zhugeliang"],
                    "贬谪": ["du", "baijuyi", "sushi"],
                    "豪迈": ["libai", "sushi", "liqingzhao"],
                    "君子": ["confucius", "yanhuei", "zengzi"],
                    "禅意": ["wangwei", "tao", "confucius"],
                    "策略": ["zhugeliang", "confucius", "sushi"],
                    "责任": ["du", "baijuyi", "confucius"],
                    "旷达": ["sushi", "libai", "tao"],
                    "坚强": ["liqingzhao", "confucius", "du"],
                    "安贫": ["yanhuei", "tao", "confucius"]
                };
                
                let participants = [];
                keywords.forEach(keyword => {
                    const matched = participantMappings[keyword] || [];
                    participants.push(...matched);
                });
                
                // 去重并限制数量
                participants = [...new Set(participants)];
                return participants.slice(0, 4);
            }
        };

        // 15秒倒计时选择机制
        let optionSelectionTimer = null;
        let hasUserMadeChoice = false;

        // 处理@历史人物（智能话题匹配版）
        async function handleMention(character, mentionText = null, isTimedChoice = false) {
            console.log(`🎭 处理@人物: ${character}, 文本: "${mentionText}", 是否快速选择: ${isTimedChoice}`);
            
            // 清除可能存在的计时器
            if (optionSelectionTimer) {
                clearTimeout(optionSelectionTimer);
                optionSelectionTimer = null;
            }
            
            // 🔧 使用统一别名解析系统
            const resolvedCharacter = resolveCharacterAlias(character) || character;
            const characterName = aiPersonalities[resolvedCharacter]?.name || resolvedCharacter;
            const currentEnvironment = getCurrentEnvironment();
            
            // 显示打字指示器
            showTypingIndicator(`${characterName}正在输入...`);
            
            setTimeout(async () => {
                try {
                    // 获取初始回应
                    let responseText = getFallbackResponse(resolvedCharacter);
                    
                    // 隐藏打字指示器
                    hideTypingIndicator();

                    // 显示初始回应
                    const response = {
                        type: character,
                        text: responseText,
                        isInitialResponse: true
                    };

                    await appendMessage(response, true);
                    
                    // 记录已@过的角色
                    if (!gameState.mentionedCharacters) {
                        gameState.mentionedCharacters = [];
                    }
                    if (!gameState.mentionedCharacters.includes(character)) {
                        gameState.mentionedCharacters.push(character);
                    }

                    // 根据是否快速选择决定话题类型
                    let discussionTopic, participants;
                    
                    if (isTimedChoice && mentionText) {
                        // 快速选择：使用智能话题匹配
                        const customResult = intelligentTopicMatcher.parseTopicFromMention(mentionText);
                        discussionTopic = customResult.topic.title;
                        participants = customResult.participants;
                        
                        console.log(`🚀 使用智能匹配话题: ${discussionTopic}`);
                    } else {
                        // 超时或无明确话题：使用环境固定话题
                        discussionTopic = getCurrentTopic(currentEnvironment);
                        participants = getCurrentParticipants();
                        
                        console.log(`⏰ 使用环境固定话题: ${discussionTopic}`);
                    }

                    // 短暂停顿后启动灵活多轮对话
                    setTimeout(() => {
                        flexibleMultiRoundDialogue.startFlexibleDiscussion(
                            character, 
                            discussionTopic,
                            currentEnvironment,
                            participants
                        );
                    }, 2000);
                    
                } catch (error) {
                    console.error('处理@历史人物时发生错误', error);
                    hideTypingIndicator();
                    
                    // 错误时的通用回应
                    const errorCharacterName = aiPersonalities[character]?.name || character;
                    const errorResponse = {
                        type: character,
                        text: `${errorCharacterName}：刘兄，虽有网络阻隔，但心意相通。此处虽简，有君子居之，何陋之有？`
                    };
                    await appendMessage(errorResponse, true);
                    
                    setTimeout(() => {
                        proceedToStage(gameState.currentStage + 1);
                    }, 2000);
                }
            }, 1500);
        }
        
        // 根据环境获取当前话题
        function getCurrentTopic(environment) {
            const topics = {
                "江边": "贬谪逆境中的人生感悟",
                "柳边": "心境修养与精神超脱",
                "斗室": "陋室的真正含义"
            };
            return topics[environment] || "人生智慧";
        }

        // 获取预制回应
        function getFallbackResponse(character) {
            const fallbackResponses = fallbackContent.characterResponses[character];
            if (fallbackResponses && fallbackResponses.length > 0) {
                const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
                return fallbackResponses[randomIndex];
            }
            
            // 如果没有预制回应，根据角色类型生成通用回应
            const personality = aiPersonalities[character];
            if (personality) {
                const styleResponses = {
                    "隐逸派": "观此环境，虽简朴却有天然之趣。心远地自偏，何须在意外物？",
                    "家国派": "虽遭贬谪，然心系苍生之志不可改。此等磨砺，正可砥砺君子品格。",
                    "儒家派": "君子居之，何陋之有？德馨者居，斯室不陋。当修身养德，以德化人。",
                    "豪放派": "区区陋室，岂能困住君子之志？大丈夫当豪迈处世，何惧风雨！"
                };
                
                for (const [style, response] of Object.entries(styleResponses)) {
                    if (personality.interaction_style.includes(style.slice(0, 2))) {
                        return `${personality.name}：${response}`;
                    }
                }
                
                return `${personality.name}：刘兄，同遭世事无常，当以平常心对待。有朋自远方来，不亦乐乎？`;
            }
            
            return `${character}：刘兄，此处虽简，心境却可无限宽广。`;
        }

        // 获取当前环境可用的角色
        function getAvailableCharacters() {
            // 这里可以根据游戏进度和环境返回可用角色
            return Object.keys(aiPersonalities);
        }

        // 显示打字指示器
        function showTypingIndicator(text = "有人正在输入...") {
            typingIndicator.textContent = text;
            typingIndicator.style.opacity = "1";
        }

        // 隐藏打字指示器
        function hideTypingIndicator() {
            typingIndicator.style.opacity = "0";
        }

        // 进入下一阶段
        function proceedToStage(stageNumber) {
            gameState.currentStage = stageNumber;
            
            // 更新进度条
            const progress = (stageNumber / Object.keys(gameScript).length) * 100;
            progressBar.style.width = progress + '%';
            
            if (gameScript[stageNumber.toString()]) {
                displayMessages(gameScript[stageNumber.toString()].messages);
            } else {
                // 游戏结束
                endGame();
            }
        }

        // 显示消息序列
        async function displayMessages(messages) {
            gameState.isShowingMessages = true;
            
            for (let i = 0; i < messages.length; i++) {
                if (i > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                await appendMessage(messages[i], true);
            }
            
            gameState.isShowingMessages = false;
            
            // 显示选项
            const currentStageData = gameScript[gameState.currentStage.toString()];
            if (currentStageData && currentStageData.options) {
                setTimeout(() => {
                    showOptions(currentStageData.options);
                }, 1000);
            }
        }

        // ====== 《陋室铭》创作群聊赏析系统 ======
        
        // 《陋室铭》创作状态
        const poemCreationState = {
            inputLines: [],      // 玩家已输入的句子
            currentLine: 0,      // 当前行数
            minRequiredLines: 3, // 最少需要输入3个句子
            isCreating: false,   // 是否正在创作状态
            participantScholars: ["confucius", "du", "libai", "tao", "wangwei", "sushi"] // 参与赏析的学者
        };

        // 《陋室铭》完整原文库（用于验证和提示）
        const loudShiMingOriginalLines = [
            "山不在高，有仙则名",
            "水不在深，有龙则灵", 
            "斯是陋室，惟吾德馨",
            "苔痕上阶绿，草色入帘青",
            "谈笑有鸿儒，往来无白丁",
            "可以调素琴，阅金经",
            "无丝竹之乱耳，无案牍之劳形",
            "南阳诸葛庐，西蜀子云亭",
            "孔子云：何陋之有？"
        ];

        // 处理《陋室铭》创作环节
        async function handlePoemCreation() {
            console.log('🎨 开始创作《陋室铭》环节');
            
            // 初始化创作状态
            poemCreationState.isCreating = true;
            poemCreationState.inputLines = [];
            poemCreationState.currentLine = 0;
            
            // 显示创作引导消息
            const introMessage = {
                type: "system",
                text: `📝 创作时刻到了！请在下方输入框中逐句创作您的《陋室铭》。\n💡 历史名人将为每句提供实时赏析和点评。\n⚡ 至少需要输入${poemCreationState.minRequiredLines}个句子才能进入下一阶段。`
            };
            await appendMessage(introMessage, true);
            
            // 激活输入界面
            setTimeout(() => {
                activatePoemInputInterface();
            }, 1500);
        }

        // 激活《陋室铭》输入界面
        function activatePoemInputInterface() {
            // 隐藏选项
            optionsContainer.classList.add('translate-y-full');
            
            // 激活输入框
            const userInput = document.getElementById('userInput');
            userInput.disabled = false;
            userInput.readOnly = false;
            userInput.className = userInput.className.replace('text-gray-400', 'text-gray-800');
            userInput.placeholder = '请输入《陋室铭》的第1句...';
            userInput.value = '';
            
            // 绑定输入事件处理器
            const poemInputHandler = async (e) => {
                if (e.key === 'Enter' && userInput.value.trim()) {
                    const inputLine = userInput.value.trim();
                    userInput.value = '';
                    
                    await handlePoemLineInput(inputLine);
                    
                    // 更新placeholder
                    if (poemCreationState.isCreating) {
                        userInput.placeholder = '请输入《陋室铭》原文句子';
                    }
                }
            };
            
            userInput.addEventListener('keydown', poemInputHandler);
            userInput.focus();
            
            // 存储处理器以便后续移除
            userInput.poemInputHandler = poemInputHandler;
            
            // 显示创作提示
            showPoemCreationHints();
        }

        // 显示创作提示
        async function showPoemCreationHints() {
            const hintsMessage = {
                type: "system",
                text: `💭 提示：您可以使用经典原句，也可以自由创作。\n📖 经典开头：山不在高，有仙则名 / 水不在深，有龙则灵\n🎯 目标：至少输入${poemCreationState.minRequiredLines}句，展现您对"陋室"精神的理解`
            };
            await appendMessage(hintsMessage, true);
        }

        // 处理玩家输入的《陋室铭》句子
        async function handlePoemLineInput(inputLine) {
            console.log(`📝 玩家输入第${poemCreationState.currentLine + 1}句: "${inputLine}"`);
            
            // 显示玩家输入的句子
            const playerMessage = {
                type: "liuyuxi",
                text: inputLine,
                isPoemLine: true,
                lineNumber: poemCreationState.currentLine + 1
            };
            await appendMessage(playerMessage, true);
            
            // 记录输入
            poemCreationState.inputLines.push(inputLine);
            poemCreationState.currentLine++;
            
            // 生成群聊赏析回应
            await generatePoemLineAppreciations(inputLine, poemCreationState.currentLine);
            
            // 检查是否达到最低要求
            if (poemCreationState.currentLine >= poemCreationState.minRequiredLines) {
                setTimeout(() => {
                    showPoemCompletionOptions();
                }, 2000);
            }
        }

        // 生成诗句赏析回应
        async function generatePoemLineAppreciations(inputLine, lineNumber) {
            console.log(`🎭 为第${lineNumber}句生成赏析`);
            
            // 选择2-3个学者进行赏析
            const selectedScholars = selectAppreciationScholars(inputLine, lineNumber);
            
            console.log(`选择的赏析学者:`, selectedScholars.map(id => aiPersonalities[id]?.name));
            
            // 依次生成赏析
            for (let i = 0; i < selectedScholars.length; i++) {
                const scholarId = selectedScholars[i];
                
                // 显示思考指示器
                showTypingIndicator(`${aiPersonalities[scholarId].name}正在赏析...`);
                
                // 等待间隔
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                hideTypingIndicator();
                
                // 生成赏析内容
                const appreciation = await generateScholarAppreciation(scholarId, inputLine, lineNumber);
                
                if (appreciation) {
                    await appendMessage(appreciation, true);
                }
                
                // 学者间的间隔
                if (i < selectedScholars.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // 选择参与赏析的学者
        function selectAppreciationScholars(inputLine, lineNumber) {
            const availableScholars = [...poemCreationState.participantScholars];
            const selectedScholars = [];
            
            // 根据内容智能选择相关学者
            const contentBasedSelection = getContentRelevantScholars(inputLine);
            
            // 优先选择内容相关的学者
            for (const scholarId of contentBasedSelection) {
                if (selectedScholars.length < 2 && availableScholars.includes(scholarId)) {
                    selectedScholars.push(scholarId);
                    availableScholars.splice(availableScholars.indexOf(scholarId), 1);
                }
            }
            
            // 如果不足2个，随机补充
            while (selectedScholars.length < 2 && availableScholars.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableScholars.length);
                selectedScholars.push(availableScholars[randomIndex]);
                availableScholars.splice(randomIndex, 1);
            }
            
            // 偶尔添加第三个学者 (30%概率)
            if (Math.random() < 0.3 && availableScholars.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableScholars.length);
                selectedScholars.push(availableScholars[randomIndex]);
            }
            
            return selectedScholars;
        }

        // 根据内容获取相关学者
        function getContentRelevantScholars(inputLine) {
            const contentMapping = {
                // 德行品格相关
                "德": ["confucius", "yanhuei", "zengzi"],
                "君子": ["confucius", "yanhuei", "zengzi"],
                "仁": ["confucius", "yanhuei"],
                
                // 自然山水相关
                "山": ["tao", "wangwei", "libai"],
                "水": ["tao", "wangwei", "du"],
                "苔": ["tao", "wangwei"],
                "草": ["tao", "wangwei"],
                "绿": ["tao", "wangwei"],
                
                // 学问文化相关
                "鸿儒": ["confucius", "du", "yangxiong"],
                "白丁": ["confucius", "du"],
                "金经": ["confucius", "zengzi", "yangxiong"],
                "素琴": ["confucius", "wangwei"],
                
                // 清雅生活相关
                "琴": ["confucius", "wangwei", "tao"],
                "经": ["confucius", "zengzi", "yangxiong"],
                "丝竹": ["confucius", "wangwei"],
                "案牍": ["du", "baijuyi"],
                
                // 历史典故相关
                "诸葛": ["zhugeliang", "du"],
                "子云": ["yangxiong", "confucius"],
                "孔子": ["confucius", "yanhuei", "zengzi"]
            };
            
            const relevantScholars = [];
            
            // 检查每个关键词
            for (const [keyword, scholars] of Object.entries(contentMapping)) {
                if (inputLine.includes(keyword)) {
                    relevantScholars.push(...scholars);
                }
            }
            
            // 去重并返回
            return [...new Set(relevantScholars)];
        }

        // 生成学者赏析内容
        async function generateScholarAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            if (!personality) return null;
            
            try {
                let appreciationText;
                
                // 优先尝试AI生成 (如果可用)
                if (AI_FEATURES.enabled && dialogueControls.canMakeAICall(scholarId, "poem_creation")) {
                    appreciationText = await generateAIAppreciation(scholarId, inputLine, lineNumber);
                } else {
                    // 使用预制赏析
                    appreciationText = generatePresetAppreciation(scholarId, inputLine, lineNumber);
                }
                
                return {
                    type: scholarId,
                    text: appreciationText,
                    isPoemAppreciation: true,
                    lineNumber: lineNumber,
                    isAIGenerated: AI_FEATURES.enabled && dialogueControls.canMakeAICall(scholarId, "poem_creation")
                };
                
            } catch (error) {
                console.error(`生成${personality.name}的赏析失败:`, error);
                
                // 降级处理
                return {
                    type: scholarId,
                    text: `${personality.name}：此句颇有意境，深得我心。`,
                    isPoemAppreciation: true,
                    lineNumber: lineNumber
                };
            }
        }

        // AI生成赏析内容
        async function generateAIAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            
            const prompt = `你是${personality.name}（${personality.period}），${personality.background}。

刘禹锡刚刚创作了《陋室铭》的第${lineNumber}句：
"${inputLine}"

请从你的专业角度对这句诗进行赏析点评。

你的文学特色：${personality.language_style}
你的核心理念：${personality.key_concepts.join('、')}
你的经典名句：${personality.classic_quotes.join('；')}

赏析要求：
1. 体现你的文学专业性和历史身份
2. 从修辞手法、意境营造、思想内涵等角度点评
3. 可以联系你的人生经历和文学主张
4. 语言要符合你的时代特色和个人风格
5. 字数控制在80-120字
6. 语调要专业而不失亲切

请直接以${personality.name}的身份进行赏析，不要加引号：`;

            const response = await callPoeAI(prompt, { 
                temperature: 0.7,
                maxTokens: 200
            });
            
            dialogueControls.recordAICall(scholarId, "poem_creation");
            return response;
        }

        // 生成预制赏析内容
        function generatePresetAppreciation(scholarId, inputLine, lineNumber) {
            const personality = aiPersonalities[scholarId];
            
            // 针对不同学者的赏析风格模板
            const appreciationStyles = {
                "confucius": {
                    approach: "道德修养",
                    keywords: ["德", "君子", "仁", "礼"],
                    templates: [
                        `此句深得'德不孤，必有邻'之理。`,
                        `君子之德如风，草必偃。此句正体现德化之功。`,
                        `'文质彬彬，然后君子'，此句文采与内涵并重。`
                    ]
                },
                "du": {
                    approach: "社会关怀",
                    keywords: ["民", "国", "社稷", "责任"],
                    templates: [
                        `此句让我想起'朱门酒肉臭，路有冻死骨'，对比鲜明，发人深省。`,
                        `刘兄此句，深得诗歌'美刺'之道，言简而意深。`,
                        `'位卑未敢忘忧国'，此句虽写个人境遇，实含忧国之情。`
                    ]
                },
                "libai": {
                    approach: "豪迈想象",
                    keywords: ["仙", "高", "名", "灵"],
                    templates: [
                        `哈哈！此句气势如虹，颇有'黄河之水天上来'的豪迈！`,
                        `妙哉！此句用典巧妙，意境高远，有超凡脱俗之感。`,
                        `刘兄此句，如'飞流直下三千尺'，气象万千！`
                    ]
                },
                "tao": {
                    approach: "自然情趣",
                    keywords: ["自然", "苔", "草", "绿", "色"],
                    templates: [
                        `此句写景真切，如我'采菊东篱下'般自然纯真。`,
                        `苔痕草色，生机盎然。真正的'心远地自偏'啊！`,
                        `此句朴实自然，远胜雕琢华美。归真返朴，此之谓也。`
                    ]
                },
                "wangwei": {
                    approach: "意境禅理",
                    keywords: ["色", "境", "静", "禅"],
                    templates: [
                        `此句诗中有画，画中有禅。'青青河畔草'的意境跃然纸上。`,
                        `色彩运用精妙，绿意盎然中见禅机。境由心转，心境自清。`,
                        `'空山新雨后'，此句亦有天然去雕饰之美。`
                    ]
                },
                "sushi": {
                    approach: "旷达哲理",
                    keywords: ["旷达", "哲理", "人生"],
                    templates: [
                        `此句颇有哲理！'人生如逆旅'，居所何妨简陋？`,
                        `妙不可言！此句让我想起'回首向来萧瑟处，也无风雨也无晴'。`,
                        `刘兄此句，深得苦中作乐之道，令东坡佩服！`
                    ]
                }
            };
            
            const style = appreciationStyles[scholarId];
            if (!style) {
                return `${personality.name}：此句甚好，颇有深意。`;
            }
            
            // 检查是否有相关关键词
            const hasRelevantKeyword = style.keywords.some(keyword => inputLine.includes(keyword));
            
            if (hasRelevantKeyword) {
                // 生成针对性赏析
                return `${personality.name}：${generateSpecificAppreciation(scholarId, inputLine, style)}`;
            } else {
                // 使用通用模板
                const randomTemplate = style.templates[Math.floor(Math.random() * style.templates.length)];
                return `${personality.name}：${randomTemplate}`;
            }
        }

        // 生成具体的针对性赏析
        function generateSpecificAppreciation(scholarId, inputLine, style) {
            const specificAppreciations = {
                "confucius": {
                    "德": `'德馨'二字，正是君子立身之本。此句得圣人'德不孤，必有邻'之真传。`,
                    "君子": `君子之居，不在华美，在于德行。此句深得儒家修身之要。`,
                    "鸿儒": `'谈笑有鸿儒'，此乃'德者得朋'之写照。学而时习，不亦乐乎？`
                },
                "du": {
                    "白丁": `'往来无白丁'与我'朱门酒肉臭'形成对比，但此处重在德化，非贫富之分。`,
                    "案牍": `'无案牍之劳形'！刘兄深知我'文章憎命达'之苦，官场劳形，不如德馨之乐也。`
                },
                "libai": {
                    "仙": `'有仙则名'！此句境界高远，如我'举头望明月'般超脱凡俗！`,
                    "高": `山之高不在形，在于神韵。此句如我'蜀道之难，难于上青天'，气象万千！`
                },
                "tao": {
                    "苔": `苔痕自绿，草色自青，天然无雕饰。此正'采菊东篱下'之真趣！`,
                    "绿": `一'绿'字用得妙极！生机盎然，如春风化雨，润物无声。`
                },
                "wangwei": {
                    "绿": `'绿'字传神！此句色彩明丽，如我'山色有无中'，诗中有画意。`,
                    "青": `青青之色，静谧雅致。'明月松间照，清泉石上流'的意境跃然纸上。`
                },
                "sushi": {
                    "素琴": `'调素琴'三字雅致！音乐怡情，正如我'但愿人长久，千里共婵娟'之心境。`,
                    "金经": `'阅金经'，读书怡性。'发愤忘食，乐以忘忧'，书中自有颜如玉啊！`
                }
            };
            
            const charAppreciations = specificAppreciations[scholarId];
            if (!charAppreciations) return style.templates[0];
            
            // 查找匹配的关键词
            for (const [keyword, appreciation] of Object.entries(charAppreciations)) {
                if (inputLine.includes(keyword)) {
                    return appreciation;
                }
            }
            
            return style.templates[0];
        }

        // 显示创作完成选项
        function showPoemCompletionOptions() {
            // 激活选项容器
            optionsList.innerHTML = '';
            
            // 继续创作选项
            const continueOption = document.createElement('button');
            continueOption.className = 'w-full p-3 text-left bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200 border border-blue-200';
            continueOption.innerHTML = `<div class="font-medium">✍️ 继续创作</div><div class="text-sm text-gray-600 mt-1">再添几句，让作品更加完整</div>`;
            continueOption.addEventListener('click', () => {
                optionsContainer.classList.add('translate-y-full');
                document.getElementById('userInput').focus();
            });
            
            // 完成创作选项
            const finishOption = document.createElement('button');
            finishOption.className = 'w-full p-3 text-left bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200 border border-green-200';
            finishOption.innerHTML = `<div class="font-medium">✅ 完成创作</div><div class="text-sm text-gray-600 mt-1">已输入${poemCreationState.currentLine}句，可以结束创作了</div>`;
            finishOption.addEventListener('click', () => {
                finishPoemCreation();
            });
            
            optionsList.appendChild(continueOption);
            optionsList.appendChild(finishOption);
            
            // 显示选项
            optionsContainer.classList.remove('translate-y-full');
        }

        // 完成《陋室铭》创作
        async function finishPoemCreation() {
            console.log('🎉 完成《陋室铭》创作');
            
            // 隐藏选项
            optionsContainer.classList.add('translate-y-full');
            
            // 禁用输入框
            const userInput = document.getElementById('userInput');
            userInput.disabled = true;
            userInput.readOnly = true;
            userInput.className = userInput.className.replace('text-gray-800', 'text-gray-400');
            userInput.placeholder = '点击此处继续...';
            userInput.value = '';
            
            // 移除事件监听器
            if (userInput.poemInputHandler) {
                userInput.removeEventListener('keydown', userInput.poemInputHandler);
                delete userInput.poemInputHandler;
            }
            
            // 结束创作状态
            poemCreationState.isCreating = false;
            
            // 显示创作总结（修改版）
            await showPoemCreationSummary();
            
            // 继续游戏流程
            setTimeout(() => {
                proceedToStage(gameState.currentStage + 1);
            }, 3000);
        }

        // 显示创作总结
        async function showPoemCreationSummary() {
            const summaryMessage = {
                type: "system",
                text: `🎊 《陋室铭》创作完成！\n\n📊 创作统计：\n• 共创作 ${poemCreationState.currentLine} 句\n• 获得 ${poemCreationState.participantScholars.length} 位文豪赏析\n• 展现了您对"惟吾德馨"精神的独特理解`
            };
            await appendMessage(summaryMessage, true);
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const congratsMessage = {
                type: "system", 
                text: `🌟 恭喜！您已经体验了与历史文豪们一起品评《陋室铭》的乐趣。\n💭 每一句都承载着深厚的文化内涵，每一次赏析都是思想的碰撞。`
            };
            await appendMessage(congratsMessage, true);
        }

        // ====== 朋友圈生成系统 ======
        
        // 智能个性分析引擎
        const personalityAnalyzer = {
            analyzePlayerProfile: function() {
                console.log('🧠 开始深度个性分析...');
                
                const analysis = {
                    personalityType: "探索型文人",
                    dominantTheme: "平衡智慧",
                    mainValues: [],
                    modernConcerns: [],
                    socialMediaStyle: "理性思辨型",
                    gameExperience: this.summarizeGameExperience(),
                    characterInteractions: this.analyzeCharacterInteractions(),
                    creativeContent: this.analyzeCreativeContent(),
                    questioningStyle: this.analyzeQuestioningStyle()
                };
                
                // 综合分析确定主导主题
                analysis.dominantTheme = this.determineDominantTheme();
                
                // 生成个性化的朋友圈主题
                analysis.momentsTheme = this.generateMomentsTheme(analysis.dominantTheme);
                
                // 生成现代思辨话题
                analysis.modernDebateTopics = this.generateModernDebateTopics(analysis.dominantTheme);
                
                console.log('✅ 个性分析完成:', analysis);
                return analysis;
            },
            
            // 分析角色互动偏好
            analyzeCharacterInteractions: function() {
                const mentionedChars = gameState.mentionedCharacters || [];
                const interactions = {
                    preferredTypes: [],
                    focusAreas: []
                };
                
                // 分析偏好的角色类型
                mentionedChars.forEach(charId => {
                    const personality = aiPersonalities[charId];
                    if (personality) {
                        if (personality.key_concepts.includes("自然") || personality.key_concepts.includes("隐逸")) {
                            interactions.preferredTypes.push("精神追求");
                        }
                        if (personality.key_concepts.includes("忧国") || personality.key_concepts.includes("社稷")) {
                            interactions.preferredTypes.push("社会关怀");
                        }
                        if (personality.key_concepts.includes("德") || personality.key_concepts.includes("君子")) {
                            interactions.preferredTypes.push("道德修养");
                        }
                    }
                });
                
                return interactions;
            },
            
            // 分析创作内容特点
            analyzeCreativeContent: function() {
                const inputLines = poemCreationState.inputLines || [];
                const analysis = {
                    themes: [],
                    style: "传统",
                    focusKeywords: []
                };
                
                const allText = inputLines.join('');
                
                // 分析主题关键词
                if (allText.includes("德") || allText.includes("馨")) analysis.themes.push("品德修养");
                if (allText.includes("山") || allText.includes("水") || allText.includes("自然")) analysis.themes.push("自然情怀");
                if (allText.includes("学") || allText.includes("书") || allText.includes("经")) analysis.themes.push("学习治学");
                if (allText.includes("居") || allText.includes("室") || allText.includes("陋")) analysis.themes.push("生活哲学");
                
                return analysis;
            },
            
            // 分析提问风格（TODO: 在提问系统完善后实现）
            analyzeQuestioningStyle: function() {
                return {
                    depth: "中等",
                    concerns: ["人生哲理", "现实生活"],
                    type: "探索型"
                };
            },
            
            // 确定主导主题
            determineDominantTheme: function() {
                const stylePoints = gameState.stylePoints;
                const mentionedChars = gameState.mentionedCharacters || [];
                const inputLines = poemCreationState.inputLines || [];
                
                let scores = {
                    "物质与精神": 0,
                    "挫折与成长": 0,
                    "独处与社交": 0,
                    "理想与现实": 0,
                    "传统与现代": 0,
                    "内卷与躺平": 0
                };
                
                // 根据游戏选择倾向评分
                scores["物质与精神"] += (stylePoints.tao || 0) * 15;
                scores["挫折与成长"] += (stylePoints.du || 0) * 15;
                scores["理想与现实"] += (stylePoints.balanced || 0) * 10;
                scores["传统与现代"] += (stylePoints.ru || 0) * 15;
                
                // 根据@的角色评分
                mentionedChars.forEach(charId => {
                    if (charId === "tao") scores["物质与精神"] += 20;
                    if (charId === "du" || charId === "baijuyi") scores["挫折与成长"] += 20;
                    if (charId === "wangwei") scores["独处与社交"] += 20;
                    if (charId === "confucius") scores["传统与现代"] += 20;
                    if (charId === "sushi") scores["理想与现实"] += 20;
                });
                
                // 根据创作内容评分
                const allText = inputLines.join('');
                if (allText.includes("德") || allText.includes("品格")) scores["传统与现代"] += 10;
                if (allText.includes("简") || allText.includes("朴") || allText.includes("陋")) scores["物质与精神"] += 10;
                if (allText.includes("志") || allText.includes("理想")) scores["理想与现实"] += 10;
                
                // 添加随机因子，增加变化性
                Object.keys(scores).forEach(key => {
                    scores[key] += Math.random() * 5;
                });
                
                // 找出最高分的主题
                const dominantTheme = Object.keys(scores).reduce((a, b) => 
                    scores[a] > scores[b] ? a : b
                );
                
                console.log('主题分析得分:', scores);
                console.log('主导主题:', dominantTheme);
                
                return dominantTheme;
            },
            
            // 生成朋友圈主题
            generateMomentsTheme: function(dominantTheme) {
                const themeTemplates = {
                    "物质与精神": {
                        title: "现代版'陋室'思考：房价时代的精神富足",
                        keywords: ["房价", "物质", "精神", "内心富足", "简朴生活"]
                    },
                    "挫折与成长": {
                        title: "人生低谷时的古代智慧：如何在逆境中修炼心境",
                        keywords: ["挫折", "成长", "逆境", "坚韧", "人生感悟"]
                    },
                    "独处与社交": {
                        title: "一个人的精神世界：现代社交vs内心宁静",
                        keywords: ["独处", "社交", "内心", "宁静", "自我对话"]
                    },
                    "理想与现实": {
                        title: "诗与远方的平衡术：在现实生活中保持理想主义",
                        keywords: ["理想", "现实", "平衡", "诗意", "生活哲学"]
                    },
                    "传统与现代": {
                        title: "古典文化的现代意义：传统智慧如何指导当代生活",
                        keywords: ["传统", "现代", "文化", "智慧", "传承"]
                    },
                    "内卷与躺平": {
                        title: "古人的'中庸之道'：既不内卷也不躺平的生活智慧",
                        keywords: ["内卷", "躺平", "中庸", "平衡", "生活态度"]
                    }
                };
                
                return themeTemplates[dominantTheme] || themeTemplates["理想与现实"];
            },
            
            // 生成现代思辨话题
            generateModernDebateTopics: function(dominantTheme) {
                const debateTopics = {
                    "物质与精神": {
                        title: "💰 如果刘禹锡生活在2024年",
                        questions: [
                            "月薪3万但要还30年房贷 vs 月薪8千但内心充实，你选哪个？",
                            "是先解决物质基础再追求精神生活，还是精神富足更重要？",
                            "现代'陋室'（小户型、合租房）能否也有'德馨'之美？",
                            "消费主义时代，如何定义真正的'富足'？"
                        ]
                    },
                    "挫折与成长": {
                        title: "💪 现代版'贬谪'经历",
                        questions: [
                            "被裁员、考研失败、创业失败...现代人如何面对人生低谷？",
                            "是逃避现实还是正面硬刚？古人的'既来之则安之'还适用吗？",
                            "社交媒体时代的挫折是否更难承受？（因为要面对他人的成功展示）",
                            "什么样的挫折经历能让人真正成长？"
                        ]
                    },
                    "独处与社交": {
                        title: "🧘 一个人的世界 vs 社交网络",
                        questions: [
                            "享受独处 vs 害怕孤独，现代人为何难以安静待着？",
                            "古人的'心远地自偏'在手机不离手的时代如何实现？",
                            "线上社交能否替代面对面的深度交流？",
                            "什么样的独处才是有意义的？（而不是无聊刷手机）"
                        ]
                    },
                    "理想与现实": {
                        title: "✨ 诗与远方 vs 眼前的苟且",
                        questions: [
                            "毕业后是选择稳定工作还是追求梦想？这个选择有标准答案吗？",
                            "理想主义在现实面前是否注定要妥协？",
                            "如何在日常琐碎中保持对生活的诗意想象？",
                            "什么年龄段最适合'理想主义'？什么时候该'现实一点'？"
                        ]
                    },
                    "传统与现代": {
                        title: "📚 古典智慧 vs 现代生活",
                        questions: [
                            "古人的生活节奏 vs 现代快节奏，哪种更有利于身心健康？",
                            "传统的'修身养性'在讲究效率的现代社会还有意义吗？",
                            "如何在保持传统文化底蕴的同时适应现代生活？",
                            "年轻人学古典文学是'装文艺'还是真的有用？"
                        ]
                    },
                    "内卷与躺平": {
                        title: "⚖️ 努力的边界在哪里？",
                        questions: [
                            "内卷 vs 躺平，有没有第三种选择？",
                            "古人的'中庸之道'能否解决现代人的焦虑？",
                            "什么样的努力是有意义的？什么样的努力是无效内卷？",
                            "在竞争激烈的环境中，如何保持内心平静？"
                        ]
                    }
                };
                
                return debateTopics[dominantTheme] || debateTopics["理想与现实"];
            },
            
            summarizeGameExperience: function() {
                const experiences = [];
                
                // 统计创作内容
                if (poemCreationState.inputLines.length > 0) {
                    experiences.push(`创作了${poemCreationState.inputLines.length}句个性化《陋室铭》`);
                }
                
                // 统计交互人物
                const mentionedChars = gameState.mentionedCharacters || [];
                if (mentionedChars.length > 0) {
                    const charNames = mentionedChars.map(id => aiPersonalities[id]?.name || id);
                    experiences.push(`与${charNames.join('、')}等历史名人深度交流`);
                }
                
                // 统计关键选择
                const keyChoices = gameState.selectedOptions.filter(opt => opt.option.style);
                experiences.push(`做出${keyChoices.length}个影响人生观的重要选择`);
                
                return experiences;
            }
        };
        
        // 朋友圈内容生成器
        const momentsGenerator = {
            generateMomentsContent: async function(playerProfile) {
                try {
                    if (AI_FEATURES.enabled) {
                        return await this.generateAIMomentsContent(playerProfile);
                    } else {
                        return this.generatePresetMomentsContent(playerProfile);
                    }
                } catch (error) {
                    console.error('朋友圈内容生成失败', error);
                    return this.generatePresetMomentsContent(playerProfile);
                }
            },
            
            generateAIMomentsContent: async function(playerProfile) {
                const prompt = `你是刘禹锡，刚刚结束了一场《陋室铭》的创作和分享体验。请以刘禹锡的口吻生成一条现代朋友圈动态。

玩家特征分析：
- 性格类型：${playerProfile.personalityType}
- 核心价值观：${playerProfile.mainValues.join('、')}
- 游戏体验：${playerProfile.gameExperience.join('；')}

现代思考角度：
${playerProfile.modernConcerns.map(concern => `• ${concern}`).join('\n')}

要求：
1. 以刘禹锡的身份，但融入现代朋友圈的语言风格
2. 结合玩家的性格特点和选择倾向
3. 既要有古典文学底蕴，也要有现代人的思考
4. 适当加入对现代社会问题的感悟
5. 语言要亲切自然，不要过于文绉绉
6. 字数控制在150-200字
7. 可以适当使用emoji，但要克制

请直接输出朋友圈内容，不要加引号或解释：`;

                const content = await callPoeAI(prompt, {
                    temperature: 0.8,
                    maxTokens: 300
                });
                
                return content;
            },
            
            generatePresetMomentsContent: function(playerProfile) {
                const templates = {
                    "精神追求型": [
                        `今天和古代文豪们一起品评《陋室铭》，深感"德馨"二字的分量 📚\n\n现代人在快节奏生活中，是否还记得什么是真正的精神富足？\n苔痕上阶绿，草色入帘青 🍃\n简单的美好，胜过复杂的焦虑\n\n与诸位文友共勉：外在的"陋"不可怕，内心的"馨"才珍贵 ✨`,
                        
                        `刚刚体验了一场跨越千年的文学雅集 🌟\n\n从江边到柳边再到斗室，每一次迁移都是心境的升华\n想起陶渊明的"心远地自偏"，在这个物欲横流的时代，我们如何找到内心的桃花源？\n\n科技再发达，也代替不了精神的充实\n谈笑有鸿儒，往来无白丁 📖`
                    ],
                    "社会责任型": [
                        `今日与杜甫、白居易等前辈探讨《陋室铭》，颇有感触 🏔️\n\n"斯是陋室，惟吾德馨"让我想起当下年轻人的困境\n高房价时代的"陋室"，不是选择而是现实\n但正如古人所言，真正的品质不在外在环境\n\n愿每一个在城市奋斗的年轻人，都能在"陋室"中找到自己的"德馨" 💪\n#当代青年 #精神家园`,
                        
                        `"安得广厦千万间，大庇天下寒士俱欢颜"📝\n\n今天重读《陋室铭》，想到杜甫的这句诗\n一个是被迫居陋室却泰然处之，一个是心怀天下苍生\n\n现在的"寒士"在哪里？是996的程序员？是背着房贷的普通人？\n文人的社会责任从未改变\n用笔记录时代，用心关怀民生 ❤️`
                    ],
                    "传统修身型": [
                        `"君子居之，何陋之有？"📜\n\n今天和孔子、颜回等圣贤学习《陋室铭》，深感修身养性的重要\n\n网络时代信息爆炸，如何保持内心的宁静？\n快节奏生活中，如何践行"君子慎独"？\n\n传统文化不是古董，而是现代人的精神指南\n每日三省吾身，在喧嚣中保持初心 🙏\n\n#传统文化 #现代传承`,
                        
                        `刚刚完成了《陋室铭》的创作体验 ✍️\n\n"德不孤，必有邻"，今天真正体会到了这句话的含义\n即使在最简陋的环境中，品德高尚的人也会有知音相伴\n\n想到现代社会的道德焦虑，或许我们需要回到经典中寻找答案\n修身、齐家、治国、平天下\n一切都从"德馨"开始 ⭐`
                    ],
                    "平衡智慧型": [
                        `今天体验了一场特别的《陋室铭》创作之旅 🎋\n\n从刘禹锡的人生际遇中学到：\n变化是常态，适应是智慧\n外境可以简陋，内心必须丰富\n\n现代人的焦虑大多来自对外在的过度关注\n房子可以小，格局不能小\n工资可以少，精神不能贫 💫\n\n感谢古代智者的启发，让我们在浮躁的时代保持内心的平衡 🍃`
                    ]
                };
                
                const baseType = playerProfile.personalityType.split("：")[0];
                const contentArray = templates[baseType] || templates["平衡智慧型"];
                
                return contentArray[Math.floor(Math.random() * contentArray.length)];
            }
        };
        
        // 聊天截图生成器（已移除功能）
        const chatScreenshotGenerator = {
            generateChatScreenshots: function() {
                // 移除截图功能，返回空数组
                return [];
            },
            
            selectChatHighlights: function() {
                // 选择游戏中的精彩对话片段
                const highlights = [];
                
                // 1. 经典名句赏析
                if (poemCreationState.inputLines.length > 0) {
                    highlights.push({
                        type: "poem_creation",
                        title: "《陋室铭》创作时刻",
                        content: poemCreationState.inputLines.slice(0, 3).join('\n'),
                        participants: ["刘禹锡", "孔子", "杜甫", "李白"]
                    });
                }
                
                // 2. 历史人物互动
                const mentionedChars = gameState.mentionedCharacters || [];
                if (mentionedChars.length > 0) {
                    highlights.push({
                        type: "character_interaction", 
                        title: "与古代文豪的对话",
                        content: "君子居之，何陋之有？\n心远地自偏，何处不桃源？",
                        participants: mentionedChars.map(id => aiPersonalities[id]?.name || id).slice(0, 4)
                    });
                }
                
                // 3. 价值观选择时刻
                const keyChoices = gameState.selectedOptions.filter(opt => opt.option.style);
                if (keyChoices.length > 0) {
                    highlights.push({
                        type: "value_choice",
                        title: "人生选择的关键时刻", 
                        content: "在逆境中保持君子风范\n既来之则安之的生活智慧",
                        participants: ["刘禹锡", "系统"]
                    });
                }
                
                return highlights.slice(0, 2); // 最多2张截图
            },
            
            createScreenshotElement: function(highlight, index) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-3';
                screenshotDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm font-medium text-gray-700">${highlight.title}</div>
                        <div class="text-xs text-gray-500">${index + 1}/2</div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2 font-mono whitespace-pre-line">${highlight.content}</div>
                    <div class="text-xs text-gray-500">
                        参与者：${highlight.participants.join('、')}
                    </div>
                `;
                
                return screenshotDiv;
            }
        };
        
        // 朋友圈社交互动生成器
        const momentsInteractionGenerator = {
            generateInteractions: async function(momentsContent, playerProfile) {
                // 生成点赞和评论
                const likes = this.generateLikes();
                const comments = await this.generateComments(momentsContent, playerProfile);
                
                return { likes, comments };
            },
            
            generateLikes: function() {
                // 选择会点赞的历史人物
                const allCharacters = Object.keys(aiPersonalities);
                const likingCharacters = [];
                
                // 随机选择8-12个人点赞
                const likeCount = 8 + Math.floor(Math.random() * 5);
                
                for (let i = 0; i < likeCount && allCharacters.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * allCharacters.length);
                    likingCharacters.push(allCharacters[randomIndex]);
                    allCharacters.splice(randomIndex, 1);
                }
                
                return likingCharacters.map(id => aiPersonalities[id]?.name || id);
            },
            
            generateComments: async function(momentsContent, playerProfile) {
                const comments = [];
                
                // 选择评论者（包括扩展人物）
                const commenters = this.selectCommenters();
                
                for (const commenter of commenters) {
                    try {
                        let commentText;
                        
                        if (AI_FEATURES.enabled && Math.random() < 0.6) {
                            commentText = await this.generateAIComment(commenter, momentsContent, playerProfile);
                        } else {
                            commentText = this.generatePresetComment(commenter, playerProfile);
                        }
                        
                        comments.push({
                            author: commenter.name,
                            emoji: commenter.emoji,
                            text: commentText,
                            isAI: AI_FEATURES.enabled && Math.random() < 0.6
                        });
                        
                    } catch (error) {
                        console.error(`生成${commenter.name}评论失败`, error);
                        // 降级处理
                        comments.push({
                            author: commenter.name,
                            emoji: commenter.emoji,
                            text: this.generatePresetComment(commenter, playerProfile),
                            isAI: false
                        });
                    }
                }
                
                return comments;
            },
            
            selectCommenters: function() {
                // 扩展评论人物库
                const extendedCommenters = [
                    { name: "韩愈", emoji: "📝", personality: "古文运动倡导者，文以载道" },
                    { name: "柳宗元", emoji: "🌊", personality: "山水文学家，政治改革者" },
                    { name: "王勃", emoji: "🌅", personality: "初唐四杰，英年早逝" },
                    { name: "孟浩然", emoji: "🏞️", personality: "山水田园诗人，淡泊名利" },
                    { name: "辛弃疾", emoji: "⚔️", personality: "豪放词人，忧国忧民" },
                    { name: "范仲淹", emoji: "🏛️", personality: "政治家文学家，先忧后乐" },
                    { name: "现代读者小王", emoji: "💼", personality: "当代上班族，文学爱好者" },
                    { name: "90后文青", emoji: "📱", personality: "年轻人，追求精神生活" },
                    { name: "北漂青年", emoji: "🏠", personality: "在大城市奋斗的年轻人" }
                ];
                
                // 随机选择4-6个评论者
                const commentCount = 4 + Math.floor(Math.random() * 3);
                const selectedCommenters = [];
                
                for (let i = 0; i < commentCount && extendedCommenters.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * extendedCommenters.length);
                    selectedCommenters.push(extendedCommenters[randomIndex]);
                    extendedCommenters.splice(randomIndex, 1);
                }
                
                return selectedCommenters;
            },
            
            generateAIComment: async function(commenter, momentsContent, playerProfile) {
                const isModernPerson = commenter.name.includes("现代") || commenter.name.includes("90后") || commenter.name.includes("北漂");
                
                const prompt = `你是${commenter.name}（${commenter.personality}），看到刘禹锡发的这条朋友圈动态：

"${momentsContent}"

请以${commenter.name}的身份写一条评论回应。

${isModernPerson ? 
`作为现代人，你要：
1. 用现代网络语言风格
2. 结合当代生活实际情况
3. 可以质疑或补充古典观点
4. 表达年轻人的真实想法` :
`作为古代文人，你要：
1. 符合历史人物身份
2. 可以用古典文学语言
3. 体现你的文学主张和人生阅历
4. 与刘禹锡产生思想共鸣或辩论`}

要求：
1. 语言要自然，符合朋友圈评论风格
2. 可以适当使用emoji
3. 字数控制在50-80字
4. 要有针对性，不要泛泛而谈
5. ${isModernPerson ? '可以提及现代社会问题' : '可以引用经典或典故'}

请直接输出评论内容：`;

                const comment = await callPoeAI(prompt, {
                    temperature: 0.9,
                    maxTokens: 150
                });
                
                return comment;
            },
            
            generatePresetComment: function(commenter, playerProfile) {
                const presetComments = {
                    "韩愈": [
                        "文以载道，梦得此文深得文章之要！古今相通，德馨永恒 📝",
                        "师者传道，今日之陋室，他日之经典！后生可畏 ✨"
                    ],
                    "柳宗元": [
                        "山水之乐，在乎心也。梦得兄深得此理！🌊",
                        "同为贬谪之人，最懂这种境界。心境高远胜过高楼大厦 🏞️"
                    ],
                    "辛弃疾": [
                        "金戈铁马，不如一室书香。梦得兄境界高矣！⚔️",
                        "了却君王天下事，赢得生前身后名。文人当如是 🌟"
                    ],
                    "现代读者小王": [
                        "刘老师说得太对了！我租的10平小房间瞬间不香了...学会知足 💼",
                        "房价这么高，看来古人早就给我们心理安慰了。谢谢梦得老师！😊"
                    ],
                    "90后文青": [
                        "古代的精神富足vs现代的物质焦虑，这个对比太扎心了 📱",
                        "德馨>德薪，但是德薪也很重要啊哈哈😂 现实与理想的差距..."
                    ],
                    "北漂青年": [
                        "在北京的出租屋里看到这个，想哭...但确实，心态很重要 🏠",
                        "房子是租的，生活不是。感谢刘老师的人生哲学课！💪"
                    ]
                };
                
                const comments = presetComments[commenter.name];
                if (comments && comments.length > 0) {
                    return comments[Math.floor(Math.random() * comments.length)];
                }
                
                // 通用评论
                const isModern = commenter.name.includes("现代") || commenter.name.includes("90后") || commenter.name.includes("北漂");
                if (isModern) {
                    return "现代人表示学到了！古人的智慧真的很治愈 😊";
                } else {
                    return "深有同感，与君共勉！古今相通之理也 ✨";
                }
            }
        };
        
        // 智能古今对话主题系统
        const ancientModernDialogueSystem = {
            // 主题库定义
            topicDatabase: {
                "balanced": {
                    title: "物质与精神的平衡",
                    ibProfile: "Balanced",
                    emoji: "💰",
                    subtitle: "如果陶渊明生活在2024年",
                    questions: [
                        "月薪3万但要还30年房贷 vs 月薪8千但内心充实，你选哪个？",
                        "现代'陋室'（小户型、合租房）能否也有'德馨'之美？",
                        "消费主义时代，如何定义真正的'富足'？",
                        "'不为五斗米折腰'在高房价时代还现实吗？"
                    ],
                    triggerCharacters: ["tao", "yanhuei"],
                    keywords: ["简朴", "物质", "精神", "归隐"]
                },
                "caring": {
                    title: "社会责任与个人生活",
                    ibProfile: "Caring",
                    emoji: "🏛️",
                    subtitle: "现代版'位卑未敢忘忧国'",
                    questions: [
                        "普通人需要为社会问题承担多少责任？",
                        "关注时事政治 vs 专心个人生活，如何平衡？",
                        "社交媒体时代，每个人都是'自媒体'，该如何发声？",
                        "'先天下之忧而忧'的理想主义在现实中如何实践？"
                    ],
                    triggerCharacters: ["du", "baijuyi"],
                    keywords: ["忧国", "责任", "社会", "民生"]
                },
                "risktakers": {
                    title: "自由精神与现实约束",
                    ibProfile: "Risk-takers",
                    emoji: "🌙",
                    subtitle: "如果李白是当代年轻人",
                    questions: [
                        "996工作制 vs '安能摧眉折腰事权贵'，如何选择？",
                        "稳定工作 vs 追求梦想，这个选择有标准答案吗？",
                        "在规则严密的现代社会，如何保持精神上的自由？",
                        "'仰天大笑出门去'的洒脱在现代社会还可能吗？"
                    ],
                    triggerCharacters: ["libai"],
                    keywords: ["自由", "理想", "豪迈", "梦想"]
                },
                "knowledgeable": {
                    title: "传统智慧与现代价值",
                    ibProfile: "Knowledgeable",
                    emoji: "📚",
                    subtitle: "古典教育 vs 现代素质",
                    questions: [
                        "传统的'修身齐家治国平天下'在现代还有意义吗？",
                        "孝道、尊师等传统观念如何适应现代家庭关系？",
                        "年轻人学古典文学是'装文艺'还是真的有用？",
                        "'君子'品格在现代职场和社交中是优势还是劣势？"
                    ],
                    triggerCharacters: ["confucius", "zengzi", "yangxiong"],
                    keywords: ["传统", "文化", "修身", "君子"]
                },
                "reflective": {
                    title: "内心宁静与外在浮躁",
                    ibProfile: "Reflective",
                    emoji: "🧘",
                    subtitle: "现代人的精神焦虑",
                    questions: [
                        "手机不离手的时代，如何实现'心远地自偏'？",
                        "冥想、正念 vs 古人的'静坐'，有什么区别？",
                        "在信息爆炸的环境中，如何保持内心的清明？",
                        "'行到水穷处，坐看云起时'的境界现代人能达到吗？"
                    ],
                    triggerCharacters: ["wangwei"],
                    keywords: ["禅意", "宁静", "冥想", "内心"]
                },
                "openminded": {
                    title: "乐观豁达与现实压力",
                    ibProfile: "Open-minded",
                    emoji: "😊",
                    subtitle: "现代版'也无风雨也无晴'",
                    questions: [
                        "面对裁员、失恋、考试失败，如何保持苏轼式的豁达？",
                        "是先解决问题再开心，还是先开心再解决问题？",
                        "'人生如逆旅，我亦是行人'对现代焦虑症有用吗？",
                        "社交媒体上的'完美生活'展示 vs 真实的人生起伏"
                    ],
                    triggerCharacters: ["sushi"],
                    keywords: ["豁达", "乐观", "旷达", "快乐"]
                },
                "principled": {
                    title: "个人坚韧与时代变迁",
                    ibProfile: "Principled",
                    emoji: "💪",
                    subtitle: "时代洪流中的个体力量",
                    questions: [
                        "'生当作人杰，死亦为鬼雄'的气概现代人还需要吗？",
                        "面对时代变化（AI、失业风险），个人如何保持韧性？",
                        "女性在现代社会如何平衡温柔与坚强？",
                        "个人努力 vs 时代机遇，哪个更重要？"
                    ],
                    triggerCharacters: ["liqingzhao"],
                    keywords: ["坚强", "坚韧", "品格", "原则"]
                },
                "thinkers": {
                    title: "理想抱负与现实妥协",
                    ibProfile: "Thinkers",
                    emoji: "🎯",
                    subtitle: "现代版'鞠躬尽瘁'",
                    questions: [
                        "毕业后的理想与现实：大厂高薪 vs 理想工作，如何选择？",
                        "'非淡泊无以明志'在竞争激烈的环境中还适用吗？",
                        "什么年龄段最适合'理想主义'？什么时候该'现实一点'？",
                        "个人理想与家庭责任冲突时，如何平衡？"
                    ],
                    triggerCharacters: ["zhugeliang"],
                    keywords: ["理想", "抱负", "规划", "智慧"]
                }
            },
            
            // 智能匹配算法
            matchPlayerTopic: function() {
                const mentionedChars = gameState.mentionedCharacters || [];
                const playerChoices = gameState.selectedOptions || [];
                const poemLines = poemCreationState.inputLines || [];
                
                console.log('🎯 开始智能匹配古今对话主题');
                console.log('提及角色:', mentionedChars);
                
                let scores = {};
                
                // 初始化分数
                Object.keys(this.topicDatabase).forEach(key => {
                    scores[key] = 0;
                });
                
                // 1. 角色匹配（权重70%）
                mentionedChars.forEach(charId => {
                    Object.entries(this.topicDatabase).forEach(([topicKey, topic]) => {
                        if (topic.triggerCharacters.includes(charId)) {
                            scores[topicKey] += 70;
                            console.log(`角色匹配: ${charId} → ${topicKey} (+70分)`);
                        }
                    });
                });
                
                // 2. 选择倾向分析（权重20%）
                const stylePoints = gameState.stylePoints || {};
                if (stylePoints.tao > 0) scores["balanced"] += 20;
                if (stylePoints.du > 0) scores["caring"] += 20;
                if (stylePoints.ru > 0) scores["knowledgeable"] += 15;
                
                // 3. 创作内容关键词（权重10%）
                const allText = poemLines.join('');
                Object.entries(this.topicDatabase).forEach(([topicKey, topic]) => {
                    topic.keywords.forEach(keyword => {
                        if (allText.includes(keyword)) {
                            scores[topicKey] += 10;
                            console.log(`关键词匹配: ${keyword} → ${topicKey} (+10分)`);
                        }
                    });
                });
                
                // 4. 添加随机因子（防止过于固定）
                Object.keys(scores).forEach(key => {
                    scores[key] += Math.random() * 5;
                });
                
                // 选择最高分的主题
                const bestTopic = Object.keys(scores).reduce((a, b) => 
                    scores[a] > scores[b] ? a : b
                );
                
                console.log('主题匹配得分:', scores);
                console.log('最终选择主题:', bestTopic, this.topicDatabase[bestTopic].title);
                
                return this.topicDatabase[bestTopic];
            },
            
            // 生成话题UI HTML
            generateTopicHTML: function(selectedTopic) {
                return `
                    <div class="mx-4 my-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl overflow-hidden shadow-sm border border-purple-100">
                        <!-- 顶部标签区 -->
                        <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">🤔</span>
                                    <div>
                                        <h3 class="font-semibold text-lg">深度思辨：古今对话</h3>
                                        <p class="text-purple-100 text-sm mt-1">基于您的游戏体验智能匹配</p>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <span class="text-sm font-medium">IB · ${selectedTopic.ibProfile}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 主题内容区 -->
                        <div class="p-5">
                            <div class="flex items-center mb-4">
                                <span class="text-3xl mr-3">${selectedTopic.emoji}</span>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${selectedTopic.title}</h4>
                                    <p class="text-gray-600 text-sm mt-1">${selectedTopic.subtitle}</p>
                                </div>
                            </div>
                            
                            <!-- 思辨问题列表 -->
                            <div class="space-y-3">
                                ${selectedTopic.questions.map((question, index) => `
                                    <div class="flex items-start bg-white rounded-lg p-3 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                        <div class="w-6 h-6 bg-gradient-to-r from-purple-400 to-blue-400 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5 flex-shrink-0">
                                            ${index + 1}
                                        </div>
                                        <p class="text-gray-700 text-sm leading-relaxed">${question}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- 底部提示 -->
                            <div class="mt-5 pt-4 border-t border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-gray-500">
                                        💡 这些问题没有标准答案，每个人都可以有自己的思考
                                    </div>
                                    <div class="flex items-center text-xs text-purple-600">
                                        <span class="w-2 h-2 bg-purple-400 rounded-full mr-1"></span>
                                        <span>个性化匹配</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // 预生成古今对话内容
        function generateAncientModernDialogueContent() {
            // 智能匹配主题
            const selectedTopic = ancientModernDialogueSystem.matchPlayerTopic();
            
            // 直接返回HTML内容，而不是操作DOM
            return ancientModernDialogueSystem.generateTopicHTML(selectedTopic);
        }

        // 朋友圈UI生成器
        const momentsUIGenerator = {
            generateMomentsUI: async function(momentsContent, screenshots, interactions, ancientModernContent) {
                const momentsContainer = document.createElement('div');
                momentsContainer.className = 'fixed inset-0 bg-white z-50 overflow-y-auto';
                
                momentsContainer.innerHTML = `
                    <!-- 微信朋友圈头部 -->
                    <div class="sticky top-0 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between z-10">
                        <button id="closeMoments" class="text-gray-600 hover:text-gray-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-lg font-medium">朋友圈</h1>
                        <button class="text-gray-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zM12 13a1 1 0 110-2 1 1 0 010 2zM12 20a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 朋友圈内容 -->
                    <div class="pb-6">
                        <!-- 用户信息区 -->
                        <div class="px-4 py-6 bg-gradient-to-r from-blue-50 to-purple-50">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                    刘
                                </div>
                                <div class="ml-3">
                                    <div class="font-medium text-gray-800">刘禹锡</div>
                                    <div class="text-sm text-gray-500">诗豪 · 唐代文学家</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 朋友圈动态 -->
                        <div class="px-4 py-4 border-b border-gray-100">
                            <!-- 发布时间 -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-gray-500">2分钟前 · 陋室雅集</div>
                                <div class="text-xs text-gray-400">📍 时空交汇点</div>
                            </div>
                            
                            <!-- 文字内容 -->
                            <div class="text-gray-800 leading-relaxed mb-4" style="font-size: 16px;">
                                ${momentsContent.replace(/\n/g, '<br>')}
                            </div>
                            
                            <!-- 聊天截图 -->
                            <div id="chatScreenshots" class="mb-4">
                                ${screenshots.map(screenshot => screenshot.outerHTML).join('')}
                            </div>
                            
                            <!-- 互动统计 -->
                            <div class="flex items-center justify-between py-3 border-t border-gray-100">
                                <div class="flex items-center text-sm text-gray-500">
                                    <span class="flex items-center mr-4">
                                        <span class="mr-1">👍❤️😮</span>
                                        <span>${interactions.likes.slice(0, 3).join('、')}等${interactions.likes.length}人</span>
                                    </span>
                                </div>
                                <div class="flex items-center text-sm text-gray-500">
                                    <span class="mr-3">💬 ${interactions.comments.length}条评论</span>
                                    <span>🔄 3次转发</span>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="flex items-center justify-around py-3 border-t border-gray-100">
                                <button class="flex items-center text-gray-600 hover:text-blue-500">
                                    <span class="mr-1">👍</span>
                                    <span>点赞</span>
                                </button>
                                <button class="flex items-center text-gray-600 hover:text-blue-500">
                                    <span class="mr-1">💬</span>
                                    <span>评论</span>
                                </button>
                                <button id="saveScreenshot" class="flex items-center text-gray-600 hover:text-green-500">
                                    <span class="mr-1">📱</span>
                                    <span>保存截图</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 评论区 -->
                        <div class="px-4 py-4">
                            <h3 class="font-medium text-gray-800 mb-4">评论 (${interactions.comments.length})</h3>
                            <div id="commentsList">
                                ${interactions.comments.map(comment => `
                                    <div class="flex items-start mb-4 pb-4 border-b border-gray-50 last:border-b-0">
                                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm mr-3">
                                            ${comment.emoji}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm text-gray-800 mb-1">
                                                ${comment.author}
                                                ${comment.isAI ? '<span class="text-xs text-blue-500 ml-1">✨AI</span>' : ''}
                                            </div>
                                            <div class="text-gray-700 text-sm leading-relaxed">
                                                ${comment.text}
                                            </div>
                                            <div class="text-xs text-gray-400 mt-2">
                                                刚刚 · <span class="hover:text-blue-500 cursor-pointer">回复</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- 深度思辨：古今对话板块 -->
                        <div id="ancientModernDialogue">
                            ${ancientModernContent || ''}
                        </div>
                    </div>
                `;
                
                return momentsContainer;
            }
        };
        
        // 启动朋友圈生成流程
        async function generateMomentsPage() {
            console.log('🎨 开始生成朋友圈页面');
            
            try {
                // 1. 分析玩家特征
                const playerProfile = personalityAnalyzer.analyzePlayerProfile();
                console.log('玩家特征分析完成:', playerProfile);
                
                // 2. 生成朋友圈内容
                const momentsContent = await momentsGenerator.generateMomentsContent(playerProfile);
                console.log('朋友圈内容生成完成');
                
                // 3. 生成聊天截图
                const screenshots = chatScreenshotGenerator.generateChatScreenshots();
                console.log('聊天截图生成完成');
                
                // 4. 生成社交互动
                const interactions = await momentsInteractionGenerator.generateInteractions(momentsContent, playerProfile);
                console.log('社交互动生成完成');
                
                // 5. 预生成古今对话内容
                const ancientModernContent = generateAncientModernDialogueContent();
                console.log('古今对话内容预生成完成');
                
                // 6. 生成完整UI（包含古今对话内容）
                const momentsUI = await momentsUIGenerator.generateMomentsUI(momentsContent, screenshots, interactions, ancientModernContent);
                
                // 7. 显示朋友圈页面
                document.body.appendChild(momentsUI);
                
                // 8. 绑定事件
                bindMomentsEvents(momentsUI);
                
                console.log('✅ 朋友圈页面生成完成');
                
            } catch (error) {
                console.error('朋友圈生成失败:', error);
                showMomentsError();
            }
        }
        
        // 绑定朋友圈交互事件
        function bindMomentsEvents(momentsUI) {
            // 关闭朋友圈
            const closeBtn = momentsUI.querySelector('#closeMoments');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    momentsUI.remove();
                });
            }
            
            // 保存截图功能
            const saveBtn = momentsUI.querySelector('#saveScreenshot');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    // 简化版保存功能
                    const alert = document.createElement('div');
                    alert.className = 'fixed top-4 left-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    alert.textContent = '📱 截图保存功能已触发（模拟）';
                    document.body.appendChild(alert);
                    
                    setTimeout(() => alert.remove(), 2000);
                });
            }
        }
        
        // 朋友圈错误处理
        function showMomentsError() {
            const errorMessage = {
                type: "system",
                text: "😅 朋友圈功能暂时不可用，但你的《陋室铭》创作体验已经完成！感谢参与这次跨越时空的文学之旅。"
            };
            appendMessage(errorMessage, true);
        }

        // 游戏结束（修改版）
        function endGame() {
            setTimeout(async () => {
                const endMessage = {
                    type: "system",
                    text: "🎉 恭喜你完成了《陋室铭》的创作体验！\n\n💫 现在为您生成专属朋友圈，分享这次跨越时空的文学之旅..."
                };
                await appendMessage(endMessage, true);
                
                // 2秒后生成朋友圈
                setTimeout(() => {
                    generateMomentsPage();
                }, 2000);
                
            }, 1000);
        }

        // 开始游戏
        function startGame() {
            // 直接开始游戏，不显示AI功能提示
            displayMessages(gameScript["0"].messages);
        }

        // CSP预测试功能
        async function testApiConnection() {
            const testApiBtn = document.getElementById('testApiBtn');
            const apiStatus = document.getElementById('apiStatus');
            const apiTestResult = document.getElementById('apiTestResult');
            const startGameBtn = document.getElementById('startGameBtn');
            
            // 开始测试
            testApiBtn.disabled = true;
            testApiBtn.textContent = '测试中...';
            apiStatus.innerHTML = '<span class="text-blue-500">🔄 正在测试连接...</span>';
            
            try {
                // 进行实际的Poe AI测试调用
                const testResponse = await callPoeAI("请回复'连接成功'四个字", {
                    temperature: 0.1,
                    maxTokens: 10
                });
                
                // 测试成功
                apiStatus.innerHTML = '<span class="text-green-500">✅ 连接成功</span>';
                apiTestResult.className = 'mt-3 text-sm text-green-600 bg-green-50 p-3 rounded block';
                apiTestResult.textContent = `✨ AI增强功能已就绪！响应内容："${testResponse}"`;
                
                // 启用开始游戏按钮
                startGameBtn.disabled = false;
                startGameBtn.className = startGameBtn.className.replace('opacity-50 cursor-not-allowed', 'hover:scale-105');
                const startText = startGameBtn.parentElement.querySelector('p');
                if (startText) {
                    startText.textContent = '🎮 AI功能已激活，开始您的《陋室铭》之旅';
                }
                
                testApiBtn.textContent = '重新测试';
                testApiBtn.disabled = false;
                
            } catch (error) {
                console.error('API测试失败:', error);
                
                // 测试失败，但仍允许游戏进行
                apiStatus.innerHTML = '<span class="text-orange-500">⚠️ 部分功能受限</span>';
                apiTestResult.className = 'mt-3 text-sm text-orange-600 bg-orange-50 p-3 rounded block';
                apiTestResult.innerHTML = `
                    <div class="mb-2">⚠️ AI增强功能连接失败</div>
                    <div class="text-xs text-gray-600 mb-2">错误信息：${error.message}</div>
                    <div class="text-sm">💡 游戏仍可正常进行，但会使用预制对话内容</div>
                `;
                
                // 禁用AI功能但允许游戏继续
                AI_FEATURES.enabled = false;
                AI_FEATURES.textVariants = false;
                AI_FEATURES.textAnnotation = false;
                
                // 启用开始游戏按钮
                startGameBtn.disabled = false;
                startGameBtn.className = startGameBtn.className.replace('opacity-50 cursor-not-allowed', 'hover:scale-105');
                const startText = startGameBtn.parentElement.querySelector('p');
                if (startText) {
                    startText.textContent = '🎮 使用预制内容模式开始游戏';
                }
                
                testApiBtn.textContent = '重新测试';
                testApiBtn.disabled = false;
            }
        }

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化典故解释功能
            initTextAnnotation();
            
            // 绑定API测试按钮
            const testApiBtn = document.getElementById('testApiBtn');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', testApiConnection);
            }
            
            // 如果在游戏指南页面，监听开始游戏按钮
            const startGameBtn = document.getElementById('startGameBtn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    // 隐藏游戏指南页面
                    const gameGuide = document.getElementById('gameGuide');
                    gameGuide.classList.add('opacity-0');
                    setTimeout(() => {
                        gameGuide.style.display = 'none';
                        startGame();
                    }, 500);
                });
            } else {
                startGame();
            }
        });
    </script>
</body>
</html>
